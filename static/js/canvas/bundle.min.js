(function(){
function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(e,t){var r=[],n=!0,o=!1,a=void 0
try{for(var i,s=e[Symbol.iterator]();!(n=(i=s.next()).done)&&(r.push(i.value),!t||r.length!==t);n=!0);}catch(e){o=!0,a=e}finally{try{n||null==s.return||s.return()}finally{if(o)throw a}}return r}function _arrayWithHoles(e){if(Array.isArray(e))return e}function scale_canvas(e,t,r,n){e.width=r*PIXEL_RATIO,e.height=n*PIXEL_RATIO,e.style.width=r+"px",e.style.height=n+"px",t.setTransform(PIXEL_RATIO,0,0,PIXEL_RATIO,0,0),t.save()}function setup_canvasses(e,t){canvas_width=e,canvas_height=t,scale_canvas(canvas.node(),context,e,t),scale_canvas(canvas_single.node(),context_single,e,t),scale_canvas(gui_canvas.node(),gui_context,e,t),scale_canvas(hover_canvas.node(),hover_context,e,t),scale_canvas(cursor_canvas.node(),cursor_context,e,t),scale_canvas(grid_canvas.node(),grid_context,e,t),cursor_context.fillStyle="yellowgreen",cursor_context.strokeStyle="yellowgreen",canvas_offset_x=canvas.node().getBoundingClientRect().left,canvas_offset_y=canvas.node().getBoundingClientRect().top}function calc_canvas_width(){return[window.innerWidth-2*CANVAS_MARGIN-200,window.innerHeight-2*CANVAS_MARGIN]}function set_current_element(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1]
if("canvas"==e.iama&&"canvas"==currentElement.iama)return!1
text_for_render.pause_sorting(),text_for_render.invalidate_sorted()
var r=e!=currentElement
if(currentElement=e,"text"==e.iama&&(e=find_border_by_id(e.border_id)),el_on_single=!1,paths_on_single=[],el_on_single=!(merged.is_parent(e)||"table"in e||manage_groups.element_in_active_group(e))&&("border"==e.iama||"drawing"==e.iama||"math_shape"==e.iama)&&e,el_on_single&&(paths_on_single=_.flatten(path.find_connections(el_on_single.id).map(function(e){return shapes_storage.paths.filter(function(t){return t.id==e.id})}))),paths_on_single.length>0){var n=new Set(Object.values(shapes_storage.borders_bound).map(function(e){return e.path_id}))
paths_on_single.map(function(e){return e.id}).filter(function(e){return n.has(e)}).length>0&&(el_on_single=!1,paths_on_single=[])}if(gui_buttons.reset_path_control_points(),(r||!el_on_single||t)&&render_all(),el_on_single?render_single():cc.clear_canvas(context_single),canvas_status.mobile_mode){var o,a
if("canvas"==currentElement.iama)o=last_pos[0],a=last_pos[1]
else if("text"==currentElement.iama){var i=[currentElement.x,currentElement.y]
o=i[0],a=i[1]}else{var s=[currentElement.x,currentElement.y+currentElement.width]
o=s[0],a=s[1]}display_cursor_mobile_mode(20,o,a)}}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(e,t){var r=[],n=!0,o=!1,a=void 0
try{for(var i,s=e[Symbol.iterator]();!(n=(i=s.next()).done)&&(r.push(i.value),!t||r.length!==t);n=!0);}catch(e){o=!0,a=e}finally{try{n||null==s.return||s.return()}finally{if(o)throw a}}return r}function _arrayWithHoles(e){if(Array.isArray(e))return e}function conv_arrow_rotation_to_geo_rotation(e){var t=180-e
return t<0?t+360:t}function conv_angle(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]&&arguments[3],o=-e/(180/Math.PI),a=t*Math.cos(o)-r*Math.sin(o),i=t*Math.sin(o)+r*Math.cos(o)
return n?[a-t,i-r]:[Math.round(1e5*a)/1e5,Math.round(1e5*i)/1e5]}function rotate_point(e,t,r){return[Math.cos(e)*t+Math.sin(e)*r,-Math.sin(e)*t+Math.cos(e)*r]}function round_to(e,t){return Math.round(e*Math.pow(10,t))/Math.pow(10,t)}function to_bbox(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0
return{top:e.y-t,left:e.x-t,bottom:e.y+e.height+2*t,right:e.x+e.width+2*t}}function bbox_to_xywh(e){var t=e.top,r=e.left,n=e.bottom
return{x:r,y:t,width:e.right-r,height:n-t}}function xywh_to_bbox(e){var t=e.x,r=e.y,n=e.width
return{top:r,left:t,bottom:r+e.height,right:t+n}}function is_inside(e,t,r){return e>r.left&&e<r.right&&t>r.top&&t<r.bottom}function bbox_is_inside_bbox(e,t){return is_inside(e.left,e.top,t)&&is_inside(e.right,e.bottom,t)}function get_bbox_of_figure(e,t){var r=[e.width,e.height],n=r[0],o=r[1],a=[e.x,e.y],i=a[0],s=a[1]
return t?[i,s,n,o]:parse_to_bbox(i,s,n,o)}function parse_to_bbox(e,t,r,n){function o(r,n){return[e+r,t+n]}var a={}
return a.x0y0=[e,t],a.x1y0=o(r,0),a.x0y1=o(0,n),a.x1y1=o(r,n),a}function get_path_points_min_max(e){return[Math.min.apply(null,e.map(function(e){return e.x})),Math.max.apply(null,e.map(function(e){return e.x})),Math.min.apply(null,e.map(function(e){return e.y})),Math.max.apply(null,e.map(function(e){return e.y}))]}function pyth_dist(e,t){return Math.pow(e[0]-t[0],2)+Math.pow(e[1]-t[1],2)}function get_bbox_of_group(e){var t=minY=1/0,r=maxY=-1/0,n=["path_group","text_block","text_path"]
return e.forEach(function(e){if("iama"in e&&!n.find(function(t){return t==e.iama})){var o=abs_pos_to_bbox(e)
t=Math.min(t,o.left),minY=Math.min(minY,o.top),r=Math.max(r,o.right),maxY=Math.max(maxY,o.bottom)}}),[t,r,minY,maxY]}function abs_pos_to_bbox(e){var t=[e.x,e.y],r=t[0],n=t[1],o=[e.width,e.height],a=o[0],i=o[1]
return{top:n,bottom:n+i,left:r,right:r+a,width:a,height:i}}function to_discrete_position(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:parseInt,r=_slicedToArray(e,2),n=r[0],o=r[1]
return[t(n/mdd)*mdd,t(o/mdd)*mdd]}function get_custom_bbox(e){var t=get_bbox_of_figure(e,!0,!0),r=_slicedToArray(t,4)
return x=r[0],y=r[1],w=r[2],h=r[3],{top:y,bottom:y+h,left:x,right:x+w,width:w,height:h}}function points_in_area(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:_.all,n=[t.x0y0,t.x1y0,t.x1y1,t.x0y1],o=[]
return e.forEach(function(e){o.push(point_is_inside(e,n))}),r(o)}function get_minxy_maxxy_of_array(e){var t=e.map(function(e){return e[0]}),r=e.map(function(e){return e[1]}),n=Math.min.apply(null,t),o=Math.max.apply(null,t)
return[n,Math.min.apply(null,r),o,Math.max.apply(null,r)]}function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(e,t){var r=[],n=!0,o=!1,a=void 0
try{for(var i,s=e[Symbol.iterator]();!(n=(i=s.next()).done)&&(r.push(i.value),!t||r.length!==t);n=!0);}catch(e){o=!0,a=e}finally{try{n||null==s.return||s.return()}finally{if(o)throw a}}return r}function _arrayWithHoles(e){if(Array.isArray(e))return e}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function _iterableToArray(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e)){for(var t=0,r=new Array(e.length);t<e.length;t++)r[t]=e[t]
return r}}function make_shape_storage(){function e(e){q={},e.texts.forEach(function(e){e.border_id in q?q[e.border_id].push(e):q[e.border_id]=[e]}),T={},e.borders_bound.forEach(function(e){return T[e.id]=e}),z={},e.borders.forEach(function(e){return z[e.id]=e}),I=e.paths,L=e.icons,C=e.knots,M=e.drawings,e.math_shapes&&(O=e.math_shapes),t(e.images)}function t(e){Object.keys(e).forEach(function(t){var r=new Image
r.src=e[t].source,r.border_data=e[t],j[t]=r})}function r(){Object.values(T).forEach(function(e){return delete e.redraw_data}),Object.values(z).forEach(function(e){return delete e.redraw_data}),I.forEach(function(e){return delete e.redraw_data}),M.forEach(function(e){return delete e.redraw_data}),Object.values(q).forEach(function(e){e.forEach(function(e){return delete e.parts})})
var e=JSON.parse(JSON.stringify(q))
Object.values(z).forEach(function(e){return position_texts(e.id)}),Object.values(T).forEach(function(e){return position_texts(e.id)})
var t={}
return Object.keys(j).forEach(function(e){var r=Object.assign({},j[e].border_data)
r.source=j[e].getAttribute("src"),t[e]=r}),{borders_bound:T,borders:z,paths:I,drawings:M,images:t,icons:L,texts:e,knots:C,math_shapes:O}}function n(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],n=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],o=!(arguments.length>4&&void 0!==arguments[4])||arguments[4],a=!(arguments.length>5&&void 0!==arguments[5])||arguments[5],i=!(arguments.length>6&&void 0!==arguments[6])||arguments[6],s=[]
return t&&(s=s.concat(Object.values(z))),r&&(s=s.concat(I)),n&&(s=s.concat(M)),o&&(s=s.concat(L)),a&&(s=s.concat(C)),i&&(s=s.concat(Object.values(O))),s.filter(function(t){return is_inside.apply(void 0,_toConsumableArray(posit2.get_top_left(t)).concat([e]))&&is_inside.apply(void 0,_toConsumableArray(posit2.get_bottom_right(t)).concat([e]))})}function o(e,t,r){var n=document.createElementNS("http://www.w3.org/2000/svg","path")
n.setAttribute("d",r.d)
var o=get_points_along_path(n,10,0)
"drawing"==r.iama&&(o=o.map(function(e){var t=_slicedToArray(e,2),n=t[0],o=t[1]
return[n+r.x,o+r.y]}))
var a=o.map(function(r){return pyth_dist(r,[e,t])})
return Math.min.apply(void 0,a.sort(function(e,t){return t-e}))}function a(e,t){var r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],n=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],a=[]
r&&n?a=I.concat(M):n?a=M:r&&(a=I)
var i=s(e,t,a,!0)
if(!i)return i
var _=i.map(function(r){return o(e,t,r)}),l=Math.min.apply(void 0,_)
if(l<R){var c=i[_.indexOf(l)]
return"add_ons"in c?"head"in c.add_ons&&is_inside(e,t,xywh_to_bbox(c.add_ons.head.bbox))?c.add_ons.head:"tail"in c.add_ons&&is_inside(e,t,xywh_to_bbox(c.add_ons.tail.bbox))?c.add_ons.tail:c:c}}function i(e,t){var r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],n=!1
if(n||(n=s(e,t,L)),n||(n=s(e,t,C)),n||(n=s(e,t,Object.values(O))),n||(n=s(e,t,Object.values(z),!1)),n||(n=s(e,t,Object.values(T))),n){if("border"==n.iama&&merged.is_parent(n)){var o=s(e,t,Array.from(merged.get_children(n)))
o&&(n=o)}var a=s(e,t,find_parts_with_border_id(n.id),!1,0)
return r&&n&&!a?n:n?a||n:void 0}}function s(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]&&arguments[3],o=arguments.length>4?arguments[4]:void 0
o=void 0==o?get_scaled_margin():get_scaled_margin(o)
for(var a=[],i=r.length-1;i>-1;i--){var s=function(i){var s=r[i],_=!1
if(use_points_for_detection(s)){var l=get_poly_config(s).points,c=l.map(function(e){var t=_slicedToArray(e,2),r=t[0],n=t[1]
return[s.x+r*s.width,s.y+n*s.height]})
_=point_is_inside([e,t],c)}else _=is_inside(e,t,to_bbox(s,o))
if(_){if(!n)return{v:s}
a.push(s)}}(i)
if("object"===_typeof(s))return s.v}return a.length>0?a:void 0}function l(e,t){var r=gui_buttons.is_resize_button(e,t)
return r||((r=gui_buttons.is_flip_button(e,t))?r:(r=gui_buttons.is_connect_button(e,t))?r:(r=gui_buttons.is_morph_button(e,t))?r:(r=gui_buttons.is_path_control_point(e,t))?r:(r=gui_buttons.is_line_end_button(e,t))?r:(r=i(e,t,!1))||a(e,t))}function c(e,t){var r=i(e,t,!0)
r&&"text"==r.iama&&(r=find_border_by_id(r.border_id)),r&&"flipped"in r&&flip_shape(r)}function u(e){e=e||d3.event.sourceEvent||d3.event
var t=get_xy_inverted_from_event(e),r=_slicedToArray(t,2),n=r[0],o=r[1]
if(canvas_status.view_mode)return c(n,o)
if(canvas_status.slide_mode||canvas_status.export_mode&&!printer.is_fixed_A_ratio()){return gui_buttons.is_path_control_point(n,o)||s(n,o,[slider])}var _=gui_buttons.is_resize_button(n,o)
return _||(_=gui_buttons.is_connect_button(n,o)),_||(_=gui_buttons.is_morph_button(n,o)),_||(_=gui_buttons.is_par_handle(n,o)),_||(_=gui_buttons.is_path_control_point(n,o)),_||(_=gui_buttons.is_line_end_button(n,o)),_||!gui_buttons.is_flip_button(n,o)?(_||(_=i(n,o,!0)),_||a(n,o,!1,!0)):void 0}function d(e,t){return s(e,t,Object.values(z))}function f(e,t){return s(e,t,Object.values(z))}function h(e){if("text"==e.iama)return k(e),!1
var t=m(e)
if(Array.isArray(t)){var r=t.indexOf(e);-1!=r&&t.splice(r,1)}else delete t[e.id]}function p(e){"border_data"in e?j[e.border_data.border_id]=e:y(e)}function m(e){var t=e.iama
return"border"==t?e.bound?T:z:"path_group"==t?I:"text"==t?q:"drawing"==t?M:"fa_icon"==t?L:"knot"==t?C:"math_shape"==t?O:void 0}function g(e){e.forEach(y)}function y(e){var t=m(e)
Array.isArray(t)?t.push(e):"text"==e.iama?x(e):t[e.id]=e}function v(){var e={top:currentElement.y,left:currentElement.x,bottom:currentElement.y+currentElement.height,right:currentElement.x+currentElement.width}
Object.values(shapes_storage.borders).filter(function(t){return is_inside(t.x,t.y,e)||is_inside(t.x+t.width,t.y+t.height,e)}).forEach(function(e){return b(e)})}function b(e){e.draw_order=Date.now()}function w(e){if(e in z)return z[e]
if(e in T)return T[e]
if(e in O)return O[e]
var t=C.concat(I).filter(function(t){return t.id==e})
return 0!=t.length&&t[0]}function x(e){e.border_id in q?q[e.border_id].push(e):q[e.border_id]=[e],text_for_render.invalidate_sorted()}function k(e){q[e.border_id]=q[e.border_id].filter(function(t){return t!=e}),text_for_render.invalidate_sorted()}function E(e){var t=[]
return e.forEach(function(e){if(e in q){var r=z[e]
r&&"flipped"in r?(to_add=q[e].filter(function(e){return e.flipped==r.flipped}),to_add.forEach(function(e){return t.push(e)})):q[e].forEach(function(e){return t.push(e)})}}),t}function A(e){var t=!0,r=!1,n=void 0
try{for(var o,a=M[Symbol.iterator]();!(t=(o=a.next()).done);t=!0){var i=o.value
if("add_ons"in i){if(i.add_ons.head==e)return i
if(i.add_ons.tail==e)return i}}}catch(e){r=!0,n=e}finally{try{t||null==a.return||a.return()}finally{if(r)throw n}}}var S=arguments.length>0&&void 0!==arguments[0]&&arguments[0],q={},T={},z={},I=[],M=[],j={},L=[],C=[],O={}
S&&function(r){if(Array.isArray(r.borders))return e(r),!0
q=r.texts,T=r.borders_bound,z=r.borders,I=r.paths,L=r.icons,C=r.knots,M=r.drawings,r.math_shapes&&(O=r.math_shapes),t(r.images)}(S)
var R=100
return{get_text_array_from_ids:E,add_shapes:g,add_shape:y,add_text:x,add_existing_shape:p,find_clickable_shape:l,find_draggable_shape:u,find_connectable_shape:d,find_text_droppable_shape:f,texts:q,borders_bound:T,borders:z,paths:I,drawings:M,images:j,icons:L,knots:C,math_shapes:O,find_shapes_in_bbox:n,find_shape:i,get_data_for_save:r,remove:h,remove_text:k,move_covered_to_top:v,move_to_top:b,get_all:function(){return Object.values(z).concat(Object.values(O)).concat(Object.values(T)).concat(I).concat(M).concat(L).concat(C).concat(_.flatten(Object.values(q)))},search_shapes_with_id:w,find_parent_of_drawing_add_on:A}}function find_borders_bound_by_path_id(e){return Object.values(shapes_storage.borders_bound).filter(function(t){return t.path_id==e})}function get_text_with_border_id(e){if(!(arguments.length>1&&void 0!==arguments[1]&&arguments[1])&&shapes_storage.borders[e]&&"flipped"in shapes_storage.borders[e]){var t=shapes_storage.borders[e].flipped
return shapes_storage.texts[e].filter(function(e){return e.flipped==t})}return shapes_storage.texts[e]||[]}function find_border_by_id(e){return e in shapes_storage.borders?shapes_storage.borders[e]:e in shapes_storage.borders_bound?shapes_storage.borders_bound[e]:e in shapes_storage.borders_bound?shapes_storage.math_shapes[e]:shapes_storage.knots.filter(function(t){return t.id==e})[0]}function find_path_by_id(e){return shapes_storage.paths.filter(function(t){return t.id==e})[0]}function use_points_for_detection(e){return"border"==e.iama&&"rect"!=e.shape&&"ellipse"!=e.shape}function is_shape_inside_bbox(e,t){return is_inside.apply(void 0,_toConsumableArray(posit2.get_top_left(e)).concat([t]))&&is_inside.apply(void 0,_toConsumableArray(posit2.get_bottom_right(e)).concat([t]))}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(e,t){var r=[],n=!0,o=!1,a=void 0
try{for(var i,s=e[Symbol.iterator]();!(n=(i=s.next()).done)&&(r.push(i.value),!t||r.length!==t);n=!0);}catch(e){o=!0,a=e}finally{try{n||null==s.return||s.return()}finally{if(o)throw a}}return r}function _arrayWithHoles(e){if(Array.isArray(e))return e}function get_new_ids(e){function t(e,t){for(var r=/"id":"([#|_|A-z][0-9]{4})"/g,n=[],o={},a=!0;a=r.exec(e);)n.push(a[1])
return n=n.sort(),n.forEach(function(e){o[e]=t()}),new Set(Object.keys(o)),Object.values(o),o}var r=JSON.stringify(e),n=t(r,next_id_gen("#",0))
Object.keys(n).forEach(function(e){var t=new RegExp(e,"g")
r=r.replace(t,n[e])})
var n=t(r,get_new_id)
return Object.keys(n).forEach(function(e){var t=new RegExp(e,"g")
r=r.replace(t,n[e])}),JSON.parse(r)}function find_highest_ids_per_prefix(e){for(var t={},r=0;r<e.length;r++)if(e[r].id&&e[r].iama&&"path_group"!=e[r].iama){var n=function(e){return[e.slice(0,1),e.slice(1)]}(e[r].id),o=_slicedToArray(n,2),a=o[0],i=o[1]
a in t||(t[a]="0000"),t[a]=get_max(t[a],i)}return t}function get_max(e,t){return"_"==e&&(e="0"),"_"==t&&(t="0"),e>t?e:t}function pad_id(e){return res="",e<10&&(res+="0"),e<100&&(res+="0"),e<1e3&&(res+="0"),res}function next_id_gen(e,t){var r=t
return function(){if(r>9999){var t=get_new_id_prefix_and_num(),n=_slicedToArray(t,2),o=n[0],a=n[1]
e=o,r=a}return res=pad_id(r),res+=r.toString(),r+=1,e+res}}function get_new_id_prefix_and_num(){var e=find_highest_ids_per_prefix(shapes_storage.get_all()),t=Object.keys(e).filter(function(e){return"_"!=e}).sort()
if(t.length>0){for(var r=0;r<t.length;r++)if(e[t[r]]<9999)return[t[r],parseInt(e[t[r]])+1]
return[String.fromCharCode(t.slice(-1)[0].charCodeAt(0)+1),0]}return["A",0]}function make_table_id_func(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"t",t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0
return function(){return t+=1,e+"0".repeat(4-t.toString().length)+t.toString()}}function table_init(){tables={}
var e=Object.values(shapes_storage.borders).filter(function(e){return"table"in e})
if(0==e.length)t=0
else{s=Array.from(new Set(e.map(function(e){return e.table}))),s.forEach(function(e){return reconstruct_table(e)})
var t=Math.max.apply(void 0,s.map(function(e){return parseInt(e.slice(1))}))}get_id_for_table=make_table_id_func("t",t)}function find_highest_id_and_prefix(e,t){var r=find_highest_ids_per_prefix(e),n="@",o="0000"
return Object.keys(r).forEach(function(e){n=get_max(e,n),o=get_max(o,r[e])}),t?t in r?[n,parseInt(r[t])]:[n,0]:[n,parseInt(r[n])]}function get_default_border(){var e=["icon_basic","line_hor","line_vert","math_shape"],t=get_new_id(),r=predef_styles.get_classes()[active_style.style_class]
return{x:last_pos[0],y:last_pos[1],width:10,height:4,color:r.color,stroke:r.stroke,stroke_width:infinity.get_border_width(infinity.get_level(),active_style.style_class),fill:r.fill,id:t,iama:"border",shape:-1==e.indexOf(active_style.shape)?active_style.shape:"rect",style_class:active_style.style_class,font_size:infinity.get_font_size(infinity.get_level(),r.font_class),font_family:r.font_family,num_pars:0,text_align:r.alignment,level:infinity.get_level(),padding:infinity.get_standard_scaling(r.padding)}}function get_default_drawing(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"hand",n=predef_styles.get_classes()[active_style.style_class],o={width:5,height:5,stroke:is_visible_color(n.fill)?n.fill:"black",stroke_width:infinity.get_standard_scaling(active_style.pencil_size,infinity.get_level(),2),flow:"lineto",iama:"drawing",level:infinity.get_level(),d:"",type:r}
return"rgba(0,0,0,0)"==o.stroke&&(o.stroke="rgba(10,10,10,0.7)"),isNaN(e)||isNaN(t)||"hand"!=r||(o.points=[],o.d="M"+[e,t],o.points.push([[e,t]])),o}function get_default_knot(e,t){return{id:get_new_id(),x:e,y:t,iama:"knot",width:5,height:5}}function get_default_textpart_for_par(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:""
return 0==e.parts.length?{text:t,x:e.x,y:e.y,width:2,height:e.height,border_id:e.border_id,iama:"text",parent:e,num:0,line_num:0}:(last=e.parts[e.parts.length-1],{text:t,x:last.x+last.w,y:last.y,width:2,height:e.height,border_id:e.border_id,iama:"text",parent:e,num:last.num,line_num:0})}function get_default_text(e,t){var r=get_text_style_from_border(e),n=r.font_size,o=r.color,a=r.font_family,i=e.style_class in predef_styles.get_classes()?predef_styles.get_classes()[e.style_class].line_height:1.2
t&&(n=t)
var s={x:parseInt(e.x+n*i),y:parseInt(e.y),has_own_style:!1,stroke:!1,stroke_width:!1,fill:!1,border_id:e.id,text:"",line_height:i,margin:0,iama:"text",chunk_num:0,par_num:0,font_family:a,font_size:n,color:o,font_fam_inherited:!0,font_size_inherited:!0,parts:[],width:MIN_PAR_WIDTH,height:parseInt(n)*i}
return"flipped"in e&&(s.flipped=e.flipped),s}function get_default_icon(e,t){var r=fa_handler.get_selected_icon(),n=predef_styles.get_classes()[active_style.style_class],o=infinity.get_level(),a=infinity.get_font_size(o,0)
return{x:e,y:t,icon:r,stroke:n.stroke,stroke_width:.5,fill:is_visible_color(n.fill)?n.fill:"rgba(10,10,10,0.8)",iama:"fa_icon",shape:"icon",font_size:a,width:a,height:a,level:o}}function is_visible_color(e){return t=tinycolor(e),0!=t.getAlpha()&&"ffffff"!=t.toHex()}function get_text_style_from_border(e){var t=e.color||(e.style_class?predef_styles.get_classes()[e.style_class].color:"black")
if(e.font_class)var r=predef_styles.font_class_to_size(e.font_class,e.level)
else var r=e.font_size||12
return{font_size:r,color:t,font_family:e.font_family}}function plus_minus_generator(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:2
r=r||1
var o=e.querySelector(".plus"),a=e.querySelector(".minus"),i=e.querySelector("input")
o.onmousedown=function(){var e=parseFloat(i.value)
i.value=round_to(e+r,n),t(i)},a.onmousedown=function(){var e=parseFloat(i.value)
i.value=round_to(e-r,n),t(i)},i.onchange=function(){t(i)}}function copy_element_new(e,t){function r(e){return JSON.parse(JSON.stringify(e))}var n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],o=get_new_id(),a=r(e)
a.id=o
var i=[]
if(n&&"id"in e&&(i=get_text_with_border_id(e.id),i.length>0)){i.forEach(function(e){return delete e.parts})
var i=i.map(function(e){return r(e)})
i.forEach(function(e){return e.border_id=o}),i.forEach(function(e){return shapes_storage.add_text(e)})}return shapes_storage.add_shape(a),reposition_protocol(a,t[0]-e.x,t[1]-e.y),n&&i.length>0&&(position_texts(e.id),position_texts(a.id)),a}function correct_chunk_style_attributes_if_no_own_style(){_.flatten(Object.values(shapes_storage.texts)).forEach(function(e){"has_own_style"in e&&e.has_own_style||(e.fill=!1,e.stroke=!1,e.stroke_width=!1)})}function correct_chunk_own_style_of_no_styles(){_.flatten(Object.values(shapes_storage.texts)).forEach(function(e){e.fill||e.stroke||e.stroke_width||(e.has_own_style=!1)})}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(e,t){var r=[],n=!0,o=!1,a=void 0
try{for(var i,s=e[Symbol.iterator]();!(n=(i=s.next()).done)&&(r.push(i.value),!t||r.length!==t);n=!0);}catch(e){o=!0,a=e}finally{try{n||null==s.return||s.return()}finally{if(o)throw a}}return r}function _arrayWithHoles(e){if(Array.isArray(e))return e}function change_path_end_fig(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1]
"path_group"==currentElement.iama?manage_groups.get_group(currentElement,!0).forEach(function(r){set_current_element(r),path.set_path_attrs(r),cpa.arrow_width=infinity.get_standard_scaling(10,cpa.level||"L1"),cpa.arrow_height=infinity.get_standard_scaling(17,cpa.level||"L1"),cpa["arrow_"+e]=!!t&&path_end_fig,change_arrow("arrow_"+e)}.bind(this)):currentElement.iama}function change_arrow(e){cpa[e]||(cpa[e]=!1,delete cpa.path_g.add_ons[e.split("_")[1]]),path.remake_path(!0)}function path_correction_for_arrow(e,t){var r=document.createElementNS("http://www.w3.org/2000/svg","path")
if(r.setAttribute("d",e[0]),c_to_c=e[1],t)n=r.getTotalLength(),n-=cpa.arrow_height*OVERLAP+0
else var n=cpa.arrow_height*OVERLAP+0
var o=r.getPointAtLength(n)
return original_point=c_to_c.midpoints[t].slice(),c_to_c.midpoints[t]=[o.x,o.y],cpa.arrow_height+=0,[make_d(c_to_c,1-OVERLAP),original_point]}function calc_arrow_angle(e,t,r){if(e[0]==t[0]&&e[1]==t[1])return 0
dx=e[0]-t[0],dy=e[1]-t[1]
var n=360/(2*Math.PI),o=Math.atan(dx/dy),a=n*o
return dx>=0&&dy>=0?-1*(a-90)+180:dx>=0&&dy<0?90-a:dx<0&&dy<0?-1*(a-90):270-a}function add_arrow_test(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"arrow",n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:10,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:17,a=path_to_array(e.d),i="head"==t?1:0,s=0,_=1
0!=i&&(s=a.length-1,_=s-1)
var l=[a[s].x+e.x,a[s].y+e.y],c=[a[_].x+e.x,a[_].y+e.y]
c=[l[0]+.1*(c[0]-l[0]),l[1]+.1*(c[1]-l[1])]
var u=[calc_arrow_angle(l,c),l[0],l[1]],d={stroke:"black",stroke_width:2,fill:"black"},f=path_end_figs[r].func(n,o,[0,0]),h=calc_bbox_for_arrow.apply(void 0,u.concat([n,o]))
"add_ons"in e||(e.add_ons={}),e.add_ons[t]={style:d,specs:f,end:i,figure:r,rotation:u,parent_id:e.id,side:t,bbox:h,x:l[0]-n/2,y:l[1]-o/2,width:n,height:o,iama:"path_addon"}}function add_shape_to_line_end(e,t,r){var n=1==t?e.j:e.i,o=t?e.original_point_head||e.midpoints[1]:e.original_point_tail||e.midpoints[0],a=path_end_figs[r].func(cpa.arrow_width,cpa.arrow_height,[0,0]),i=[calc_arrow_angle(o,e.midpoints[t],n),o[0],o[1]],s=get_styles_for_add_on(cpa.path_g.add_ons[1==t?"head":"tail"]),_=calc_bbox_for_arrow.apply(void 0,i.concat([cpa.arrow_width,cpa.arrow_height]))
return{style:s,specs:a,end:t,figure:r,rotation:i,parent_id:cpa.path_g.id,bbox:_,x:o[0]-cpa.arrow_width/2,y:o[1]-cpa.arrow_height/2,width:cpa.arrow_width,height:cpa.arrow_height,iama:"path_addon"}}function calc_bbox_for_arrow(e,t,r,n,o){var a=-e/(180/Math.PI),i=rotate_point(a,o,n/2),s=_slicedToArray(i,2),_=s[0],l=s[1],c=rotate_point(a,o,-n/2),u=_slicedToArray(c,2),d=u[0],f=u[1],h=get_minxy_maxxy_of_array([[0,0],[_,l],[d,f]]),p=_slicedToArray(h,4),m=p[0],g=p[1]
return{x:m+t,y:g+r,width:p[2]-m,height:p[3]-g}}function get_styles_for_add_on(e){if(e&&"style"in e)var t=e.style
else var t={inherited:!0}
return t.inherited&&("double"==cpa.type?(t.stroke_width=cpa.path_g.outer_width,t.stroke=cpa.path_g.stroke,t.fill=cpa.path_g.fill):(t.stroke_width=cpa.path_g.inner_width,t.stroke=cpa.path_g.fill,t.fill=cpa.path_g.fill)),t}function make_zero_one(e,t,r,n){var o=_slicedToArray(n,2),a=o[0],i=o[1],s=["M "+a+" "+i+" L "+(a+r)+" "+i+" M "+(a+r/2)+" "+(i-t/2)+" L "+(a+r/2)+" "+(i+t/2)],_=e.select("path")
return _.empty()&&(_=e.append("path")),_.attr("d",s),add_circle(e,t,r,n)}function add_circle(e,t,r,n){var o=e.select("circle")
return o.empty()&&(o=e.append("circle")),o.attr("r",4).attr("cx",n[0]+r).attr("cy",n[1]).style("fill","white"),e}function make_zero_tripod(e,t,r,n){var e=make_tripod(e,t,r,n)
return add_circle(e,t,r,n)}function make_one_only_one(e,t,r,n){var o=_slicedToArray(n,2),a=o[0],i=o[1]
return{fig:"path",d:"M "+a+" "+i+" L "+(a+r)+" "+i+" M "+(a+r/2)+" "+(i-t/2)+" L "+(a+r/2)+" "+(i+t/2)+" M "+(a+r)+" "+(i-t/2)+" L "+(a+r)+" "+(i+t/2)}}function make_tripod_one(e,t,r){var n=_slicedToArray(r,2),o=n[0],a=n[1]
return{fig:"poly",points:[o,a+e/2,o+t,a,o,a,o+t,a,o,a-e/2,o+t,a,o+t,a-e/2,o+t,a+e/2]}}function make_tripod(e,t,r){var n=_slicedToArray(r,2)
return n[0],n[1],{fig:"poly",points:ps}}function make_arrow_head(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[0,0],n=[]
return n.push(r),n.push([r[0]+t,r[1]+e/2]),n.push([r[0]+t,r[1]-e/2]),{points:n,fig:"poly"}}function make_arrow_head_rev(e,t,r){var n=[]
return n.push([r[0]+t,r[1]]),n.push([r[0],r[1]+e/2]),n.push([r[0],r[1]-e/2]),{points:n,fig:"poly"}}function make_curved_arrow_head(e,t,r){var n="M "+(r[0]+t)+", "+(r[1]-e/2)
return n+=" C "+(r[0]-.33*t)+", "+(r[1]+e/2),n+=" "+(r[0]-.33*t)+", "+(r[1]-e/2),n+=" "+(r[0]+t)+", "+(r[1]+e/2),{d:n,fig:"path"}}function change_arrow_size(e){function t(e){if("path_group"==e.iama||"path_basic"==e.iama||"drawing"==e.iama){var t=Object.keys(e.add_ons)
return e.add_ons[t[0]]}return e}var r=e.name,n=parseInt(e.value),o=t(currentElement)
if(!o.parent_id){var a=shapes_storage.find_parent_of_drawing_add_on(o),i="width"==r?n:o.width,s="height"==r?n:o.height
return add_arrow_test(a,o.side,o.figure,i,s),set_current_element(1==o.end?a.add_ons.head:a.add_ons.tail),!1}manage_groups.get_group(currentElement,!0).forEach(function(e){(e=t(e))&&(path.clear_path_attrs(),path.set_path_attrs(find_path_by_id(e.parent_id)),cpa["arrow_"+r]=n,path.remake_path(!0))}),render()}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function _iterableToArray(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e)){for(var t=0,r=new Array(e.length);t<e.length;t++)r[t]=e[t]
return r}}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(e,t){var r=[],n=!0,o=!1,a=void 0
try{for(var i,s=e[Symbol.iterator]();!(n=(i=s.next()).done)&&(r.push(i.value),!t||r.length!==t);n=!0);}catch(e){o=!0,a=e}finally{try{n||null==s.return||s.return()}finally{if(o)throw a}}return r}function _arrayWithHoles(e){if(Array.isArray(e))return e}function _defineProperty(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function close_other_fieldsets(){var e=document.querySelectorAll("#edit_mode_menu fieldset:not(.collapsed):not(#fs_help):not(#fs_study_mode)")
_.forEach(e,function(e){return toggle_field_set(e)})
var t=document.querySelectorAll("#slides_menu fieldset:not(.collapsed):not(#fs_help_slides)")
_.forEach(t,function(e){return toggle_field_set(e)})}function toggle_field_set(e){var t=e.querySelector(".fs_toggle")
if(!t)return!1
t.style.display=""==t.style.display?"none":null,e.querySelector("legend").classList.toggle("collapsed"),e.classList.toggle("collapsed")}function close_fieldset(e){e.querySelector(".fs_toggle").style.display="none",e.querySelector("legend").classList.add("collapsed"),e.classList.add("collapsed")}function change_submenu(e){for(var t,r=e.target.parentElement.querySelectorAll("h4"),n=0;n<r.length;n++)r[n].classList.remove("active"),r[n]==e.target&&(t=n)
e.target.classList.add("active")
for(var o=direct_child_only_selector(e.target.parentElement.parentElement,".sub"),a=0;a<o.length;a++)o[a].style.display="none"
o[t].style.display="block"}function direct_child_only_selector(e,t){return Array.from(e.querySelectorAll(t)).filter(function(t){return t.parentElement==e})}function change_text_color_of_chunks(e,t){get_text_with_border_id(e).forEach(function(e){e.has_own_style||(e.color=t)}),position_texts(e)}function fill_example_figs(){var e=d3.select("body").select("#shapes_svg").append("g").attr("id","example_fig").attr("transform","scale(0.275)")
!function(t,r,n){for(var o=_.keys(t),a=0;a<o.length;a++)!function(){var r=o[a],i=poly_config[r].points,s=poly_config[r].dims.width,_=poly_config[r].dims.height
i=i.map(function(e){var t=_slicedToArray(e,2),r=t[0],n=t[1]
return[s*r,_*n]})
var l=e.append("g")
l.append("polygon").attr("points",i),l.attr("width",s),l.attr("height",_),l.style("stroke-width","4px"),l.style("stroke","#CF5544"),l.classed("example_fig",!0),l.attr("transform","translate("+fig_to_pos[r][0]+") scale("+t[o[a]][1]+")"),l.on("click",function(e,t){return function(){n(e,t,0,0)}}(o[a],l.node()))}()}(fig_to_pos,0,select_shape),t=e.append("g").attr("transform","translate(".concat(c5+10,",").concat(r6-10,") scale(2)")).attr("i_am_a","icon_basic").attr("width",50).attr("height",50),t.append("rect").attr("x",-5).attr("width",50).attr("height",65).attr("class","example_fig").on("click",function(){select_shape("icon_basic",this)}).on("dblclick",function(){open_modal("icon_modal")}),t.append("text").text("").attr("transform","translate(0,50)").style("font-size","48px").style("font-family",'"Font Awesome 5 Free"').style("font-weight",900).style("fill","#CF5544").style("pointer-events","none"),e.append("g").attr("transform","translate(".concat(c5+45,",").concat(r1+45,") scale(1)")).attr("i_am_a","ellipse").attr("class","example_fig").attr("width",90).attr("height",60).on("click",function(){select_shape("ellipse",this,-45,-30)}).style("stroke-width","4px").style("stroke","#CF5544").append("ellipse").attr("rx",45).attr("ry",30)
var t=e.append("g").attr("transform","translate(".concat(c5,",").concat(r4,") scale(1)")).attr("width",30).attr("height",100)
t.append("rect").attr("x",0).attr("y",0).attr("width",100).attr("height",100).attr("class","example_fig").style("stroke","rgba(0,0,0,0").style("pointer-events","visible").on("click",function(){select_shape("line_hor",this)}),t.append("line").attr("x1",0).attr("y1",50).attr("x2",100).attr("y2",50).style("stroke-width","10px").style("stroke","#CF5544").style("pointer-events","none")
var t=e.append("g").attr("transform","translate(".concat(c5,",").concat(r5,") scale(1)")).attr("width",30).attr("height",100)
t.append("rect").attr("x",0).attr("y",0).attr("width",100).attr("height",100).attr("class","example_fig").style("stroke","rgba(0,0,0,0").style("pointer-events","visible").on("click",function(){select_shape("line_vert",this)}),t.append("line").attr("x1",50).attr("y1",0).attr("x2",50).attr("y2",100).style("stroke-width","10px").style("stroke","#CF5544").style("pointer-events","none")
var r=[[{x:"0",y:"0"},"M52,289q7,42,54,97t116,56q35,0,64,-18t43,-45q42,63,101,63q37,0,64,-22t28,-59q0,-29,-14,-47t-27,-22t-23,-4q-19,0,-31,11t-12,29q0,46,50,63q-11,13,-40,13q-13,0,-19,-2q-38,-16,-56,-66q-60,-221,-60,-258q0,-28,16,-40t35,-12q37,0,73,33t49,81q3,10,6,11t16,2h4q15,0,15,-8q0,-1,-2,-11q-16,-57,-62,-101t-107,-44q-70,0,-106,63q-41,-62,-94,-62h-6q-49,0,-70,26t-22,55q0,32,19,52t45,20q43,0,43,-42q0,-20,-12,-35t-23,-20t-13,-5l-3,-1q0,-1,6,-4t16,-7t19,-3q36,0,62,45q9,16,23,68t28,108t16,66q5,27,5,39q0,28,-15,40t-34,12q-40,0,-75,-32t-49,-82q-2,-9,-5,-10t-16,-2h-14q-6,6,-6,11z"],[{x:"794",y:"0"},"M56,237t0,13t14,20h299v150l1,150q10,13,19,13q13,0,20,-15v-298h298q15,-8,15,-20t-15,-20h-298v-298q-8,-14,-18,-14h-2h-2q-12,0,-18,14v298h-299q-14,7,-14,20z"],[{x:"1795",y:"0"},"M21,287q0,14,15,48t48,71t74,36q41,0,66,-23t26,-64q-2,-19,-3,-21q0,-3,-16,-46t-33,-97t-16,-86q0,-43,14,-60t42,-18q23,0,43,11t31,23t27,33q0,1,5,20t14,59t19,74q38,150,42,157q13,27,43,27q13,0,21,-7t11,-12t2,-9q0,-13,-49,-210t-56,-216q-28,-83,-97,-132t-138,-50q-45,0,-79,22t-34,66q0,22,7,37t19,22t20,10t17,3q44,0,44,-42q0,-20,-12,-35t-23,-20t-13,-5l-3,-1q2,-5,19,-12t34,-7h8q17,0,26,2q33,9,61,38t43,62t23,56t8,30l-6,-4q-6,-4,-19,-11t-26,-12q-20,-5,-39,-5q-46,0,-81,22t-46,71q-1,7,-1,31q0,57,35,149t35,117q0,1,0,2q0,9,0,12t-4,7t-11,4h-4q-23,0,-42,-19t-30,-41t-17,-42t-8,-22q-2,-2,-16,-2h-14q-6,6,-6,9z"]],t=e.append("g").attr("transform","translate(20,840)").attr("width",30).attr("height",100)
t.append("rect").attr("x",0).attr("y",-60).attr("width",200).attr("height",100).attr("class","example_fig").style("stroke","rgba(0,0,0,0").style("pointer-events","visible").on("click",function(){math_jax_specs.loaded||start_math(),select_shape("math_shape",this,0,-60)}),t=t.append("g").attr("transform","matrix(0.08,0,0,-0.08,0,0)"),r.forEach(function(e){t.append("path").attr("transform","translate(".concat(e[0].x,",").concat(e[0].y,")")).attr("d",e[1]).style("fill","#CF5544").style("pointer-events","none")})}function select_shape(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0
active_style.shape=e,pick_me_example(t,r,n),text_to_feedback_pane("selected: "+e+" Double click canvas to add"),prev_element=void 0}function pick_me_example(e){change_halo(e,arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,arguments.length>2&&void 0!==arguments[2]?arguments[2]:0),set_current_element(e),set_color_picker(e)}function change_halo(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0
d3.select("#shapes_svg").selectAll(".halo").remove(),append_halo(e,t,r)}function append_halo(e,t,r){var n=d3.select(e),o=parseFloat(n.attr("width"))+10,a=parseFloat(n.attr("height"))+10
"g"!==n.node().tagName&&(n=d3.select(n.node().parentElement)),n.append("rect").attr("height",a).attr("width",o).attr("transform","translate(".concat(t-5,",").concat(r-5,")")).classed("filter","true").classed("halo","true").style("fill","none").style("stroke","#A217BB").style("stroke-width",6)}function parse_htmlstyle_to_object(e){for(var t={},r=0;r<e.length;r++)t[e[r]]=e[e[r]]
return"text"in t||(t.text="black"),t}function fill_example_css_styles(e){function t(){var e=document.querySelector("#fs_styles").getBoundingClientRect()
return[e.left-240,e.top]}for(var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:7,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:27,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:18,i=e.append("g").attr("class","example_styles"),s=0;s<Object.keys(predef_styles.get_classes()).length;s++){var _="style_"+s
i.append("rect").attr("x",r+(o+5)*(s%6)).attr("y",n+(a+6)*parseInt(s/6)).attr("width",o).attr("height",a).attr("class",_).style("fill",predef_styles.get_classes()[_].fill).style("stroke",predef_styles.get_classes()[_].stroke).style("stroke-width",predef_styles.get_classes()[_].stroke_width).on("contextmenu",function(){var e
currentElement=parse_htmlstyle_to_object(this.style),set_color_picker(currentElement),(e=cmm).position_and_display.apply(e,_toConsumableArray(t()).concat(["#cm-predef-styles",!1,!1])),predef_styles.set_cm_for_predef_style(this.classList[0]),gui_buttons.add_marker_to_example_style(this.classList[0]),d3.event.preventDefault(),d3.event.stopPropagation()}).on("click",function(){var e=this
return"canvas"==currentElement.iama?(active_style.style_class=this.classList[0],gui_buttons.add_marker_to_example_style(active_style.style_class),text_to_feedback_pane("default style changed"),!1):canvas_status.draw_mode?(active_style.style_class=this.classList[0],start_new_draw_group(),render_current_draw_group(context_single),!1):"fa_icon"==currentElement.iama?(manage_groups.get_group(currentElement,!0).forEach(function(t){t.fill=predef_styles.get_classes()[e.classList[0]].fill}),render_all(),!1):(check_for_range_and_add_border(),manage_groups.get_group(currentElement,!0).forEach(function(t){"text"==t.iama&&(t=part_to_chunk(t),t.has_own_style=!0,position_texts(t.border_id)),predef_styles.set_styles_from_class(t,e.classList[0]),t.rough&&delete t.redraw_data}),gui_buttons.add_marker_to_example_style(currentElement.style_class),void set_current_element(currentElement,!0))}),i.append("text").attr("x",r+(o+5)*(s%6)+2).attr("y",n+(a+6)*parseInt(s/6)+a/2).attr("class",_).style("fill","black"==predef_styles.get_classes()[_].color||"rgba(0,0,0,1)"==predef_styles.get_classes()[_].color?"rgba(0,0,0,0)":predef_styles.get_classes()[_].color).style("stroke","rgba(0,0,0,0)").style("font-size","8px").style("pointer-events","none").text("text")}}function toggle_move_fine(e){return fine_move=!fine_move,toggle_button(document.querySelector("#form_move_delta")),fine_move}function toggle_size_fine(e){return fine_size=!fine_size,toggle_button(document.querySelector("#form_size_delta")),fine_size}function close_main_feedback_func(){document.querySelector("#fs_feedback").style.display="none"}function create_feedback_func(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0]
e||(e=document.querySelector("#fs_feedback"))
var t
return function(r){var n=arguments.length>1&&void 0!==arguments[1]&&arguments[1],o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:2500
e.style.display="inherit","string"==typeof r&&(r=[r])
var a=r.reduce(function(e,t){return e+"<p>"+t+"</p>"},"")
e.querySelector("div").innerHTML=a,e.classList.toggle("error",n),clearTimeout(t),t=setTimeout(function(){return e.style.display="none"},o)}}function make_feedback_func(e){return function(t,r,n){r&&e.classList.contains("collapsed")&&toggle_field_set(e),"string"==typeof t&&(t=[t])
var o=t.reduce(function(e,t){return e+"<p>"+t+"</p>"},"")
if(e.querySelector(".fs_toggle").innerHTML=o,n){var a=e.querySelector("legend")
a&&(a.classList.toggle("flash",!0),setTimeout(function(){return a.classList.toggle("flash",!1)},750))}}}function check_for_range_when_p_form_action(){if(gui_cursor.has_selection()){if(1==gui_cursor.get_range().in_selection.length){var e=gui_cursor.split_off_range()
return set_current_element(e.parts[0]),gui_cursor.clear_selection(),e}text_to_feedback_pane(["You cannot change the style of to chunks at the time. ","Select one part at a time","a chunk is a piece of text with a distinct style"])}}function check_for_range_and_add_border(){var e=check_for_range_when_p_form_action()
e&&set_current_element(add_own_style_to_text(e))}function add_own_style_to_text(e){return e.has_own_style=!0,predef_styles.get_classes()[active_style.style_class],e}function toggle_slide_edit_menu(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=document.querySelector("#slides_menu"),o=document.querySelector("#edit_mode_menu")
canvas_status.export_mode&&drag_export_off()
var a
a=t?r:!slides_mode,a?(n.classList.remove("menu_hidden"),o.classList.add("menu_hidden"),slides_mode=!0,slide_manager.setup_menu(),slide_manager.update_all_slides()):(view.clear_shapes_to_render(),drag_slides_off(),n.classList.add("menu_hidden"),o.classList.remove("menu_hidden"),slides_mode=!1,canvas_status.slide_exclusion_mode&&exit_slide_exclusion_mode(),slide_manager.slide_show_on()&&slide_manager.end_slide_show())}function create_nesw_button(e,t,r,n){function o(e,r,n,o,i,s,_,l){a.append("path").attr("d","M ".concat(t," ").concat(t,"  L ").concat(e," ").concat(r," A ").concat(t," ").concat(t," 0 0 1 ").concat(n," ").concat(o," L ").concat(t," ").concat(t)).attr("class",i).attr("dir",i.split(" ")[0]).on("click",function(){change_path_side(s,_,l)}).style("pointer-events","visible")}var a=d3.select(e).append("svg").attr("width",2*t).attr("height",2*t)
a.node().onclick=function(t){d3.selectAll("."+e.classList[0]).selectAll("path").classed("on",!1),update_path_direction_buttons()}
var i=180/Math.PI,s=t-Math.sin(45/i)*t,_=2*t-s
o(s,s,_,s,"north keep-open path_from_to "+r,0,"from"==r,n),o(_,s,_,_,"east keep-open path_from_to "+r,1,"from"==r,n),o(_,_,s,_,"south keep-open path_from_to "+r,2,"from"==r,n),o(s,_,s,s,"west keep-open path_from_to "+r,3,"from"==r,n),function(e){a.append("rect").attr("x",e).attr("y",e).attr("width",2*(t-e)).attr("height",2*(t-e)).style("stroke","black").style("stroke-width",2).style("fill","rgba(0,0,0,0.05").style("pointer-events","none"),[[t,e,t,e-9],[2*t-e,t,2*t-e+9,t],[t,2*t-e,t,2*t-e+9],[e,t,e-9,t]].forEach(function(e){var t=_slicedToArray(e,4),r=t[0],n=t[1],o=t[2],i=t[3]
a.append("line").attr("x1",r).attr("x2",o).attr("y1",n).attr("y2",i).style("stroke","black").style("stroke-width",3).style("pointer-events","none")})}(t*(1-Math.sin(45*Math.PI/180)))}function add_end_figs_for_path_to_buttons(){for(var e=document.querySelectorAll(".form_path_end_fig .svg_holder"),t=0;t<e.length;t++){var r=Object.keys(path_end_figs)[t%3],n=e[t]
!function(e){n.onclick=function(){currentElement.has_arrow&&set_current_element(currentElement.parentElement)
var t=""
this.hasAttribute("side")?t=this.getAttribute("side"):console.log("andere manier vinden hier"),path_end_fig=e
var r
if("path_group"==currentElement.iama)r=!cpa["arrow_"+t]||cpa["arrow_"+t]&&cpa["arrow_"+t]!=path_end_fig,change_path_end_fig(t,r)
else if("drawing"==currentElement.iama||"path_addon"==currentElement.iama){var n=currentElement
"path_addon"==currentElement.iama&&((n=find_path_by_id(currentElement.parent_id))||shape_storage.find_parent_of_drawing_add_on(currentElement)),r=!("add_ons"in n&&t in n.add_ons),r?add_arrow_test(n,t,path_end_fig):delete n.add_ons[t]}r?$(".if-arrow").css("display","block"):$(".if-arrow").css("display","none"),render()}}(r),n=d3.select(n.querySelector("svg"))
var o=path_end_figs[r].func(10,17,[2,12])
"poly"==o.fig?n.append("g").append("polyline").attr("points",o.points):n.append("g").append("path").attr("d",o.d)}}function set_color_picker(e){var t
return e=e||currentElement,t=get_selectors_for_color(e),color_t=tinycolor(t),colorpicker.spectrum("set",color_t),color_t}function get_selectors_for_color(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1]
return t=t||active_style.fill_what,"fill"==t?e.fill:"border"==t?e.stroke:"text"==t?e.color:"stroke"==t?e.stroke:void 0}function make_font_selector(e){e.classList.add("font_select_outer")
var t=document.createElement("div")
t.classList.add("font_select_inner"),e.appendChild(t),t.onclick=function(){this.classList.toggle("open"),this.parentElement.classList.toggle("open")},t.onwheel=function(e){e.stopPropagation()}
var r=document.createElement("i")
r.style="clear:both; float:right;",r.classList.add("fa","fa-caret-down","fa-2x","keep-open"),t.parentElement.parentElement.appendChild(r),r.onclick=function(){t.classList.toggle("open"),t.parentElement.classList.toggle("open")},fonts.forEach(function(e,r){var n=document.createElement("div")
n.style.fontFamily=e,n.innerText=e,n.classList.add("font_select_item"),t.appendChild(n),n.onclick=function(e){t.classList.remove("open"),t.parentElement.classList.remove("open"),t.scrollTop=26*r,change_font(e),e.stopPropagation()}})}function change_selected_in_font_list(e,t){e.querySelector(".font_select_inner").scrollTop=26*fonts.indexOf(t)}function dragElement(e){function t(e){e=e||window.event,e.preventDefault(),i=e.clientX,s=e.clientY,document.onmouseup=n,document.onmousemove=r}function r(t){t=t||window.event,t.preventDefault(),o=i-t.clientX,a=s-t.clientY,i=t.clientX,s=t.clientY,e.style.top=e.offsetTop-a+"px",e.style.left=e.offsetLeft-o+"px"}function n(){document.onmouseup=null,document.onmousemove=null}var o=0,a=0,i=0,s=0
e.onmousedown=t}function view_mode_on(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0]
canvas_status.view_mode=!0,toggle_side_bar(!1),document.querySelector("#keyboard_button").style.display="none",e||(document.querySelector("#view_mode_button").style.display="block",text_to_feedback_pane(["View mode (no changes possible)","Click eye button to exit"],!1,4e3)),to_canvas.set_canvas()}function view_mode_off(){canvas_status.view_mode=!1,document.querySelector("#view_mode_button").style.display="none",canvas_status.mobile_mode&&(document.querySelector("#keyboard_button").style.display="inline"),text_to_feedback_pane("View mode is now off")}function show_wait_spinner(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:""
document.querySelector("#be_patient").style.display="block",document.querySelector("#be_patient h2").innerText=e,document.querySelector("#be_patient p").innerText=t}function hide_wait_spinner(){document.querySelector("#be_patient").style.display="none"}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(e,t){var r=[],n=!0,o=!1,a=void 0
try{for(var i,s=e[Symbol.iterator]();!(n=(i=s.next()).done)&&(r.push(i.value),!t||r.length!==t);n=!0);}catch(e){o=!0,a=e}finally{try{n||null==s.return||s.return()}finally{if(o)throw a}}return r}function _arrayWithHoles(e){if(Array.isArray(e))return e}function get_x_pos_for_alignment(e,t,r,n){return"left"==e?n:"right"==e?n+t-r:n+(t-r)/2}function get_chunks_by_par(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=get_text_with_border_id(e,t)
return gs=_.groupBy(r,function(e){return e.par_num}),Object.keys(gs).forEach(function(e){gs[e].sort(function(e,t){return e.chunk_num-t.chunk_num})}),gs}function get_chunks_in_par(e,t){return get_text_with_border_id(e).filter(function(e){return e.par_num==t}).sort(function(e,t){return e.chunk_num-t.chunk_num})}function even_out_paragraphs(e){var t=get_bbox_of_figure(e),r=t.x1y1[1]-t.x0y0[1],n=e.padding
n&&(r-=2*parseInt(n))
var o=get_text_with_border_id(e.id),a=get_height_per_par(_.groupBy(o,function(e){return e.par_num})),i=Object.keys(a).length
if(0==i)return!1
var s=Object.values(a).reduce(function(e,t){return e+t},0)
margin_between_pars=parseInt((r-s)/(i+1))
for(var l=get_chunks_by_par(e.id),c=0;c<i;c++)!function(e){l[e].forEach(function(t){t.margin_top=margin_between_pars,t.y+=(e+1)*margin_between_pars,t.parts.forEach(function(t){return t.y+=(e+1)*margin_between_pars})})}(c)
render()}function position_texts(e){var t=find_border_by_id(e),r=get_text_with_border_id(e)
if(0==r.length)return!1
r.forEach(function(e){return delete e.parts})
var n=_.groupBy(r,function(e){return e.par_num}),o=get_poly_config(t),a=t.stroke_width/2||1,i=t.height,s=t.width,l={}
Object.keys(n).forEach(function(e){n[e]=n[e].sort(function(e,t){return e.chunk_num-t.chunk_num})
var r=n[e][0].margin_left||0
l[e]=find_breaks_for_par(n[e],s*o.fo_width-r-2*t.padding)})
for(var c=t.y+a+i*o.fo_top_left[1]+t.padding,u=0,d=0;d<t.num_pars;d++)l[d]&&l[d].forEach(function(e,r){var a,i=e.line_parts,l=e.chunks_on_line,f=e.text_width
a="margin_left"in l[0]?t.padding+l[0].margin_left+t.x+s*o.fo_top_left[0]:t.padding+get_x_pos_for_alignment(t.text_align,s*o.fo_width-2*t.padding,f,t.x+s*o.fo_top_left[0]),0==r&&(c+=n[d][0].margin_top||0)
var h=Math.max.apply(void 0,l.map(function(e){return e.height}))
_.zip(i,l).forEach(function(e,r){var n=_slicedToArray(e,2),i=n[0],s=n[1]
"parts"in s||(s.parts=[])
var _=Math.max(measure_text_width({font_style:s.font_style,text:i.text,font_family:s.font_family,font_size:s.font_size}),MIN_PAR_WIDTH),d={text:i.text,line_num:i.line_num,x:a,y:c,baseline_offset:7*h/9,width:_,height:h,border_id:s.border_id,iama:"text",num:u,par_num:s.par_num,parent:s}
l.length-1==r&&s.cover_whole_line&&(d.text_border={},d.text_border.width=o.fo_width*t.width-2*t.padding,d.text_border.x=t.padding+t.x+t.width*o.fo_top_left[0]),s.parts.push(d),a+=_,u+=1}),c+=h})
adjust_border_height(t,r,o,!0)}function find_breaks_for_par(e,t){var r=function(){return[{chunks_on_line:e,line_parts:e.map(function(e){return{text:e.text,line_num:0}}),text_width:o||MIN_PAR_WIDTH}]},n=e.map(function(e){return measure_par_width_at_each_letter(e).slice(1)}),o=n.reduce(function(e,t){return e+t.slice(-1)[0]},0)
if(o<=t)return r()
for(var a=[],i=0,s=0;s<e.length;s++)a.push(n[s].map(function(e){return e+i})),i+=n[s].slice(-1)[0]
var l=_.flatten(a),c=_.flatten(a.map(function(e,t){return new Array(e.length).fill(t)})),u=_.flatten(e.map(function(e){return e.text.split("")}))
if(l.length<2)return r()
for(var d=1;d<l.length;d++)if(l[d]-l[d-1]>t)return r()
for(var f=[0].concat(l),h=[],p=1,m=0;m<l.length;){var g=_.findIndex(l,function(e){return t<e-(g?l[g-1]:0)})
g=-1==g?l.length:function(e,t,r){for(var n=[" ","-",",",".",":","/"],o=e;o>t;o--)if(-1!=n.indexOf(r[o]))return o+1
return e}(g,m,u)
var y=Array.from(new Set(c.slice(m,g))).map(function(t){return e[t]})
if(h.push({chunks_on_line:y,line_parts:break_to_line_part(c,u,m,g,p-1),text_width:f[g]-f[m]||MIN_PAR_WIDTH}),m=g,(p+=1)>l.length+1)return!1}return h}function break_to_line_part(e,t,r,n,o){var a=Array.from(new Set(e.slice(r,n))),i=[]
return a.forEach(function(a){var s=e.map(function(e){return e==a})
text=_.zip(s.slice(r,n),t.slice(r,n)).reduce(function(e,t){return e+(t[0]?t[1]:"")},""),i.push({text:text,line_num:o})}),i}function compare_styles_of_shapes_for_render(e,t){return _.all(["fill","stroke","stroke_width","stroke_dasharray"].map(function(r){return e[r]==t[r]}))}function compare_styles_of_chunks_for_render(e,t){return _.all(["font_family","font_size","color","font_style"].map(function(r){return e[r]==t[r]}))}function compare_styles_of_chunks(e,t){return _.all(["font_family","font_size","color","fill","stroke","stroke_width","style_class"].map(function(r){return e[r]==t[r]}))}function merge_chunks(e,t){e.text+=t.text,shapes_storage.remove(t)}function check_par_for_chunk_style_equality(e,t){var r=get_chunks_in_par(e,t)
if(r.length<2)return!1
for(var n=!1,o=0;o<r.length-1;o++)compare_styles_of_chunks(r[o],r[o+1])&&(n=!0,merge_chunks(r[o],r[o+1]))
n&&(reset_chunk_numbering(e,t),position_texts(e))}function reset_par_and_chunk_numbering(e){var t={},r=get_chunks_by_par(e)
Object.keys(r).forEach(function(e){t[e]=r[e].length}),shapes_storage.texts[e]=shapes_storage.texts[e].filter(function(e){return!(0==e.text.length&&1!=t[e.par_num])})
var n=get_chunks_by_par(e,!0),o=Object.keys(n).sort(function(e,t){return e-t})
o.forEach(function(e,t){n[e].forEach(function(e,r){e.par_num=t,e.chunk_num=r})}),shapes_storage.borders[e].num_pars=o.length}function reset_chunk_numbering(e,t){get_chunks_in_par(e,t).forEach(function(e,t){return e.chunk_num=t})}function handle_par_drag(e,t,r){d3.event.sourceEvent.shiftKey&&(t=0),d3.event.sourceEvent.altKey&&(r=0),change_par_margin(e,t,r)}function move_dragged_par_to_final_pos(e,t,r,n,o){var a=e.parent.border_id,i=get_chunks_in_par(e.parent.border_id,e.parent.par_num)
!function(t,r){find_border_by_id(e.parent.border_id).num_pars-=1
for(var n=get_chunks_by_par(t),o=r+1;o<Object.keys(n).length;o++)n[o].forEach(function(e){return e.par_num-=1})}(a,e.parent.par_num)
var s=n+t,_=o+r,l=shapes_storage.find_text_droppable_shape(s,_),c=0
l?c=function(e,t){for(var r=get_chunks_by_par(e),n=0;n<Object.keys(r).length&&!(r[n][0].parts[0].y>t);n++);for(var o=n;o<Object.keys(r).length;o++)r[o].forEach(function(e){return e.par_num+=1})
return n}(l.id,_):(last_pos=[s,_],l=add_shape_to_canvas(!1),l.width=100),l.num_pars+=1,i.forEach(function(e){shapes_storage.remove_text(e),delete e.margin_top,delete e.margin_left,e.border_id=l.id,e.par_num=c,shapes_storage.add_text(e)}),position_texts(l.id),position_texts(a),set_current_element(l)}function swap_line(e,t,r){var n=get_chunks_by_par(e,!0),o=Object.keys(n).length-1
return!(t<0||t>o)&&!(r<0||r>o)&&(n[t].forEach(function(e){return e.par_num=r}),void n[r].forEach(function(e){return e.par_num=t}))}function select_line_up(e,t,r){var n=Object.keys(t).map(function(e){return parseInt(e)}),o=n.indexOf(e.par_num)
if(0==e.line_num){if(o>0){var a=_.groupBy(_.flatten(t[n[o-1]].map(function(e){return e.parts})),function(e){return e.line_num})
return a[Object.keys(a).length-1][0]}return!1}return r[e.line_num-1][0]}function select_line_down(e,t,r){var n=Object.keys(t).length,o=Object.keys(r).length,a=Object.keys(t).map(function(e){return parseInt(e)}),i=a.indexOf(e.par_num)
return e.line_num<o-1?r[e.line_num+1][0]:i+1<n&&t[a[i+1]][0].parts[0]}function select_line_with_arrow(e,t){var r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],n=get_chunks_by_par(e),o=_.groupBy(_.flatten(n[t.par_num].map(function(e){return e.parts})),function(e){return e.line_num}),a=!1;(a=r?select_line_down(t,n,o):select_line_up(t,n,o))&&(set_current_element(a),gui_buttons.frame_element(currentElement),gui_cursor.set_cursor_by_index(currentElement,0))}function make_shape_flippable(e){get_text_with_border_id(e.id).forEach(function(e){return e.flipped=!1}),e.flipped=!1}function flip_shape(e){var t=e.width,r=e.height
e.flipped=!e.flipped,!e.flipped&&e.flipsize?(e.width=e.flipsize[0],e.height=e.flipsize[1]):e.flipsize=[t,r],position_texts(e.id),gui_buttons.frame_element(e),canvas_status.view_mode?(text_for_render.invalidate_sorted(),render_all()):(text_for_render.invalidate_sorted(),set_current_element(e))}function reset_par_numbering_all_borders(){ids=Object.values(shapes_storage.borders).map(function(e){return[e.id,e.num_pars]}),ids.forEach(function(e){_.range(e[1]).forEach(function(t){return reset_chunk_numbering(e[0],t)})})}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(e,t){var r=[],n=!0,o=!1,a=void 0
try{for(var i,s=e[Symbol.iterator]();!(n=(i=s.next()).done)&&(r.push(i.value),!t||r.length!==t);n=!0);}catch(e){o=!0,a=e}finally{try{n||null==s.return||s.return()}finally{if(o)throw a}}return r}function _arrayWithHoles(e){if(Array.isArray(e))return e}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(e,t){var r=[],n=!0,o=!1,a=void 0
try{for(var i,s=e[Symbol.iterator]();!(n=(i=s.next()).done)&&(r.push(i.value),!t||r.length!==t);n=!0);}catch(e){o=!0,a=e}finally{try{n||null==s.return||s.return()}finally{if(o)throw a}}return r}function _arrayWithHoles(e){if(Array.isArray(e))return e}function find_parts_with_border_id(e){var t=get_text_with_border_id(e),r=[]
return t.forEach(function(e){"parts"in e?e.parts.forEach(function(e){return r.push(e)}):r.push(t[0])}),r}function set_shape_width_to_max_line_width(e){var t=find_border_by_id(e),r=get_text_with_border_id(e),n=_.flatten(r.map(function(e){return e.parts})),o=_.groupBy(n,function(e){return e.par_num+"_"+e.line_num}),a=Math.max.apply(null,Object.values(o).map(function(e){return e.reduce(function(e,t){return e+t.width},0)})),i=get_poly_config(t),s=a/i.fo_width+2*t.padding
t.width=s+2,t.fixed_size=!0,t.rough&&delete t.redraw_data,t.border_sides_arr&&calc_border_dasharray(t,t.border_sides_arr)}function recalc_border_width(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],n=arguments.length>3&&void 0!==arguments[3]&&arguments[3],o=find_border_by_id(e),a=o.width
if(!o.fixed_size||t){var i=get_chunks_by_par(e),s=get_width_per_par(i),_=measure_max_text_width(s),l=get_poly_config(o),c=_/l.fo_width+2*o.padding
if(n&&c<a)return!1
o.width=c+2,r&&(max_width=n&&a>max_border_width?a:max_border_width,o.width=Math.min(o.width,infinity.get_standard_scaling(max_width,o.level||"L1"))),o.width==max_border_width&&(o.fixed_size=!0),o.rough&&delete o.redraw_data,o.border_sides_arr&&calc_border_dasharray(o,o.border_sides_arr)}}function recalc_border_height(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=find_border_by_id(e),n=get_poly_config(r)
adjust_border_height(r,get_text_with_border_id(e),n,t),r.rough&&delete r.redraw_data,r.border_sides_arr&&calc_border_dasharray(r,r.border_sides_arr)}function adjust_border_height(e,t,r){var n=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],o=function(e,t){return round_to((measure_total_text_height(get_height_per_par(get_chunks_by_par(e.id)))+2*e.padding)/t-e.height,0)}(e,r.fo_height)
if(o<0&&n)return!1
if(0!=o){if(r.fo_height<1){var a=(e.height+o)*r.fo_height-e.height*r.fo_height
!function(e,t){e.forEach(function(e){return e.y+=t}),e.forEach(function(e){return e.parts.forEach(function(e){return e.y+=t})})}(t,a)}resize_protocol(e,0,o,!0)}}function add_par_and_position_cursor(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:-1;-1==t&&(t=e.num_pars)
var r=add_paragraph_to_shape(e,t).parent
recalc_border_height(e.id,!0),position_texts(e.id),render(),gui_cursor.set_cursor_by_xpos(r.parts[0],last_pos[0]+100),gui_cursor.start_cursor()}function add_icon_to_canvas(e,t){var r=get_default_icon(e,t)
shapes_storage.icons.push(r)}function add_shape_to_canvas(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=get_default_border()
return roughen_all&&(t.rough=!0),e?(t.font_size=infinity.get_font_size(infinity.get_level(),4),shapes_storage.borders_bound[t.id]=t):shapes_storage.borders[t.id]=t,t}function add_line_to_canvas(){var e=get_default_drawing(0,0,"line")
roughen_all&&(e.rough=!0)
var t=last_pos,r=_slicedToArray(t,2),n=r[0],o=r[1],a=[],i=infinity.get_standard_scaling(100,e.level)
"line_hor"==active_style.shape?a=[[[n,o],[n+i,o]]]:"line_vert"==active_style.shape&&(a=[[[n,o],[n,o+i]]]),set_drawing_pos(e,a),shapes_storage.drawings.push(e),set_current_element(e)}function get_new_shape_with_text(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=add_shape_to_canvas(t),n=add_paragraph_to_shape(r)
return e&&add_text_to_paragraph(n,e),[r,n]}function add_paragraph_to_shape(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:-1,r=arguments.length>2?arguments[2]:void 0,n=get_default_text(e,r)
n.par_num=e.num_pars,e.num_pars+=1,shapes_storage.add_text(n)
var o=get_default_textpart_for_par(n)
return n.parts.push(o),-1!=t&&swap_line(e.id,n.par_num,t),set_current_element(o),o}function add_text_to_paragraph(e,t){e.parent.text=t,e.text=t,measure_text(e.parent),recalc_border_width(e.parent.border_id),recalc_border_height(e.parent.border_id,!0),gui_cursor.set_cursor_by_xpos(e.parent.parts[0],last_pos[0]+100),gui_cursor.start_cursor()}function get_poly_config(e){if(e.shape in poly_config){if("points"in e){var t=poly_config[e.shape].fo_dims(e.points),r=_slicedToArray(t,3)
return{fo_top_left:r[0],fo_width:r[1],fo_height:r[2],points:e.points}}return poly_config[e.shape]}var n=get_pos_for_foreignObject(e)
return n.points=e.points,n}function el_under_dragged_shape(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0]
el_under=!1
var t=d3.event.sourceEvent||d3.event,r=get_xy_inverted_from_event(t),n=_slicedToArray(r,2),o=n[0],a=n[1]
e=shapes_storage.find_connectable_shape(o,a),cc.clear_canvas(hover_context),e&&(el_under=e,render_hover_highlight(e,"rgba(13, 177, 255, 0.75)",hover_context,get_scaled_margin()))}function get_scaled_margin(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:5
return 0==e?0:Math.max(1,parseInt(e/transform.k))}function repos_shape(e,t,r){var n=e.id||!1
if(e.x+=t,e.y+=r,"add_ons"in e&&Object.keys(e.add_ons).forEach(function(n){e.add_ons[n].x+=t,e.add_ons[n].y+=r,e.add_ons[n].bbox.x+=t,e.add_ons[n].bbox.y+=r,e.add_ons[n].rotation[1]=e.add_ons[n].rotation[1]+t,e.add_ons[n].rotation[2]=e.add_ons[n].rotation[2]+r}),!n)return!1
get_text_with_border_id(n).forEach(function(e){e.x+=t,e.y+=r,"parts"in e&&e.parts.forEach(function(e){e.x+=t,e.y+=r,"text_border"in e&&(e.text_border.x+=t)})}),n in shapes_storage.images&&(shapes_storage.images[n].border_data.x+=t,shapes_storage.images[n].border_data.y+=r)}function resize_protocol(e,t,r,n){var o=n?[e]:manage_groups.get_group(e,!0)
o=o.filter(function(e){return"path_group"!=e.iama&&"text"!=e.iama}),no_feedback=!0,no_table=!1,o.length>1&&path.change_collision_detection.turn_off_temporary(),o.forEach(function(e){if("drawing"==e.iama)resize_drawing(e,t,r)
else if(e.is_cell)resize_cell(e,t,r)
else if("path_addon"==e.iama){var n=conv_angle(conv_arrow_rotation_to_geo_rotation(e.rotation[0]),t,r),o=_slicedToArray(n,2),a=o[0],i=o[1]
if(e.width=Math.max(5,e.width-i),e.height=Math.max(5,e.height-a),e.parent_id)path.set_path_attrs(find_path_by_id(e.parent_id)),path.remake_path(!0),set_current_element(1==e.end?cpa.path_g.add_ons.head:cpa.path_g.add_ons.tail)
else{var s=shapes_storage.find_parent_of_drawing_add_on(e)
add_arrow_test(s,e.side,e.figure,e.width,e.height),set_current_element(1==e.end?s.add_ons.head:s.add_ons.tail)}}else resize_shape(e,t,r)}),o.length>1&&path.change_collision_detection.restore(),no_table=!0,no_feedback=!1}function resize_shape(e,t,r){e.width=round_to(t+e.width,0),e.height=round_to(r+e.height,0)
var n=!1,o=!1
return e.width<=5&&(n=!0,e.width=5,text_to_feedback_pane("min width must be 5")),e.height<=5&&(o=!0,e.height=5,text_to_feedback_pane("min height must be 5")),!(n&&o||n&&0==r||o&&0==t)&&(path.recalc_connections(e.id),position_texts(e.id),e.id in shapes_storage.images&&(shapes_storage.images[e.id].border_data.has_fixed_size||calc_image_size(e,shapes_storage.images[e.id])),"border_sides_arr"in e&&calc_border_dasharray(e,e.border_sides_arr),e.rough&&delete e.redraw_data,!0)}function find_sticky_and_reposition(e,t,r){reposition_protocol(e,t,r)}function reposition_protocol(e,t,r){function n(e,t,r){e.is_cell?repos_cell(e,t,r):repos_shape(e,t,r),path.recalc_connections(e.id,!1,!0)}no_feedback=!0
var o=manage_groups.get_group(e)
o.length>1&&(o=o.filter(function(e){return"path_group"!=e.iama&&"text"!=e.iama}),o=clear_children_from_group(o),path.change_collision_detection.turn_off_temporary()),no_table=!1,o.forEach(function(e,o){n(e,t,r)}),o.forEach(function(e){merged.is_parent(e)&&merged.get_children(e).forEach(function(e){return n(e,t,r)})}),no_table=!0,o.length>1&&path.change_collision_detection.restore()}function clear_children_from_group(e){var t=e.slice()
return e.forEach(function(r){merged.is_child(r)&&-1!=e.indexOf(merged.get_parent(r))&&(t=t.filter(function(e){return e!=r}))}),t}function arrow_position_element(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=get_deltaxy_from_key_press(e),o=fine_move||r?1:mdd
find_sticky_and_reposition(currentElement,n[0]*o,n[1]*o,t),gui_buttons.frame_element(currentElement),render()}function arrow_resize_element(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=get_deltaxy_from_key_press(e),o=fine_size||r?1:mdd
resize_protocol(currentElement,n[0]*o,n[1]*o,t),gui_buttons.frame_element(currentElement),render()}function repos_text_block(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=get_bbox_of_figure(t,!0),o=_slicedToArray(n,4),a=o[0],i=o[1],s=o[2],_=o[3],l={x:a,y:i,width:s,height:_},c=l.x+l.width*e.pos_perc+r
e.pos_perc=(c-l.x)/l.width,isNaN(d)&&(d=.5),isNaN(e.pos_perc)&&(e.pos_perc=.5)
var u=path.create_svg_path_for_measurement(t.d),d=u.getPointAtLength(u.getTotalLength()*e.pos_perc),f=d.x-e.width/2,h=d.y-e.height/2
r=f-e.x
var p=h-e.y
e.x=f,e.y=h,get_text_with_border_id(e.id).forEach(function(e){e.x+=r,e.y+=p}),position_texts(e.id)}function calc_polygon_points(e){var t=poly_config[e.shape].points,r=e.width,n=e.height
return t.map(function(e){var t=_slicedToArray(e,2),o=t[0],a=t[1]
return[r*o,n*a]})}function calc_border_dasharray(e){for(var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=calc_polygon_points(e),n=[],o=r.length,a=0;a<r.length;a++){var i=pyth_dist(r[a],r[(a+1)%o])
n.push(Math.sqrt(i))}var s=(n.reduce(function(e,t){return e+t}),e.shape),l=poly_config[s].borders,c=new Array(o).fill(!1)
sides_to_draw=[],t.forEach(function(e,t){e&&sides_to_draw.push(l[t])}),sides_to_draw=_.flatten(sides_to_draw),sides_to_draw.forEach(function(e){return c[e]=!0}),vals=[],c[0]||vals.push(0),vals.push(n[0])
for(var a=1;a<o;a++)c[a-1]==c[a]?vals[vals.length-1]+=n[a]:vals.push(n[a])
e.stroke_dasharray=vals}function calc_custom_poly_points(e){var t=function(e){for(var t=1/0,r=1/0,n=0,o=0,a=0;a<e.length;a++){var i=e[a]
t=Math.min(t,i[0]),n=Math.max(n,i[0]),r=Math.min(r,i[1]),o=Math.max(o,i[1])}return[t,n,r,o]}(e),r=_slicedToArray(t,4),n=r[0],o=r[1],a=r[2],i=r[3],s=Math.max(o-n,1),_=Math.max(i-a,1)
return{points:e.map(function(e){var t=_slicedToArray(e,2),r=t[0],o=t[1]
return[round_to((r-n)/s,4),round_to((o-a)/_,4)]}),dims:{width:s,height:_},mid:[n+(o-n)/2,a+(i-a)/2],topleft:[n,a]}}function delete_shape(e){cc.clear_canvas(gui_context)
var t=manage_groups.get_group(e,!0)
t.forEach(function(e){var t=!("hg"in e)&&"text"!=e.iama
merged.is_parent(e)&&merged.remove_group(e),merged.is_child(e)&&merged.remove_child(e),t&&undoer.start(),path.find_connections(e.id).forEach(function(e){manage_groups.remove_element_if_present(e),undoer.remove(e)}),undoer.remove(e),t?(undoer.stop(),text_to_feedback_pane("Deleted items: press control Q to undo")):text_to_feedback_pane("Element removed (not undoable)"),"text"==e.iama&&check_par_for_chunk_style_equality(e.border_id,e.par_num),manage_groups.remove_element_if_present(e)}),t.length>1&&manage_groups.reset(),render_all(),to_canvas.set_canvas()}function make_poly_points(e){var t=get_default_border()
return t.shape="custom",roughen_all&&(t.rough=!0),update_poly_points(t,e),shapes_storage.borders[t.id]=t,t}function update_poly_points(e,t){var r=calc_custom_poly_points(t),n=r.points,o=r.dims,a=(r.mid,r.topleft)
e.points=n,e.width=o.width,e.height=o.height,e.x=a[0],e.y=a[1]}function calc_dims_for_snapshot(e,t,r,n){var o=1
o=e/t>r/n?e/r:t/n
var a=parseInt(e/o),i=parseInt(t/o),s=0,_=0
return a<r&&(s=parseInt((r-a)/2)),i<n&&(_=parseInt((n-i)/2)),{x:s,y:_,w:a,h:i,scale:o}}function make_snapshot(e,t,r,n,o,a,i){var s=arguments.length>7&&void 0!==arguments[7]&&arguments[7]
s||(s=document.createElement("canvas"))
var _=calc_dims_for_snapshot(r,n,o,a),l=s.getContext("2d")
return scale_canvas(s,l,o,a),l.drawImage(i,parseInt(transform.applyX(e)*PIXEL_RATIO),parseInt(transform.applyY(t)*PIXEL_RATIO),parseInt(r*transform.k*PIXEL_RATIO),parseInt(n*transform.k*PIXEL_RATIO),_.x,_.y,_.w,_.h),s}function get_xy_inverted_from_event(e){var t=get_x_y_from_event(e),r=_slicedToArray(t,2),n=r[0],o=r[1],a=transform.invert([n-canvas_offset_x,o-canvas_offset_y]),i=_slicedToArray(a,2)
return n=i[0],o=i[1],[n,o]}function get_x_y_from_event(e){return"touch"==e.type.slice(0,5)?"touchend"==e.type?[e.changedTouches[0].clientX,e.changedTouches[0].clientY]:[e.touches[0].clientX,e.touches[0].clientY]:[e.clientX,e.clientY]}function insert_point_in_polygon(e,t){e=e.map(function(e){return Math.floor(e/mdd)*mdd})
var r=t.length,n=t.map(function(e,n){return[e,t[(n+1)%r]]}).map(function(t){return inbetween2(t[0],t[1],e,25)}).indexOf(!0)+1
if(!n)return text_to_feedback_pane(["cannot find position for new point","click in between to points, for both x and y"]),[!1,!1,!1]
var o=t.splice(n)
return t.push(e),t=t.concat(o)}function poly_points_to_absolute_points(e){return e.points.map(function(t){return[t[0]*e.width+e.x,t[1]*e.height+e.y]})}function add_point_to_polygon(e,t){var r=poly_points_to_absolute_points(e),n=insert_point_in_polygon(t,r)
update_poly_points(currentElement,n),gui_buttons.reset_path_control_points(),show_poly_points(e),render()}function reshape_polygon(e,t,r){var n=poly_config[e.shape].shape
if("points"in e)var o=e.points.slice()
else var a=get_poly_config(e),o=a.points.map(function(e){return e.slice()})
var i=o.map(function(t){return[t[0]*e.width,t[1]*e.height]}),s=n(i,t,r),_=get_minxy_maxxy_of_array(s),l=_slicedToArray(_,4),c=l[0],u=l[1],d=l[2],f=l[3]
e.x+=c,e.y+=u,e.width=d-c,e.height=f-u,e.points=s.map(function(t){return[round_to((t[0]-c)/e.width,4),round_to((t[1]-u)/e.height,4)]}),e.rough&&delete e.redraw_data,"border_sides_arr"in e&&calc_border_dasharray(e,e.border_sides_arr)}function handle_gui_resize_double_click(){manage_groups.get_group(currentElement,!0).forEach(function(e){d3.event.ctrlKey?set_shape_width_to_max_line_width(e.id):(d3.event.shiftKey||recalc_border_width(e.id,!0,!0),position_texts(e.id),recalc_border_height(e.id))}),gui_buttons.frame_element(currentElement),set_current_element(currentElement)}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(e,t){var r=[],n=!0,o=!1,a=void 0
try{for(var i,s=e[Symbol.iterator]();!(n=(i=s.next()).done)&&(r.push(i.value),!t||r.length!==t);n=!0);}catch(e){o=!0,a=e}finally{try{n||null==s.return||s.return()}finally{if(o)throw a}}return r}function _arrayWithHoles(e){if(Array.isArray(e))return e}function resize_drawing(e,t,r,n){var o,a,i=e.d.split("M").slice(1).map(function(e){return"M"+e}).map(path_to_array),s=get_path_points_min_max(_.flatten(i)),l=_slicedToArray(s,4),c=l[0],u=l[1],d=l[2],f=l[3],h=u-c,p=f-d
n?(o=t,a=r):(o=h+t,a=p+r)
var m=!1,g=i.map(function(e){if(0==o&&0==a)return text_to_feedback_pane("smaller not possible"),m=!0,!1
if(2!=e.length||0!=h&&0!=p){o<5|a<5&&(o=Math.max(5,o),a=Math.max(5,a),text_to_feedback_pane("no smaller possible"))
var t=e.map(function(e){return{x:e.x/h,y:e.y/p}}),r=t.map(function(e){return{x:e.x*o,y:e.y*a}})}else r=e,0==h&&(o=0),0==p&&(a=0),r[e.length-1].x=o,r[e.length-1].y=a
return r})
if(m)return!1
var y=""
y="lineto"==e.flow?g.map(array_to_line).join(" "):g.map(array_to_path).join(" "),e.d=y,e.width=o,e.height=a,"drawing"==e.iama&&"add_ons"in e&&Object.keys(e.add_ons).forEach(function(t){return add_arrow_test(e,t,e.add_ons[t].figure,e.add_ons[t].width,e.add_ons[t].height)}),e.rough&&delete e.redraw_data}function start_new_draw_group(e,t){current_draw_group=current_draw_group.filter(function(e){return""!=e.d}),set_current_element(get_default_drawing(e,t)),current_draw_group.push(currentElement)}function make_line_drawing(e){var t=Math.min.apply(null,e.map(function(e){return e[0]})),r=Math.min.apply(null,e.map(function(e){return e[1]})),n=get_default_drawing(t,r,"line")
n.d=array_to_line(e.map(function(e){var t=_slicedToArray(e,2)
return{x:t[0],y:t[1]}})),n.flow="lineto",cc.clear_canvas(gui_context),roughen_all&&(n.rough=!0),set_drawing_pos(n,[e]),shapes_storage.drawings.push(n)}function set_drawing_pos(e,t){var r=1/0,n=1/0,o=-1/0,a=-1/0,i=_.flatten(t,!0),s=i.map(function(e){return e[0]}),l=i.map(function(e){return e[1]})
r=Math.min(r,Math.min.apply(void 0,s)),o=Math.max(o,Math.max.apply(void 0,s)),n=Math.min(n,Math.min.apply(void 0,l)),a=Math.max(a,Math.max.apply(void 0,l)),e.x=r,e.y=n,e.width=Math.max(4,o-r),e.height=Math.max(4,a-n)
var c=t.map(function(e){return e.map(function(e){var t=_slicedToArray(e,2),o=t[0],a=t[1]
return{x:o-r,y:a-n}})})
e.d=c.map(array_to_line).join(" "),"lineto"!=e.flow&&(e.d=drawn_line_to_bezier(e.d))}function handle_line_drag(e,t,r,n){var o=path_to_array(e.d),a={x:0,y:0}
if(0==t){var i=o.slice(0,1)[0]
a.x=i.x+r,a.y=i.y+n}else{var i=o.slice(-1)[0]
a.x=i.x+r,a.y=i.y+n}cc.clear_canvas(gui_context),render_poly_line([[i.x+e.x,i.y+e.y],[a.x+e.x,a.y+e.y]],gui_context,!1)}function handle_line_end_drag(e,t,r,n){var o=path_to_array(e.d),a={x:0,y:0}
if(0==t){var i=o.slice(0,1)[0]
a.x=i.x+r,a.y=i.y+n,o=[a].concat(o)}else{var s=o.slice(-1)[0]
a.x=s.x+r,a.y=s.y+n,o.push(a)}var _=[o.map(function(t){var r=t.x,n=t.y
return[r+e.x,n+e.y]})]
set_drawing_pos(e,_),e.rough&&delete e.redraw_data,gui_buttons.frame_element(e),set_current_element(e),"drawing"==e.iama&&"add_ons"in e&&Object.keys(e.add_ons).forEach(function(t){return add_arrow_test(e,t,e.add_ons[t].figure,e.add_ons[t].width,e.add_ons[t].height)})}function handle_poly_point_add_button_end_drag(e,t){var r=d3.event.subject
r.x+=e,r.y+=t,get_
var n=gui_buttons.get_path_control_points_as_ref().map(function(e){return[e.x,e.y]})
update_poly_points(currentElement,n)}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(e,t){var r=[],n=!0,o=!1,a=void 0
try{for(var i,s=e[Symbol.iterator]();!(n=(i=s.next()).done)&&(r.push(i.value),!t||r.length!==t);n=!0);}catch(e){o=!0,a=e}finally{try{n||null==s.return||s.return()}finally{if(o)throw a}}return r}function _arrayWithHoles(e){if(Array.isArray(e))return e}function table_to_cols(e){var t=tables[e],r=_.range(t[0].length).map(function(e){return[]})
return t.forEach(function(e){e.forEach(function(e,t){return r[t].push(e)})}),r}function equal_height_current_row(){var e=parseInt(currentElement.vt.split("_")[0])
resize_heights(tables.temp01[e])}function equal_width_current_col(){var e=parseInt(currentElement.vt.split("_")[1])
resize_widths(table_to_cols("temp01")[e])}function resize_widths(e){if(e=e.filter(function(e){return"dummy_cell"!=e.me}),e.length<2)return!1
var t=e.map(function(e){return e.width}),r=Math.max.apply(null,t)
resize_elements(e[t.indexOf(r)],e,"width")}function resize_heights(e){if(e=e.filter(function(e){return"dummy_cell"!=e.me}),e.length<2)return!1
var t=e.map(function(e){return e.height}),r=Math.max.apply(null,t)
resize_elements(e[t.indexOf(r)],e,"height")}function equal_width_per_col(e){table_to_cols("temp01").forEach(resize_widths),set_current_element(tables.temp01[0][0],!0)}function equal_height_per_row(e){tables.temp01.forEach(resize_heights),set_current_element(tables.temp01[0][0],!0)}function alter_min_x_margin_for_table(e){for(var t=table_to_cols("temp01"),r=0;r<t.length-1;r++)!function(r){var n=t[r].filter(function(e){return"dummy_cell"!=e.me})
if(0==n.length)return"continue"
var o=Math.max.apply(null,n.map(function(e){return e.x+e.width}))
t[r+1].forEach(function(t){"dummy_cell"!=t.me&&repos_shape(t,o-t.x+e,0)})}(r)
set_current_element(tables.temp01[0][0],!0)}function alter_min_y_margin_for_table(e){for(var t=tables.temp01,r=0;r<t.length-1;r++)!function(r){var n=t[r].filter(function(e){return"dummy_cell"!=e.me})
if(0==n.length)return"continue"
var o=Math.max.apply(null,n.map(function(e){return e.y+e.height}))
t[r+1].forEach(function(t){"dummy_cell"!=t.me&&repos_shape(t,0,o-t.y+e)})}(r)
set_current_element(tables.temp01[0][0],!0)}function resize_elements(e,t,r){var n=parseFloat(e.width),o=parseFloat(e.height)
t.forEach(function(e,t){var a="height"==r?e.width:n,i="width"==r?e.height:o
"fa_icon"!=e.iama&&(e.width=a,e.height=i,position_texts(e.id),path.recalc_connections(e.id))})}function find_boundaries(e){for(var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],n=1/0,o=0,a=1/0,i=0,s=0;s<e.length;s++){var _=(e[s],[posit2.get_top_left(e[s]),posit2.get_bottom_right(e[s])]),l=t?0:1,c=r?1:0
n=Math.min(n,_[l][0]),a=Math.min(a,_[l][1]),o=Math.max(o,_[c][0]),i=Math.max(i,_[c][1])}return[n,a,o,i]}function find_dim_for_alignment(e){var t=find_boundaries(e,!0,!1),r=_slicedToArray(t,4)
return minX=r[0],minY=r[1],maxX=r[2],maxY=r[3],maxY-minY>maxX-minX?"vert":"hor"}function find_start_end_position(e,t){var r=find_boundaries(e,!0,!0),n=_slicedToArray(r,4)
minX=n[0],minY=n[1],maxX=n[2],maxY=n[3]
var o=posit2.get_top_left(e[0]),a=posit2.get_bottom_right(e[0])
return"hor"==t?(minY=o[1],maxY=a[1]):"vert"==t&&(minX=o[0],maxX=a[0]),[minX,maxX,minY,maxY]}function sort_els(e,t){var r=e.filter(function(e){return"path_group"!=e.iama})
return r=r.sort(function(e,r){return posit2.get_top_left(e)[t]-posit2.get_top_left(r)[t]})}function align_figs(e,t,r,n){function o(e,t,r){var n=get_custom_bbox(e),o=get_custom_bbox(t)
return 0==r?n.top-n.bottom:1==r?o.left-n.right:2==r?o.top-n.bottom:3==r?n.left-o.right:void 0}function a(){var e=get_custom_bbox(i),t=get_custom_bbox(l)
return"hor"==u?t.right+v-e.left:t.bottom+v-e.top}var i,s,_,l
t=t.filter(function(t){return t!=e})
var c=[e].concat(t)
if(c.length<2)return!1
var u=find_dim_for_alignment(c),d=find_start_end_position([e]),f=_slicedToArray(d,4),h=f[0],p=(f[1],f[2]),m=(f[3],"hor"==u?0:1),g=0==m?1:2
c=sort_els(c,m)
var y=c.indexOf(e)
if(y==c.length-1)var v=o(c[0],c[1],g)
else var v=o(c[y],c[y+1],g)
for(var y=0;y<c.length;y++)i=c[y],me=i.iama,me&&(y>0&&(l=c[y-1]),"hor"==u?(s=y>0?a():0,_=p-posit2.get_top_left(i)[1]):(_=y>0?a():0,s=h-posit2.get_top_left(i)[0]),"hor"==r&&(s=0),"vert"==r&&(_=0),i.x+=s,i.y+=_)
n||resize_protocol(parent,0,0)}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function _iterableToArray(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e)){for(var t=0,r=new Array(e.length);t<e.length;t++)r[t]=e[t]
return r}}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(e,t){var r=[],n=!0,o=!1,a=void 0
try{for(var i,s=e[Symbol.iterator]();!(n=(i=s.next()).done)&&(r.push(i.value),!t||r.length!==t);n=!0);}catch(e){o=!0,a=e}finally{try{n||null==s.return||s.return()}finally{if(o)throw a}}return r}function _arrayWithHoles(e){if(Array.isArray(e))return e}function show_typed(e){var t=""
if(e.ctrlKey&&(t+="control "),e.shiftKey&&(t+="shift "),e.altKey&&(t+="alt "),e.shiftKey&&e.ctrlKey&&"Shift"==e.key&&text_to_demo_pane("control + shift",!1,1400),e.shiftKey&&e.ctrlKey&&"Control"==e.key&&text_to_demo_pane("shift + control",!1,1400),"Shift"==e.key||"Control"==e.key)return!1
t+=e.key,text_to_demo_pane(t,!1,1400)}function handle_keyboard(e){function t(){return key_pressed[38]?0:key_pressed[40]?2:key_pressed[37]?3:key_pressed[39]?1:void 0}function r(){var r=find_border_by_id("text"==currentElement.iama?currentElement.border_id:currentElement.id),n=posit2.get_top_left(r,!0),o=posit2.get_w_h(r),a=_slicedToArray(o,2),i=a[0],s=a[1],l=_slicedToArray(n,2),c=l[0],u=l[1],d=_.any(key_pressed.slice(37,41))?t():2,f=infinity.get_standard_scaling(6)
0==d&&(last_pos=[c,u-4*f]),1==d&&(last_pos=[c+i+f,u]),2==d&&(last_pos=[c,u+s+f]),3==d&&(last_pos=[c-4*f,u]),last_pos=to_discrete_position(last_pos),to_canvas.set_canvas(),gui_cursor.stop_cursor(),gui_buttons.add_location_circle(),e.preventDefault()}if("INPUT"==document.activeElement.tagName||"SELECT"==document.activeElement.tagName||"TEXTAREA"==document.activeElement.tagName)return!0
if(canvas_status.draw_mode)return handle_key_down_for_draw_mode(e),!1
var n="keydown"==e.type
if(key_pressed[e.keyCode]=n,"Dead"==e.key)return!1
if(27==e.keyCode&&n)return keyboard_cancel()
if(slide_manager.slide_show_on())return handle_slide_show_key_events(e),!1
if("canvas"==currentElement.iama&&arrow_key_pressed())return handle_key_down_canvas_transform(e),!1
if(canvas_status.view_mode)return handle_view_mode_key_events(e),!1
if(key_pressed[18]){var o=-1
if(key_pressed[49]?o=0:key_pressed[50]?o=1:key_pressed[51]?o=2:key_pressed[52]?o=3:key_pressed[53]&&(o=4),-1!=o&&(gui_cursor.clear_cursor(),e.shiftKey?4!=o&&(infinity.change_shape_level(currentElement,"L"+o),set_current_element(currentElement,!0),text_to_feedback_pane("changed to L"+o)):"border"==currentElement.iama||"text"==currentElement.iama?(change_font_class(o),text_to_feedback_pane("changed to font "+["XL","L","R","S","XS"][o]),set_current_element(currentElement,!0)):text_to_feedback_pane("select shape with text first")),!arrow_key_pressed())return!1}if(n&&(gui_cursor.cursor_on()||gui_cursor.has_selection())){var a=handle_key_down_for_cursor(e)
if(demo_mode&&a&&("Enter"==e.key?text_to_demo_pane("Enter",!1,1300):"Backspace"==e.key||"Delete"==e.key||arrow_key_pressed()?show_typed(e):"x"==e.key&&e.ctrlKey?text_to_demo_pane("control x",!1,1500):text_to_demo_pane("typing....",!1,400)),a)return!1}if(demo_mode&&n&&show_typed(e),n&&key_pressed[16]&&17==e.keyCode)return drag_draw_on(),!1
if(!n&&poly_draw&&(17==e.keyCode||16==e.keyCode)){if(17==e.keyCode){if(points_for_poly.length>2){var i=make_poly_points(points_for_poly)
gui_buttons.clear(),set_current_element(i)}}else 16==e.keyCode&&points_for_poly.length>1&&(make_line_drawing(points_for_poly),set_current_element(b))
points_for_poly=[],poly_draw=!1}if("Enter"==e.key&&"keydown"==e.type)return add_par_and_position_cursor(currentElement),!1
if(key_pressed[17]&&key_pressed[220]&&(currentElement||"mainsvg"!=currentElement.id)&&manage_groups.toggle_element(currentElement),key_pressed[17]&&key_pressed[190]&&"text"==currentElement.iama)return currentElement.text="&nbsp;&nbsp;&nbsp;&nbsp"+currentElement.text,!1
if("keydown"==e.type){if(key_pressed[17]&&key_pressed[70]||key_pressed[114])return show_search_form(),e.preventDefault(),!1
if(113==e.keyCode&&!more_than_n_key_pressed(1))return setTimeout(function(){local_store.quick_save(),key_pressed=[]}.bind(this),50),!1
if(117==e.keyCode&&!more_than_n_key_pressed(1))return toggle_advanced_options(),key_pressed=[],e.preventDefault(),!1
if(118==e.keyCode&&!more_than_n_key_pressed(1)){var s=toggle_size_fine()
return text_to_feedback_pane("fine resize is "+(s?"on":"off")),key_pressed=[],!1}if(119==e.keyCode&&!more_than_n_key_pressed(1)){var l=toggle_move_fine()
return text_to_feedback_pane("fine position is "+(l?"on":"off")),key_pressed=[],!1}if(120==e.keyCode&&!more_than_n_key_pressed(1))return toggle_slide_edit_menu(),key_pressed=[],!1
if(121==e.keyCode&&!more_than_n_key_pressed(1))return toggle_side_bar(),e.preventDefault(),key_pressed=[],!1
if(123==e.keyCode&&!more_than_n_key_pressed(1))return canvas_status.view_mode?view_mode_off():view_mode_on(),e.preventDefault(),key_pressed=[],!1
if(key_pressed[17]&&key_pressed[81])return undoer.undo(),!1
if(key_pressed[17]&&key_pressed[70])return key_pressed=[],!1
if(key_pressed[16]&&key_pressed[17]&&!more_than_n_key_pressed(2)){if(16==e.keyCode)if(slides_mode)drag_slides_on()
else{if(canvas_status.align_on)return text_to_feedback_pane("Cannot group now: reset or keep current group alignment first"),!1
drag_select_on()}else drag_draw_on()
return!1}if(key_pressed[9]&&!more_than_n_key_pressed(1)){if("canvas"==currentElement.iama){var c=find_closest_neighbour({x:last_pos[0],y:last_pos[1],width:25,height:25},2)
c?(set_current_element(find_border_by_id(c)),gui_buttons.frame_element(currentElement)):(to_canvas.set_reverse(),gui_buttons.frame_element(currentElement))}else r()
return!1}if(key_pressed[9]&&_.any(key_pressed.slice(37,41)))return r(),!1
if(9==e.keyCode&&key_pressed[16]){if("text"==currentElement.iama)set_current_element(find_border_by_id(currentElement.border_id)),gui_cursor.clear(),gui_buttons.frame_element(currentElement)
else{if("border"!=currentElement.iama)return!1
set_current_element(get_chunks_by_par(currentElement.id)[0][0].parts[0]),gui_buttons.frame_element(currentElement)}return e.preventDefault(),!1}if(key_pressed[17]&&key_pressed[67]&&_.any(key_pressed.slice(37,41))){if("border"!=currentElement.iama)return text_to_feedback_pane("cannot copy this shape with connection. Use control x + arrowkey instead",!0),!1
var u=get_pos_from_direction(currentElement,e.keyCode),f=currentElement,h=copy_prepped_shape_to_canvas(currentElement,u)
return h&&path.make_new_connection(f,h,document.querySelector("#form_always_add_arrow").checked),set_current_element(h),gui_buttons.frame_element(currentElement),render(),canvas_status.copy_on=!1,el_to_copy=!1,!1}if(key_pressed[17]&&key_pressed[88]&&_.any(key_pressed.slice(37,41))){var u=get_pos_from_direction(currentElement,e.keyCode),h=copy_prepped_shape_to_canvas(currentElement,u)
return set_current_element(h),gui_buttons.frame_element(currentElement),render(),!1}if(key_pressed[17]&&key_pressed[66])return make_ready_for_cross_window_copy(),!1
if(key_pressed[17]&&key_pressed[67])return make_ready_for_copy(!1),e.preventDefault(),!1
if(key_pressed[17]&&key_pressed[83])return e.preventDefault(),style_copier.setup_style_copy(),text_to_feedback_pane("click another ".concat(k," to copy style to it")),key_pressed=[],!1
if(key_pressed[17]&&key_pressed[86])return!0
if(!key_pressed[17]&&(e.keyCode>47&&e.keyCode<91||e.keyCode>=96&&e.keyCode<=111||e.keyCode>=186&&e.keyCode<=192||e.keyCode>=219&&e.keyCode<=222||220==e.keyCode)&&last_pos){if("border"==currentElement.iama)add_text_to_shape(currentElement,e.key)
else if("path_group"==currentElement.iama){var p=currentElement.id,m=get_new_shape_with_text(e.key,!0),g=_slicedToArray(m,2),y=g[0]
g[1],y.path_id=p,y.pos_perc=.5,y.bound=!0,set_current_element(y)}else{var v=get_new_shape_with_text(e.key),w=_slicedToArray(v,2),x=(w[0],w[1])
set_current_element(x)}return!1}var k=currentElement.iama
if(key_pressed[46]||key_pressed[8])return key_pressed[16]||"text"!=k?(delete_shape(currentElement),e.stopPropagation(),e.preventDefault(),to_canvas.set_canvas(),!1):(text_to_feedback_pane(["press shift delete or shift backspace to remove this item","(to avoid accidental deletes when typing)"],!1,!0),!1)
if(key_pressed[17]&&!key_pressed[16]&&_.any(key_pressed.slice(37,41)))return path.change_collision_detection.turn_off_temporary(),arrow_resize_element(e.keyCode,e.getModifierState("CapsLock"),e.altKey),path.change_collision_detection.restore(),!1
if(key_pressed[16]&&!key_pressed[17]&&_.any(key_pressed.slice(37,41))&&"P"!=currentElement.tagName){d=t()
var E=find_closest_neighbour(currentElement,d)
return E&&(set_current_element(shapes_storage.search_shapes_with_id(E)),display_fs_for_shape(currentElement),update_open_fs(currentElement),cc.clear_canvas(gui_context),gui_buttons.frame_element(currentElement)),!1}if(k&&"path_group"!=k&&_.any(key_pressed.slice(37,41)))return path.change_collision_detection.turn_off_temporary(),arrow_position_element(e.keyCode,e.getModifierState("CapsLock"),e.altKey),path.change_collision_detection.restore(),!1}}function add_text_to_shape(e,t,r){var n=add_paragraph_to_shape(e,void 0,r)
return add_text_to_paragraph(n,t),position_texts(n.parent.border_id),gui_buttons.clear(),set_current_element(n),n}function keyboard_cancel(){return cmm.status()?(cmm.off(),!1):(canvas_status.slide_exclusion_mode?exit_slide_exclusion_mode():slide_manager.slide_show_on()?slide_manager.end_slide_show():canvas_status.draw_mode?drag_draw_off():canvas_status.copy_on?(canvas_status.copy_on=!1,text_to_feedback_pane("aborting copy")):canvas_status.drag_select?drag_select_off():style_copier.is_on()?text_to_feedback_pane("aborting style copy"):canvas_status.search_form?hide_search_form():canvas_status.slide_mode?drag_slides_off():canvas_status.export_mode?drag_export_off():manage_groups.get_current_group().length>0&&manage_groups.reset(),style_copier.cancel(),key_pressed=[],!1)}function more_than_n_key_pressed(e){for(var t=0,r=0;r<key_pressed.length;r++)if(key_pressed[r]&&(t+=1),t>e)return!0
return!1}function F_key(){for(var e=112;e<124;e++)if(key_pressed[e])return!0
return!1}function get_pos_from_direction(e,t){var r=posit2.get_top_left(e,!0),n=_slicedToArray(r,2),o=n[0],a=n[1],i=posit2.get_w_h(e),s=_slicedToArray(i,2),_=s[0],l=s[1],c=0,u=0
return 37==t&&(c=round_to_mdd_with_minimum(-_-marge_for_copy)),38==t&&(u=round_to_mdd_with_minimum(-l-marge_for_copy)),39==t&&(c=round_to_mdd_with_minimum(_+marge_for_copy)),40==t&&(u=round_to_mdd_with_minimum(l+marge_for_copy)),[o+c,a+u]}function round_to_mdd_with_minimum(e){return e/mdd==parseInt(e/mdd)?parseInt(e/mdd)*mdd:(parseInt(e/mdd)+1*Math.sign(e))*mdd}function get_deltaxy_from_key_press(e){var t=0,r=0
return 38==e&&(r=-1),40==e&&(r=1),37==e&&(t=-1),39==e&&(t=1),[t,r]}function handle_key_down_for_cursor(e){function t(e){var t=currentElement.parent
swap_line(t.border_id,t.par_num,t.par_num+e),position_texts(t.border_id),render(),gui_cursor.set_cursor_by_index(t.parts[0],0),gui_buttons.frame_element(t.parts[0])}if(key_pressed[17]){if(key_pressed[67]&&gui_cursor.has_selection())return gui_cursor.handle_text_copy(),!0
if(key_pressed[88]&&gui_cursor.has_selection())return gui_cursor.handle_text_cut(),!0
if(key_pressed[86])return!!gui_cursor.has_range_to_paste()&&(gui_cursor.handle_text_paste(),!0)
if(key_pressed[65])return gui_cursor.select_all_text_in_par_from_cursor(),!0
if(arrow_key_pressed())return change_par_margin.apply(void 0,[currentElement].concat(_toConsumableArray(get_deltaxy_from_key_press(e.keyCode)))),!0
if(key_pressed[66])return add_styling_to_par("bold"),!0
if(key_pressed[73])return add_styling_to_par("italic"),!0
if(key_pressed[83])return!1}if(key_pressed[16]&&(key_pressed[46]||key_pressed[8])){var r=gui_cursor.get_cursor().chunk
return delete_shape(r),position_texts(r.border_id),gui_cursor.clear(),set_current_element(find_border_by_id(r.border_id)),!0}if(e.keyCode>=48&&e.keyCode<=90||e.keyCode>=96&&e.keyCode<=111||e.keyCode>=186&&e.keyCode<=192||e.keyCode>=219&&e.keyCode<=222||32==e.keyCode)return cc.status().gui_canvas||gui_buttons.clear(),gui_cursor.insert_text(e.key),render(),!0
if("Enter"==e.key)return gui_cursor.handle_new_line(),!0
if(37==e.keyCode){if(e.shiftKey)gui_cursor.range_backward()
else if(gui_cursor.cursor_on())gui_cursor.move_cursor_backward()
else{var n=gui_cursor.get_range(),o=n.before.chunk.parts.slice(-1)[0],a=n.before.before_index
gui_cursor.clear(),gui_cursor.set_cursor_by_index(o,a),gui_cursor.start_cursor()}return!0}if(39==e.keyCode){if(e.shiftKey)gui_cursor.range_forward()
else if(gui_cursor.cursor_on())gui_cursor.move_cursor_forward()
else{var i=gui_cursor.get_range(),s=i.after.chunk.parts[0],_=i.after.after_index
gui_cursor.clear(),gui_cursor.set_cursor_by_index(s,_),gui_cursor.start_cursor()}return!0}return 40==e.keyCode?(e.shiftKey?t(1):select_line_with_arrow(currentElement.border_id,gui_cursor.get_part_from_cursor(),!0),!0):38==e.keyCode?(e.shiftKey?t(-1):select_line_with_arrow(currentElement.border_id,gui_cursor.get_part_from_cursor(),!1),!0):35==e.keyCode?(key_pressed[16]?gui_cursor.range_to_end():gui_cursor.move_cursor_to_end(),!0):36==e.keyCode?(key_pressed[16]?gui_cursor.range_to_start():gui_cursor.move_cursor_to_start(),!0):8==e.keyCode?(gui_cursor.backspace(),render(),!0):46==e.keyCode&&(gui_cursor.delete(),render(),!0)}function arrow_key_pressed(){return _.any(key_pressed.slice(37,41))}function handle_key_down_for_draw_mode(e){e.shiftKey?(start_new_draw_group(),render_current_draw_group(context_single),text_to_feedback_pane("ready new drawing")):27==e.keyCode&&"keydown"==e.type&&keyboard_cancel()}function handle_key_down_canvas_transform(e){var t=get_deltaxy_from_key_press(e.keyCode),r=_slicedToArray(t,2),n=r[0],o=r[1]
if(e.shiftKey){var a=n+o==1?1.06*transform.k:transform.k/1.06
delta_k=a-transform.k
var i=last_pos[0]*delta_k,s=last_pos[1]*delta_k
set_zoom_and_trans(transform.x-i,transform.y-s,a)}else if(e.ctrlKey){var _=n*canvas_width*.04,l=o*canvas_height*.04
last_pos[0]+=_/transform.k,last_pos[1]+=l/transform.k,gui_buttons.add_location_circle()}else{var c=n*canvas_width*.04,u=o*canvas_height*.04,d=transform.x-c,f=transform.y-u
set_zoom_and_trans(d,f,transform.k),last_pos[0]+=c/transform.k,last_pos[1]+=u/transform.k,gui_buttons.add_location_circle()}}function handle_view_mode_key_events(e){return 123!=e.keyCode||"keydown"!=e.type||more_than_n_key_pressed(1)?key_pressed[17]&&key_pressed[70]||key_pressed[114]?(show_search_form(),e.preventDefault(),!1):void 0:(canvas_status.view_mode?view_mode_off():view_mode_on(),e.preventDefault(),key_pressed=[],!1)}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(e,t){var r=[],n=!0,o=!1,a=void 0
try{for(var i,s=e[Symbol.iterator]();!(n=(i=s.next()).done)&&(r.push(i.value),!t||r.length!==t);n=!0);}catch(e){o=!0,a=e}finally{try{n||null==s.return||s.return()}finally{if(o)throw a}}return r}function _arrayWithHoles(e){if(Array.isArray(e))return e}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function _iterableToArray(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e)){for(var t=0,r=new Array(e.length);t<e.length;t++)r[t]=e[t]
return r}}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(e,t){var r=[],n=!0,o=!1,a=void 0
try{for(var i,s=e[Symbol.iterator]();!(n=(i=s.next()).done)&&(r.push(i.value),!t||r.length!==t);n=!0);}catch(e){o=!0,a=e}finally{try{n||null==s.return||s.return()}finally{if(o)throw a}}return r}function _arrayWithHoles(e){if(Array.isArray(e))return e}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function _iterableToArray(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e)){for(var t=0,r=new Array(e.length);t<e.length;t++)r[t]=e[t]
return r}}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(e,t){var r=[],n=!0,o=!1,a=void 0
try{for(var i,s=e[Symbol.iterator]();!(n=(i=s.next()).done)&&(r.push(i.value),!t||r.length!==t);n=!0);}catch(e){o=!0,a=e}finally{try{n||null==s.return||s.return()}finally{if(o)throw a}}return r}function _arrayWithHoles(e){if(Array.isArray(e))return e}function add_canvas_drag_default(){canvas.call(d3.drag().subject(shapes_storage.find_draggable_shape).on("start",drag_start).on("drag",dragged).on("end",drag_end)).call(zoom_behavior),canvas.on("dblclick.zoom",null)}function add_canvas_drag_select(){var e,t
canvas.call(d3.drag().on("start",function(){e=get_xy_inverted_from_event(d3.event.sourceEvent),draw_rect_select([e[0]-5,e[1]-5],e)}).on("drag",function(){demo_mode&&text_to_demo_pane("dragging the canvas"),t=get_xy_inverted_from_event(d3.event.sourceEvent),draw_rect_select(e,t)}).on("end",function(){handle_drag_select(e,t),drag_select_off()}))}function add_canvas_drag_draw(){canvas.call(drag_draw)}function find_drag_selector_subject(e){e=e||d3.event.sourceEvent||d3.event
var t=get_xy_inverted_from_event(e),r=_slicedToArray(t,2),n=r[0],o=r[1]
return gui_buttons.is_path_control_point(n,o)||(is_inside(n,o,to_bbox(slider,1))?slider:to_canvas.get_canvas())}function add_canvas_drag_selector(){var e,t
canvas.call(d3.drag().subject(find_drag_selector_subject).on("start",function(){slider||(e=get_xy_inverted_from_event(d3.event.sourceEvent),draw_rect_select([e[0]-5,e[1]-5],e))}).on("drag",function(){var r=cumulator_pos.add(d3.event.dx,d3.event.dy),n=_slicedToArray(r,2),o=n[0],a=n[1]
demo_mode&&text_to_demo_pane("dragging the canvas"),"path_cp"==d3.event.subject.iama?(set_current_element(slider),drag_selector_resize(o,a),draw_slider(slider)):d3.event.subject==slider?(slider.x+=o,slider.y+=a,draw_slider(slider)):(t=get_xy_inverted_from_event(d3.event.sourceEvent),draw_rect_select(e,t))}).on("end",function(){if("canvas"==d3.event.subject.iama){var r=t[1]-e[1],n=t[0]-e[0]
slider={width:n,height:r,x:e[0],y:e[1],iama:"slider"}}draw_slider_resize_points(),cumulator_pos.reset(),set_buttons_for_slide(),add_canvas_drag_default()}))}function drag_end(){var e=d3.event.subject.iama
if("gui_connect"==e)drag_knot_end()
else if("knot"==e)drag_knot_end()
else if("gui_morph"==e)position_texts(currentElement.id),render()
else if("path_cp"==e)"drag_func"in d3.event.subject&&"dragend"in d3.event.subject.drag_func&&d3.event.subject.drag_func.dragend(),"path_group"==currentElement.iama&&path.remake_path(!0,!0)
else if("gui_resize"==e)d3.event.subject.fixed_size=!0
else if("gui_par_handle"==d3.event.subject.iama)d3.event.sourceEvent&&d3.event.sourceEvent.ctrlKey&&(gui_cursor.clear_cursor(),move_dragged_par_to_final_pos.apply(void 0,[currentElement].concat(_toConsumableArray(cumulator_pos.dist_from_start()),_toConsumableArray(cumulator_pos.get_origin()))))
else if("gui_line_end"==d3.event.subject.iama)handle_line_end_drag.apply(void 0,[currentElement,d3.event.subject.index].concat(_toConsumableArray(cumulator_pos.dist_from_start())))
else if("gui_line_end"==d3.event.subject.iama)handle_poly_point_add_button_end_drag()
else if("slider"==d3.event.subject.iama||"slider_cp"==e)(canvas_status.slide_mode||canvas_status.export_mode&&!printer.is_fixed_A_ratio())&&(draw_slider_resize_points(),printer.change_goal_w_h(slider.width,slider.height))
else{if(canvas_has_been_dragged){var t=d3.event.subject.iama
canvas_status.export_mode||"gui_resize"==t||"gui_connect"==t||"text"==t||(set_current_element(d3.event.subject),gui_buttons.frame_element(d3.event.subject),d3.event.subject.on_slide&&slide_manager.handle_object_of_slide_has_moved(d3.event.subject))}gui_buttons.has_control_points()&&(move_all_control_points.apply(void 0,_toConsumableArray(cumulator_pos.dist_from_start())),gui_buttons.render_path_control_points())}cumulator_pos.reset(),canvas_has_been_dragged=!1}function drag_start(){var e
cc.clear_canvas(cursor_context),cc.clear_canvas(hover_context),cc.clear_canvas(gui_context),(e=cumulator_pos).set_origin.apply(e,_toConsumableArray(get_xy_inverted_from_event(d3.event.sourceEvent))),cumulator_pos.set_fixed_int(d3.event.sourceEvent&&d3.event.sourceEvent.shiftKey?1:void 0),gui_cursor.cursor_on()&&gui_cursor.clear_cursor(),canvas_status.export_mode||-1==["border","drawing","fa_icon","knot","math_shape"].indexOf(d3.event.subject.iama)||set_current_element(d3.event.subject)}function dragged(){var e=cumulator_pos.add(d3.event.dx,d3.event.dy)
if(0!=e[0]||0!=e[1])if(demo_mode&&(d3.event.sourceEvent.shiftKey?text_to_demo_pane("shift pressed + dragging",!1,1e3):text_to_demo_pane("dragging",!1,300)),canvas_has_been_dragged=!0,canvas_status.slide_mode||canvas_status.export_mode)"path_cp"==d3.event.subject.iama||"slider_cp"==d3.event.subject.iama?(set_current_element(slider),drag_selector_resize.apply(void 0,_toConsumableArray(e)),draw_slider(slider)):"slider"==d3.event.subject.iama&&(reposition_protocol.apply(void 0,[d3.event.subject].concat(_toConsumableArray(e))),draw_slider(slider))
else{if("gui_resize"==d3.event.subject.iama)resize_protocol(currentElement,e[0],e[1]),gui_buttons.frame_element(currentElement),currentElement.fixed_size=!0
else if("knot"==d3.event.subject.iama)reposition_protocol(d3.event.subject,e[0],e[1]),gui_buttons.frame_element(d3.event.subject),el_under_dragged_shape(this.parentElement)
else{if("gui_connect"==d3.event.subject.iama)return drag_knot.apply(void 0,_toConsumableArray(e)),!1
if("gui_morph"==d3.event.subject.iama)reshape_polygon.apply(void 0,[currentElement].concat(_toConsumableArray(e)))
else{if("gui_par_handle"==d3.event.subject.iama)return d3.event.sourceEvent&&d3.event.sourceEvent.ctrlKey?console.log("drag par to canvas"):handle_par_drag.apply(void 0,[currentElement].concat(_toConsumableArray(e))),!1
if("gui_line_end"==d3.event.subject.iama)handle_line_drag.apply(void 0,[currentElement,d3.event.subject.index].concat(_toConsumableArray(cumulator_pos.dist_from_start())))
else if("path_cp"==d3.event.subject.iama){var t;(t=d3.event.subject.drag_func).drag.apply(t,_toConsumableArray(e))}else{if("text"==d3.event.subject.iama){var r
return(r=gui_cursor).select_text.apply(r,_toConsumableArray(cumulator_pos.get_origin()).concat(_toConsumableArray(cumulator_pos.get_current()),[d3.event.subject])),!1}"path_id"in d3.event.subject?repos_text_block(d3.event.subject,shapes_storage.paths.filter(function(e){return e.id==d3.event.subject.path_id})[0],e[0]):reposition_protocol(d3.event.subject,e[0],e[1]),canvas_status.plumbs_on&&gui_buttons.draw_plumbs_only(d3.event.subject)}}}requestAnimationFrame(render)}}function drag_discrete(){function e(e){return Math.round(1e5*e)/1e5}function t(e){return e<0?Math.ceil(e):Math.floor(e)}function r(e,t){_=[e,t]}var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:void 0,o=0,a=0,i=0,s=0,_=[]
return{add:function(r,_){o=e(r/zoom_factor+o),a=e(a+_/zoom_factor),n=d3.event.sourceEvent&&d3.event.sourceEvent.altKey?1:mdd
var l=t(o/(n||mdd))*(n||mdd),c=t(a/(n||mdd))*(n||mdd)
return o%=n||mdd,a%=n||mdd,i+=l,s+=c,[l,c]},reset:function(){var e=0!=i&&0!=s
return o=0,a=0,i=0,s=0,e},status:function(){return[o,a]},dist_from_start:function(){return[i,s]},set_origin:r,get_origin:function(){return _},get_current:function(){return[_[0]+i,_[1]+s]},set_fixed_int:function(e){return n=e}}}function drag_knot(e,t){gui_buttons.move_connect_button(e,t),el_under_dragged_shape(this.parentElement)}function drag_knot_end(){return"gui_connect"==d3.event.subject.iama?gui_buttons.end_drag_gui_connect(el_under):el_under&&(path.attach_path(el_under,d3.event.subject),render()),el_under=!1,cc.clear_canvas(gui_context),!1}function drag_draw_on(){canvas.on(".drag",null),canvas.on(".zoom",null),canvas_status.draw_mode=!0,add_canvas_drag_draw(),canvas.node().style.cursor=null,canvas.node().classList.add("drag_draw"),toggle_button_to_status(document.querySelector("#form_toggle_draw"),!0),toggle_button_to_status(document.querySelector("#cm_toggle_draw"),!0)}function drag_draw_off(){current_draw_group.filter(function(e){return""!=e.d}).forEach(function(e){set_drawing_pos(e,e.points),delete e.points}),current_draw_group.forEach(function(e){return shapes_storage.drawings.push(e)}),current_draw_group=[],canvas.on(".drag",null),canvas_status.draw_mode=!1,add_canvas_drag_default(),cc.clear_canvas(context_single),canvas.node().style.cursor="inherit",canvas.node().classList.remove("drag_draw"),toggle_button_to_status(document.querySelector("#form_toggle_draw"),!1),toggle_button_to_status(document.querySelector("#cm_toggle_draw"),!1),to_canvas.set_canvas()}function drag_select_on(){text_to_feedback_pane(0==manage_groups.get_current_group().length?"drag canvas to group shapes":"drag canvas to add to or remove from group"),canvas.on(".drag",null),canvas.on(".zoom",null),canvas_status.drag_select=!0,add_canvas_drag_select(),canvas.node().style.cursor="cell"}function drag_select_off(){canvas.on(".drag",null),canvas_status.drag_select=!1,add_canvas_drag_default(),cc.clear_canvas(gui_context),canvas.node().style.cursor="inherit",update_quick_grouping_forms()}function drag_slides_on(){text_to_feedback_pane("drag the canvas to add a slide"),canvas.on(".drag",null),canvas.on(".zoom",null),canvas_status.slide_mode=!0,add_canvas_drag_selector(),canvas.node().style.cursor="cell"}function drag_slides_off(){canvas.on(".drag",null),canvas_status.slide_mode=!1,gui_buttons.reset_path_control_points(),slider=!1,set_buttons_for_slide(),add_canvas_drag_default(),cc.clear_canvas(context_single),canvas.node().style.cursor="inherit"}function drag_export_on(){canvas_status.export_mode=!0,to_canvas.set_canvas(),document.querySelector("#form_remove_print_region").style.display="block",document.querySelector("#form_print_buttons").style.display="block",document.querySelector("#form_print_add_print_region").style.display="none",set_form_print_ratio_choice()}function drag_export_off(){canvas.on(".drag",null),canvas_status.export_mode=!1,slider=!1,add_canvas_drag_default(),cc.clear_canvas(gui_context),cc.clear_canvas(context_single),canvas.node().style.cursor="inherit",document.querySelector("#form_print_buttons").style.display="none",document.querySelector("#form_print_add_print_region").style.display="block",document.querySelector("#form_remove_print_region").style.display="none"}function handle_drag_select(e,t){var r={top:e[1],left:e[0],bottom:t[1],right:t[0]},n=shapes_storage.find_shapes_in_bbox(r)
manage_groups.toggle_elements(n)}function get_path_custom_flow_attrs(e){function t(e,t,n,o){var i=Math.round((e-t)/n*1e4)/1e4
if(!r&&(i<0||i>1)){var s
return 0==o&&e<a.x&&(s=e-a.x),0==o&&e>a.x&&(s=e-a.x-a.width),1==o&&e<a.y&&(s=e-a.y),1==o&&e>a.y&&(s=e-a.y-a.height),Math.round(1e4*s)/1e4}return i}var r=!1,n=e[0],o=e[e.length-1],a=calc_bbox_endpoints(n.x,n.y,o.x,o.y),i=o.x-n.x||1,s=o.y-n.y||1,_=[]
return _=e.slice(1,e.length-1).map(function(e){return[t(e.x,n.x,i,0),t(e.y,n.y,s,1)]}),_.join(", ")}function drag_selector_resize(e,t){if(0!=e||0!=t){var r=d3.event.subject
r.x+=e,r.y+=t,0==r.index?(slider.x+=e,slider.y+=t,slider.width-=e,slider.height-=t):1==r.index?(slider.y+=t,slider.width+=e,slider.height-=t):2==r.index?(slider.x+=e,slider.width-=e,slider.height+=t):(slider.width+=e,slider.height+=t)}}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(e,t){var r=[],n=!0,o=!1,a=void 0
try{for(var i,s=e[Symbol.iterator]();!(n=(i=s.next()).done)&&(r.push(i.value),!t||r.length!==t);n=!0);}catch(e){o=!0,a=e}finally{try{n||null==s.return||s.return()}finally{if(o)throw a}}return r}function _arrayWithHoles(e){if(Array.isArray(e))return e}function zoomed(){var e=d3.event.transform,t=d3.event.transform.k
e.always_render&&(transform=e,has_transformed=!0,zoom_factor=t),demo_mode&&text_to_demo_pane("dragging canvas"),requestAnimationFrame(function(r){if(last_anim&&r-last_anim<14&&!e.always_render)return!1
last_anim=r,transform=e,has_transformed=!0,zoom_factor=t,cc.clear_canvas(context_single),cc.clear_canvas(hover_context),render_all(r,!1,!0),canvas_status.export_mode&&printer.draw_print_region(!0)}),zoom_count+=1,gridlines.on()&&gridlines.make()}function canvas_doubleclick_default(){if(canvas_status.view_mode)return!1
var e=get_xy_inverted_from_event(d3.event),t=_slicedToArray(e,2),r=t[0],n=t[1],o=shapes_storage.find_clickable_shape(r,n)
demo_mode&&text_to_demo_pane("double click",!1,1e3),o?("gui_resize"==o.iama&&handle_gui_resize_double_click(),("path_group"==o.iama||"drawing"==o.iama&&"line"==o.type)&&(set_current_element(o),gui_buttons.get_el_with_cps()==o?(gui_buttons.reset_path_control_points(),gui_buttons.frame_element(currentElement)):"path_group"==o.iama?show_path_control_points(o):show_line_control_points(o)),"text"==o.iama&&gui_cursor.handle_double_click(r,n,o),"fa_icon"==o.iama&&(open_modal("icon_modal"),fa_handler.opened_from_canvas(!0)),"math_shape"==o.iama&&open_math_modal(o)):("icon_basic"==active_style.shape?add_icon_to_canvas(r,n):"math_shape"==active_style.shape?math_jax_specs.loaded?trigger_math("x+y"):start_math().then(function(){trigger_math("x+y")}):"line"==active_style.shape.split("_")[0]?add_line_to_canvas():add_active_shape_to_canvas(),render())}function add_active_shape_to_canvas(){var e=add_shape_to_canvas()
e.width=infinity.get_standard_scaling(120,e.level,0),e.height=infinity.get_standard_scaling(70,e.level,0)
var t=to_discrete_position([e.x-Math.floor(e.width/2),e.y-Math.floor(e.height/2)]),r=_slicedToArray(t,2),n=r[0],o=r[1]
e.x=n,e.y=o,set_current_element(e)}function canvas_click_default(){if(ignore_svg_click)return ignore_svg_click=!1,!1
if(demo_mode&&(d3.event.ctrlKey?text_to_demo_pane("control + mouse click",!1,1e3):d3.event.shiftKey?text_to_demo_pane("shift + mouse click",!1,1e3):text_to_demo_pane("mouse click",!1,1e3)),cmm.status()&&cmm.off(),canvas_status.export_mode)return!1
var e=get_xy_inverted_from_event(d3.event),t=_slicedToArray(e,2),r=t[0],n=t[1]
last_pos=to_discrete_position([r,n])
var o=shapes_storage.find_clickable_shape(r,n)
if(canvas_status.view_mode)return o&&o.parent&&"text"==o.parent.iama&&is_web_link(o.parent.text)&&window.open(o.parent.text,"_blank"),!1
if(d3.event.ctrlKey&&!o)return poly_draw=!0,points_for_poly.push(last_pos),render_poly_line(points_for_poly,gui_context,!1),render_poly_points(points_for_poly,gui_context),!1
if(d3.event.shiftKey&&!o)return poly_draw=!0,points_for_poly.push(last_pos),render_poly_line(points_for_poly,gui_context,!1),render_poly_points(points_for_poly,gui_context),!1
if(canvas_status.copy_on&&el_to_copy){var a=posit2.get_w_h(el_to_copy),i=_slicedToArray(a,2),s=i[0],_=i[1],l=copy_prepped_shape_to_canvas(el_to_copy,to_discrete_position([last_pos[0]-s/2,last_pos[1]-_/2]))
return el_to_copy=!1,canvas_status.copy_on=!1,set_current_element(l),!1}style_copier.is_on()&&o?style_copier.copy_styles_to_shape(o):o&&"gui_connect"==o.iama||o&&"gui_resize"==o.iama||(o&&"gui_flip"==o.iama?flip_shape(currentElement):o&&"text"==o.iama&&gui_cursor.has_selection()&&gui_cursor.xy_is_in_range(r,n)?gui_cursor.range_contains_all_text_in_par()?gui_cursor.clear_selection():gui_cursor.select_all_text_in_par_from_range():o?(set_current_element(o),display_fs_for_shape(o),gui_buttons.frame_element(currentElement),d3.event.ctrlKey&&manage_groups.toggle_element(part_to_chunk(currentElement),!0),d3.event.shiftKey&&(manage_groups.cycle_through_groups_of_shape(currentElement),update_quick_grouping_forms()),"path_group"!=currentElement.iama&&gui_buttons.reset_path_control_points(),"path_group"==currentElement.iama&&path.set_path_attrs(currentElement),gui_buttons.add_marker_to_example_style(part_to_chunk(o).style_class)):(gui_cursor.clear(),to_canvas.set_canvas(),display_fs_for_shape(currentElement),gui_buttons.add_marker_to_example_style(active_style.style_class),gui_buttons.clear(),gui_buttons.add_location_circle(),canvas_status.mobile_mode&&display_cursor_mobile_mode(20,last_pos[0],last_pos[1])))}function add_canvas_default_click(){canvas.on("click",canvas_click_default),canvas.on("dblclick",canvas_doubleclick_default)}function canvas_slide_exclusion_mode_click(){var e=get_xy_inverted_from_event(d3.event),t=_slicedToArray(e,2),r=t[0],n=t[1]
last_pos=to_discrete_position([r,n])
var o=shapes_storage.find_clickable_shape(r,n)
if(!o)return!1
slide_manager.handle_exclusion_mode_click(o)}function add_canvas_slide_exclusion_mode_click(){canvas.on("click",canvas_slide_exclusion_mode_click)}function set_zoom_and_trans(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]&&arguments[3],o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:render_all,a=arguments.length>5&&void 0!==arguments[5]&&arguments[5]
goal_transform=get_new_transform(e,t,r),a&&(goal_transform.always_render=!0),n?canvas.transition().delay(200).duration(anim_dur).call(zoom_behavior.transform,goal_transform).on("end",o):canvas.call(zoom_behavior.transform,goal_transform)}function get_new_transform(e,t,r){return d3.zoomIdentity.translate(e,t).scale(r)}function zoom_to_area(e){var t=e.x,r=e.y,n=e.width,o=e.height,a=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:6,_=calc_zoom_trans(t,r,n,o,s),l=_slicedToArray(_,2),c=l[0],u=l[1]
if(isNaN(c)||isNaN(u[0])||isNaN(u[1]))return!1
i?set_zoom_and_trans(u[0],u[1],c,a,function(){return render_all(0,!1,!0,i)},!a):set_zoom_and_trans(u[0],u[1],c,a,null,!a)}function find_scale_and_spare_margins(e,t,r,n){var o=arguments.length>4&&void 0!==arguments[4]&&arguments[4],a=spare_margin_h=0
if(o)var i=r,s=n
else var i=Math.max(r,300),s=Math.max(n,150)
var _=e/i,l=t/s
return o&&(_=Math.min(_,o),l=Math.min(l,o)),_<l?(spare_margin_h=t-_*s+(n<s?_*(s-n):0),a=e-_*i+(r<i?_*(i-r):0)):(a=e-l*i+(r<i?l*(i-r):0),spare_margin_h=t-l*s+(n<s?l*(s-n):0)),[Math.min(_,l),a,spare_margin_h]}function calc_zoom_trans(e,t,r,n){var o=arguments.length>4&&void 0!==arguments[4]&&arguments[4],a=document.querySelector("#sidebar").classList.contains("menu_hidden"),i=!a&&full_screen?MARGE_MENU:0,s=canvas_width-i,_=canvas_height,l=find_scale_and_spare_margins(s,_,r,n,o),c=_slicedToArray(l,3),u=c[0]
return[u,[-e*u+c[1]/2,-t*u+c[2]/2]]}function zoom_end(){if(currentElement&&!canvas_status.slide_mode&&set_current_element(currentElement,!0),gui_buttons.frame_element(currentElement),slides_mode||infinity.get_level()==zoom_level_start||(text_to_feedback_pane(infinity.get_level()),mdd=infinity.get_mdd()),d3.event.sourceEvent){var e=get_xy_inverted_from_event(d3.event.sourceEvent),t=_slicedToArray(e,2),r=t[0],n=t[1]
last_pos=to_discrete_position([r,n])}gui_buttons.add_location_circle(),canvas_status.export_mode&&printer.draw_print_region(),has_transformed&&to_canvas.set_canvas()}function zoom_start(){text_for_render.start_sorting(),zoom_level_start=infinity.get_level(),gui_cursor.stop_cursor(),cc.clear_canvas(gui_context),gui_cursor.has_selection()&&gui_cursor.clear_selection(),cc.clear_canvas(cursor_context),has_transformed=!1}function set_button_class(e,t){for(var r=e.querySelectorAll("button"),n=0;n<r.length;n++)r[n].classList.toggle("onoff-on",!1)
t.classList.toggle("onoff-on",!0)}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function _iterableToArray(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e)){for(var t=0,r=new Array(e.length);t<e.length;t++)r[t]=e[t]
return r}}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(e,t){var r=[],n=!0,o=!1,a=void 0
try{for(var i,s=e[Symbol.iterator]();!(n=(i=s.next()).done)&&(r.push(i.value),!t||r.length!==t);n=!0);}catch(e){o=!0,a=e}finally{try{n||null==s.return||s.return()}finally{if(o)throw a}}return r}function _arrayWithHoles(e){if(Array.isArray(e))return e}function render_single(e){last_text_item_rendered=!1
var t
if(!el_on_single)return render_all(),!1
t=el_on_single
var r=context_single
if(cc.clear_canvas(r),r.save(),r.beginPath(),r.translate(transform.x,transform.y),r.scale(transform.k,transform.k),"border"==el_on_single.iama){drawBorders(t,r),el_on_single.id in shapes_storage.images&&drawImage(shapes_storage.images[el_on_single.id],r)
var n=get_text_with_border_id(t.id)
n.forEach(function(e){return draw_text_border(e,r)}),n.forEach(function(e){return drawText(e,r,!0)}),paths_on_single.forEach(function(e){return drawPath(e,r)})}else"math_shape"==el_on_single.iama?render_math_jax_shape(el_on_single,r):"drawing"==el_on_single.iama&&drawDrawing(el_on_single,r)
r.restore(),cc.set_has_ink(r)}function get_items_to_render(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=arguments.length>1&&void 0!==arguments[1]&&arguments[1]
view.set_bbox(e)
var r=Object.values(shapes_storage.borders).filter(view.is_in_view)
el_on_single&&!t&&(r=r.filter(function(e){return e!=el_on_single}))
var n=Object.values(shapes_storage.borders_bound).filter(view.is_in_view)
el_on_single&&!t&&(n=n.filter(function(e){return e!=el_on_single}))
var o=new Set(r.concat(n).map(function(e){return e.id})),a=text_for_render.get_texts(o),i=shapes_storage.paths.filter(view.is_in_view)
if(el_on_single&&paths_on_single.length>0&&!t){var s=paths_on_single.map(function(e){return e.id})
i=i.filter(function(e){return-1==s.indexOf(e.id)})}if(el_on_single&&!t)var _=Object.keys(shapes_storage.images).filter(function(e){return e!=el_on_single.id})
else var _=Object.keys(shapes_storage.images)
var l=shapes_storage.drawings.filter(view.is_in_view)
el_on_single&&"drawing"==el_on_single.iama&&!t&&(l=l.filter(function(e){return e!=el_on_single}))
var c=Object.values(shapes_storage.math_shapes).filter(view.is_in_view)
return el_on_single&&"math_shape"==el_on_single.iama&&!t&&(c=c.filter(function(e){return e!=el_on_single})),[r,n,a,i,_,l,shapes_storage.icons,c]}function render_for_pic(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]&&arguments[3]
e.beginPath(),e.translate(r.x,r.y),e.scale(r.k,r.k),n&&(e.save(),e.fillStyle=n,e.rect(slider.x,slider.y,slider.width,slider.height),e.fill(),e.restore()),last_text_item_rendered=!1,render_shapes(e,t,get_items_to_render,!0)}function render_all(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:get_items_to_render,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:context
last_text_item_rendered=!1,r&&cc.clear_canvas(context_single),o.save(),cc.clear_canvas(o),o.translate(transform.x,transform.y),o.scale(transform.k,transform.k),render_shapes(o,t,n,r),slider&&draw_slider(slider),o.restore(),cc.set_has_ink(o)}function render_shapes(e,t,r,n){wobbles=[]
var o=r(t,n),a=_slicedToArray(o,8),i=a[0],s=a[1],_=a[2],l=a[3],c=a[4],u=a[5],d=a[6],f=a[7]
l.forEach(function(t){return drawPath(t,e)}),draw_shapes_in_order(i,e),s.forEach(function(t){return drawBorders(t,e)}),c.forEach(function(t){return drawImage(shapes_storage.images[t],e)}),_.forEach(function(t){return draw_text_border(t,e)}),_.forEach(function(t){return drawText(t,e)}),context.fillStyle="#252323",wobbles.forEach(function(e){return drawWobble(e,context)}),u.forEach(function(t){return drawDrawing(t,e)}),d.forEach(function(t){return draw_fa_icon(t,e)}),f.forEach(function(t){return render_math_jax_shape(t,e)})}function draw_shapes_in_order(e,t){var r=[]
e.forEach(function(e){"draw_order"in e?r.push(e):drawBorders(e,t)}),r.sort(function(e,t){return e.draw_order-t.draw_order}),r.forEach(function(e){return drawBorders(e,t)})}function draw_text_border(e,t){if(e.has_own_style){var r={}
if(e.fill&&(r.fill=e.fill),e.stroke&&(r.stroke=e.stroke),"stroke_width"in e&&(r.stroke_width=e.stroke_width||0),e.stroke_dasharray&&(r.stroke_dasharray=e.stroke_dasharray),e.filter&&(r.filter=e.filter),!render_to_pdf||"stroke_width"in r||(e.stroke_width=0),!("parts"in e))return!1
var n=e.parts[0],o=e.parts[e.parts.length-1]
render_text_selection(n.x,o.x+o.width,n,o,r,t)}}function render_current_draw_group(e){cc.clear_canvas(e),e.save(),e.translate(transform.x,transform.y),e.scale(transform.k,transform.k),current_draw_group.forEach(function(t){return drawDrawing(t,e)}),e.restore(),cc.set_has_ink(e)}function drawDrawing(e,t){t.save(),draw_line_for_drawing(e,t),t.restore(),"add_ons"in e&&Object.keys(e.add_ons).forEach(function(r){return drawAddon(e.add_ons[r],t)})}function draw_line_for_drawing(e,t){if(e.rough)roughing.draw(e,t)
else{t.translate(e.x,e.y)
var r=new Path2D(e.d)
t.strokeStyle=e.stroke,t.lineWidth=e.stroke_width,"stroke_dasharray"in e&&t.setLineDash(e.stroke_dasharray),"canvas"in t?t.stroke(r):(t.fillStyle="rgba(0,0,0,0)",t.path(e.d).stroke())}}function drawText(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2]
t.beginPath(),!n&&!no_wobble&&transform.k*e.font_size<5?(set_style_for_text(e,t),drawWobble(e,t)):(set_style_for_text(e,t),e.parts?render_to_pdf?(correction=1.4==e.line_height?0:e.height*e.line_height/1.4/4,e.parts.forEach(function(e){return t.fillText(e.text,r(e.x),r(e.y-correction))})):e.parts.forEach(function(e){return t.fillText(e.text,r(e.x),r(e.y+e.baseline_offset))}):t.fillText(e.text,r(e.x),r(e.y)))}function drawWobble(e,t){e.parts&&e.parts.forEach(function(e){return t.fillRect(e.x,e.y+e.baseline_offset/2,e.width,1)})}function drawPath(e,t){if(t.save(),e.rough)"canvas"in t||(t.fillStyle="rgba(0,0,0,0)"),roughing.draw(e,t)
else{t.beginPath()
var r=new Path2D(e.d)
"double"==e.type&&(t.strokeStyle=e.stroke,t.lineWidth=e.outer_width,"dasharray_outer"in e&&t.setLineDash(e.dasharray_outer),"canvas"in t?t.stroke(r):(t.fillStyle="rgba(0,0,0,0)",t.path(e.d).stroke())),t.strokeStyle=e.fill,t.lineWidth=e.inner_width,"dasharray_inner"in e&&t.setLineDash(e.dasharray_inner),"filter"in e&&(t.filter=e.filter),"canvas"in t?t.stroke(r):(t.fillStyle="rgba(0,0,0,0)",t.path(e.d).stroke())}t.restore(),"add_ons"in e&&Object.keys(e.add_ons).forEach(function(r){return drawAddon(e.add_ons[r],t)})}function drawAddon(e,t){if(t.save(),t.strokeStyle=e.style.stroke,t.lineWidth=e.style.stroke_width,t.fillStyle=e.style.fill,t.translate(e.rotation[1],e.rotation[2]),t.rotate(e.rotation[0]*(Math.PI/180)),"poly"==e.specs.fig)t.beginPath(),t.moveTo(e.specs.points[0][0],e.specs.points[0][1]),e.specs.points.forEach(function(e){var r=_slicedToArray(e,2),n=r[0],o=r[1]
return t.lineTo(n,o)}),t.closePath(),t.fill(),t.stroke()
else if("canvas"in t){var r=new Path2D(e.specs.d)
t.stroke(r)}else t.fillStyle="rgba(0,0,0,0)",t.path(e.specs.d).stroke()
t.restore()}function drawBorders(e,t){"ellipse"==e.shape?drawEllipse(e,t):drawPolygon(e,t)}function r(e){return e}function drawEllipse(e,t){t.save(),e.rough?roughing.draw(e,t):(t.beginPath(),set_style_for_context(e,t),t.ellipse(e.x+e.width/2,e.y+e.height/2,e.width/2,e.height/2,0,0,2*Math.PI),t.closePath(),t.fill(),e.stroke_width>0&&t.stroke()),t.restore()}function drawPolygon(e,t){t.save(),e.rough?roughing.draw(e,t):(set_style_for_context(e,t),poly_steps(e,t),t.fill(),e.stroke_width>0&&t.stroke()),t.restore()}function poly_steps(e,t){"scale"in e&&t.scale(e.scale,e.scale),t.translate(r(e.x),r(e.y))
var n=e.width,o=e.height
if("points"in e)var a=e.points
else var a=poly_config[e.shape].points||[[0,0],[1,0],[1,1],[0,1]]
a=a.map(function(e){var t=_slicedToArray(e,2),r=t[0],a=t[1]
return[n*r,o*a]}),t.beginPath(),t.moveTo(a[0][0],a[0][1]),a.forEach(function(e){var n=_slicedToArray(e,2),o=n[0],a=n[1]
return t.lineTo(r(o),r(a))}),t.closePath()}function drawImage(e,t){var r=e.border_data
find_border_by_id(r.border_id),t.drawImage(e,0,0,r.img_width,r.img_height,r.x,r.y,r.border_width,r.border_height)}function set_style_for_context(e,t){t.strokeStyle=e.stroke,t.fillStyle=e.fill,t.lineWidth=e.stroke_width,e.filter&&(t.filter=e.filter),e.stroke_dasharray&&t.setLineDash(e.stroke_dasharray)}function set_style_for_text(e,t){if(!(arguments.length>2&&void 0!==arguments[2]&&arguments[2])&&last_text_item_rendered&&compare_styles_of_chunks_for_render(e,last_text_item_rendered))return!1
var r=e.color||e.fill,n=predef_styles.get_font_style(e)
t.filter=e.filter||"none",t.fillStyle=r,t.font=n,last_text_item_rendered=e}function render_text_selection(e,t,r,n,o,a){a.save(),"stroke"in o&&(a.strokeStyle=o.stroke),"fill"in o&&(a.fillStyle=o.fill),"stroke_width"in o&&(a.lineWidth=o.stroke_width),"stroke_dasharray"in o&&a.setLineDash(o.stroke_dasharray),"filter"in o&&(a.filter=o.filter),a.beginPath()
var i=[]
if(r==n)"text_border"in n?i.push([n.text_border.x,n.y,n.text_border.width,n.height]):i.push([e,r.y,t-e,r.height])
else{i.push([e,r.y,r.x+r.width-e,r.height]),"text_border"in n?i.push([n.text_border.x,n.y,n.text_border.width,n.height]):i.push([n.x,n.y,t-n.x,n.height])
var s=find_parts_with_border_id(r.border_id).sort(function(e,t){return e.num-t.num}),_=!0,l=!1,c=void 0
try{for(var u,d=s[Symbol.iterator]();!(_=(u=d.next()).done);_=!0){var f=u.value
f.num>r.num&&f.num<n.num&&i.push([f.x,f.y,f.width,f.height])}}catch(e){l=!0,c=e}finally{try{_||null==d.return||d.return()}finally{if(l)throw c}}}return i.forEach(function(e){var t=_slicedToArray(e,4),r=t[0],n=t[1],o=t[2],i=t[3]
return a.rect(r,n,o,i,a)}),"stroke"in o&&o.stroke_width>0&&a.stroke(),"fill"in o&&a.fill(),a.closePath(),a.restore(),cc.set_has_ink(a),i}function draw_fa_icon(e,t){t.save(),t.beginPath(),t.textBaseline="top",t.font=e.icon.weight+" "+e.font_size+"px "+(e.icon.is_brand?'"Font Awesome 5 Brands"':'"Font Awesome 5 Free"'),"fill"in e&&(t.fillStyle=e.fill),t.lineWidth=e.stroke_width,"stroke"in e&&(t.strokeStyle=e.stroke),t.translate(e.x,e.y),"zoom_scale"in e&&t.scale(e.zoom_scale,e.zoom_scale),"fill"in e&&t.fillText(String.fromCodePoint(parseInt(e.icon.code,16)),0,0),"stroke_width"in e&&e.stroke_width>0&&!render_to_pdf&&t.strokeText(String.fromCodePoint(parseInt(e.icon.code,16)),0,0),t.restore(),cc.set_has_ink(t)}function draw_gui_path(e,t){t.save(),t.beginPath(),t.fillStyle=e.fill,t.lineWidth=e.stroke_width,t.strokeStyle=e.stroke,t.translate(e.x,e.y),"scale"in e&&t.scale(e.scale,e.scale),"zoom_scale"in e&&t.scale(e.zoom_scale,e.zoom_scale)
var r=new Path2D(e.d)
t.stroke(r),t.fill(r),t.restore(),cc.set_has_ink(t)}function render_poly_line(e,t){var r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2]
t.save(),t.translate(transform.x,transform.y),t.scale(transform.k,transform.k),t.beginPath(),t.strokeStyle="yellowgreen",t.lineWidth="drawing"==currentElement.iama?currentElement.stroke_width:2,t.moveTo(e[0][0],e[0][1]),e.forEach(function(e){var r=_slicedToArray(e,2),n=r[0],o=r[1]
return t.lineTo(n,o)}),r&&t.closePath(),t.stroke(),t.restore(),cc.set_has_ink(t)}function render_poly_points(e,t){t.save(),t.translate(transform.x,transform.y),t.scale(transform.k,transform.k),t.beginPath(),t.fillStyle="yellowgreen",e.forEach(function(e){var r=_slicedToArray(e,2)
return drawEllipse({x:r[0],y:r[1],width:4,height:4},t)}),t.fill(),t.restore(),cc.set_has_ink(t)}function draw_slider(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:context_single
draw_rect_select([e.x,e.y],[e.x+e.width,e.y+e.height],t)}function draw_rect_select(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:gui_context
cc.clear_canvas(r),r.save(),r.beginPath(),r.translate(transform.x,transform.y),r.scale(transform.k,transform.k),r.fillStyle="rgba(0,0,360,0.25)",r.strokeStyle="black",r.rect(e[0],e[1],t[0]-e[0],t[1]-e[1]),r.fill(),r.stroke(),r.restore(),cc.set_has_ink(r)}function render_hover_highlight(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0
if(r.save(),r.beginPath(),r.translate(transform.x,transform.y),r.scale(transform.k,transform.k),r.strokeStyle=t,r.lineWidth=2*n,use_points_for_detection(e))poly_steps(e,r)
else if("ellipse"==e.shape||"knot"==e.iama)r.ellipse(e.x+e.width/2,e.y+e.height/2,e.width/2+n,e.height/2+n,0,0,2*Math.PI)
else if("path_group"==e.iama){r.beginPath()
var o=new Path2D(e.d)
r.stroke(o)}else if("d"in e){r.save(),r.translate(e.x,e.y),r.beginPath()
var a=new Path2D(e.d)
r.stroke(a),r.restore()}else{var i=n/2
r.rect(e.x-i,e.y-i,e.width+2*i,e.height+2*i)}r.stroke(),r.restore(),cc.set_has_ink(r)}function render_math_jax_shape(e,t){t.save(),t.translate(e.x,e.y+.6*e.height),t.transform(1/e.scale,0,0,-1/e.scale,0,0),t.fillStyle=e.fill,t.strokeStyle=e.stroke,t.lineWidth=e.stroke_width*e.scale,render_math_jax_item(e.items,t),t.restore()}function render_math_jax_item(e,t){arguments.length>2&&void 0!==arguments[2]&&arguments[2],t.save(),t.beginPath(),2==e.trans.length&&t.translate.apply(t,_toConsumableArray(e.trans)),e.paths.forEach(function(e){t.save(),e[0].trans&&t.scale(e[0].trans[0],e[0].trans[0]),t.translate(parseInt(e[0].x),parseInt(e[0].y))
var r=new Path2D(e[1])
t.stroke(r),"canvas"in t?(t.stroke(r),t.fill(r)):t.path(e[1]).stroke(),t.restore()}),e.rects.forEach(function(e){t.rect(e.x,e.y,e.width,e.height),t.fill(),t.stroke()}),e.children&&e.children.forEach(function(e){return render_math_jax_item(e,t)}),t.restore()}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function _iterableToArray(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e)){for(var t=0,r=new Array(e.length);t<e.length;t++)r[t]=e[t]
return r}}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(e,t){var r=[],n=!0,o=!1,a=void 0
try{for(var i,s=e[Symbol.iterator]();!(n=(i=s.next()).done)&&(r.push(i.value),!t||r.length!==t);n=!0);}catch(e){o=!0,a=e}finally{try{n||null==s.return||s.return()}finally{if(o)throw a}}return r}function _arrayWithHoles(e){if(Array.isArray(e))return e}function make_d(e){function t(e,t,r){var n=.3*e.dist
switch(parseInt(t)){case 0:i=[e.midpoints[r][0],e.midpoints[r][1]-n]
break
case 1:i=[e.midpoints[r][0]+n,e.midpoints[r][1]]
break
case 2:i=[e.midpoints[r][0],e.midpoints[r][1]+n]
break
case 3:i=[e.midpoints[r][0]-n,e.midpoints[r][1]]}return i}function r(e,t,r,n){if(void 0==n)var o=line_styles[active_style.line_flow].perpendicular[r],a=line_styles[active_style.line_flow].inline[r]
else var o=line_styles[n].perpendicular[r],a=line_styles[n].inline[r]
var s=e.dx,_=e.dy,l=e.midpoints[r][0],c=e.midpoints[r][1],u=0==r?1:-1
if("function"==typeof a)switch(parseInt(t)){case 0:i=[a(l,s,u),o(c,_,u)]
break
case 1:i=[o(l,s,u),a(c,_,u)]
break
case 2:i=[a(l,s,u),o(c,_,u)]
break
case 3:i=[o(l,s,u),a(c,_,u)]}else switch(parseInt(t)){case 0:l=a<-2||a>2?l+u*a:l+s*a*u,c=o<-2||o>2?c+u*o:c+_*o*u,i=[l,c]
break
case 1:c=a<-2||a>2?c+u*a:c+_*a*u,l=o<-2||o>2?l+u*o:l+s*o*u,i=[l,c]
break
case 2:l=a<-2||a>2?l+u*a:l+s*a*u,c=o<-2||o>2?c+u*o:c+_*o*u,i=[l,c]
break
case 3:c=a<-2||a>2?c+u*a:c+_*a*u,l=o<-2||o>2?l+u*o:l+s*o*u,i=[l,c]}return i}if("manhattan"!=cpa.flow||cpa.custom_flow)if("straight"==cpa.flow&&cpa.custom_flow)var n=get_path_from_custom_flow(cpa.custom_flow,e,!0)
else if("hooked"==cpa.flow||"hooked_rev"==cpa.flow)if(cpa.custom_flow)var n=get_path_from_custom_flow(cpa.custom_flow,e,!0)
else{var o=function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=_slicedToArray(e.midpoints,2),n=r[0],o=r[1],a=Math.abs(n[0]-o[0]),i=Math.abs(n[1]-o[1]),s=calc_bbox_endpoints.apply(void 0,_toConsumableArray(n).concat(_toConsumableArray(o))),_=s.x,l=s.y,c=s.width,u=s.height
if(cpa.custom_flow)var d=cpa.custom_flow.split(",").map(function(e){return parseFloat(e)}),f=[_+c*d[0],l+u*d[1]]
else if(t){if(0==e.i)var f=[n[0],n[1]-.3*i]
else if(1==e.i)var f=[n[0]+.3*a,n[1]]
else if(2==e.i)var f=[n[0],n[1]+.3*i]
else if(3==e.i)var f=[n[0]-.3*a,n[1]]}else if(0==e.j)var f=[o[0],o[1]-.3*i]
else if(1==e.j)var f=[o[0]+.3*a,o[1]]
else if(2==e.j)var f=[o[0],o[1]+.3*i]
else if(3==e.j)var f=[o[0]-.3*a,o[1]]
return[("M"+n+"L"+f+"L"+o).replace(/[\]\[]/g,""),f]}(e,"hooked_rev"==cpa.flow),a=_slicedToArray(o,2),n=a[0],i=a[1]
e.cps=[i]}else if(cpa.custom_flow)var n=get_path_from_custom_flow(cpa.custom_flow,e,"lineto"==cpa.flow||"manhattan"==cpa.flow)
else{if(e.i==e.j)var s=t(e,e.i,0),_=t(e,e.j,1)
else var s=r(e,e.i,0,cpa.flow),_=r(e,e.j,1,cpa.flow)
var n=make_cubic_bezier_path([e.midpoints[0],s,_,e.midpoints[1]])
e.cps=[s,_]}else{var l=function(e){function t(e,t,r){return r*e[0][t]+(1-r)*e[1][t]}var r,n,o=_slicedToArray(e.midpoints,2),a=o[0],i=o[1]
if(e.i==e.j){var s=cpa.manhattan_perc||40
if(e.i%2==0){var _=0==e.i?Math.min:Math.max
l=_(a[1],i[1])+s*(1-2*(0==e.i)),r=[a[0],l],n=[i[0],l]}else{var _=3==e.i?Math.min:Math.max,l=_(a[0],i[0])+s*(1-2*(3==e.i))
r=[l,a[1]],n=[l,i[1]]}}else if(e.i%2!=e.j%2)r=n=e.i%2==1?[i[0],a[1]]:[a[0],i[1]]
else if(e.i%2==1){var c=cpa.manhattan_perc?cpa.manhattan_perc:.5
r=[t(e.midpoints,0,c),a[1]],n=[r[0],i[1]]}else if(e.i%2==0){var c=cpa.manhattan_perc?cpa.manhattan_perc:.5
r=[a[0],t(e.midpoints,1,c)],n=[i[0],r[1]]}return[("M"+a+"L"+r+"L"+n+"L"+i).replace(/[\]\[]/g,""),function(){return[(r[0]+n[0])/2,(r[1]+n[1])/2]}()]}(e),n=l[0]
e.manhattan_midpoint=l[1],e.cps=[l[1]]}return n}function make_cubic_bezier_path(e){return array_to_path(e.map(function(e){return{x:round_to(e[0],0),y:round_to(e[1],0)}}))}function array_to_path(e){for(var t="M"+e[0].x+","+e[0].y+" ",r=1;r<e.length;r++)r%3==1&&(t+="C"),t+=e[r].x+","+e[r].y+" "
return t}function array_to_line(e){for(var t="M"+round_to(e[0].x,2)+","+round_to(e[0].y,2)+" ",r=1;r<e.length;r++)t+="L"+round_to(e[r].x,2)+","+round_to(e[r].y,2)+" "
return t}function is_cubic_cp_of_type(e,t){return 1==e||e==t?"free":e%3==0?"mid":"bound"}function path_to_nothing(e,t){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=arguments.length>3&&void 0!==arguments[3]&&arguments[3],o=get_default_knot.apply(void 0,_toConsumableArray(e))
shapes_storage.knots.push(o)
var a={}
n&&(a={flow:n}),path.make_new_connection(t,o,r,a),set_current_element(cpa.path_g)}function find_paths_on_my_side(e,t){function r(e,t,r){return find_path_by_id(e)[t]==r}var n=path.find_connections(e),o=n.filter(function(t){var r=path.extract_elements_from_path_id(t.id),n=_slicedToArray(r,2)
return n[0],n[1]!=e}),a=n.filter(function(t){var r=path.extract_elements_from_path_id(t.id),n=_slicedToArray(r,2)
return n[0],n[1]==e})
return o=o.filter(function(e){return r(e.id,"from_side",t)}),a=a.filter(function(e){return r(e.id,"to_side",t)}),o=o.map(function(e){var t=path.extract_elements_from_path_id(e.id),r=_slicedToArray(t,2)
return r[0],{path:e,fig:r[1],side:"to_"}}),a=a.map(function(e){var t=path.extract_elements_from_path_id(e.id),r=_slicedToArray(t,2),n=r[0]
return r[1],{path:e,fig:n,side:"from_"}}),o.concat(a)}function disperse_path_over_side(e,t,r){var n=e.id,o=find_paths_on_my_side(n,t)
if(o.length<1)return!1
if("knot"==e.iama)return!1
var a=(1-2*r)/(o.length+1),i=r,s=o.map(function(e){e.class=e.path.id.slice(0,17)
var t=find_border_by_id(e.fig),r=[t.x,t.y,t.width,t.height],n=r[0],o=r[1],a=r[2],i=r[3]
return e.box={x:n,y:o,width:a,height:i},e})
func=t%2==0?function(e,t){return e.box.x+e.box.width/2-(t.box.x+t.box.width/2)}:function(e,t){return e.box.y+e.box.height/2-(t.box.y+t.box.height/2)}
for(var l=s.sort(function(e,t){return func(e,t)}),c=_.groupBy(l,function(e,t){return e.class}),u=0;u<l.length;u++){for(var d=c[l[u].class].sort(function(e,t){return e.path<t.path}),f=d.length,h=0;h<f;h++){var p=d[h]
path.set_path_attrs(p.path),"from_"==p.side?cpa.pos2=i+a*(1+u+h):function(e,t){return!((e+t)%2==0&&e!=t||0==e&&3==t||3==e&&0==t||1==e&&2==t||2==e&&1==t)}(parseInt(cpa.from_side),parseInt(cpa.to_side))?cpa.pos1=i+a*(u+f)-a*h:cpa.pos1=i+a*(1+u+h),path.remake_path(!0,!0)}u+=h-1}}function get_points_along_path_generator(e,t,r){var n=e.getTotalLength()
n/t>500&&(t=parseInt(n/500))
var o=r
return regeneratorRuntime.mark(function a(){var i
return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(!(o<n-r)){a.next=7
break}return i=e.getPointAtLength(o),o+=t,a.next=5,[i.x,i.y]
case 5:a.next=0
break
case 7:case"end":return a.stop()}},a,this)})}function get_points_along_path(e,t,r){var n=e.getTotalLength()
n/t>500&&(t=parseInt(n/500))
for(var o=[],a=r;a<n-r;a+=t){var i=e.getPointAtLength(a)
o.push([i.x,i.y])}return o}function get_path_pos(e,t){var r=e.concat(t),n=Math.min.apply(null,r.map(function(e){return e[0]})),o=Math.min.apply(null,r.map(function(e){return e[1]}))
return[n,o,Math.max.apply(null,r.map(function(e){return e[0]}))-n,Math.max.apply(null,r.map(function(e){return e[1]}))-o]}function calc_bbox_endpoints(e,t,r,n){return{x:Math.min(e,r),y:Math.min(t,n),width:Math.abs(e-r),height:Math.abs(t-n)}}function get_path_from_custom_flow(e,t){function r(e,t,r,n){if(e<0||e>1){if(0==n&&e<0)return s.x+e
if(0==n&&e>0)return s.x+s.width+e
if(1==n&&e<0)return s.y+e
if(1==n&&e>0)return s.y+s.height+e}return e*r+t}var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],o=t.midpoints[0],a=t.midpoints[1],i=e.split(",").map(function(e){return parseFloat(e)}),s=calc_bbox_endpoints(o[0],o[1],a[0],a[1]),_=a[0]-o[0],l=a[1]-o[1]
i=i.map(function(e,t){return r(e,o[t%2],t%2==0?_:l,t%2)})
for(var c=[],u=0;u<i.length;u+=2)c.push([i[u],i[u+1]])
return t.cps=c,n?array_to_line([o].concat(c).concat([a]).map(function(e){return{x:e[0],y:e[1]}})):make_cubic_bezier_path([o].concat(c).concat([a]))}function get_manhattan_perc(e,t){var r=e,n=path_to_array(r.d),o=n[0],a=n.slice(-1)[0],o=[o.x,o.y],a=[a.x,a.y],i=parseInt(r.from_side)%2,s=1*!i
if(cpa.from_side==cpa.to_side){var _=Math.min.apply(null,[o,a].map(function(e){return e[s]-t[s]}))
return 1==cpa.from_side||2==cpa.from_side?-_:_}return 1-(t[s]-o[s])/(a[s]-o[s])}function path_to_array(e){data=e.match(/([A-Z])|(-?\d+\.?\d*)/g)
for(var t=[],r="",n=0;n<data.length;n+=0)isNaN(parseFloat(data[n]))?(r=data[n],n+=1,start_of_el=!0):(t.push({x:parseFloat(data[n]),y:parseFloat(data[n+1]),i:n,type:r,start:start_of_el}),n+=2,start_of_el=!1)
return t}function change_path_flow_and_style(e,t,r){path.set_path_attrs(currentElement),e?(cpa.flow=t||"fluid",currentElement.flow=t||"fluid",cpa.custom_flow=null,delete currentElement.custom_flow,active_style.line_flow=cpa.flow):(cpa.type=r||"plain",currentElement.type=r||"plain",active_style.line_style=cpa.type),path.redo_path(),form_update&&update_open_fs(currentElement)}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(e,t){var r=[],n=!0,o=!1,a=void 0
try{for(var i,s=e[Symbol.iterator]();!(n=(i=s.next()).done)&&(r.push(i.value),!t||r.length!==t);n=!0);}catch(e){o=!0,a=e}finally{try{n||null==s.return||s.return()}finally{if(o)throw a}}return r}function _arrayWithHoles(e){if(Array.isArray(e))return e}function show_line_control_points(e){gui_buttons.clear()
var t=path_to_array(e.d).map(function(t){var r=t.x,n=t.y
return{x:r+e.x,y:n+e.y}})
setup_path_control_point(e,t[0],"free_endpoint",0),setup_path_control_point(e,t[t.length-1],"free_endpoint",t.length-1),t.slice(1,-1).forEach(function(t,r){return setup_path_control_point(e,t,"free_endpoint",r+1)}),gui_buttons.set_el_with_cps(e),gui_buttons.render_path_control_points()}function show_path_control_points(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0]
gui_buttons.clear(),e=e||currentElement,gui_buttons.reset_path_control_points()
var t=e.d,r=path_to_array(t),n=e,o="path_group"==n.iama
if(n.iama,setup_path_control_point(n,r[0],"endpoint_from",cpa.from_side),setup_path_control_point(n,r[r.length-1],"endpoint_to",cpa.to_side),o&&"manhattan"==cpa.flow){var a={}
a.x=(r[1].x+r[2].x)/2,a.y=(r[1].y+r[2].y)/2,setup_path_control_point(n,a,"manhattan")}else o&&"straight"==cpa.flow?r.slice(1,-1).forEach(function(e,t){return setup_path_control_point(n,e,"free_endpoint",t+1,r.length)}):"hooked"==cpa.flow?setup_path_control_point(n,r[1],"free_endpoint",1,1,7):r.slice(1,-1).forEach(function(e,t){return setup_path_control_point(n,e,"bezier",t+1,r.length-2,7)})
gui_buttons.set_el_with_cps(n),gui_buttons.render_path_control_points()}function show_poly_points(e){"points"in e||console.log("onterecht aanroepen show poly points: geen points arr")
var t=e.points.map(function(t){var r=_slicedToArray(t,2),n=r[0],o=r[1]
return[e.x+e.width*n,e.y+e.height*o]})
gui_buttons.reset_path_control_points(),t.forEach(function(t,r){setup_path_control_point(e,{x:t[0],y:t[1]},"poly_point",r.toString())}),gui_buttons.set_el_with_cps(e),gui_buttons.render_path_control_points()}function setup_path_control_point(e,t,r,n,o){var a,i
if(arguments.length>5&&void 0!==arguments[5]&&arguments[5],"endpoint"==r.slice(0,8)){var s=end_point_move
a="red",i=n%2==1?"ns-resize":"ew-resize",n=!1}else if("manhattan"==r){var s=manhattan_move
a="purple",i=cpa.to_side%2==1?"ew-resize":"ns-resize"}else if("bezier"==r){var _=is_cubic_cp_of_type(n,o),s=cubic_move
a="free"==_?"greenyellow":"bound"==_?"blue":"purple",i="move"}else if("poly_point"==r){var s=poly_point_move
a="green",i="cell"}else if("free_endpoint"==r){var s=free_move
a="pink",i="cell"}else console.log("onbekende dragtype in add control_point")
var l=[-5,-5]
"path_basic"==e.iama||e.iama
var c={x:t.x+l[0],y:t.y+l[1],index:n,drag_type:r,drag_func:s,width:10,height:10,cursor:i,fill:a,iama:"path_cp"}
return gui_buttons.add_path_control_point(c),c}function move_all_control_points(e,t){"path_group"==gui_buttons.get_el_with_cps().iama?show_path_control_points(gui_buttons.get_el_with_cps()):gui_buttons.get_path_control_points_as_ref().forEach(function(r){r.x+=e,r.y+=t})}function move_cubic_cp(e,t,r,n,o){var a=arguments.length>5&&void 0!==arguments[5]&&arguments[5],i=[]
if("mid"!=(o=o||is_cubic_cp_of_type(n,r.length-2))||a)if("bound"!=o||a)r[n].x+=e,r[n].y+=t,i=[n]
else{var s=n%3==2?n+2:n-2
r[n].x+=e,r[n].y+=t,r[s].x-=e,r[s].y-=t,i=[n,s]}else i=[n-1,n,n+1],i.forEach(function(n){r[n].x+=e,r[n].y+=t})
"path_basic"==currentElement.iama||"country_basic"==currentElement.iama||(offset=[0,0])}function add_cp_to_path(e){var t=path_to_array(e.d).map(function(e){return[e.x,e.y]}),r="manhattan"==e.flow||"straight"==e.flow
if(r)var n=t.pop(),o=t.pop(),a=[(n[0]+o[0])/2,(n[1]+o[1])/2],i=t.concat([o,a,n])
else if(t.length>4){var i=casteljau_insert(t.splice(0,4),.5)
i=i.concat(t)}else var i=casteljau_insert(t,.5)
i=i.map(function(e){return{x:e[0],y:e[1]}})
var s=r?array_to_line(i):array_to_path(i)
e.d=s}function casteljau_insert(e,t){function r(r){var n=e.map(function(e){return e[r]}),o=_slicedToArray(n,4),a=o[0],i=o[1],s=o[2],_=o[3],l=(1-t)*a+t*i,c=(1-t)*i+t*s,u=(1-t)*s+t*_,d=(1-t)*l+t*c,f=(1-t)*c+t*u,h=(1-t)*d+t*f
return[[a,l,d,h],[h,f,u,_]]}var n=r(0),o=_slicedToArray(n,2),a=o[0],i=o[1],s=r(1),l=_slicedToArray(s,2),c=l[0],u=l[1],d=_.zip(a,c),f=_.zip(i,u)
return d.concat(f.splice(1))}function straighten_cps(e){var t=e.d,r=path_to_array(t),n=gui_buttons.get_path_control_points_as_ref()
if(r.length>4&&e.custom_flow)for(var o=3;o<r.length-2;o+=3){var a=function(e){var t=_slicedToArray(e,3),r=t[0],n=t[1],o=t[2]
return n.x=(r.x+o.x)/2,n.y=(r.y+o.y)/2,[n.x,n.y]}(r.slice(o-1,o+2)),i=_slicedToArray(a,2),s=i[0],_=i[1],l=n[o]
l.x=s,l.y=_}e.d=array_to_path(r),e.custom_flow=get_path_custom_flow_attrs(r),e.fixed_side=!0}function draw_slider_resize_points(){positions=[[slider.x-5,slider.y-5],[slider.x+slider.width-5,slider.y-5],[slider.x-5,slider.y+slider.height-5],[slider.x+slider.width-5,slider.y+slider.height-5]],gui_buttons.reset_path_control_points(),positions.forEach(function(e,t){gui_buttons.add_path_control_point({cursor:["nw-resize","ne-resize","sw-resize","se-resize"][t],index:t,x:e[0],y:e[1],drag_type:"poly_point",drag_func:poly_point_move,width:10,height:10,fill:"red",iama:"slider_cp"})}),gui_buttons.set_el_with_cps(slider),gui_buttons.render_path_control_points(!0)}function add_lines_to_control_points(e){function t(e,t){render_poly_line([[e.x,e.y],[t.x,t.y]],gui_context)}var r=arguments.length>1&&void 0!==arguments[1]&&arguments[1]
if(e.length>2)for(var n=e.slice(1,-1),o=0;o<n.length-1;o+=3)if(r){var a={x:n[o].x+r[0],y:n[o].y+r[1]},i={x:n[o+1].x+r[0],y:n[o+1].y+r[1]},s={x:n[o+2].x+r[0],y:n[o+2].y+r[1]}
t(a,i),t(i,s)}else t(n[o],n[o+1]),t(n[o+1],n[o+2])}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(e,t){var r=[],n=!0,o=!1,a=void 0
try{for(var i,s=e[Symbol.iterator]();!(n=(i=s.next()).done)&&(r.push(i.value),!t||r.length!==t);n=!0);}catch(e){o=!0,a=e}finally{try{n||null==s.return||s.return()}finally{if(o)throw a}}return r}function _arrayWithHoles(e){if(Array.isArray(e))return e}function append_options(e,t){t.forEach(function(t){$(e).append($("<option></option>").attr("value",t).text(t))})}function change_font(e){var t=e.target.innerText
"text"==currentElement.iama&&check_for_range_when_p_form_action(currentElement),manage_groups.get_group(currentElement,!0).forEach(function(e){"text"==e.iama?(e=part_to_chunk(e),change_font_fam_for_chunk(e,t),e.font_fam_inherited=!1):change_font_fam_for_border(e,t),resize_if_wanted_after_font_change(e)}),render_all(!1,!1,!0)}function change_font_fam_for_border(e,t){e.font_family=t,predef_styles.style_class_to_custom(e),get_text_with_border_id(e.id).forEach(function(e){e.font_fam_inherited&&change_font_fam_for_chunk(e,t)})}function change_font_fam_for_chunk(e,t){e.font_family=t}function resize_if_wanted_after_font_change(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n="width"==document.querySelector('#form_font_resize_action input[name="action"]:checked').value
"text"==e.iama&&(e=find_border_by_id(e.border_id))
var o=e.id
shapes_storage.texts[o]&&(path.change_collision_detection.turn_off_temporary(),path.change_all_paths_fixed.turn_on(),(n||!t&&r)&&recalc_border_width(o,!0,!0,key_pressed[16]||t),position_texts(o),(!n||!t&&r)&&recalc_border_height(o,key_pressed[16]),path.change_collision_detection.restore(),path.change_all_paths_fixed.turn_off())}function change_font_class(e){check_for_range_when_p_form_action()
var t="text"==currentElement.iama?shapes_storage.borders[currentElement.border_id].level:currentElement.level,r=infinity.get_font_size(t||"L1",e)
manage_groups.get_group(currentElement,!0).forEach(function(e){var t=e.font_size
change_font_size_of_el(e,r)&&resize_if_wanted_after_font_change(e,t<r,!0)}),document.querySelector("#form_font_size input").value=r,font_button_on_off(e),gui_buttons.frame_element(currentElement),set_current_element(currentElement)}function part_to_chunk(e){return e&&"parent"in e?e.parent:e}function change_font_size_of_el(e,t){if("text"==e.iama)e=part_to_chunk(e),e.font_size_inherited=!1,e.font_size=t,measure_text(e)
else{if("fa_icon"==e.iama)return e.font_size=t,e.width=t,e.height=t,!1
predef_styles.style_class_to_custom(e),e.font_size=t,get_text_with_border_id(e.id).forEach(function(e){e.font_size_inherited&&(e.font_size=t,measure_text(e))})}return!0}function font_button_on_off(e){d3.selectAll(".form_font_class button").classed("onoff-on",!1)
for(var t=document.querySelectorAll(".form_font_class button:nth-child("+(e+2)+")"),r=0;r<t.length;r++)t[r].classList.toggle("onoff-on",!0)}function toggle_font_class(e,t){font_button_on_off(predef_styles.is_font_class(e,t))}function get_height_of_par(e){for(var t=0,r=Object.entries(e),n=0;n<r.length;n++){var o=_slicedToArray(r[n],2)
line_num=o[0],parts=o[1],t+=Math.max.apply(null,parts.map(function(e){return e.height+(0==line_num)*(e.parent.margin_top||0)}))}return t}function get_height_per_par(e){for(var t={},r=Object.entries(e),n=0;n<r.length;n++){var o=_slicedToArray(r[n],2)
a=o[0],b=o[1]
var i=_.flatten(b.map(function(e){return e.parts})).filter(function(e){return e})
if(1==i.length)t[a]=i[0].parent.line_height*i[0].parent.font_size+(i[0].parent.margin_top||0)
else{var s=_.groupBy(i,function(e){return e.line_num})
t[a]=get_height_of_par(s)}}return t}function get_width_of_par(e){for(var t=0,r=Object.entries(e),n=0;n<r.length;n++){var o=_slicedToArray(r[n],2)
line_num=o[0],parts=o[1],t=Math.max(t,parts.map(function(e){return e.height}).reduce(function(e,t){return e+t}),0)}return t}function get_width_per_par(e){for(var t={},r=Object.entries(e),n=0;n<r.length;n++){var o=_slicedToArray(r[n],2)
a=o[0],b=o[1],t[a]=b.reduce(function(e,t){return t.width+e},0)+(b[0].margin_left||0)}return t}function measure_total_text_height(e){return Object.values(e).reduce(function(e,t){return e+t},0)}function measure_text_width(e){return gui_context.font=predef_styles.get_font_style(e),gui_context.measureText(e.text).width}function measure_max_text_width(e){return by_line=Object.values(e),Math.max.apply(void 0,by_line)}function recalc_text_widths(e){get_text_with_border_id(e).forEach(function(e){var t=measure_text_width(e)
e.width=Math.max(t,MIN_PAR_WIDTH)}),borders_bound.filter(function(t){return t.border_id==e}).forEach(function(e){return recalc_text_widths(e.id)})}function measure_text(e){e.height=round_to(e.font_size*e.line_height,2),e.width=round_to(measure_text_width(e),2)}function measure_par_width_at_each_letter(e){var t,r=[0]
t=get_dict_with_vals("parent"in e?e.parent:e)
try{e.text.split("").map(function(e){if(e in t)var n=t[e]
else var n=gui_context.measureText(e).width
r.push(n)})}catch(e){}for(var n=1;n<r.length;n++)r[n]+=r[n-1]
return r}function add_styling_to_par(e){check_for_range_when_p_form_action(),manage_groups.get_group(currentElement,!0).forEach(function(t){"font_style"in t?t.font_style.includes(e)?t.font_style=t.font_style.replace(e,"").trim():t.font_style+=" "+e:t.font_style=e}),render_all(!1,!1,!0)}function delete_par_margings(e){var t=get_chunks_by_par(e)
Object.keys(t).forEach(function(e){t[e].forEach(function(e){delete e.margin_top,delete e.margin_left})}),position_texts(e),render()}function change_par_margin(e,t,r){var n=get_chunks_in_par(e.border_id,e.par_num)
n.forEach(function(e){e.margin_top||(e.margin_top=0),e.margin_left||(e.margin_left=0),e.margin_top=Math.max(0,r+e.margin_top),e.margin_left=Math.max(0,t+e.margin_left)}),position_texts(e.border_id)
var o=find_border_by_id(e.border_id),a=n.slice(-1)[0].parts.slice(-1)[0],i=a.y+a.height-(o.y+o.height)
i>0&&(o.height+=i),render()}function find_text_with_web_links(){var e=/^(https?):\/\/[^\s\/$.?#].[^\s]*$/
return arr.filter(function(t){return t.text.match(e)}).map(function(e){return e.text})}function is_web_link(e){var t=/^(https?):\/\/[^\s\/$.?#].[^\s]*$/
return e.match(t)}function change_border_width(e){"text"==currentElement.iama&&check_for_range_when_p_form_action(),manage_groups.get_group(currentElement,!0).forEach(function(t){var r=t.iama,n="stroke_width"
"path_group"==r?n="plain"==t.type||"double"==t.type&&document.querySelector("#form_border_inner").checked?"inner_width":"outer_width":"text"==r&&(t=part_to_chunk(t),t.has_own_style||add_own_style_to_text(t)),t.rough&&delete t.redraw_data,t.style_class&&predef_styles.style_class_to_custom(t),t[n]=parseFloat(e.value),t.add_ons&&Object.keys(t.add_ons).forEach(function(r){t.add_ons[r].style.stroke_width=parseFloat(e.value)})}),set_current_element(currentElement,!0)}function change_border_dasharray(e,t){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2]
manage_groups.get_group(e,!0).forEach(function(e){"path_group"==e.iama&&"double"==cpa.type?(e.dasharray_inner=t,r&&(e.dasharray_outer=r)):"path_group"==e.iama?e.dasharray_inner=t:e.stroke_dasharray=t,delete e.border_sides_arr}),set_current_element(e),d3.selectAll("#form_border_side button.onoff-on").classed("onoff-on",!1)}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(e,t){var r=[],n=!0,o=!1,a=void 0
try{for(var i,s=e[Symbol.iterator]();!(n=(i=s.next()).done)&&(r.push(i.value),!t||r.length!==t);n=!0);}catch(e){o=!0,a=e}finally{try{n||null==s.return||s.return()}finally{if(o)throw a}}return r}function _arrayWithHoles(e){if(Array.isArray(e))return e}function find_merged_shapes(e){return merged.get_children(e)}function update_quick_grouping_forms(){manage_groups.permanent_group_active()?($(".when_group").css("display","flex"),$(".form_deselect_group").css("display","inline-block"),$(".form_temp_group_to_perm").css("display","none"),$(".form_temp_group_to_perm_deactivate").css("display","none")):manage_groups.get_current_group().length>0?($(".when_group").css("display","flex"),$(".form_temp_group_to_perm").css("display","inline-block"),$(".form_temp_group_to_perm_deactivate").css("display","inline-block"),$(".form_deselect_group").css("display","none")):($(".when_group").css("display","none"),$("#fs_grouping_quick .when_group").css("display","none"))}function disperse_group(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1.1,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1.1,n=get_bbox_of_group(e),o=_slicedToArray(n,4),a=o[0],i=(o[1],o[2])
o[3],e.forEach(function(e){var n=posit2.get_top_left(e,!0),o=_slicedToArray(n,2),s=o[0],_=o[1],s=(s-a)*t+a,_=(_-i)*r+i
e.x=s,e.y=_}),resize_protocol(e[0],0,0),render()}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(e,t){var r=[],n=!0,o=!1,a=void 0
try{for(var i,s=e[Symbol.iterator]();!(n=(i=s.next()).done)&&(r.push(i.value),!t||r.length!==t);n=!0);}catch(e){o=!0,a=e}finally{try{n||null==s.return||s.return()}finally{if(o)throw a}}return r}function _arrayWithHoles(e){if(Array.isArray(e))return e}function make_form_prelim(){document.querySelector("#form_border_inner_outer").style.display="none"}function set_fs(e){var t=e.getAttribute("i_am_a"),t=d3.select(e).classed("polygon_basic")&&"slide"!=t?"polygon":t
make_form_prelim(),minimal_menu&&all_form_elements.filter(function(e){return-1==non_minimal_fieldsets.indexOf(e)}),minimal_menu&&non_minimal_fieldsets.forEach(function(e){return d3.select("#"+e).style("display","none")}),e.querySelector("article")&&(e.querySelector("article").classList.contains("has_background")&&set_background_button(e.querySelector("article")),document.querySelector("#form_article_padding input").value=parseInt(e.querySelector("article").style.padding||0))}function fill_forms(e){e=part_to_chunk(e)
var t=e.iama
if("slider"==t)return!1
fill_fs_infinity(e),"text"==t?(fill_fs_border(e),fill_fs_para(e),fill_fs_font(e)):"fa_icon"==t?(fill_fs_border(e),fill_font_size(e)):"path_group"==t?(fill_fs_border(e),fill_fs_path(e),fill_fs_path_advanced(e),fill_fs_path_label(e)):"path_addon"==e.iama?fill_fs_path_label(e):"canvas"==e.iama||("text_block"==t||"text_path"==t?fill_fs_border(e):"drawing"==t?(fill_fs_border(e),fill_fs_drawing(e)):"knot"==t||(t?(fill_fs_border(e),fill_fs_font(e),fill_fs_fig_stuff(e),"path_basic"==t&&fill_fs_drawing(e),"line_for_graph"==t&&(fill_fs_line_for_graph(e),fill_fs_graphing(e)),minimal_menu||fill_fs_merge(e)):console.log("fillform onbekend type",e))),help_on&&display_help(e),gui_buttons.add_marker_to_example_style(e.style_class),form_filled=!0}function display_help(e){"text"==e.iama?text_to_help_pane(help_text.P):"path_addon"==e.iama?text_to_help_pane(help_text.path_addon):"canvas"==e.iama?text_to_help_pane(help_text.svg):"path_group"==e.iama?text_to_help_pane(help_text.path_group):"drawing"==e.iama?text_to_help_pane(help_text.drawing_lineto):e.shape in help_text?text_to_help_pane(help_text[e.shape]):-1!=polygon_shapes.indexOf(e.shape)&&text_to_help_pane(help_text.polygon)}function set_invalid_form_inputs_to_zero(){return[[document.querySelector("#form_border_width input"),1],[document.querySelector("#form_paragraph_padding_left input"),0],[document.querySelector("#form_paragraph_padding_top input"),0],[document.querySelector("#form_font_size input"),0],[document.querySelector("#form_border_dash input"),0]].forEach(function(e){var t=_slicedToArray(e,2),r=t[0],n=t[1]
if("Nan"==r.value||""==r.value)r.value=0
else{var o=/[+-]?\d+(\.\d+)?/g,a=r.value,i=a.match(o)
i=i&&1==i.length?parseFloat(i[0]).toFixed(n):i?i.join(" "):"",r.value=i}}),!1}function display_fs_for_shape(e){"parent"in e&&(e=e.parent)
var t=minimal_menu?all_form_elements.filter(function(e){return-1==non_minimal_fieldsets.indexOf(e)}):all_form_elements
minimal_menu&&non_minimal_fieldsets.forEach(function(e){return d3.select("#"+e).style("display","none")})
var r
"text"==e.iama?r=paragraph_form_elements.slice():"path_group"==e.iama?r=path_form_elements.slice():"fa_icon"==e.iama?r=figs.fa_icon.my_form_elements.slice():"drawing"==e.iama?(r=drawing_form_elements.slice(),"line"==e.type&&r.push("fs_rough")):"path_addon"==e.iama?r=path_add_on_form_elements.slice():"canvas"==e.iama?r=svg_form_elements.slice():e.is_cell?r=figs.cell_basic.my_form_elements.slice():e.shape?(e.shape in poly_config?r=figs.polygon.my_form_elements.slice():e.shape in figs?r=figs[e.shape].my_form_elements.slice():"custom"==e.shape&&(r=figs.poly_point.my_form_elements.slice()),e.id in shapes_storage.images&&r.push("fs_image")):r="math_shape"==e.iama?["form_fill","fs_border","fs_colors","colors_svg","ffw_fill","ffw_stroke","fs_grouping_quick"]:[],hide_or_display_form_fields(t,r),form_filled=!1,update_open_fs(e)}function hide_or_display_form_fields(e,t){e.forEach(function(e){-1!=t.indexOf(e)?el=d3.select("#"+e).style("display","flex"):d3.select("#"+e).style("display","none")})}function update_open_fs(e){var t=document.querySelectorAll("#edit_mode_menu fieldset:not(.collapsed):not(#fs_help)")
if(!form_hidden&&help_on&&display_help(e),fill_fs_infinity(e),1==t.length){if("none"==t[0].style.display)return!1
var r=t[0].id
"fs_border"==r?fill_fs_border(e):"fs_font"==r?fill_fs_font(e):"fs_fig_stuff"==r?fill_fs_fig_stuff(e):"fs_image"==r||("fs_para"==r?fill_fs_para(e):"fs_path"==r?fill_fs_path(e):"fs_path_label"==r?fill_fs_path_label(e):"fs_path_advanced"==r||("fs_graphing"==r||"fs_board"==r?(fill_fs_graphing(e),"line_for_graph"==iama(e)&&fill_fs_line_for_graph(e)):"fs_drawing"==r?fill_fs_drawing(e):"fs_grouping"==r&&fill_fs_merge(e)))}}function fill_fs_line_for_graph(e){$(".cm_graph_formula_text").prop("value",find_g(e).getAttribute("my_func")),$(".form_graph_when_line").css("display","block")}function fill_fs_graphing(e){var t=if_line_to_graph(e)
$(".form_graph_crossed_axis").prop("checked",t.hasAttribute("graph_axis_crossed")),$(".form_graph_grid").prop("checked",t.hasAttribute("gridded"))
var r=t.getAttribute("domain_x").split(",").map(function(e){return parseFloat(e)}),n=_slicedToArray(r,2),o=n[0],a=n[1]
if($(".cm_graph_min_domain").val(o),$(".cm_graph_max_domain").val(a),$(".cm_graph_formula_text").val(""),$(".form_graph_num_ticks_x").val(t.querySelector(".x_axis").getAttribute("num_ticks")),$(".form_graph_num_ticks_y").val(t.querySelector(".y_axis").getAttribute("num_ticks")),t.hasAttribute("asymptotic")||t.hasAttribute("fixed_range")){var i=t.getAttribute("domain_y").split(",").map(function(e){return parseFloat(e)}),s=_slicedToArray(i,2),_=s[0],l=s[1]
$(".cm_graph_min_range").val(l),$(".cm_graph_max_range").val(_),document.querySelector("#form_if_asymptotic").style.display="flex"}else document.querySelector("#form_if_asymptotic").style.display="none"
if($(".form_show_axis_num").prop("checked",!t.classList.contains("no_nums")),"axes_board"==iama(t)){var c=t.classList.contains("no_nums")?"none":"block"
document.querySelector("#form_domain_and_ranges").style.display=c}}function fill_fs_path_advanced(e){}function fill_fs_merge(e){document.querySelector(".form_ungroup_all_children").parentElement.style.display=merged.is_parent(e)?"inherit":"none",document.querySelector("#form_ungroup").parentElement.style.display=merged.is_child(e)?"inherit":"none"}function fill_fs_path_label(e){if("path_group"==e.iama||"drawing"==e.iama){var t="add_ons"in e?Object.keys(e.add_ons):[]
if(!(t.length>0))return $(".if-arrow").css("display","none"),!1
e=e.add_ons[t[0]],$(".if-arrow").css("display","block")}document.querySelector("#form_add_on_height input").value=e.height,document.querySelector("#form_add_on_width input").value=e.width}function update_path_direction_buttons(){d3.selectAll(".path_from_to").classed("on",!1),document.querySelectorAll("#cm-path-directions-from .path_from_to")[parseInt(cpa.from_side)].classList.toggle("on",!0),document.querySelectorAll("#cm-path-directions-to .path_from_to")[parseInt(cpa.to_side)].classList.toggle("on",!0),document.querySelectorAll("#form-path-directions-from .path_from_to")[parseInt(cpa.from_side)].classList.toggle("on",!0),document.querySelectorAll("#form-path-directions-to .path_from_to")[parseInt(cpa.to_side)].classList.toggle("on",!0)}function fill_fs_path(e){toggle_path_reset_button(e),$(".form_path_style2 select").val(e.type),update_path_direction_buttons()}function toggle_path_reset_button(e){e.fixed_side||e.custom_flow?$(".form_path_reset").css("display","flex"):$(".form_path_reset").css("display","none")}function fill_fs_para(e){e=part_to_chunk(e)
var t=e.line_height
document.querySelector("#form_paragraph_line_height input").value="normal"==t?1.4:parseFloat(t),document.querySelector("#form_paragraph_padding_left input").value=e.margin_left||0,document.querySelector("#form_paragraph_padding_top input").value=e.margin_right||0}function fill_fs_fig_stuff(e){document.querySelector("#form_article_padding input").value=e.padding,set_language_for_syntax_highlight(e)}function fill_font_size(e){document.querySelector("#form_font_size input").value=e.font_size
var t="text"==e.iama?find_border_by_id(e.border_id).level:e.level
toggle_font_class(e.font_size,t)}function fill_fs_font(e){"text"==e.iama&&(e=part_to_chunk(e)),fill_font_size(e),toggle_font_alignment(e),change_selected_in_font_list(document.querySelector("#form_fonts_list"),e.font_family)}function fill_fs_infinity(e){$("#form_set_infinity_level").find("button").toggleClass("onoff-on",!1),"border"==e.iama?$('#form_set_infinity_level button[value="'.concat(e.level||"L1",'"]')).toggleClass("onoff-on",!0):$('#form_set_infinity_level button[value="'.concat(infinity.get_level()||"L1",'"]')).toggleClass("onoff-on",!0)}function fill_fs_border(e){var t=e.iama,r=0
document.querySelector("#form_border_inner").checked=!0,document.querySelector("#form_border_inner_outer").style.display="none","path_group"==t?("double"==e.type&&(document.querySelector("#form_border_inner_outer").style.display="inherit"),"double"!=e.type||document.querySelector("#form_border_inner_outer input").checked?(r=e.inner_width,document.querySelector("#form_border_dash input").value=e.dasharray_inner||""):(r=e.outer_width,document.querySelector("#form_border_dash input").value=e.dasharray_outer||"")):(r=e.stroke_width,document.querySelector("#form_border_dash input").value=e.stroke_dasharray||""),document.getElementById("form_border_width").querySelector("input").value=r,document.getElementById("cm_border_width").querySelector("input").value=r,document.getElementById("form_article_padding").querySelector("input").value=e.padding,$(".form_fig_has_path").css("display",0==path.find_connections(e.id).length?"none":"flex"),document.querySelector("#form_border_side").style.display="path_group"==t||"text"==t||e.rough||"ellipse"==e.shape?"none":"flex","path_group"!=e.iama||"double"!=e.type||e.rough?e.rough?(document.querySelector("#form_border_dash_double").style.display="none",document.querySelector("#form_border_dash_single").style.display="none"):(document.querySelector("#form_border_dash_double").style.display="none",document.querySelector("#form_border_dash_single").style.display="block"):(document.querySelector("#form_border_dash_double").style.display="block",document.querySelector("#form_border_dash_single").style.display="none"),set_language_for_syntax_highlight(e),(t||"P"==tag)&&toggle_border_buttons(e),set_invalid_form_inputs_to_zero()}function set_language_for_syntax_highlight(e){"syntax_highlighted"in e&&(document.querySelector("#form_language_for_syntax_highlight").value=e.syntax_highlighted)}function fill_fs_drawing(e){}function toggle_border_buttons(e){if(buttons=document.querySelectorAll("#form_border_side button"),"border_sides_arr"in e){var t=e.border_sides_arr
_.forEach(buttons,function(e,r){return e.classList.toggle("onoff-on",t[r])})}else _.forEach(buttons,function(e){return e.classList.toggle("onoff-on",!1)})}function toggle_font_alignment(e){var t=".text_align_"+e.text_align
d3.selectAll(".text_align_left, .text_align_center, .text_align_right").classed("onoff-on",!1),d3.selectAll(t).classed("onoff-on",!0)}function position_path_direction_buttons(e){function t(e,t){var r="30px",n={0:[0,0],1:[r,0],2:[0,r],3:[r,r]},o=_slicedToArray(n[e],2),a=o[0],i=o[1],s=_slicedToArray(n[t],2),_=s[0],l=s[1]
d3.selectAll(".path_direction_tail").style("margin-left",a),d3.selectAll(".path_direction_tail").style("margin-top",i),d3.selectAll(".path_direction_head").style("margin-left",_),d3.selectAll(".path_direction_head").style("margin-top",l)}var r=path_to_array(e.d),n=r[0],o=r.slice(-1)[0],a=o.x-n.x,i=o.y-n.y
Math.min(Math.abs(a),Math.abs(i))/Math.abs(Math.max(Math.abs(a),Math.abs(i)))<.25?Math.abs(a)<Math.abs(i)?i>0?t(0,2):t(2,0):a>0?t(0,1):t(1,0):a>0&&i>0?t(0,3):a<0&&i>0?t(1,2):a>0&&i<0?t(2,1):t(3,0)}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function _iterableToArray(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e)){for(var t=0,r=new Array(e.length);t<e.length;t++)r[t]=e[t]
return r}}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(e,t){var r=[],n=!0,o=!1,a=void 0
try{for(var i,s=e[Symbol.iterator]();!(n=(i=s.next()).done)&&(r.push(i.value),!t||r.length!==t);n=!0);}catch(e){o=!0,a=e}finally{try{n||null==s.return||s.return()}finally{if(o)throw a}}return r}function _arrayWithHoles(e){if(Array.isArray(e))return e}function find_largest_rect(e){function t(e,t){_[l].one=e,_[l].two=t,l+=1}function r(){return l-=1,[_[l].one,_[l].two]}function n(t){e[t].forEach(function(e,t){return s[t]=e?s[t]+1:0})}var o={one:0,two:0},a={one:-1,two:-1},i=0,s=[],_=[],l=0,c=e[0].length,u=e.length
return function(){var e,l
for(e=0;e<c+1;e+=1)_[e]={one:0,two:0},s[e]=0
for(l=0;l<u;l+=1){var d=0
for(n(l),e=0;e<c+1;e+=1)if(s[e]>d&&(t(e,d),d=s[e]),s[e]<d){var f,h,p
do{var m=r(),g=_slicedToArray(m,2)
f=g[0],h=g[1],p=d*(e-f),p>i&&(i=p,o.one=f,o.two=l,a.one=e-1,a.two=l-d+1),d=h}while(s[e]<d)
0!=(d=s[e])&&t(f,h)}}return[o.one,o.two,a.one,a.two]}()}function get_pos_for_foreignObject(e){if("ellipse"==e.shape){var t=e.width/2,r=e.height/2,n=[(2*t-Math.sqrt(2)*t)/2/e.width,(2*r-Math.sqrt(2)*r)/2/e.height]
d=Math.sqrt(2)*t/e.width,u=Math.sqrt(2)*r/e.height}else var o=find_inside_pos_for_fo(e),a=_slicedToArray(o,3),i=_slicedToArray(a[0],2),s=i[0],_=i[1],l=a[1],c=a[2],n=[(s-e.x)/e.width,(_-e.y)/e.height],u=c/e.height,d=l/e.width
return{fo_top_left:n,fo_height:u,fo_width:d}}function find_inside_pos_for_fo(e){for(var t=[e.x,e.y],r=t[0],n=t[1],o=[e.width,e.height],a=o[0],i=o[1],s=[],_=0;_<=i;_+=5){for(var l=[],c=0;c<=a;c+=5)l.push([c+r,_+n])
s.push(l)}var u=get_points_on_border(e),d=s.map(function(e){return e.map(function(e){return point_is_inside(e,u)})}),f=find_largest_rect(d),h=_slicedToArray(f,4)
tl_x=h[0],br_y=h[1],br_x=h[2],tl_y=h[3]
var p=[r+5*tl_x,n+5*tl_y],a=5*(br_x-tl_x+1),i=5*(br_y-tl_y+1)
return[p,a,i]}function get_points_on_border(e){var t=e.points,r=[e.x,e.y,e.width,e.height],n=r[0],o=r[1],a=r[2],i=r[3]
return t.map(function(e){var t=_slicedToArray(e,2),r=t[0],s=t[1]
return[n+r*a,o+s*i]})}function for_triangle(e,t,r,n){var o=[0,1,2]
o.splice(e,1)
var a=o[0],i=o[1],s=Math.min(Math.abs(t[e][0]-t[a][0]),Math.abs(t[e][1]-t[a][1])),_=Math.min(Math.abs(t[e][0]-t[i][0]),Math.abs(t[e][1]-t[i][1])),l=s<_?a:i
return inbetween2(t[e],t[l],r)||(o.splice(o.indexOf(l),1),l=o[0]),calc_x_from_y(t[e],t[l],r[n],n%2==0,!0)}function get_offset(e,t,r,n,o){n=parseInt(n),o=parseFloat(o)
var a=[[t*o,0],[t,r*o],[t*o,r],[0,r*o]][n],i=e.points.map(function(e){var n=_slicedToArray(e,2),o=n[0],a=n[1]
return[t*o,r*a]}),s=n%2==0?0:1,_=find_index_of_closest_point(i,a),l=i.length
if(3==i.length)var c=for_triangle(_,i,a,s)
else{var u=inbetween2(i[_],i[(_+1)%l],a,0,1),d=inbetween2(i[l*(_<1)+(_-1)%l],i[_],a,0,1)
if(u&&!d)var f=(_+1)%l
else if(d&&!u)var f=l*(_<1)+(_-1)%l
else if(u&&d)if(between_two_lines(i[_],i[(_+1)%l],[a]))var f=(_+1)%l
else if(between_two_lines(i[l*(_<1)+(_-1)%l],i[_],[a]))var f=l*(_<1)+(_-1)%l
else var h=find_closest_projectable(n,i,a),p=_slicedToArray(h,2),_=p[0],f=p[1]
else var m=find_closest_projectable(n,i,a),g=_slicedToArray(m,2),_=g[0],f=g[1]
var c=calc_x_from_y(i[_],i[f],a[s],s%2==0,!0)}return[c[0],c[1]]}function get_offset_for_ellipse(e,t,r,n,o,a){var i=Math.PI,s=(1-a)*i+0*a
return 0==o?[t+t*Math.cos(s),n+-n*Math.sin(s)]:2==o?[t+t*Math.cos(s),n+n*Math.sin(s)]:1==o?[t+t*Math.sin(s),n+n*Math.cos(s)]:3==o?[t+-t*Math.sin(s),n+n*Math.cos(s)]:void 0}function path_placement_correction(e,t,r,n,o,a){if("ellipse"==e.shape){var i=o/2,s=a/2,_=get_offset_for_ellipse(r,i,n,s,0,t),l=get_offset_for_ellipse(r,i,n,s,2,t),c=get_offset_for_ellipse(r,i,n,s,1,t),u=get_offset_for_ellipse(r,i,n,s,3,t)
return[_,c,l,u]}var d=get_poly_config(e),_=get_offset(d,o,a,0,t),l=get_offset(d,o,a,2,t),c=get_offset(d,o,a,1,t),u=get_offset(d,o,a,3,t)
return[_,c,l,u]}function find_index_of_closest_point(e,t){var r=e.map(function(e){return pyth_dist(e,t)})
return r.indexOf(d3.min(r))}function pyth_dist(e,t){return Math.pow(e[0]-t[0],2)+Math.pow(e[1]-t[1],2)}function between_two_lines(e,t,r){for(var n,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,a=t[0]-e[0],i=t[1]-e[1],s=i/a,_=e[1]-e[0]*s,l=0;l<r.length;l++){var c=r[l]
if(s==1/0||s==-1/0?(t1=e[0]+o,t2=e[0]-o,n=0):0==s?(t1=e[1]+o,t2=e[1]-o,n=1):(t1=s*c[0]+_+o,t2=s*c[0]+_-o,n=1),!(c[n]>t1&&c[n]<t2||c[n]<t1&&c[n]>t2))return!1}return!0}function find_closest_projectable(e,t,r){var n=_.range(t.length).map(function(e){return[e,(e+1)%t.length]}),o=0==e||2==e?0:1,a=0==e||2==e?1:0,i=n.map(function(e){return[t[e[0]][o],t[e[1]][o]].sort(function(e,t){return e>t})}),s=n.map(function(e){return[t[e[0]][a],t[e[1]][a]].sort(function(e,t){return e>t})}),l=r[o]
projections=i.map(function(e,t){return l>=e[0]&&l<=e[1]?Math.min(Math.abs(r[a]-s[t][a]),Math.abs(r[a]-s[t][a])):1/0})
var c=Math.min.apply(null,projections)
return n[projections.indexOf(c)]}function calc_x_from_y(e,t,r,n,o){var a=t[0]-e[0],i=t[1]-e[1],s=i/a,_=e[1]-e[0]*s
if(0==s)return o?[r,e[1]]:r
if(s==1/0||s==-1/0)return o?[e[0],r]:r
var l=_+s*r,c=(r-_)/s
return o?n?[r,l]:[c,r]:n?l:c}function find_closest_neighbour_fallback(e,t){var r,n=Object.values(shapes_storage.borders).concat(Object.values(shapes_storage.math_shapes)).filter(function(t){return t!=e}),o=n.map(function(e){return posit2.get_mid_of_side(e,(t+2)%4)}),a=posit2.get_mid_of_side(e,t)
0==t&&(r=function(e){return e[1]<a[1]}),2==t&&(r=function(e){return e[1]>a[1]}),3==t&&(r=function(e){return e[0]<a[0]}),1==t&&(r=function(e){return e[0]>a[0]}),o=_.zip(n,o)
var i=o.filter(function(e){return r(e[1])})
if(0==i.length)return!1
for(var s=i.map(function(e){return pyth_dist(e[1],a)}),l=1/0,c=0,u=0;u<s.length;u++)s[u]<l&&(l=s[u],c=u)
return i[c][0].id}function find_closest_neighbour(e,t){var r,n=(arguments.length>2&&void 0!==arguments[2]&&arguments[2],!(arguments.length>3&&void 0!==arguments[3])||arguments[3]),o=Object.values(shapes_storage.borders).concat(Object.values(shapes_storage.math_shapes)),a=o.map(function(e){return posit2.tlbr(e)}),i=posit2.tlbr(e)
0==t&&(r=[(i.left+i.right)/2,i.bottom]),2==t&&(r=[(i.left+i.right)/2,i.top]),1==t&&(r=[i.left,(i.bottom+i.top)/2]),3==t&&(r=[i.right,(i.bottom+i.top)/2])
var s
0==t&&(s=function(e){return r[1]>e.bottom&&(inbetween(i.left,i.right,e.left)||inbetween(i.left,i.right,e.right)||covered(i.left,i.right,e.left,e.right))}),2==t&&(s=function(e){return r[1]<e.top&&(inbetween(i.left,i.right,e.left)||inbetween(i.left,i.right,e.right)||covered(i.left,i.right,e.left,e.right))}),1==t&&(s=function(e){return r[0]<e.left&&(inbetween(i.top,i.bottom,e.top)||inbetween(i.top,i.bottom,e.bottom)||covered(i.top,i.bottom,e.top,e.bottom))}),3==t&&(s=function(e){return r[0]>e.right&&(inbetween(i.top,i.bottom,e.top)||inbetween(i.top,i.bottom,e.bottom)||covered(i.top,i.bottom,e.top,e.bottom))}),a=_.zip(o,a)
var l=a.filter(function(e){return s(e[1])})
if(0==l.length)return!!n&&find_closest_neighbour_fallback(e,t)
for(var c=l.map(function(e){return pyth_dist([e[1].left,e[1].top],r)}),u=1/0,d=0,f=0;f<c.length;f++)c[f]<u&&(u=c[f],d=f)
return c[d]<1e6||!n?l[d][0].id:!!n&&find_closest_neighbour_fallback(e,t)}function inbetween(e,t,r){return e<=r&&t>=r}function covered(e,t,r,n){return e<r&&t>n||r<e&&n>t}function inbetween2(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,a=Math.min(e[0],t[0]),i=Math.max(e[0],t[0]),s=Math.min(e[1],t[1]),_=Math.max(e[1],t[1]),l=i-a,c=_-s
if(l<n){var u=(n-l)/2
a-=u,i+=u}if(c<n){var u=(n-c)/2
s-=u,_+=u}o>0&&(a-=o,s-=o,i+=o,_+=o)
var d=a<=r[0]&&r[0]<=i,f=s<=r[1]&&r[1]<=_
return d&&f}function point_is_inside(e,t){for(var r=e[0],n=e[1],o=!1,a=0,i=t.length-1;a<t.length;i=a++){var s=t[a][0],_=t[a][1],l=t[i][0],c=t[i][1]
_>n!=c>n&&r<(l-s)*(n-_)/(c-_)+s&&(o=!o)}return o}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(e,t){var r=[],n=!0,o=!1,a=void 0
try{for(var i,s=e[Symbol.iterator]();!(n=(i=s.next()).done)&&(r.push(i.value),!t||r.length!==t);n=!0);}catch(e){o=!0,a=e}finally{try{n||null==s.return||s.return()}finally{if(o)throw a}}return r}function _arrayWithHoles(e){if(Array.isArray(e))return e}function check_if_data_is_valid(e){return"gs"in e&&(e=e.gs),new Set(["borders","borders_bound","drawings","icons","images","knots","paths","texts"," math_shapes"]),!0}function check_if_old_data_is_valid(e){if("gs"in e&&(e=e.gs),"[object Array]"!=Object.prototype.toString.call(e))return text_to_feedback_pane("nothing to load found in file",!0),!1
if(0==e.length)return!1
var t=Object.keys(e[0])
return!!_.all(["attrs","element","children"].map(function(e){return!!t.find(function(t){return t==e})}))||(text_to_feedback_pane("unknown data in json file. cannot parse",!0),!1)}function old_to_new(e,t){function r(e){var t=/style_[0-9]+/,r=e.match(t)
return!!r&&"style_"+(parseInt(r[0].split("_")[1])+0)}function n(e,t,r,n){return find_style_in_string(t,e)||(n&&(e=n),e=e.trim(),r&&e in predef_styles.get_classes()[r]?predef_styles.get_classes()[r][e]:void 0)}function o(e,t){var r=find_style_in_string(e,"font-size")
if(r)return parseInt(r)
var n=t.match(/font[0-9]/)
return n?predef_styles.font_class_to_size(n[0]):void 0}function a(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[0,0],l=e.attrs.i_am_a
if("knot"==l){var c=e.attrs.id,u=e.attrs.transform.match(/\d+\.?\d*,\d+\.?\d*/)[0].split(",").map(function(e){return parseInt(e)}),d={x:u[0],y:u[1],iama:"knot",width:20,height:20,id:e.attrs.id}
shapes_storage.knots.push(d)}else if("path_group"==l){var c=e.attrs.id,f={id:c,from_side:parseInt(e.attrs.from_side),to_side:parseInt(e.attrs.to_side),type:e.attrs.type,flow:e.attrs.flow,pos1:parseFloat(e.attrs.pos1),pos2:parseFloat(e.attrs.pos2),d:e.children.filter(function(e){return"click_catcher"==e.attrs.class})[0].attrs.d,iama:"path_group",fill:"black",inner_width:2,outer_width:4,add_ons:{}}
if("style"in e.attrs){if(e.attrs.style.includes("stroke-dasharray"))var h=find_style_in_string(e.attrs.style,"stroke-dasharray")
h&&(f.dasharray_inner=h.split(",").map(function(e){return parseInt(e)})),f.inner_width=parseInt(find_style_in_string(e.children[0].attrs.style,"stroke-width")),f.fill=find_style_in_string(e.attrs.style,"stroke")}"custom_flow"in e.attrs&&(f.custom_flow=e.attrs.custom_flow),e.children.slice(2).forEach(function(e){if("arrow_1"==e.attrs.class||"arrow_0"==e.attrs.class){var t=e.attrs,a="arrow_1"==t.class?"head":"tail"
f.add_ons[a]={},f.add_ons[a].figure=t.type,f.add_ons[a].width=parseInt(t.arrow_width),f.add_ons[a].height=parseInt(t.arrow_height)}if("text_block"==e.attrs.i_am_a){var i=r(e.attrs.class)
i&&(active_style.style_class=i)
var s=get_default_border(),_=e.attrs.transform.match(/\d+\.?\d*,\d+\.?\d*/)[0].split(",").map(function(e){return parseInt(e)})
s.bound=!0,s.path_id=f.id,s.x=_[0],s.y=_[1],s.width=parseInt(e.attrs.width),s.height=parseInt(e.attrs.height),s.id=e.attrs.id,s.font_family=n("font-family",e.attrs.style,i,"font_family")||"Open Sans",s.font_size=o(e.attrs.style,e.attrs.class),s.stroke_width=parseInt(n("stroke-width",e.attrs.style,i,"stroke_width")),s.stroke=n("stroke",e.attrs.style,i)||"black",s.text_align=n("text-align",e.attrs.style,i,"text-align")||"center"
var l=get_default_text(s)
s.pos_perc=parseFloat(e.attrs.pos_perc),l.text=e.children[1].innerText,e.children[1].children&&(l.text+=e.children[1].children.map(function(e){return e.innerText}).join(" ")),shapes_storage.borders_bound[s.id]=s,s.num_pars=1,shapes_storage.add_text(l),position_texts(s.id)}}),s.push(f)}else if(-1!=["rect_basic","cell_basic","ellipse_basic","rect_canvas","text_basic"].indexOf(l)||-1!=Object.keys(poly_config).indexOf(l)){var p=function(e,t){var a=get_default_text(y),s="class"in t&&r(t.class)
return s&&(a.style_class=s),s||(s=i||"style_24"),active_style.style_class=s,a.text=e.innerText,a.font_family=n("font-family",t.style,s,"font_family")||"Open Sans",a.font_fam_inherited=find_style_in_string(t.style,"font_family"),a.font_size=o(t.style,t.class),a.font_size_inherited=!1,a.font_size||(a.font_size=y.font_size||12,a.font_size_inherited=!0),a.fill=n("background-color",t.style,s,"fill")||"rgba(0,0,0,0)",a.color=n(" color",t.style,s,"color")||"black",a.has_own_style=find_style_in_string(t.style,"fill")||find_style_in_string(t.style,"color"),measure_text(a),a},c=e.attrs.id,m=r(e.attrs.class)
m&&(active_style.style_class=m)
var g=e.attrs.transform.match(/\d+\.?\d*,\d+\.?\d*/)[0].split(",").map(function(e){return parseInt(e)}),y=get_default_border()
y.x=g[0]+t[0],y.y=g[1]+t[1],y.width=parseInt(e.attrs.width),y.height=parseInt(e.attrs.height),y.id=c,y.iama="border",y.shape=function(e){return"ellipse_basic"==e?"ellipse":-1!=Object.keys(poly_config).indexOf(e)?e:"rect"}(l),y.fixed_size=!0,y.font_family=n("font-family",e.attrs.style,m,"font_family")||"Open Sans",y.font_size=o(e.attrs.style,e.attrs.class),y.stroke_width=parseInt(n("stroke-width",e.attrs.style,m,"stroke_width")),y.stroke=n("stroke",e.attrs.style,m)||"black",y.text_align=n("text-align",e.attrs.style,m,"text-align")||"center","cell_basic"==l&&(y.table=e.attrs.table,y.vt=e.attrs.vt)
var v=e.children.filter(function(e){return"foreignObject"==e.element}),b=v.length>0?v[0].children[0].children:[]
b||(b=[]),"text_basic"==l&&(b=[{children:[e.children[0]],attrs:e.children[0].attrs}])
var w=0
i=m,b.forEach(function(e,t){if(!e.children)return!1
e.children.forEach(function(r){r=p(r,_.isEmpty(r.attrs)?e.attrs:r.attrs),r.par_num=t,r.text&&""!=r.text&&shapes_storage.add_text(r)}),w=t}),y.num_pars=w+1,shapes_storage.borders[y.id]=y,position_texts(y.id)
try{v[0].children[0].attrs.class.includes("has_background")&&function(e,t){add_background_image(t,e.attrs.style.match(/data:image\/png;base64,(.+?)\);/)[0].slice(0,-3),!1)}(v[0].children[0],y)}catch(e){}e.children.filter(function(e){return"g"==e.element}).forEach(function(e){return a(e,[y.x,y.y])})}else console.log(e)}!function(e){for(var t=e.styles.slice(1),r=0;r<24;r++){var n=t[23-r],o=find_style_in_string(n,"font-family")
o&&(predef_styles.get_classes()["style_"+r].font_family=o)
var a=find_style_in_string(n," color")
a&&(predef_styles.get_classes()["style_"+r].color=a)
var i=find_style_in_string(n,"fill")
i&&(predef_styles.get_classes()["style_"+r].fill=i)
var s=find_style_in_string(n,"stroke")
s&&(predef_styles.get_classes()["style_"+r].stroke=s)
var _=find_style_in_string(n,"stroke-width")
_&&(predef_styles.get_classes()["style_"+r].stroke_width=parseFloat(_))
var l=find_style_in_string(n,"text-align")
l&&(predef_styles.get_classes()["style_"+r].alignment=l)
var c=find_style_in_string(n,"padding")
c&&(predef_styles.get_classes()["style_"+r].padding=parseInt(c))}for(var u=38;u<43;u++){var d=find_style_in_string(t[u],"font-size")
d&&predef_styles.set_font_size_of_predef(u-38,parseInt(d))}}(t),predef_styles.load(predef_styles.get_classes())
var i,s=[]
e.forEach(function(e){return a(e)}),Object.values(shapes_storage.borders).forEach(function(e){"table"in e&&(e.is_cell=!0)}),s.forEach(function(e){return shapes_storage.paths.push(e)}),s.forEach(function(e){if(path.set_path_attrs(e),cpa.e1&&cpa.e2){var t=path.find_path(!0,!0),r=t[1],n=get_path_pos(r.midpoints,r.cps),o=_slicedToArray(n,4),a=o[0],i=o[1],s=o[2],_=o[3]
e.x=a,e.y=i,e.width=s,e.height=_,cpa.arrow_head&&(cpa.path_g.add_ons.head=add_shape_to_line_end(t[1],1,cpa.arrow_head)),cpa.arrow_tail&&(cpa.path_g.add_ons.tail=add_shape_to_line_end(t[1],0,cpa.arrow_tail))}})}function find_style_in_string(e,t){var r=new RegExp(t+":(.+?);"),n=r.exec(e)
return!!n&&n[1].replace(/"/g,"").trim()}function open_tab(e,t){var r,n
for(n=document.getElementsByClassName("modal_tab"),r=0;r<n.length;r++)n[r].style.display="none"
document.getElementById(t).style.display="block",e&&"A"!=e.target.tagName&&(d3.selectAll("#save_load_modal h2").style("display","none"),document.querySelector("#modal_"+t).style.display="block")}function close_modal(e){document.querySelector("#"+e).style.display="none",menu_status.modal_on=!1,fa_handler.opened_from_canvas(!1)}function open_modal(e){menu_status.modal_on=!0,document.querySelector("#"+e).style.display="block"}function open_math_modal(e){math_jax_specs.loaded||start_math(),menu_status.math_modal_on=!0,document.querySelector("#math_modal").style.display="block",document.querySelector("#math_modal textarea").value=e.raw_text,math_jax_specs.shape=e}function close_math_modal(){menu_status.math_modal_on=!1,math_jax_specs.shape=!1,document.querySelector("#math_modal").style.display="none"}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(e,t){var r=[],n=!0,o=!1,a=void 0
try{for(var i,s=e[Symbol.iterator]();!(n=(i=s.next()).done)&&(r.push(i.value),!t||r.length!==t);n=!0);}catch(e){o=!0,a=e}finally{try{n||null==s.return||s.return()}finally{if(o)throw a}}return r}function _arrayWithHoles(e){if(Array.isArray(e))return e}function is_link(e){return"DT"==e.tagName&&e.querySelector(":scope > A")&&e.querySelector(":scope > A").hasAttribute("ICON")}function is_folder_header(e){return"DT"==e.tagName&&e.querySelector("DL")}function parse_link(e){return(e=e.querySelector("A"))?{href:e.getAttribute("HREF"),icon:e.getAttribute("ICON"),text:e.textContent}:{}}function parse_bookmarks(e){var t={},r=document.createElement("div")
return r.innerHTML=e,parse_folder(r.querySelector("DL"),t),t}function parse_folder(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"root",n=r
t[n]={children:[]},Array.from(e.children).forEach(function(e){is_link(e)?t[n].children.push(parse_link(e)):is_folder_header(e)&&parse_folder(e.querySelector("DL"),t[n],get_title_of_folder(e))})}function add_fav_icon(e,t){var r=new Image
r.src=t,r.border_data={x:e.x,y:e.y,width:e.width,height:e.height,border_id:e.id,sizing:"cover",has_fixed_size:!0},r.onload=function(){this.border_data.img_width=this.width,this.border_data.img_height=this.height,this.border_data.border_width=this.width,this.border_data.border_height=this.height},shapes_storage.images[e.id]=r}function add_bookmark_to_map(e,t,r){last_pos=[t,r]
var n=get_new_shape_with_text(e.text),o=_slicedToArray(n,2),a=o[0]
return o[1],a}function add_folder_name(e,t,r){var n=active_style.style_class
active_style.style_class="style_0"
var o=add_bookmark_to_map({text:r},e,t)
return active_style.style_class=n,o}function add_path_between_folders(e,t){path.make_new_connection(e,t,!1,{disperse:!1,manhattan_perc:.02,from_side:1,to_side:3,fixed_side:!0})}function add_bookmark_folder(e,t,r,n){var o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,a=add_folder_name(t,r,n)
o&&add_path_between_folders(o,a),r+=a.height+40
var i=r,s=t,_=0
if("children"in e){var l=e.children.length,c=parseInt(l/3)+1
e.children.forEach(function(e,n){n%c==0&&(_=Math.max(_,i),i=r),s=t+285*parseInt(n/c)
var o=add_bookmark_to_map(e,s,i)
i+=o.height+10})}return i=r,Object.keys(e).filter(function(e){return"children"!=e}).forEach(function(r){var n=add_bookmark_folder(e[r],t+825+30,i,r,a)
i=n}),Math.max(_,i)}function add_bookmarks_to_map(e){var t=last_pos[0],r=last_pos[1]
active_style.line_flow="manhattan",set_zoom_and_trans(last_pos[0],last_pos[1],2,!1,!1,!0),path.change_collision_detection.turn_off_temporary(),add_bookmark_folder(e.root,t,r,"root"),path.change_collision_detection.restore()}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(e,t){var r=[],n=!0,o=!1,a=void 0
try{for(var i,s=e[Symbol.iterator]();!(n=(i=s.next()).done)&&(r.push(i.value),!t||r.length!==t);n=!0);}catch(e){o=!0,a=e}finally{try{n||null==s.return||s.return()}finally{if(o)throw a}}return r}function _arrayWithHoles(e){if(Array.isArray(e))return e}function find_target_for_image(e){return"P"==e.tagName?e:find_g(e)}function handle_paste_event(e){if("math_modal_input"==document.activeElement.id)return!0
if("drop"==e.type){var t=shapes_storage.find_clickable_shape(transform.invertX(e.clientX),transform.invertY(e.clientY))
t||(t=to_canvas.get_canvas()),set_current_element(t)}var r="canvas"==currentElement.iama
if(e.clientX&&(last_pos=[transform.invertX(e.clientX),transform.invertY(e.clientY)]),"INPUT"==e.target.tagName)return!0
var n="paste"==e.type?currentElement:e.target,o=(e.clipboardData||e.dataTransfer||e.originalEvent.clipboardData).items
e.preventDefault(),force_plain_text=document.querySelector("#form_import_force_plain_text").checked,r?(_.map(o,function(e){return e.type}).find(function(e){return"text/html"==e})?handle_html_paste_data(o,!1):_.map(o,function(e){return e.type}).find(function(e){return 0===e.indexOf("image")})?(active_style.shape="rect",add_active_shape_to_canvas(),handle_pic_paste_event(o,n,!1)):_.map(o,function(e){return e.type}).find(function(e){return"text/plain"==e})?handle_text_drop_event(o,"text/plain",!1,parse_text_data):_.map(o,function(e){return e.type}).find(function(e){return"text/csv"==e})&&handle_text_drop_event(o,"text/csv",!1,parse_text_data),e.stopPropagation()):gui_cursor.cursor_on()||gui_cursor.has_selection()?_.map(o,function(e){return e.type}).find(function(e){return"text/plain"==e})?handle_text_drop_event(o,"text/plain",!1,function(e){gui_cursor.insert_text(e),render()}):_.map(o,function(e){return e.type}).find(function(e){return"text/csv"==e})&&handle_text_drop_event(o,"text/csv",!1,function(e){gui_cursor.insert_text(e),render()}):(_.map(o,function(e){return e.type}).find(function(e){return 0===e.indexOf("image")})&&handle_pic_paste_event(o,n,!1),_.map(o,function(e){return e.type}).find(function(e){return"text/plain"==e})?handle_text_drop_event(o,"text/plain",!1,text_paste_on_border):_.map(o,function(e){return e.type}).find(function(e){return"text/csv"==e})&&handle_text_drop_event(o,"text/csv",!1,text_paste_on_border)),render()}function handle_unknown_file(e,t){var r=find_blob_of_type("",e,t)
if(null!==r){var n=new FileReader
n.onload=function(e){var t=r.name.split(".").slice(-1)[0]
"json"==t?parse_json_data(e.target.result):"xdot"==t?graphviz.make(e.target.result):text_to_feedback_pane("File extension of"+r.name+" unkown")},n.readAsText(r)}}function text_paste_on_border(e){add_text_to_paragraph(add_paragraph_to_shape(currentElement),e),set_current_element(currentElement)}function handle_pic_paste_event(e,t){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2]
if(!check_if_background_img_possible(t))return text_to_feedback_pane("cannot add background image to this. Image can only be added to a shape",!0),!1
var n=find_blob_of_type("image",e,r)
if(null!==n){var o=new FileReader
o.onload=function(e){add_background_image(currentElement,e.target.result)},o.readAsDataURL(n)}}function find_blob_of_type(e,t){for(var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=null,o=0;o<t.length;o++)0===t[o].type.indexOf(e)&&(n=r?t[o]:t[o].getAsFile())
return n}function handle_text_drop_event(e,t){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=arguments.length>3?arguments[3]:void 0
if("string"==e[0].kind)e[0].getAsString(n)
else{var o=find_blob_of_type(t,e,r)
if(null!==o){var a=new FileReader
a.onload=function(e){n(e.target.result)},a.readAsText(o)}}}function find_blob_of_type(e,t){for(var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=null,o=0;o<t.length;o++)0===t[o].type.indexOf(e)&&(n=r?t[o]:t[o].getAsFile())
return n}function get_placer(e,t,r){function n(t){var r
if(t>0&&t%max_rc_before_break==0){if(write_colwise){var n=Math.max.apply(null,o.map(function(e){return e.right}))
r=[n+delta_x_import,e.bottom]}else{var n=Math.max.apply(null,o.map(function(e){return e.bottom}))
r=[e.left,n+delta_y_import]}return o=[],r}return r=0==o.length?e:o[o.length-1],write_colwise?[r.left,r.bottom+delta_y_import*(0!=t)]:[r.right+delta_x_import*(0!=t),r.top]}var e={left:e[0],right:e[0],top:e[1],bottom:e[1]},o=[]
return{get_new_pos:n,store_pos:function(e){o.push(e)}}}function is_bookmarks_data(e){return e.startsWith("<!DOCTYPE NETSCAPE-Bookmark-file-1>")}function parse_text_data(e){function t(e){return"tab"==e?"\t":"enter"==e?"\n":e.match(/\\n/)?e.replace(/\\n/g,"\n"):e.match(/^\\t/)?e.replace(/\\t/g,"\t"):e}if(is_bookmarks_data(e))return console.log("bookmark_data"),add_bookmarks_to_map(parse_bookmarks(e)),!1
if(splitter_for_text_primary=function(){return t(document.querySelector("#form_import_seperator_primary").value.toString())}(),splitter_for_text_parsing=function(){return t(document.querySelector("#form_import_seperator").value.toString())}(),splitter_for_text_primary){var r=e.split(splitter_for_text_primary)
r=r.filter(function(e){return 0!=e&&""!=e&&""!=e})}else r=[e]
var n,o=(last_pos[0],last_pos[0],last_pos[1],last_pos[1],get_placer(last_pos,100,50)),a=[]
tag_import="",setTimeout(function(){r.forEach(function(e,t){if(e.match(/[a-zA-Z0-9]+/)){n=o.get_new_pos(t),last_pos=n
var r=get_default_border()
if(shapes_storage.borders[r.id]=r,splitter_for_text_parsing)var i=e.split(splitter_for_text_parsing).filter(function(e){return 0!=e&&""!=e&&""!=e})
else var i=[e]
i.forEach(function(e){add_text_to_paragraph(add_paragraph_to_shape(r),e)}),recalc_border_width(r.id,!1,!0),recalc_border_height(r.id),position_texts(r.id),tlbr=posit2.tlbr(r),o.store_pos(tlbr),a.push(r)}}),a.length>2&&a.forEach(function(e){manage_groups.toggle_element(e)}),render_all(0,!1,!0)},50)}function select_text_in_paragraph(e){function t(e){for(;3!==e.nodeType;){var t=e.childNodes
if(0==t.length)return!1
e=t[0]}return e}if(0==e.innerText.length)return!1
var r=e.childNodes,n=t(r[0]),o=t(r[r.length-1]),a=document.createRange()
a.setStart(n,0),a.setEnd(o,o.textContent.length)
var i=window.getSelection()
return i.removeAllRanges(),i.addRange(a),!0}function make_ready_for_copy(e){1==manage_groups.get_group(currentElement,!0).length?(el_to_copy=currentElement,canvas_status.copy_on=!0,text_to_feedback_pane("click canvas to paste shape")):text_to_feedback_pane("to copy group, you can just right click the canvas and then click paste")}function make_ready_for_cross_window_copy(){var e=manage_groups.get_group(currentElement),t=[]
e.forEach(function(e){t.push(e)
var r=get_text_with_border_id(e.id)
r.forEach(function(e){return delete e.parts}),t=t.concat(r)}),t.length>0?(element_to_json_to_hook(t),e.forEach(function(e){return position_texts(e.id)}),text_to_feedback_pane("click other canvas to copy")):text_to_feedback_pane("nothing to cross tab copy: needs group")}function copy_or_cut_from_canvas(e,t){var r=document.createElement("p")
r.textContent=e,document.querySelector("#dummy_copy_hook").appendChild(r),select_text_in_paragraph(r),document.execCommand(t),document.querySelector("#dummy_copy_hook").removeChild(r)}function element_to_json_to_hook(e){copy_or_cut_from_canvas("validator-bn;"+JSON.stringify(e),"copy")}function copy_prepped_shape_to_canvas(e,t){var r=copy_element_new(e,t,document.querySelector("#form_copy_with_text").checked)
return r&&gui_buttons.frame_element(r),r}function handle_html_paste_data(e){var t=[]
if(1==e.length){var r=e[0].getAsFile(function(e){return resolve(e)}),n=new FileReader
n.onloadend=function(e){is_bookmarks_data(this.result)&&add_bookmarks_to_map(parse_bookmarks(this.result))},n.readAsText(r)}else{var o=function(e){return new Promise(function(t,r){var n=e.type
e.getAsString(function(e){return t([e,n])})})}
t=Array.from(e).map(o)}Promise.all(t).then(function(e){if(m=e.map(function(e){return"validator-bn"==e[0].split(";")[0]}),_.any(m)){var t=m.indexOf(!0),r=e[t][0].match(/;/).index
paste_bn_elements(e[t][0].slice(r+1))}else parse_text_data(e.filter(function(e){return"text/plain"===e[1]})[0][0])}).catch(function(e){console.log(e)})}function paste_bn_elements(e){var t=JSON.parse(e)
t=loader.load_part(t)
var r=get_bbox_of_group(t),n=_slicedToArray(r,4),o=n[0],a=(n[1],n[2]),i=(n[3],[o,a]),s=last_pos[0]-i[0],_=last_pos[1]-i[1]
t.forEach(function(e){"border"!=e.iama&&"math_shape"!=e.iama||(reposition_protocol(e,s,_),manage_groups.add(e),"border"==e.iama&&position_texts(e.id))}),render_all(0,!1,!0)}function check_if_background_img_possible(e){return!0}function add_background_image(e,t){var r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2]
t=t||selected_background.querySelector("img").getAttribute("src"),"text"==e.iama&&(e=find_border_by_id(e.border_id))
var n=new Image
n.src=t,n.border_data={x:e.x,y:e.y,width:e.width,height:e.height,border_id:e.id,sizing:"cover"},shapes_storage.images[e.id]=n,n.onload=function(){calc_image_size(e,this),r&&set_current_element(e)}}function calc_image_size(e,t){var r=(arguments.length>2&&void 0!==arguments[2]&&arguments[2],t.width/t.height),n=e.width/e.height
t.border_data.border_width=e.width,t.border_data.border_height=e.height,r>n?(t.border_data.img_width=t.height*n,t.border_data.img_height=t.height):(t.border_data.img_width=t.width,t.border_data.img_height=t.width/n)}function set_image_size(e,t,r){var n=shapes_storage.images[e.id]
n.border_data.border_width=t,n.border_data.border_height=r,n.border_data.img_width=n.width,n.border_data.img_height=n.height,n.border_data.has_fixed_size=!0}function size_fig_to_image(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=shapes_storage.images[e.id],o=[n.width,n.height]
if(r)var a=o[0],i=o[1]
else{var s=[e.width,e.height],a=s[0],i=s[1],_=a/i,l=parseInt(o[0])/parseInt(o[1])
_<l?t?a=i*l:i=a/l:t?i=a/l:a=i*l}e.width=a,e.height=i,calc_image_size(e,shapes_storage.images[e.id]),render()}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(e,t){var r=[],n=!0,o=!1,a=void 0
try{for(var i,s=e[Symbol.iterator]();!(n=(i=s.next()).done)&&(r.push(i.value),!t||r.length!==t);n=!0);}catch(e){o=!0,a=e}finally{try{n||null==s.return||s.return()}finally{if(o)throw a}}return r}function _arrayWithHoles(e){if(Array.isArray(e))return e}function drag_treshold(e){var t=0
return{add:function(r,n){return t+=Math.abs(r)+Math.abs(n),t>e?[r,n]:[0,0]},reset:function(){t=0},treshold_reached:function(){return t>e}}}function set_buttons_for_slide(){var e,t,r,n,o,a,i,s
slider&&slider.existing?(r=!0,n=!0,o=!0):slider&&!slider.existing?(t=!0,n=!0,o=!0):(e=!0,slide_manager.get_last_clicked_slide_preview()&&(s=!0,i=!0,a=!0,document.querySelector("#form_slide_num").innerText="for slide "+(slide_manager.get_slider(slide_manager.get_last_clicked_slide_preview()).num+1))),set_slides_buttons(e,t,r,n,o,a,i,s)}function set_slides_buttons(e,t,r,n,o,a,i,s){d3.selectAll(".form_add_slide").classed("hidden",!e),d3.selectAll(".form_make_slide").classed("hidden",!t),d3.selectAll(".form_cancel_slide").classed("hidden",!o),d3.selectAll(".form_delete_slide").classed("hidden",!a),d3.selectAll(".form_toggle_slider").classed("hidden",!i),d3.selectAll(".form_slide_exclusion_mode").classed("hidden",!s),d3.selectAll(".form_update_slide").classed("hidden",!r),d3.selectAll(".form_wrap_slide").classed("hidden",!n)}function make_slide_handler(e){slide_manager.add_slide(slider)&&(slider.existing=!0,set_buttons_for_slide(),slider_off())}function slider_off(){slide_manager.remove_slider(),to_canvas.set_canvas()}function scale_to_viewport(e,t,r,n){return Math.max(e/r,t/n)}function find_boundaries_based_on_inside_figs(e){function t(e,t){return e.top=Math.min(e.top,t.top),e.bottom=Math.max(e.bottom,t.bottom),e.left=Math.min(e.left,t.left),e.right=Math.max(e.right,t.right),e}var r=_.map(e,function(e){return xywh_to_bbox(e)})
return _.reduce(r,t,{top:1/0,bottom:-1/0,left:1/0,right:-1/0})}function enter_slide_exclusion_mode(){slide_manager.remove_slider(),canvas_status.slide_exclusion_mode=!0,canvas.on(".click",null),canvas.on(".dblclick",null),add_canvas_slide_exclusion_mode_click(),show_temp_button("click shapes to add or remove from slide. When done, click button","done",exit_slide_exclusion_mode)}function exit_slide_exclusion_mode(){canvas_status.slide_exclusion_mode=!1,canvas.on(".click",null),canvas.on(".dblclick",null),add_canvas_default_click(),cc.clear_canvas(gui_context),document.querySelector("#fs_temp_button").style.display="none"}function handle_slide_show_key_events(e){if("keyup"==e.type)return!1
37==e.keyCode||40==e.keyCode?slide_manager.prev_slide():39!=e.keyCode&&38!=e.keyCode||slide_manager.next_slide()}function add_slide_update_message(e,t,r,n){this.show_hook()
var o=this.get_title("slide ".concat(e.id,", shape ").concat(t.id)),a=this.get_button(r,"update"),i=this.get_button(n,"remove"),s=document.createElement("div")
s.classList.add("slide_message"),s.appendChild(o),s.appendChild(a),s.appendChild(i),this.hook.appendChild(s)}function align_update_message(e,t){this.show_hook()
var r=this.get_title("Reset shapes to original position ?"),n=this.get_button(e,"reset"),o=this.get_button(t,"keep"),a=document.createElement("div")
a.classList.add("slide_message"),a.appendChild(r),a.appendChild(n),a.appendChild(o),this.hook.appendChild(a)}function make_messenger(e,t){var r={show_hook:function(){e.style.display="inherit"},update_hook_after_message_click:function(){0==e.querySelectorAll(".slide_message").length&&(e.style.display="none")},get_title:function(e){var t=document.createElement("p")
return t.innerText=e,t},get_button:function(e,t){var r=document.createElement("button")
r.innerText=t
var n=this
return r.onclick=function(t){e(),this.parentElement.remove(),n.update_hook_after_message_click()},r},count:function(){return e.querySelectorAll("div").length},hook:e}
return{add_message:t.bind(r),message_count:r.count}}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(e,t){var r=[],n=!0,o=!1,a=void 0
try{for(var i,s=e[Symbol.iterator]();!(n=(i=s.next()).done)&&(r.push(i.value),!t||r.length!==t);n=!0);}catch(e){o=!0,a=e}finally{try{n||null==s.return||s.return()}finally{if(o)throw a}}return r}function _arrayWithHoles(e){if(Array.isArray(e))return e}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(e,t){var r=[],n=!0,o=!1,a=void 0
try{for(var i,s=e[Symbol.iterator]();!(n=(i=s.next()).done)&&(r.push(i.value),!t||r.length!==t);n=!0);}catch(e){o=!0,a=e}finally{try{n||null==s.return||s.return()}finally{if(o)throw a}}return r}function _arrayWithHoles(e){if(Array.isArray(e))return e}function make_cell(e,t,r,n,o,a){var i=get_default_border()
return i.x=t[0],i.y=t[1],i.width=r,i.height=n,i.vt=o+"_"+a,i.table=e,i.is_cell=!0,i.fixed_size=!0,shapes_storage.borders[i.id]=i,i}function make_table(e){var t=[],r=get_table_dims(),n=r.w,o=r.h,a=_slicedToArray(e,2),i=a[0],s=a[1],l=get_id_for_table()
no_table=!0,_.range(r.nrows).forEach(function(e){var a=[]
_.range(r.ncols).forEach(function(t){var _=[i+t*(n+r.cm),s+e*(o+r.rm)],c=make_cell(l,_,n,o,e,t)
a.push(c)}),t.push(a)}),tables[l]=t}function get_table_dims(){if(cmm.status())var e=parseInt(document.querySelector("#cm_num_rows").value),t=parseInt(document.querySelector("#cm_num_cols").value)
else var e=parseInt(document.querySelector("#form_num_rows").value),t=parseInt(document.querySelector("#form_num_cols").value)
var r=parseInt(document.querySelector("#form_cell_height").value)
return{nrows:e,ncols:t,w:parseInt(document.querySelector("#form_cell_width").value),h:r,rm:parseInt(document.querySelector("#form_row_margin").value),cm:parseInt(document.querySelector("#form_col_margin").value)}}function get_r_c_id_from_cell(e){var t=e.vt.split("_").map(function(e){return parseInt(e)}),r=_slicedToArray(t,2),n=r[0],o=r[1],a=e.table
return[parseInt(n),parseInt(o),a]}function get_table_row(e){var t=get_r_c_id_from_cell(e),r=_slicedToArray(t,3),n=r[0],o=(r[1],r[2])
return tables[o][n]}function get_table_col(e){var t=get_r_c_id_from_cell(e),r=_slicedToArray(t,3),n=(r[0],r[1]),o=r[2]
return tables[o].map(function(e){return e[n]})}function get_num_rc_from_table(e){return[tables[e].length,tables[e][0].length]}function add_rc_to_group(e){els=manage_groups.get_group(currentElement,!0),manage_groups.reset(!1),els.forEach(function(t){e(t).forEach(function(e){return manage_groups.add(e)})}),render_all(0,!1,!0)}function add_rc_to_table(e,t,r,n,o){var a=get_num_rc_from_table(e),i=a,s=_slicedToArray(i,2),l=s[0],c=s[1]
a=a[0==o?1:0],no_table=!0
var u=[]
return _.range(a).forEach(function(o){var a=r(l,c,o),i=_slicedToArray(a,2),s=i[0],_=i[1],d=Object.values(shapes_storage.borders).filter(function(t){return t.is_cell&&t.table==e&&t.vt=="".concat(s,"_").concat(_)})
if(0==d.length)var f=find_dummy_pos(tables[e],s,_),h=_slicedToArray(f,4),p=h[0],m=h[1],g=h[2],y=h[3]
else{d=d[0]
var v=posit2.get_top_left(d),b=_slicedToArray(v,2),p=b[0],m=b[1],w=posit2.get_w_h(d),x=_slicedToArray(w,2),g=x[0],y=x[1]}var k=n(l,c,o),E=_slicedToArray(k,2),s=E[0],_=E[1],A=make_cell(e,t(p,m,g,y),g,y,s,_)
u.push(A)}),u}function reconstruct_table(e){var t=Object.values(shapes_storage.borders).filter(function(t){return t.table==e}),r=t.map(function(e){return e.vt.split("_")}).reduce(function(e,t){return e[0].push(parseInt(t[0])),e[1].push(parseInt(t[1])),e},[[],[]]),n=_slicedToArray(r,2),o=n[0],a=n[1]
max_r=Math.max.apply(void 0,o)+1,max_c=Math.max.apply(void 0,a)+1
var i=[]
_.range(max_r).forEach(function(r){var n=[]
_.range(max_c).forEach(function(o){var a=t.filter(function(t){return t.table==e&&t.vt==r+"_"+o})
a=0==a.length?make_table_dummy_node(r,o,e):a[0],n.push(a)}),i.push(n)}),tables[e]=i}function make_table_dummy_node(e,t,r){return{me:"dummy_cell",table:r,vt:e+"_"+t}}function find_dummy_pos(e,t,r){function n(e,t){for(var r=t.length,n=1;n<t.length;n++){var a=t[(e+n)%r]
if("dummy_cell"!=a.iama&&a!=o)return a}return!1}var o=arguments.length>3&&void 0!==arguments[3]&&arguments[3],a=n(t,e.map(function(e){return e[r]})),i=n(r,e[t]),s=_=c=l=0,s=posit2.get_top_left(a)[0],_=posit2.get_top_left(i)[1],l=posit2.get_w_h(i)[1],c=posit2.get_w_h(a)[0]
return[s,_,c,l]}function get_cell_pos(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1]
if("dummy_cell"==e.iama){var r=get_r_c_id_from_cell(e),n=_slicedToArray(r,3),o=n[0],a=n[1],i=n[2],s=find_dummy_pos(tables[i],o,a,e),_=_slicedToArray(s,4),l=_[0],c=_[1],u=_[2],d=_[3]
return t?[l,c,u,d]:[l,c]}var f=posit2.get_top_left(e),h=_slicedToArray(f,2),l=h[0],c=h[1]
if(t){var p=posit2.get_w_h(e),m=_slicedToArray(p,2),u=m[0],d=m[1]
return[l,c,u,d]}return[l,c]}function get_rows_cols_of_grouped_cells(e){var t=manage_groups.get_group(e,!0).map(function(e){var t=get_r_c_id_from_cell(e)
return t[2]=e,t})
return[_.groupBy(t,function(e){return e[0]}),_.groupBy(t,function(e){return e[1]})]}function table_to_cols(e){var t=tables[e],r=_.range(t[0].length).map(function(e){return[]})
return t.forEach(function(e){e.forEach(function(e,t){return r[t].push(e)})}),r}function set_borders_of_group_of_cells(e,t){cells=manage_groups.get_group(currentElement,!0)
var r=get_rows_cols_of_grouped_cells(t),n=_slicedToArray(r,2),o=n[0],a=n[1]
max_col=Math.max.apply(null,Object.keys(a)),max_row=Math.max.apply(null,Object.keys(o)),min_col=Math.min.apply(null,Object.keys(a)),min_row=Math.min.apply(null,Object.keys(o))
var i=o[min_row].map(function(e){return e[2]}),s=o[max_row].map(function(e){return e[2]}),_=a[max_col].map(function(e){return e[2]}),l=a[min_col].map(function(e){return e[2]})
cells.forEach(function(e){var t=r=n=o=!1,t=-1!=i.indexOf(e),r=-1!=_.indexOf(e),n=-1!=s.indexOf(e),o=-1!=l.indexOf(e)
ido(e).calc_border(e,[t,r,n,o])})}function make_table_from_existing_shapes(e){var t=manage_groups.get_current_group(),r=t.filter(function(e){return"border"==e.iama})
return r.length<2?(text_to_feedback_pane(["can only make tables from rect basic","you can morph shape to rect basic from the shape menu"]),!1):!!place_existing(r)&&(manage_groups.reset(),!0)}function place_existing(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1]
return get_placer_to_table(e,parseInt(document.querySelector("#form_col_margin").value),parseInt(document.querySelector("#form_row_margin").value)).make_table(t)}function get_shapes_in_table(e){var t=[]
return tables[e].forEach(function(e){t=t.concat(e)}),t.filter(function(e){return!("dummy_cell"==e.iama)})}function unmake_table(e){tables[e].forEach(function(e){e.forEach(function(e){delete e.table,delete e.vt,delete e.is_cell})}),delete tables[e]}function set_row_height(e){var t=get_table_row(e),r=Math.max.apply(void 0,t.map(function(e){return e.height}))
t.forEach(function(e,t){"dummy_cell"!=e.iama&&resize_shape(e,0,r-e.height)})}function set_col_width(e){var t=get_table_col(e),r=Math.max.apply(void 0,t.map(function(e){return e.width}))
t.forEach(function(e,t){"dummy_cell"!=e.iama&&resize_shape(e,r-e.width,0)})}function resize_cell(e,t,r,n){if(arguments.length>4&&void 0!==arguments[4]&&arguments[4],"dummy_cell"!=e.iama&&!resize_shape(e,t,r))return!1
if(!d3.event||d3.event.sourceEvent&&!d3.event.sourceEvent.shiftKey){var o=get_my_table(e),a=find_my_neighbours(o,e),i=_slicedToArray(a,4),s=(i[0],i[1]),_=i[2]
i[3],s&&repos_cell(s,0,r,!0,!1,!1),_&&repos_cell(_,t,0,!0,!1,!1)}}function repos_cell(e,t,r,n,o){var a=arguments.length>5&&void 0!==arguments[5]&&arguments[5]
if(my_els=[],repos_shape(e,t,r),!d3.event||d3.event&&!d3.event.sourceEvent.shiftKey){var i=get_my_table(e),s=find_my_neighbours(i,e),_=_slicedToArray(s,4),l=_[0],c=_[1],u=_[2],d=_[3]
a?(l&&"up"==a&&0!=t&&repos_cell(l,t,0,n,!1,"up"),c&&"down"==a&&0!=t&&repos_cell(c,t,0,n,!1,"down"),u&&"right"==a&&0!=r&&repos_cell(u,0,r,n,!1,"right"),d&&"left"==a&&0!=r&&repos_cell(d,0,r,n,!1,"left")):(l&&0!=t&&repos_cell(l,t,0,n,!1,"up"),c&&0!=t&&repos_cell(c,t,0,n,!1,"down"),u&&0!=r&&repos_cell(u,0,r,n,!1,"right"),d&&0!=r&&repos_cell(d,0,r,n,!1,"left")),0!=t&&u&&repos_cell(u,t,0,n,!1,"right"),0!=r&&c&&repos_cell(c,0,r,n,!1,"down")}}function get_my_table(e){var t=e.table
return tables[t]}function find_my_neighbours(e,t){var r=t.vt.split("_").map(function(e){return parseInt(e)}),n=_slicedToArray(r,2),o=n[0],a=n[1],i=o>0&&e[o-1][a],s=o<e.length-1&&e[o+1][a],_=e[0].length,l=a>0&&e[o][a-1]
return[i,s,a<_-1&&e[o][a+1],l]}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(e,t){var r=[],n=!0,o=!1,a=void 0
try{for(var i,s=e[Symbol.iterator]();!(n=(i=s.next()).done)&&(r.push(i.value),!t||r.length!==t);n=!0);}catch(e){o=!0,a=e}finally{try{n||null==s.return||s.return()}finally{if(o)throw a}}return r}function _arrayWithHoles(e){if(Array.isArray(e))return e}function get_placer_fill_area(e,t,r,n){function o(r){var n,o,f=posit2.get_w_h(r),h=_slicedToArray(f,2),p=h[0],m=h[1],g=l+p<s+i,y=c+m<_+i
g&&a?(n=l+i,o=c,l=n+p,u=Math.max(u,l),d=Math.max(d,c+m)):y&&!a?(n=l,o=c+i,c=o+m,u=Math.max(u,l+p),d=Math.max(d,c)):!g&&a?(n=e,o=d+i,l=n+p,c=o,u=Math.max(u,l),d=Math.max(d,c)):y||a||(n=u+i,o=t,l=n,c=o+m,u=Math.max(u,l),d=Math.max(d,c)),ido(r).reposition_me(r,n+i,o+i)}var a=!(arguments.length>4&&void 0!==arguments[4])||arguments[4],i=25,s=e+r,_=t+n
e-=i,t-=i
var l=e,c=t,u=e,d=t
return{position_shape:o}}function get_placer_to_table(e){function t(e){pos=e.map(function(e){return posit2.tlbr(e)}),ids=e.map(function(e){return e.id})
var t=[]
return ids.forEach(function(e,r){pos[r].id=e,t.push(pos[r])}),t}function r(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"bottom",r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"top",n=arguments.length>3?arguments[3]:void 0,o=e[g][t]
ibefore=g
do{g+=1}while(g<y&&n(e[g][r],o))
return e.slice(ibefore,g)}function n(t,n,o,a,i){g=0
var s=[],l=_.sortBy(t,function(e){return e[o]})
for(a&&l.reverse();g<e.length;)s.push(r(l,n,o,i))
return s}function o(e,t){for(var r=0;r<t.length;r++)if(t[r].includes(e))return r
return!1}function a(e,t,r,n){return e.forEach(function(e){var o=t-e[r]
e[n]+=o}),Math.max.apply(null,e.map(function(e){return e[n]}))}function i(e,t,r,n,o,s){0==r&&(s=Math.min.apply(null,t[0].map(function(e){return e[n]}))),e.push(s),new_max=a(t[r],s,n,o),(r+=1)<t.length&&i(e,t,r,n,o,new_max)}function s(t,r){var n={}
return e.forEach(function(e){return n[e.id]=[o(e.id,t),o(e.id,r)]}),n}function l(e){var t={}
return Object.values(e).forEach(function(e){e in t?t[e]+=1:t[e]=1}),t}function c(e){return Object.values(e).reduce(function(e,t){return e+(1!=t?t:0)},0)}function u(t){var r=_slicedToArray(t,4),n=r[0],a=r[1],s=r[2],_=r[3],l=[],c=[]
i(l,n,0,"top","bottom"),i(c,a,0,"left","right")
var u,d,f,h
e.forEach(function(e){u=o(e.id,s),d=o(e.id,_),f=l[u]+u*m,h=c[d]+d*p,e.fixed_size=!0,repos_shape(e,h-e.x,f-e.y)})}function d(){var r,o,a,i,_=t(e),u=n(_,"bottom","top",!1,function(e,t){return e<t}),d=n(_,"top","bottom",!0,function(e,t){return e>t}),f=n(_,"right","left",!1,function(e,t){return e<t}),h=n(_,"left","right",!0,function(e,t){return e>t}),p=u.map(function(e){return e.map(function(e){return e.id})}),m=f.map(function(e){return e.map(function(e){return e.id})}),g=d.map(function(e){return e.map(function(e){return e.id})}),y=h.map(function(e){return e.map(function(e){return e.id})}),v=s(p,m),b=s(g,y),w=s(p,y),x=s(g,m),k=[v,b,w,x].map(function(e){return l(e)}),E=k.map(function(e){return c(e)}),A=["ab","cd","ad","cb"],S=Math.min.apply(null,E),A=A[E.indexOf(S)]
return"cd"==A?(r=d.reverse(),o=h.reverse(),a=g.reverse(),i=y.reverse()):"ad"==A?(r=u,o=h.reverse(),a=p,i=y.reverse()):"cb"==A?(r=d.reverse(),o=f,a=g.reverse(),i=m):"ab"==A&&(r=u,o=f,a=p,i=m),[[r,o,a,i],S]}function f(t,r){var n={}
return e.forEach(function(e){return n[e.id]=[0,0]}),t.forEach(function(e,t){return e.forEach(function(e){return n[e][0]=t})}),r.forEach(function(e,t){return e.forEach(function(e){return n[e][1]=t})}),n}function h(e){return Object.values(e).map(function(e){return e.toString()}),pos_to_ids={},Object.keys(e).forEach(function(t){var r=e[t].toString()
r in pos_to_ids||(pos_to_ids[r]=[]),pos_to_ids[r].push(t)}),pos_to_ids}var p=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5,m=arguments.length>2&&void 0!==arguments[2]?arguments[2]:5,g=0
e=e.filter(function(e){return"path_group"!=e.iama})
var y=e.length
return{place:function(){var e=d()
u(e[0]),0!=e[1]&&text_to_feedback_pane("some shapes overlaying")},make_table:function(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],r=d(),n=_slicedToArray(r,2),a=_slicedToArray(n[0],4),i=a[0],s=a[1],l=a[2],c=a[3]
if(0!=n[1]){text_to_feedback_pane(["failed. Positions overlapping. cannot make table","Some cells will be overlapping after making a table","move shapes that overlap and try again","or use align > table first to make a layout to actually                    see overlapping shapes"])
var p=h(f(l,c))
return Object.keys(p).forEach(function(e){if(p[e].length>1){var t=p[e].map(function(e){return document.getElementById(e)})
add_rect_around_group(t)}}),!1}u([i,s,l,c])
var m=i.length,g=s.length,y=_.range(m).map(function(e){return new Array(g).fill(0)})
return t||(t=get_id_for_table()),e.forEach(function(e){rn=o(e.id,l),cn=o(e.id,c),y[rn][cn]=e,e.is_cell=!0,e.vt=rn+"_"+cn,e.table=t}),y=y.map(function(e,r){return e.map(function(e,n){return e||make_table_dummy_node(r,n,t)})}),tables[t]=y,!0}}}function init_study_one_by_one(e){function t(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1]
y[e][0]=t?Math.max(y[e][0]-1,0):Math.min(y[e][0]+1,f),y[e][1]=0,Object.keys(y).filter(function(t){return t!=e}).forEach(function(e){y[e][1]+=1})}function r(){var e=_.range(0,f+1).map(function(e){return[]})
return Object.keys(y).forEach(function(t){var r=[t,y[t]]
e[y[t][0]].push(r)}),e}function n(e){for(var t=0,r=f;r>=0&&!((t+=e[r].length)>g);r--);return r}function o(e,t){for(var r=[],n=1,o=e;o<=f;o++){var a=[]
a=t[o].map(function(e){return[e[0],Math.pow(p,e[1][1])*n]}),n*=h,r=r.concat(a)}return r}function a(){for(var e=r(),t=n(e),a=o(t,e),s=i(a),_=Math.random(),l=0,c=0;c<s.length;c++)if((l+=s[c][1])>_)return s[c][0]
return!1}function i(e){var t=e.reduce(function(e,t){return e+t[1]},0)
return e.map(function(e){return[e[0],e[1]/t]})}function s(e){return _.shuffle(e)}function l(e){var t="<p>Correct answer: "
return e.forEach(function(e){cl=e.added?"added":e.removed?"removed":"correct",e.removed||(t+="<span class=".concat(cl,">").concat(e.value,"</span>"))}),t+="</p>",t+="<p>Your anser:",e.forEach(function(e){cl=e.added?"added":e.removed?"removed":"correct",e.added||(t+="<span class=".concat(cl,">").concat(e.value,"</span>"))}),t+="</p>"}function c(e){var t=check=minus=!1
"start"==e&&(t=!0),!0===e&&(check=!0),e||(minus=!0),document.querySelector("#flash_card_check_res_icon").classList.toggle("fa-square-o",t),document.querySelector("#flash_card_check_res_icon").classList.toggle("fa-check-square-o",check),document.querySelector("#flash_card_check_res_icon").classList.toggle("fa-minus-square-o",minus)}var u=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],d=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],f=5,h=2,p=1.03
e=e.filter(function(e){return e.classList.contains("flippable")})
var m=e.length
if(e.length<2)return text_to_feedback_pane("need more cards to study. Could not find any at all or just one..."),!1
var g=Math.max(Math.min(m,5),parseInt(m/5)),y={}
if(u&&d)!function(){e.forEach(function(e){y[e.id]=[3,0,0]})}()
else var v=s(e)
var b=-1
document.querySelector("#form_one_by_one_controls").style.display="flex",u?function(){document.querySelector("#input_menu").style.display="block"}():function(){document.querySelector("#input_menu").style.display="none"}()
var w=toggle_zoom.filters[document.querySelector("#form_study_filter").value]
return{next:function(){if(u&&(document.querySelector("#flash_card_val_to_check").value="",document.querySelector("#flash_card_checked_res").innerHTML="",c("start")),d){var e=a()
if(e)var t=document.querySelector("#"+e)
toggle_zoom.fade_callback(),toggle_zoom.center_on_shape(t,w,t,!1,!1,!1,.2*window.innerHeight),set_current_element(t),w[1](currentElement)}else b+=1,b<m?(toggle_zoom.fade_callback(),toggle_zoom.center_on_shape(v[b],w,v[b],!1,!1,!1,.2*window.innerHeight),set_current_element(v[b]),w[1](currentElement)):(text_to_feedback_pane("studied all available flashcards! Restarting"),this.reset())},reset:function(){v=s(e),b=-1,this.next()},flip:function(){var e=currentElement
ido(e).flip_shape(e),reverse&&setTimeout(function(){ido(e).flip_shape(e)},reverse)},get_group:function(){return e},check_answer:function(){var e=document.querySelector("#flash_card_val_to_check").value,r=currentElement.querySelector("article.collapsed").textContent
diff=l(JsDiff.diffChars(e,r)),document.querySelector("#flash_card_checked_res").innerHTML=diff,this.flip(),c(e==r),d&&t(currentElement.id,e==r)}}}function _defineProperty(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function display_help_for_button(e,t){var r=e.innerText
return r in help_mapper&&(slides_mode?text_to_help_pane_slides(help_mapper[r],!1,!0):text_to_help_pane(help_mapper[r],!1,!0),t.preventDefault()),e.closest("#context-menu")&&t.preventDefault(),!1}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function _iterableToArray(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e)){for(var t=0,r=new Array(e.length);t<e.length;t++)r[t]=e[t]
return r}}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(e,t){var r=[],n=!0,o=!1,a=void 0
try{for(var i,s=e[Symbol.iterator]();!(n=(i=s.next()).done)&&(r.push(i.value),!t||r.length!==t);n=!0);}catch(e){o=!0,a=e}finally{try{n||null==s.return||s.return()}finally{if(o)throw a}}return r}function _arrayWithHoles(e){if(Array.isArray(e))return e}function change_path_side(e,t,r){manage_groups.get_group(currentElement,!0).forEach(function(t){r(t,e),path.remake_path(void 0),toggle_path_reset_button(t)}),render(),gui_buttons.frame_element(currentElement)}function toggle_advanced_options(e){minimal_menu=!minimal_menu,toggle_button_to_status(document.querySelector("#form_toggle_advanced_options"),!minimal_menu),display_fs_for_shape(currentElement)}function toggle_button_to_status(e,t){var r=is_toggle_button_on(e);(r&&!t||!r&&t)&&toggle_button(e)}function is_toggle_button_on(e){return e.querySelector(".toggle-button").classList.contains("toggle-button-selected")}function toggle_button(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1]
if("DIV"!=e.tagName||e.classList.contains("toggle-button")?"LABEL"==e.tagName?e=e.parentElement.querySelector(".toggle-button"):"BUTTON"==e.tagName&&(e=e.parentElement):e=e.querySelector(".toggle-button"),e.classList.contains("toggle-button")){e.classList.toggle("toggle-button-selected")
var r=!!e.classList.contains("toggle-button-selected")
if(t){var n=r?[1,0]:[0,1],o=_slicedToArray(n,2),a=o[0],i=o[1]
e.parentElement.querySelectorAll("label")[a].classList.add("selected"),e.parentElement.querySelectorAll("label")[i].classList.remove("selected")}return r}}function merge_covered_shapes(e){e=e.iama?e:currentElement
var t={top:e.y,left:e.x,bottom:e.y+e.height,right:e.x+e.width}
merged.is_parent(e)||merged.create_new_group(e)
for(var r=Object.values(shapes_storage.borders).concat(shapes_storage.drawings).concat(shapes_storage.icons).concat(shapes_storage.math_shapes),n=r.filter(function(e){return is_inside(e.x,e.y,t)&&is_inside(e.x+e.width,e.y+e.height,t)}),o=0,a=0;a<n.length;a++)merged.add_child(e,n[a])&&(o+=1)
text_to_feedback_pane(0==o?"no shapes found to merge":o+" shapes merged"),set_current_element(e)}function get_max_scale_for_zoom(e){return"L0"==e?2:"L1"==e?3:"L2"==e?6:8}function rescale_canvasses(e){form_hidden?setup_canvasses(window.innerWidth-2*CANVAS_MARGIN,window.innerHeight-2*CANVAS_MARGIN):setup_canvasses.apply(void 0,_toConsumableArray(calc_canvas_width())),render_all(),render_single()}function snap_to_grid(e){el=currentElement,manage_groups.get_group(el,!1).forEach(function(e){find_sticky_and_reposition(e,-el.x%grid_step,-el.y%grid_step,!0)}),set_current_element(el)}function set_val_to_cookie(e,t,r){var n=new Date
n.setTime(n.getTime()+24*r*60*60*1e3)
var o="expires="+n.toUTCString()
document.cookie="".concat(e,"=").concat(t,";").concat(o)}function find_val_in_cookie(e){var t=document.cookie,r=t.split(";").map(function(e){return e.split("=").map(function(e){return e.trim()})}),n=r.find(function(t){return t[0]==e})
return!!n&&n[1]}function build_initial_index(){return new Fuse(_.flatten(Object.values(shapes_storage.texts)).map(function(e){return{border_id:e.border_id,text:e.text,font_size:e.font_size}}),options)}function show_search_form(){document.querySelector("#search_form").style.display="block",document.querySelector("#search_form_search_value").value="",document.querySelector("#search_results").innerHTML="",document.querySelector("#search_form_search_value").focus(),document.querySelector("#search_form_search_value").onkeydown=function(e){27==e.keyCode&&hide_search_form(),"Enter"==e.key&&find_search_results(this.value),key_pressed=[],e.stopPropagation()},document.querySelector("#search_form").onkeydown=function(e){27==e.keyCode&&hide_search_form(),key_pressed=[]},canvas_status.search_form=!0}function hide_search_form(e){document.querySelector("#search_form").style.display="none",canvas_status.search_form=!1}function find_search_results(e){var t=build_initial_index()
res=t.search(e)
var r=document.querySelector("#search_results")
r.innerText="",0==res.length&&(r.innerText="No results found"),res=res.sort(function(e,t){return t.font_size-e.font_size}),res.forEach(function(t){var n=find_border_by_id(t.border_id),o=make_search_result_paragraph(e,t.text)
o.onclick=function(e){zoom_to_area(n,!1,!1,get_max_scale_for_zoom(n.level))},r.appendChild(o)})}function make_search_result_paragraph(e,t){var r=e.split(" ").map(function(e){return e.toLowerCase()}),n=t.split(" ").map(function(e){return e.toLowerCase()}),o=document.createElement("p")
return n.forEach(function(e){if(_.any(r.map(function(t){return e.includes(t)}))){var t=document.createElement("b")
t.classList.add("search_form_found_word"),t.innerText=e+" ",o.appendChild(t)}else{var n=document.createElement("span")
n.innerText=e+" ",o.appendChild(n)}}),o}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(e,t){var r=[],n=!0,o=!1,a=void 0
try{for(var i,s=e[Symbol.iterator]();!(n=(i=s.next()).done)&&(r.push(i.value),!t||r.length!==t);n=!0);}catch(e){o=!0,a=e}finally{try{n||null==s.return||s.return()}finally{if(o)throw a}}return r}function _arrayWithHoles(e){if(Array.isArray(e))return e}function get_scale_(e,t,r,n){return r/n>e/t?n/t:r/e}function add_export_scale_events(){function e(e){e.value
var t=Math.max(.1,e.value)
printer.change_scale(t)}var t=document.getElementById("form_print_output_scale"),r=t.querySelector(".plus"),n=t.querySelector(".minus"),o=t.querySelector("input"),a=function(e){return e<1?.1:.25}
r.onmousedown=function(){var t=parseFloat(o.value)
o.value=round_to(t+a(t+.01),2),e(o)},n.onmousedown=function(){var t=parseFloat(o.value)
o.value=round_to(t-a(t-.01),2),e(o)},o.onchange=function(){e(o)}}function set_form_print_ratio_choice(){if(!canvas_status.export_mode)return!1
printer.is_fixed_A_ratio()?($(".form_print_output_size_A_scale").css("display","flex"),document.querySelector("#form_print_output_size_custom").style.display="none"):($(".form_print_output_size_A_scale").css("display","none"),document.querySelector("#form_print_output_size_custom").style.display="inherit"),printer.draw_print_region()}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(e,t){var r=[],n=!0,o=!1,a=void 0
try{for(var i,s=e[Symbol.iterator]();!(n=(i=s.next()).done)&&(r.push(i.value),!t||r.length!==t);n=!0);}catch(e){o=!0,a=e}finally{try{n||null==s.return||s.return()}finally{if(o)throw a}}return r}function _arrayWithHoles(e){if(Array.isArray(e))return e}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function _iterableToArray(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e)){for(var t=0,r=new Array(e.length);t<e.length;t++)r[t]=e[t]
return r}}function fetch_a_font(e){var t,r=e.split(",")
if(r.length>1){var n=r[1]
t=n in font_to_file[r[0]]?font_to_file[r[0]][n]:font_to_file[r[0]].regular}else t=font_to_file[e].regular
return fetch("/static/assets/"+t).then(function(t){return t.ok?t.arrayBuffer():Promise.reject("failed loading font "+e)}).then(function(t){font_cache[e]=t})}function test_pdf(){var e=new PDFDocument({size:[1123,1587],layout:"landscape"}),t=e.pipe(blobStream())
if(render_to_pdf=!0,always_reset=!0,no_wobble=!0,slider){var r=get_scale(slider,goal_width,goal_height),n={x:round_to(-slider.x*r,0),y:round_to(-slider.y*r,0),k:r}
render_for_pic(get_canvas_proxy_for_pdfkit(e),slider,n,!1)}else render_all(0,!1,!1,get_items_to_render,get_canvas_proxy_for_pdfkit(e))
t.on("finish",function(){var e=t.toBlob("application/pdf"),r=window.URL.createObjectURL(e)
window.open(r,"_blank")}),e.end(),render_to_pdf=!1,always_reset=!1,no_wobble=!1}function rgba_to_rgb(e){if(!e)return["rgb(0,0,0)",0]
if(e.startsWith("rgba")){var t=e.slice(5,-1).split(",").map(function(e){return parseFloat(e)})
return[t.slice(0,3),t[3]]}return e.startsWith("rgb")?[e.slice(4,-1).split(",").map(function(e){return parseFloat(e)}).slice(0,3),1]:[e,1]}function get_canvas_proxy_for_pdfkit(e){function t(t,a,i){return"rotate"===a?function(){for(var t=arguments.length,r=new Array(t),n=0;n<t;n++)r[n]=arguments[n]
return r[0]/=Math.PI/180,e[a].apply(this,r)}:r.includes(a)?function(){for(var t=arguments.length,r=new Array(t),n=0;n<t;n++)r[n]=arguments[n]
return e[a].apply(this,r)}:o.includes(a)?function(){for(var t=arguments.length,r=new Array(t),n=0;n<t;n++)r[n]=arguments[n]
return e.fillAndStroke.apply(this,r)}:n.includes(a)?function(){return!1}:function(){for(var t=arguments.length,r=new Array(t),n=0;n<t;n++)r[n]=arguments[n]
return e[a].apply(this,r)}}var r=["transform","translate","scale","moveTo","lineTo","save","restore","ellipse","rect"],n=["beginPath",""],o=["stroke","fill"],a=["fillStyle","strokeStyle","",""],i={get:function(r,o,i){return"getContext"===o?function(){return this}:"width"===o?500:"height"===o?500:"drawImage"===o?function(){for(var t=arguments.length,r=new Array(t),n=0;n<t;n++)r[n]=arguments[n]
return e.image(r[0].src,r[5],r[6],{fit:[r[7],r[8]]})}:"fillText"===o?function(){for(var t=arguments.length,r=new Array(t),n=0;n<t;n++)r[n]=arguments[n]
return r.push({lineBreak:!1}),e.text.apply(e,r)}:"setLineDash"===o?function(){for(var t=arguments.length,r=new Array(t),n=0;n<t;n++)r[n]=arguments[n]
return e.dash(r[0][0],{space:r[0][1]})}:"function"==typeof r[o]?t(r,o,i):a.includes(o)?function(){for(var t=arguments.length,r=new Array(t),n=0;n<t;n++)r[n]=arguments[n]
return e[o].apply(this,r)}:n.includes(o)?function(){return!0}:e[o]},set:function(t,r,n){if("fillStyle"==r)e.fillColor.apply(e,_toConsumableArray(rgba_to_rgb(n)))
else if("strokeStyle"==r)e.strokeColor.apply(e,_toConsumableArray(rgba_to_rgb(n)))
else if("lineWidth"==r)e.lineWidth(n),0===n&&e.strokeColor([0,0,0],0)
else if("font"===r){var o=""
n.startsWith("bold italic")||n.startsWith("italic bold")?o=",bold italic":n.startsWith("italic")?o=",italic":n.startsWith("bold")&&(o=",bold")
var a=n.split("px"),i=_slicedToArray(a,2),s=i[0],_=i[1]
_=_.trim().replace(/"/g,""),s=_.startsWith("Font Awe")?s.match(/\d+/g)[1]:s.match(/\d+/)[0],e.fontSize(s),!o||_+o in font_cache||(o=""),e.font(font_cache[_+o])}return!0}}
return new Proxy(e,i)}function get_used_fonts(){var e=new Set
return _.flatten(Object.values(shapes_storage.texts)).forEach(function(t){var r=t.font_style?t.font_family+","+t.font_style:t.font_family
e.has(r)||e.add(r)}),shapes_storage.icons.length>0&&(e.add("Font Awesome 5 Free"),e.add("Font Awesome 5 Brands")),e}function prep_fonts(){var e=get_used_fonts(),t=new Set(Object.keys(font_cache)),r=new Set
return e.forEach(function(e){t.has(e)||r.add(e)}),Promise.all(Array.from(r).map(fetch_a_font)).catch(function(e){throw e})}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(e,t){var r=[],n=!0,o=!1,a=void 0
try{for(var i,s=e[Symbol.iterator]();!(n=(i=s.next()).done)&&(r.push(i.value),!t||r.length!==t);n=!0);}catch(e){o=!0,a=e}finally{try{n||null==s.return||s.return()}finally{if(o)throw a}}return r}function _arrayWithHoles(e){if(Array.isArray(e))return e}function mobilecheck(){var e=!1
return function(t){(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(t)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(t.substr(0,4)))&&(e=!0)}(navigator.userAgent||navigator.vendor||window.opera),e}function load_pdf_script(){return Promise.all([add_script_to_head(location.origin+"/static/js/canvas/pdfkit.js"),add_script_to_head(location.origin+"/static/js/canvas/blob-stream.js")])}function add_script_to_head(e){return new Promise(function(t,r){var n=document.createElement("script")
document.body.appendChild(n),n.onload=t,n.onerror=r,n.async=!0,n.src=e})}function unzip_blob(e,t){JSZip.loadAsync(e).then(function(e){Object.keys(e.files).forEach(function(r){e.files[r].async("string").then(function(e){t(JSON.parse(e))})})})}function toggleFullScreen(){var e=window.document,t=e.documentElement,r=t.requestFullscreen||t.mozRequestFullScreen||t.webkitRequestFullScreen||t.msRequestFullscreen,n=e.exitFullscreen||e.mozCancelFullScreen||e.webkitExitFullscreen||e.msExitFullscreen
e.fullscreenElement||e.mozFullScreenElement||e.webkitFullscreenElement||e.msFullscreenElement?n.call(e):r.call(t)}function add_text_from_mobile_input(e){if("border"==currentElement.iama)add_text_to_shape(currentElement,e)
else if("text"==currentElement.iama)gui_cursor.insert_text(e),render()
else if("canvas"==currentElement.iama){var t=get_new_shape_with_text(e),r=_slicedToArray(t,2),n=(r[0],r[1])
set_current_element(n)}}function display_cursor_mobile_mode(e,t,r){var n=document.querySelector("#mobile_text_input")
n.style.height=1.2*e
var o=transform.apply([t,r]),a=_slicedToArray(o,2)
t=a[0],r=a[1],n.style.left=t+"px",n.style.top=r+"px",n.querySelector('input[type="text"]').focus()}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(e,t){var r=[],n=!0,o=!1,a=void 0
try{for(var i,s=e[Symbol.iterator]();!(n=(i=s.next()).done)&&(r.push(i.value),!t||r.length!==t);n=!0);}catch(e){o=!0,a=e}finally{try{n||null==s.return||s.return()}finally{if(o)throw a}}return r}function _arrayWithHoles(e){if(Array.isArray(e))return e}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function _iterableToArray(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e)){for(var t=0,r=new Array(e.length);t<e.length;t++)r[t]=e[t]
return r}}function load_math_jax(){return arguments.length>0&&void 0!==arguments[0]&&arguments[0],new Promise(function(e,t){$.getScript("https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js",function(){mathjax_loaded=!0,MathJax.Hub.Config({showMathMenu:!1,extensions:["tex2jax.js"],jax:["input/TeX","output/CommonHTML"],SVG:{scale:50}}),e()})})}function delayed_change(e,t){clearTimeout(math_jax_specs.timeout),math_jax_specs.timeout=setTimeout(function(){change_math(e,t)},500)}function add_math_to_cursor(e){var t=document.querySelector("#math_modal_input"),r=t.selectionStart,n=t.selectionEnd,o=t.value.slice(0,r),a=t.value.slice(n)
t.value=o+" "+e+" "+a,t.focus(),t.selectionEnd=r+e.length+1}function change_render_to_svg(){MathJax.Hub.Queue(["setRenderer",MathJax.Hub,"SVG"])}function start_math(){return make_math_menu(),load_math_jax().then(function(){change_render_to_svg(),math_jax_specs.loaded=!0})}function make_math_menu(){function e(e,t){var r=document.createElement("div")
return r.classList.add("tab"),r.classList.add("hidden"),r.setAttribute("id",t+"_math_menu_tab"),e.appendChild(r),r}var t=["basic","relations","ranges","logics","greeks","brackets","trigonometric","binary","other","examples"],r={greeks:["\\alpha","\\beta","\\gamma","\\delta","\\epsilon",,"\\varepsilon","\\zeta","\\eta","\\theta","\\vartheta","\\iota","\\kappa","\\lambda","\\mu","\\nu","\\xi","\\pi","\\varpi","\\rho","\\varrho","\\sigma","\\varsigma","\\tau","\\upsilon","\\phi","\\varphi","\\chi","\\psi","\\omega","\\Gamma","\\Delta","\\Theta","\\Lambda","\\Xi","\\Pi","\\Sigma","\\Upsilon","\\Phi","\\Psi","\\Omega","\\partial","\\hbar","\\imath","\\jmath","\\ell","\\Re","\\Im","\\wp"],relations:["<",">","\\le","\\ge","\\leq","\\geq","\\equiv","\\gg","\\ll","\\equiv","\\doteq","\\sim","\\simeq","\\cong","\\asymp","\\approx","\\cong","=","\\neq","\\subset","\\supset","\\subseteq","\\supseteq","\\sqsubseteq","\\sqsupseteq","\\prec","\\succ","\\dashv","\\bowtie","\\in","\\notin","\\ni","\\ne","\\not","\\perp","\\parallel","\\vdash","\\models"],ranges:["\\int_{a}^{b}","\\int\\limits_{a}^{b}","\\iint_{a}^{b}","\\oint_{a}^{b}","|_0^1","\\sum_{i=1}^{10}","\\prod_{a}^{b}","\\coprod_{a}^{b}","\\bigcup_{a}^{b}","\\bigsqcup_{a}^{b}","\\bigcap_{a}^{b}","\\bigvee_{a}^{b}","\\bigwedge_{a}^{b}","\\bigoplus_{a}^{b}","\\bigodot_{a}^{b}","\\bigotimes_{a}^{b}"],trigonometric:["\\sin","\\cos","\\tan","\\cot","\\arcsin","\\arccos","\\arctan","\\sinh","\\cosh","\\tanh","\\coth","\\sec","\\csc"],binary:["\\pm","\\mp","\\times","\\div","\\ast","\\star","\\dagger","\\ddagger","\\cap","\\cup","\\uplus","\\sqcap","\\sqcup","\\vee","\\wedge","\\cdot","\\diamond","\\bigtriangleup","\\bigtriangledown","\\triangleleft","\\triangleright","\\bigcirc","\\bullet","\\wr","\\oplus","\\ominus","\\otimes","\\oslash","\\odot","\\circ","\\setminus","\\amalg"],logics:["\\exists","\\forall","\\neg","\\emptyset","\\subset","\\supset","\\in","\\notin","\\ni","\\land","\\lor","\\rightarrow","\\leftarrow","\\mapsto","\\iff","\\Leftrightarrow","\\leftrightarrow","\\top","\\bot"],brackets:["\\lbrack","\\rbrack","\\vert","\\Vert","\\lbrace","\\rbrace","\\lfloor","\\rfloor","\\langle","\\rangle","\\lceil","\\rceil","{a \\over b}","{a \\atop b}","{ a \\choose b}","{ a b\\brace a b}","{ a \\brack b}"],basic:["=","+","-","\\times","\\div","{a \\over b}","a^{2b}","\\sqrt{a}","\\sqrt[b] a"],other:["\\infty","\\,","\\:","\\;","\\quad","\\cdots","\\vdots","\\ddots","\\not{a}","\\dot{a}","\\hat{a}","\\overrightarrow{AB}","\\overleftarrow{AB}","\\vec{a}","\\widehat{AAA}","\\overline{a}","\\underline{a}","\\prime"],examples:["\\lim\\limits_{x \\to \\infty} \\exp(-x) = 0","\\begin{matrix} a & b & c \\\\  d & e & f \\\\  g & h & i \\end{matrix}","\\begin{pmatrix}   a_{1,1} & a_{1,2} & \\cdots & a_{1,n} \\\\   a_{2,1} & a_{2,2} & \\cdots & a_{2,n} \\\\  \\vdots  & \\vdots  & \\ddots & \\vdots  \\\\   a_{m,1} & a_{m,2} & \\cdots & a_{m,n}  \\end{pmatrix}","\\left( \\sum_{i=1}^{n-1} i \\right)"]},n=document.querySelector("#math_modal")
!function(e,t){var r=document.createElement("ul")
r.style.marginTop="12px",t.forEach(function(e){var t=document.createElement("li")
t.classList.add("math_menu_header"),t.innerText=e,t.onclick=function(){Array.from(r.parentElement.querySelectorAll(".tab")).forEach(function(e){return e.classList.add("hidden")}),r.parentElement.querySelector("#".concat(e,"_math_menu_tab")).classList.remove("hidden"),document.querySelectorAll("li.math_menu_header.active").forEach(function(e){return e.classList.remove("active")}),this.classList.add("active")},r.appendChild(t)}),e.appendChild(r)}(n,t),t.forEach(function(t){var o=e(n,t),a="examples"==t?"12px":"18px"
r[t].forEach(function(e){var t=document.createElement("span")
t.classList.add("mathjax_clickable_item"),t.style.fontSize=a,t.innerText="$$"+e+"$$",t.onclick=function(){add_math_to_cursor(e),math_jax_specs.auto_update&&change_math(document.querySelector("#math_modal_input").value,math_jax_specs.shape)},o.appendChild(t)})}),document.querySelector("#relations_math_menu_tab").classList.remove("hidden")}function trigger_math(e){var t=document.createElement("P")
t.innerText=e?"$$"+e+"$$":"$$ X^{27} $$",MathJax.Hub.Queue(["Typeset",MathJax.Hub,t],function(e,t){return function(){set_current_element(add_math_jax_to_new_shape(e,t))}}(t,e))}function change_math(e,t){if("math_shape"!==t.iama)return text_to_feedback_pane("do not know what shape to change... Click a shape with math inside first"),!1
var r=document.createElement("P")
r.innerText=e?"$$"+e+"$$":"$$ X^{27} $$",MathJax.Hub.Queue(["Typeset",MathJax.Hub,r],function(e,t,r){return function(){return change_math_jax_of_shape(e,t,r)}}(r,e,t))}function add_math_jax_to_new_shape(e,t){var r=e.querySelector("svg > g"),n=get_path_info(r),o=to_breakdown_shape.apply(void 0,[n,t].concat(_toConsumableArray(calc_scale(e.querySelector("svg")))))
return shapes_storage.add_shape(o),clear_defs(),o}function check_for_error_in_mathjax_output(e){return!!e.querySelector("text")&&e.querySelector("text").textContent}function change_math_jax_of_shape(e,t,r){var n=e.querySelector("svg > g")
if(!n)return!1
var o=check_for_error_in_mathjax_output(n)
if(o)setTimeout(function(){return text_to_feedback_pane(o,!0,3e3)},100)
else{close_main_feedback_func(),clearTimeout(math_jax_specs.error_callbacsk)
var a=get_scale_of_math_shape(r.scale),i=get_path_info(n)
r.raw_text=t
var s=calc_scale(e.querySelector("svg")),_=_slicedToArray(s,3),l=_[0],c=_[1],u=_[2]
r.width=c,r.height=u,r.scale=l,r.items=i,alter_scale_of_math_shape(r,a)}clear_defs(),render(),math_jax_specs.busy=!1}function get_path_info(e){function t(e){var t={x:e.getAttribute("x"),y:e.getAttribute("y")}
return e.hasAttribute("transform")&&(t.trans=parse_transform(e.getAttribute("transform"))),t}var r=""
return e.hasAttribute("transform")&&(r=parse_transform(e.getAttribute("transform"))),{trans:r,paths:get_direct_children(e,"use").map(function(e){return[t(e),Snap.path.toRelative(document.body.querySelector(e.getAttribute("href")).getAttribute("d")).toString()]}),rects:get_direct_children(e,"rect").map(function(e){return{x:e.getAttribute("x"),y:e.getAttribute("y"),width:e.getAttribute("width"),height:e.getAttribute("height")}}),children:get_direct_children(e,"g").map(get_path_info)}}function parse_transform(e){return e.startsWith("translate")?e.match(/\+?-?\d+,\+?-?\d+/)[0].split(",").map(function(e){return parseInt(e)}):e.startsWith("scale")?e.match(/\+?-?\d+\.?\d*/)[0].split(",").map(function(e){return parseFloat(e)}):[]}function to_breakdown_shape(e,t,r,n,o){var a=get_new_id(),i=predef_styles.get_classes()[active_style.style_class]
return{raw_text:t,x:last_pos[0],y:last_pos[1],color:i.color,stroke:i.stroke,stroke_width:0,fill:is_visible_color(i.fill)?i.fill:"black",id:a,iama:"math_shape",style_class:active_style.style_class,font_size:infinity.get_font_size(infinity.get_level(),i.font_class),level:infinity.get_level(),items:e,scale:r,width:n,height:o}}function calc_scale(e){var t=12*parseFloat(e.getAttribute("width")),r=12*parseFloat(e.getAttribute("height"))
return[parseFloat(e.getAttribute("viewBox").split(" ")[2])/t,t,r]}function get_direct_children(e,t){return Array.from(e.children).filter(function(e){return e.tagName==t})}function clear_defs(){}function math_jax_tests(){trigger_math("-b \\pm \\sqrt{b^2 - 4ac} \\over 2a"),trigger_math("-b \\pm \\sqrt{b^2 - 4ac} \\over {2a \\over 5}"),trigger_math("\\cos (2\\theta) = \\cos^2 \\theta - \\sin^2 \\theta"),trigger_math("\\lim\\limits_{x \\to \\infty} \\exp(-x) = 0"),trigger_math("k_{n+1} = n^2 + k_n^2 - k_{n-1}"),trigger_math("f(n) = n^5 + 4n^2 + 2 |_{n=17}"),trigger_math("\\frac{n!}{k!(n-k)!} = \\binom{n}{k}"),trigger_math("\\frac{\\frac{1}{x}+\\frac{1}{y}}{y-z}"),trigger_math(" x = a_0 + \\cfrac{1}{a_1 + \\cfrac{1}{a_2+ \\cfrac{1}{a_3 + \\cfrac{1}{a_4} } } }"),trigger_math("\\sqrt{\\frac{a}{b}}"),trigger_math("\\sqrt[n]{1+x+x^2+x^3+\\dots+x^n}"),trigger_math("\\sum_{i=1}^{10} t_i"),trigger_math("\\displaystyle\\sum_{i=1}^{10} t_i"),trigger_math("\\int_0^\\infty \\mathrm{e}^{-x}\\,\\mathrm{d}x"),trigger_math("\\int\\limits_a^b"),trigger_math("\\begin{matrix}  a & b & c \\\\  d & e & f \\\\  g & h & i \\end{matrix}"),trigger_math("f(n) =\n    \\begin{cases}\n        n/2       & \\quad \\text{if } n \\text{ is even}\\\\\n        -(n+1)/2  & \\quad \\text{if } n \\text{ is odd}\n    \\end{cases}")}function shape_to_math(e){trigger_math(get_text_with_border_id(e.id)[0].text),delete_shape(e)}function alter_scale_of_math_shape(e,t){var r=e.scale,n=get_scale_of_math_shape(t)
e.scale=n,e.width=e.width*r/n,e.height=e.height*r/n,render()}function get_scale_of_math_shape(e){return 101-e}function get_tokens_for_syntax_highlighting(e,t){return Prism.tokenize(e,Prism.languages[t])}function get_plaintext_from_shape(e){for(var t=get_chunks_by_par(e.id),r="",n=0;n<e.num_pars;n++)try{r+=t[n].reduce(function(e,t){return e+t.text},""),r+="\n"}catch(e){}return r=r.replace(/\r\n/g,"\n")}function change_par_text_to_syntax_highlight(e,t,r){var n=get_chunks_in_par(e.id,t),o=n.reduce(function(e,t){return e+t.text},""),a=get_tokens_for_syntax_highlighting(o,r)
n.forEach(shapes_storage.remove),add_tokens_to_paragraph(e,t,a)}function syntax_highlight_shape(e,t){var r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],n=get_plaintext_from_shape(e),o=get_tokens_for_syntax_highlighting(n,t)
remove_all_text_from_shape(e),e.font_family="Source Code Pro",e.fill=r?"#2d2d2d":"#f5f2f0",e.text_align="left",e.style_class=!1,e.num_pars=1,add_tokens_to_shape(e,o,!1,r),reset_par_and_chunk_numbering(e.id),position_texts(e.id),e.syntax_highlighted=t,render()}function get_color_for_token(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],r=t?0:1
return e&&"type"in e&&e.type in prism_color_map?prism_color_map[e.type][r]:e&&"alias"in e&&e.alias in prism_color_map?prism_color_map[e.alias][r]:["#ccc","black"][r]}function parse_token(e,t,r){e.split("\n").forEach(function(e,n){if(0==e.length)r.num_pars+=1
else{n>0&&(r.num_pars+=1)
var o=get_default_text(r)
o.par_num=r.num_pars-1,o.has_own_style=!0,o.text=e,o.color=t,shapes_storage.add_text(o)}})}function add_tokens_to_shape(e,t,r){var n=!(arguments.length>3&&void 0!==arguments[3])||arguments[3]
t.forEach(function(t){"string"==typeof t?parse_token(t,get_color_for_token(r,n),e):"string"==typeof t.content?parse_token(t.content,get_color_for_token(t,n),e):add_tokens_to_shape(e,t.content,t,n)})}function remove_all_text_from_shape(e){get_text_with_border_id(e.id).forEach(shapes_storage.remove)}var currentElement=!1,PIXEL_RATIO=function(){var e=document.createElement("canvas").getContext("2d")
return(window.devicePixelRatio||1)/(e.webkitBackingStorePixelRatio||e.mozBackingStorePixelRatio||e.msBackingStorePixelRatio||e.oBackingStorePixelRatio||e.backingStorePixelRatio||1)}(),canvas_offset_x=0,canvas_offset_y=0,VERSION="20180709",canvas_width,canvas_height,radius=5,transform=d3.zoomIdentity,canvas=d3.select("#draw_canvas"),context=canvas.node().getContext("2d"),canvas_single=d3.select("#draw_canvas_single"),context_single=canvas_single.node().getContext("2d"),gui_canvas=d3.select("#gui_canvas"),gui_context=gui_canvas.node().getContext("2d"),hover_canvas=d3.select("#hover_canvas"),hover_context=hover_canvas.node().getContext("2d"),cursor_canvas=d3.select("#cursor_canvas"),cursor_context=cursor_canvas.node().getContext("2d"),grid_canvas=d3.select("#grid_canvas"),grid_context=grid_canvas.node().getContext("2d"),full_screen=!1,CANVAS_MARGIN=4,_calc_canvas_width=calc_canvas_width(),_calc_canvas_width2=_slicedToArray(_calc_canvas_width,2),canvas_init_width=_calc_canvas_width2[0],canvas_init_height=_calc_canvas_width2[1],no_wobble=!1
setup_canvasses(canvas_init_width,canvas_init_height)
var MIN_PAR_WIDTH=8,max_border_width=500,shapes_storage,ignore_svg_click=!1,last_pos=[0,0],last_w=0,last_h=0,grid_step=4,mdd=4,fine_move=!1,fine_size=!1,anim_dur=1e3,to_canvas=function(){return from_shape=!1,{get_canvas:function(){return currentElement&&"canvas"!=currentElement.iama&&(from_shape=currentElement),{iama:"canvas"}},set_canvas:function(){set_current_element(this.get_canvas())},set_reverse:function(){from_shape&&("text"==from_shape.iama&&(from_shape=find_border_by_id(from_shape.border_id)),set_current_element(from_shape),from_shape=!1)}}}(),el_to_copy=!1,canvas_status={copy_on:!1,view_mode:!1,drag_select:!1,draw_mode:!1,slide_mode:!1,slide_exclusion_mode:!1,export_mode:!1,plumbs_on:!0,align_on:!1,search_form:!1,reset:function(){this.drag_select&&drag_select_off(),this.export_mode&&drag_export_off(),this.draw_mode&&drag_draw_off(),this.drag_select=!1,this.draw_mode=!1,this.slide_mode=!1,this.slide_exclusion_mode=!1,this.export_mode=!1,this.plumbs_on=!0,this.align_on=!1}},menu_status={modal_on:!1},poly_draw=!1,points_for_poly=[],minimal_menu=!0,current_map_name="",pres_mode_for_load=!1,slides_mode=!1,study_mode=!1,reverse=1e3,form_update=!0,minscale=.15,maxscale=8,slider=!1,line_generator=d3.line().curve(d3.curveCardinal).x(function(e){return e.x}).y(function(e){return e.y}),line_generator_linear=d3.line().curve(d3.curveLinear).x(function(e){return e.x}).y(function(e){return e.y}),path_end_fig="arrow",help_on=!1,form_hidden=!1,MARGIN_DIV=0,render,el_on_single=!1,paths_on_single=[],demo_mode=!1,posit2={get_top_left:function(e){return[e.x,e.y]},get_bottom_right:function(e){return[e.x+e.width,e.y+e.height]},get_w_h:function(e){return[e.width,e.height]},get_trans:function(e){return arguments.length>1&&void 0!==arguments[1]&&arguments[1],!(arguments.length>2&&void 0!==arguments[2])||arguments[2],arguments.length>3&&void 0!==arguments[3]&&arguments[3],{translate:[e.x,e.y],rotate:[0],scale:1}},tlbr:function(e){var t=this.get_top_left(e,!0),r=this.get_w_h(e),n=_slicedToArray(r,2),o=n[0],a=n[1]
return{top:t[1],left:t[0],bottom:t[1]+a,right:t[0]+o}},get_mid_of_side:function(e,t){try{var r=this.get_top_left(e,!0),n=_slicedToArray(r,2),o=n[0],a=n[1],i=this.get_w_h(e),s=_slicedToArray(i,2),_=s[0],l=s[1]
if(0==t)return[o+_/2,a]
if(1==t)return[o+_,a+l/2]
if(2==t)return[o+_/2,a+l]
if(3==t)return[o,a+l/2]}catch(e){return[1e4,1e4]}}}
shapes_storage=make_shape_storage()
var text_for_render=function(){function e(){console.log("going to work"),a=Date.now(),s=!0,i=!1,l.postMessage([a,_.flatten(Object.values(shapes_storage.texts))||[],shapes_storage.borders])}function t(t){return i?o.filter(function(e){return t.has(e.border_id)}):(s||n||e(),shapes_storage.get_text_array_from_ids(t))}function r(){i=!1,a=Date.now()}var n=!1,o=[],a=!1,i=!1,s=!0,l=new Worker("/static/js/canvas/worker_sort_text.js")
return l.onmessage=function(t){t.data[0]==a?(i=!0,s=!1,o=t.data[1]):(s=!1,n||e())},{pause_sorting:function(){return n=!0},start_sorting:function(){return n=!1},get_texts:t,invalidate_sorted:r}}(),get_id_for_table=!1
get_id_for_table=make_table_id_func("t",0)
var get_new_id=next_id_gen("_",0),all_form_elements=["fs_path_label","fs_para","form_border_width","form_border_dash","fs_path","fs_font","form_fill","form_font","form_font_size","fs_border","fs_fig_stuff","fs_image","form_styling","ffw_fill","ffw_text","ffw_stroke","ffw_stroke2","form_textblock_border","fs_grouping","fs_grouping_quick","form_border_side","fs_path_advanced","fs_import","fs_zoom_pos","fs_drawing","fs_graphing","fs_board","colors_svg","fs_rect_canvas","fs_rough"],non_minimal_fieldsets=["fs_zoom_pos","fs_import","fs_grouping","fs_path_advanced"],path_form_elements=["fs_path_label","form_fill","fs_colors","fs_border","fs_grouping_quick","colors_svg","form_border_width","form_border_dash","fs_path","ffw_fill","ffw_stroke","fs_path_advanced","fs_zoom_pos","fs_rough"],paragraph_form_elements=["form_font_list","fs_font","form_font","form_font_size","form_fill","fs_border","form_border_width","form_border_dash","fs_para","form_font_class","form_font_size","form_styling","ffw_fill","ffw_text","ffw_stroke","form_border_side","fs_zoom_pos","colors_svg","fs_grouping_quick"],svg_form_elements=["form_fill","fs_drawing","fs_grouping_quick","ffw_fill","fs_zoom_pos","fs_import","colors_svg","fs_rough"],drawing_form_elements=["form_fill","fs_colors","fs_border","form_border_width","form_border_dash","ffw_fill","ffw_stroke","colors_svg","fs_grouping_quick","fs_path_label"],path_add_on_form_elements=["form_fill","fs_colors","fs_border","form_border_width","fs_path_label","form_border_dash","ffw_fill","ffw_stroke","colors_svg","fs_grouping_quick"],most_common=["form_font_class","ffw_text","fs_zoom_pos","form_border_width",,"form_border_dash","fs_grouping","fs_grouping_quick","fs_font","form_fill","form_font","form_font_size","fs_border","fs_fig_stuff","form_disperse","form_styling","ffw_fill","ffw_stroke","form_border_side","colors_svg","fs_rough"],figs={line_for_graph:{svg_fig:"path",my_name:"line_for_graph",myclasses:["no_fill"],dims:{width:120,height:10},styles:{"stroke-width":"3px"},my_form_elements:["form_fill","fs_graphing","ffw_stroke","fs_border","form_border_width","form_border_dash","fs_grouping","colors_svg","fs_grouping_quick"],my_menu:"empty"},x_axis:{svg_fig:"d3_axis",my_name:"x_axis",dims:{width:120,height:10},myclasses:["font4","i_am_grouped"],my_style_classes:["style_20"],styles:{"stroke-width":"2px",stroke:"rgb(75,75,75)"},copyable:!1,my_form_elements:["fs_path_label","form_fill","ffw_text","ffw_stroke","fs_font","form_font","form_font_size","fs_border","form_border_width","form_border_dash","fs_grouping_quick"],my_menu:"empty"},y_axis:{svg_fig:"d3_axis",my_name:"y_axis",dims:{width:10,height:120},myclasses:["font4","i_am_grouped"],my_style_classes:["style_20"],styles:{"stroke-width":"2px",stroke:"rgb(75,75,75)"},copyable:!1,my_form_elements:["fs_path_label","form_fill","ffw_text","ffw_stroke","fs_font","form_font","form_font_size","fs_border","form_border_width","form_border_dash","fs_grouping_quick"],my_menu:"empty"},axes_board:{svg_fig:"rect",my_name:"axes_board",dims:{graph_axis_crossed:!0,gridded:!0,width:400,height:400,domain_x:[-2,2],domain_y:[2,-2]},myclasses:["evade_me","sticky","no_nums"],my_style_classes:["style_18"],styles:{"stroke-width":"1px"},copyable:!1,my_form_elements:["form_fill","fs_board","ffw_fill","fs_grouping","fs_grouping_quick","colors_svg","fs_border","form_border_width","form_border_dash"]},graph_basic:{svg_fig:"rect",my_name:"graph_basic",dims:{width:250,height:250,domain_x:[-2,2],domain_y:[2,-2]},myclasses:["evade_me","canvas_layer"],my_style_classes:["style_20"],styles:{"stroke-width":"0px"},copyable:!1,my_form_elements:["form_fill","fs_graphing","ffw_fill","fs_grouping","fs_grouping_quick","colors_svg"]},country_basic:{svg_fig:"path",my_name:"path_basic",dims:{width:120,height:90},myclasses:["path",""],my_style_classes:["style_20"],my_form_elements:most_common,my_menu:"fig",copyable:!1},path_basic:{svg_fig:"path",my_name:"path_basic",dims:{width:120,height:90},myclasses:["evade_me","path",""],my_style_classes:["style_20"],styles:{"stroke-width":"2px","pointer-events":"stroke"},my_form_elements:most_common.filter(function(e){return"ffw_stroke"!=e&&"fs_hierarchy"!=e&&"form_border_side"!=e&&"fs_fig_stuff"!=e}).concat(["fs_path_label","fs_path_advanced"]),my_menu:"fig",copyable:!0,custom_bbox:!0},polygon:{svg_fig:"polygon",my_name:"polygon",dims:{width:120,height:90},myclasses:["evade_me","polygon_basic"],my_style_classes:["style_20"],my_form_elements:most_common,my_menu:"fig",copyable:!0},custom:{svg_fig:"polygon",my_name:"poly_points",myclasses:["evade_me","polygon_basic","canvas_layer"],my_style_classes:["style_6"],my_form_elements:most_common,my_menu:"poly_points",copyable:!0},poly_points_fo:{svg_fig:"polygon",my_name:"poly_points_fo",myclasses:["evade_me","polygon_basic"],my_style_classes:["style_4"],my_form_elements:most_common,my_menu:"fig",copyable:!0},slide:{svg_fig:"polygon",my_name:"slide",myclasses:["polygon_basic","canvas_layer"],my_style_classes:["slider"],my_form_elements:["fs_zoom_pos"],my_menu:"slide",copyable:!1},rect_basic:{svg_fig:"rect",my_name:"rect_basic",dims:{width:180,height:80,rx:1,ry:1},myclasses:["evade_me"],my_style_classes:["style_20"],my_form_elements:most_common,my_menu:"fig",copyable:!0},cell_basic:{svg_fig:"rect",my_name:"cell_basic",dims:{width:180,height:80,rx:2,ry:2},myclasses:[],my_style_classes:["style_20"],my_form_elements:most_common,my_menu:"fig",copyable:!0},tan_rect:{svg_fig:"rect",my_name:"tan_rect",dims:{width:180,height:80,rx:2,ry:2},myclasses:["evade_me"],my_style_classes:["style_6"],my_form_elements:most_common,copyable:!1},rect_canvas:{svg_fig:"rect",my_name:"rect_canvas",dims:{width:150,height:100,rx:1,ry:0},myclasses:["canvas_layer"],my_style_classes:["coney_island1"],my_form_elements:["form_fill","fs_border","form_border_width","form_fill_what","fs_rect_canvas","fs_grouping_quick","form_border_width","form_group","form_disperse","ffw_fill","ffw_stroke","fs_grouping","colors_svg","form_border_side"],copyable:!0,my_menu:"rect_canvas"},ellipse:{svg_fig:"ellipse",my_name:"ellipse_basic",dims:{rx:60,ry:40},myclasses:["mainfig","evade_me"],my_style_classes:["style_20"],my_form_elements:most_common.filter(function(e){return"form_border_side"!=e}),my_menu:"fig",copyable:!0},cp_resize:{svg_fig:"circle",my_name:"cp_resize",dims:{r:5},styles:{fill:"red","stroke-width":"2px",stroke:"black","stroke-dasharray":"0"},my_style_classes:["cp_resize"],style_on_fig:!0,my_form_elements:[],copyable:!1},cp_helper:{svg_fig:"circle",my_name:"cp_helper",dims:{r:5},styles:{"stroke-dasharray":"0"},my_style_classes:["cp_helper"],style_on_fig:!0,my_form_elements:[],copyable:!1},catcher:{svg_fig:"mainfig",my_name:"catcher",dims:{rx:10,ry:10},styles:{"stroke-dasharray":"0"},my_style_classes:["catcher"],style_on_fig:!1,my_form_elements:[],copyable:!1},cp_rotate:{svg_fig:"circle",my_name:"cp_rotate",dims:{r:5},styles:{fill:"orange","stroke-width":"2px",stroke:"black","stroke-dasharray":"0"},my_style_classes:["cp_rotate"],style_on_fig:!0,my_form_elements:[],copyable:!1},fo:{svg_fig:"foreignObject",my_name:"fo",dims:{},styles:{},copyable:!1},knot:{svg_fig:"circle",my_name:"knot",dims:{r:5,width:1,height:1},styles:{fill:"none",stroke:"black"},myclasses:["mainfig"],my_style_classes:["style_23"],my_form_elements:["fs_colors","form_fill","form_border_width","fs_grouping","fs_grouping_quick","fs_border","form_border_width","fs_fig_stuff","colors_svg"],my_menu:"knot",copyable:!1},knot_gui:{svg_fig:"circle",my_name:"knot_gui",dims:{r:12,width:1,height:1,transform:"translate(-10,10)"},styles:{},myclasses:["mainfig"],my_form_elements:[],copyable:!1},knot_hierarchy:{svg_fig:"circle",my_name:"knot_hierarchy",dims:{r:5,width:1,height:1},styles:{},myclasses:["mainfig"],my_form_elements:["fs_colors","form_fill","form_border_width","fs_grouping","fs_grouping_quick","fs_border","form_border_width","fs_fig_stuff"],my_menu:"knot",copyable:!1},poly_point:{svg_fig:"circle",my_name:"poly_point",dims:{r:5,width:1,height:1},styles:{},myclasses:[],my_form_elements:["fs_colors","form_fill","form_border_width","fs_grouping","fs_grouping_quick","fs_border","form_border_width","fs_fig_stuff","colors_svg"],my_menu:"knot",copyable:!0},text_basic:{svg_fig:"text",my_name:"text_basic",dims:{},myclasses:["mainfig"],my_style_classes:["style_23","font2"],my_form_elements:["fs_colors","fs_zoom_pos","form_border_width","form_border_dash","fs_grouping","fs_grouping_quick","fs_font","form_fill","form_font","form_font_size","fs_border","form_border_width","ffw_fill","ffw_stroke","colors_svg"],my_menu:"text",copyable:!0},text_path:{svg_fig:"textPath",my_name:"text_path",dims:{},myclasses:["mainfig"],my_style_classes:["style_23","font4"],my_form_elements:["fs_colors","fs_zoom_pos","fs_border","form_border_width","fs_font","form_fill","form_font","form_font_size","ffw_fill","ffw_stroke","fs_grouping_quick","colors_svg"],my_menu:"text-on-path",copyable:!1},text_block:{svg_fig:"text",my_name:"text_block",dims:{},myclasses:["font4"],my_style_classes:["style_23"],my_form_elements:["fs_colors","fs_zoom_pos","fs_border","form_border_width","fs_font","form_fill","form_font","form_font_size","ffw_fill","ffw_text","ffw_stroke","ffw_stroke2","form_textblock_border","form_border_dash","fs_grouping_quick","colors_svg"],my_menu:"text-on-path",copyable:!1},fa_icon:{svg_fig:"text",my_name:"icon_basic",dims:{},styles:{"font-family":"FontAwesome"},myclasses:["mainfig"],my_style_classes:["style_23","font1"],my_form_elements:["fs_colors","fs_zoom_pos","fs_grouping","fs_font","form_fill","form_font_size","colors_svg","form_disperse","fs_border","form_border_width","form_border_dash","ffw_fill","ffw_stroke","fs_grouping_quick"],my_menu:"icon",copyable:!0},math_basic:{svg_fig:"relay",my_name:"math_basic",dims:{width:100,height:100},myclasses:["mainfig"],my_style_classes:["style_23","font2"],my_form_elements:["fs_colors","fs_zoom_pos","fs_grouping","fs_font","form_fill","form_font_size","fs_fig_stuff","colors_svg","form_disperse","fs_border","form_border_width","form_border_dash","ffw_fill","ffw_stroke","fs_grouping_quick"],my_menu:"icon",copyable:!0}},poly_config={rect:{points:[[0,0],[1,0],[1,1],[0,1]],fo_top_left:[0,0],fo_width:1,fo_height:1,dims:{width:90,height:90},borders:[[0],[1],[2],[3]]},triangle_u:{points:[[.5,0],[1,1],[0,1]],fo_top_left:[.25,.5],fo_width:.5,fo_height:.5,dims:{width:120,height:90},borders:[[2,0],[0],[1],[2]]},triangle_d:{points:[[0,0],[1,0],[.5,1]],fo_top_left:[.25,0],fo_width:.5,fo_height:.5,dims:{width:120,height:90},borders:[[0],[1],[1,2],[2]]},triangle_l:{points:[[1,0],[1,1],[0,.5]],fo_top_left:[.5,.25],fo_width:.5,fo_height:.5,dims:{width:90,height:90},borders:[[2],[0],[1],[1,2]]},triangle_r:{points:[[0,0],[1,.5],[0,1]],fo_top_left:[0,.25],fo_width:.5,fo_height:.5,dims:{width:90,height:90},borders:[[0],[0,1],[1],[2]]},rhombus:{points:[[.5,0],[1,.5],[.5,1],[0,.5]],fo_top_left:[.25,.25],fo_width:.5,fo_height:.5,dims:{width:90,height:90},borders:[[3,0],[0,1],[1,2],[2,3]]},diamond:{points:[[.2,0],[.8,0],[1,.25],[.5,1],[0,.25]],fo_top_left:[.2,0],fo_width:.6,fo_height:.5,dims:{width:90,height:90},borders:[[4,0,1],[1,2],[2,3],[3,4]]},hexagon_v:{points:[[.5,0],[1,.25],[1,.75],[.5,1],[0,.75],[0,.25]],fo_top_left:[0,.25],fo_width:1,fo_height:.5,dims:{width:100,height:80},borders:[[5,0],[0,1,2],[2,3],[3,4,5]]},hexagon_h:{points:[[0,.5],[.25,0],[.75,0],[1,.5],[.75,1],[.25,1]],fo_top_left:[.25,0],fo_width:.5,fo_height:1,dims:{width:100,height:80},borders:[[0,1,2],[2,3],[3,4,5],[5,0]]},octagon:function(e){return s=1/(1+Math.sqrt(2)),x=(1-s)/2,{points:[[x,0],[x+s,0],[1,x],[1,x+s],[x+s,1],[x,1],[0,x+s],[0,x]],fo_top_left:[x/2,x/2],fo_width:x+s,fo_height:x+s,borders:[[7,0,1],[1,2,3],[3,4,5],[5,6,7]],dims:{width:90,height:90}}}(),parallellogram:{points:[[.5,0],[1,0],[.5,1],[0,1]],fo_top_left:[.25,0],dims:{width:90,height:90},fo_width:.5,fo_height:1},arrow_right:{points:[[0,.25],[2/3,.25],[2/3,0],[1,.5],[2/3,1],[2/3,.75],[0,.75]],fo_top_left:[0,.25],fo_width:2/3,fo_height:.5,borders:[[0,1,2],[2,3],[3,4,5],[4,6,1]],dims:{width:110,height:90},shape:function(e,t,r){return[1,2,5,4].forEach(function(r){return e[r][0]+=t}),[0,1].forEach(function(t){return e[t][1]+=r}),[6,5].forEach(function(t){return e[t][1]-=r}),e},fo_dims:function(e){return[e[0],e[1][0]-e[0][0],e[6][1]-e[0][1]]},reshape_icon:53,cp_index:1},arrow_left:{points:[[1,.75],[1/3,.75],[1/3,1],[0,.5],[1/3,0],[1/3,.25],[1,.25]],fo_top_left:[1/3,.25],fo_width:2/3,fo_height:.5,borders:[[3,4,5],[4,6,1],[0,1,2],[2,3]],dims:{width:110,height:90},shape:function(e,t,r){return[1,2,5,4].forEach(function(r){return e[r][0]+=t}),[0,1].forEach(function(t){return e[t][1]-=r}),[6,5].forEach(function(t){return e[t][1]+=r}),e},fo_dims:function(e){return[e[5],e[0][0]-e[1][0],e[0][1]-e[6][1]]},cp_index:5,reshape_icon:53},arrow_up:{points:[[.25,1],[.25,1/3],[0,1/3],[.5,0],[1,1/3],[.75,1/3],[.75,1]],fo_top_left:[.25,1/3],fo_width:.5,fo_height:2/3,borders:[[2,3],[3,5],[4,6,1],[0,1,2]],dims:{width:90,height:110},shape:function(e,t,r){return[1,2,5,4].forEach(function(t){return e[t][1]+=r}),[0,1].forEach(function(r){return e[r][0]-=t}),[6,5].forEach(function(r){return e[r][0]+=t}),e},fo_dims:function(e){return[e[1],e[6][0]-e[0][0],e[0][1]-e[1][1]]},cp_index:5,reshape_icon:53},arrow_down:{points:[[.75,0],[.75,2/3],[1,2/3],[.5,1],[0,2/3],[.25,2/3],[.25,0]],fo_top_left:[.25,0],fo_width:.5,fo_height:2/3,borders:[[4,6,1],[0,2],[2,3],[3,5]],dims:{width:90,height:110},shape:function(e,t,r){return[1,2,5,4].forEach(function(t){return e[t][1]+=r}),[0,1].forEach(function(r){return e[r][0]+=t}),[6,5].forEach(function(r){return e[r][0]-=t}),e},fo_dims:function(e){return[e[6],e[0][0]-e[6][0],e[1][1]-e[0][1]]},reshape_icon:53,cp_index:1},chevron_right:{points:[[0,0],[.8,0],[1,.5],[.8,1],[0,1],[.2,.5]],fo_top_left:[.2,0],fo_width:.6,fo_height:1,borders:[[0,1],[1,2],[2,3],[4,5]],dims:{width:100,height:70},shape:function(e,t,r){return[2,5].forEach(function(r){return e[r][0]+=t}),e},fo_dims:function(e){return[[e[5][0],0],e[1][0]-e[5][0],e[3][1]-e[1][1]]},reshape_icon:25,cp_index:2},chevron_left:{points:[[.2,0],[1,0],[.8,.5],[1,1],[.2,1],[0,.5]],fo_top_left:[.2,0],fo_width:.6,fo_height:1,borders:[[5,0],[1,2],[3,4],[4,5]],dims:{width:100,height:70},shape:function(e,t,r){return[2,5].forEach(function(r){return e[r][0]+=t}),e},fo_dims:function(e){return[e[0],e[2][0]-e[0][0],e[4][1]-e[0][1]]},reshape_icon:25,cp_index:2},chevron_up:{points:[[0,.2],[.5,0],[1,.2],[1,1],[.5,.8],[0,1]],fo_top_left:[0,.2],fo_width:1,fo_height:.6,borders:[[0,1],[1,2],[3,4],[5,0]],dims:{width:60,height:90},shape:function(e,t,r){return[1,4].forEach(function(t){return e[t][1]+=r}),e},fo_dims:function(e){return[e[0],e[2][0]-e[0][0],e[4][1]-e[0][1]]},reshape_icon:26,cp_index:1},chevron_down:{points:[[0,0],[.5,.2],[1,0],[1,.8],[.5,1],[0,.8]],fo_top_left:[0,.2],fo_width:1,fo_height:.6,borders:[[0,1],[1,2],[2,3],[4,5]],dims:{width:60,height:90},shape:function(e,t,r){return[1,4].forEach(function(t){return e[t][1]+=r}),e},fo_dims:function(e){return[[0,e[1][1]],e[2][0]-e[0][0],e[3][1]-e[1][1]]},reshape_icon:26,cp_index:1},house_up:{points:[[.5,0],[1,.3],[1,1],[0,1],[0,.3]],fo_top_left:[0,.3],fo_width:1,fo_height:.7,borders:[[4,0],[0,1],[2],[3,4]],dims:{width:70,height:90},shape:function(e,t,r){return e[0][1]-=r,e},fo_dims:function(e){return[e[4],e[1][0]-e[4][0],e[2][1]-e[1][1]]},reshape_icon:26,cp_index:1},house_down:{points:[[.5,1],[0,.7],[0,0],[1,0],[1,.7]],fo_top_left:[0,0],fo_width:1,fo_height:.7,borders:[[2],[3,4],[4,0],[0,1]],dims:{width:70,height:90},shape:function(e,t,r){return e[0][1]-=r,e},fo_dims:function(e){return[e[2],e[4][0]-e[1][0],e[1][1]-e[2][1]]},reshape_icon:26,cp_index:1},house_left:{points:[[0,.5],[.3,0],[1,0],[1,1],[.3,1]],fo_top_left:[.3,0],fo_width:.7,fo_height:1,borders:[[0,1],[2],[3,4],[4,0]],dims:{width:70,height:90},shape:function(e,t,r){return e[0][0]-=t,e},fo_dims:function(e){return[e[1],e[2][0]-e[1][0],e[3][1]-e[2][1]]},reshape_icon:25,cp_index:1},house_right:{points:[[1,.5],[.7,1],[0,1],[0,0],[.7,0]],fo_top_left:[0,0],fo_width:.7,fo_height:1,borders:[[3,4],[4,0],[0,1],[2]],dims:{width:70,height:90},shape:function(e,t,r){return e[0][0]-=t,e},fo_dims:function(e){return[e[3],e[1][0]-e[2][0],e[2][1]-e[3][1]]},reshape_icon:25,cp_index:1},parallello_hor:{points:[[.25,0],[1,0],[.75,1],[0,1]],fo_top_left:[.25,0],fo_width:.5,fo_height:1,borders:[[3,0],[1],[1,2],[3]],dims:{width:70,height:90},shape:function(e,t,r){return e[0][0]+=t,e[2][0]-=t,e},fo_dims:function(e){return[e[0],e[2][0]-e[0][0],e[3][1]-e[0][1]]},reshape_icon:25,cp_index:1},parallello_hor_mirrored:{points:[[0,0],[.75,0],[1,1],[.25,1]],fo_top_left:[.25,0],fo_width:.5,fo_height:1,borders:[[0,1],[1],[2,3],[3]],dims:{width:70,height:90},shape:function(e,t,r){return e[1][0]+=t,e[3][0]-=t,e},fo_dims:function(e){return[[e[3][0],e[0][1]],e[1][0]-e[3][0],e[2][1]-e[1][1]]},reshape_icon:25,cp_index:1},parallello_vert:{points:[[0,.25],[1,0],[1,.75],[0,1]],fo_top_left:[0,.25],fo_width:1,fo_height:.5,borders:[[0],[1,2],[2],[3,0]],dims:{width:70,height:90},shape:function(e,t,r){return e[0][1]-=r,e[2][1]+=r,e},fo_dims:function(e){return[e[0],e[1][0]-e[0][0],e[2][1]-e[0][1]]},reshape_icon:26,cp_index:1},parallello_vert_mirrored:{points:[[0,0],[1,.25],[1,1],[0,.75]],fo_top_left:[0,.25],fo_width:1,borders:[[0],[0,1],[2],[2,3]],fo_height:.5,dims:{width:70,height:90},shape:function(e,t,r){return e[0][1]-=r,e[2][1]+=r,e},fo_dims:function(e){return[[e[0][0],e[1][1]],e[1][0]-e[0][0],e[3][1]-e[1][1]]},reshape_icon:26,cp_index:1}},polygon_shapes=Object.keys(poly_config),simple_perc=function(e){return function(t,r,n){return t+r*e*n}},perc_with_min=function(e,t){return function(r,n,o){return e*n>t?simple_perc(e)(r,n,o):r+t*o}},line_styles={straight:{perpendicular:[.5,.5],inline:[.5,.5]},fluid:{perpendicular:[.5,.5],inline:[0,0]},manh_swirl:{perpendicular:[1,1],inline:[0,0]},manhattan:{},arced:{perpendicular:[.4,.4],inline:[-20,.8]},super_swirl:{perpendicular:[simple_perc(.6),simple_perc(.4)],inline:[perc_with_min(-.2,-20),perc_with_min(-.3,-50)]}},path_specs={part_of:{thickness:"thick_to_thin",style:{"stroke-width":"2px",stroke:"black",fill:"rgb(186, 41, 41)","fill-opacity":.8}},example_of:{thickness:"thick_to_thin",style:{"stroke-width":"3px",stroke:"rgb(51, 45, 45)",fill:"steelblue","fill-opacity":.8}},plain:{thickness:"single_stroke",style:{"stroke-width":"3px",stroke:"rgb(77,64,64)",fill:"None","fill-opacity":.9}},double:{thickness:"double",style:{"stroke-width":"6px",stroke:"rgb(207, 85, 68)",fill:"None","fill-opacity":.8}},double_inner:{thickness:"single_stroke",style:{"stroke-width":"4px",stroke:"white",fill:"None","fill-opacity":1}},click_catcher:{thickness:"single_stroke",style:{"stroke-width":"20px",fill:"None","stroke-dasharray":0}}},predef_styles=function(){function e(e){e.style_class=!1}function t(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=arguments.length>1&&void 0!==arguments[1]&&arguments[1]
e||(e=active_style.style_class),shapes_storage.get_all().filter(function(t){return t.style_class==e}).forEach(function(n){r(n,e),t&&"border"==n.iama&&(recalc_border_width(n.id),position_texts(n.id))}),render_all(0,!1,!0)}function r(e){function t(e,t,r){e.has_own_style||["fill","stroke","color","stroke_width"].forEach(function(r){e[r]=t[r]}),e.font_fam_inherited&&(e.font_family=t.font_family),e.font_size_inherited&&(e.font_size=infinity.get_font_size(r,n.font_class)),measure_text(e)}var r=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=r?g[r]:e.style_class
if("drawing"==e.iama||"path_group"==e.iama&&"plain"==e.type)e.stroke=is_visible_color(n.fill)?n.fill:is_visible_color(n.stroke)?n.stroke:"rgba(10,10,10,0.8)",e.fill=e.stroke,e.color=n.color,e.add_ons&&Object.keys(e.add_ons).forEach(function(t){e.add_ons[t].style.fill=e.fill,e.add_ons[t].style.stroke=e.stroke})
else if("text"==e.iama)["fill","stroke","color","stroke_width"].forEach(function(t){e[t]=n[t]}),e.font_family=n.font_family,e.font_fam_inherited=!1
else{["fill","stroke","color","stroke_width","font_family","padding"].forEach(function(t){e[t]=n[t]}),e.text_align=n.alignment
var o=infinity.get_level_of_item(e)
if(e.font_size=infinity.get_font_size(o,n.font_class||2),"border"==e.iama){var a=get_text_with_border_id(e.id)
a.forEach(function(r){t(r,n,e.level||"L1")})}position_texts(e.id)}}function n(e){shapes_storage.get_all().filter(function(t){return t.style_class==e}).forEach(function(t){r(t,e)}),render_all(0,!1,!0)}function o(e){return arguments.length>1&&void 0!==arguments[1]&&arguments[1],y[parseInt(e.slice(-1))-1]}function a(e,t){return infinity.get_font_sizes_of_level(t).indexOf(e)}function i(e){_(e),l(e),c(e),u(e),d(e),f(e),s(),active_style.style_class=e,v=!0}function s(){document.querySelector("#ffw_fill").style.display="flex",document.querySelector("#ffw_stroke").style.display="flex",document.querySelector("#ffw_text").style.display="flex",document.querySelector("#ffw_stroke2").style.display="none"}function _(e){d3.selectAll("#predef_font_sizes button.onoff-on").classed("onoff-on",!1)
var t=g[e].font_class+2
document.querySelector("#predef_font_sizes button:nth-child("+t+")").classList.add("onoff-on")}function l(e){d3.selectAll("#predef_text_align button.onoff-on").classed("onoff-on",!1)
var t=g[e].alignment
t&&document.querySelector(".predef_text_align_"+t).classList.add("onoff-on")}function c(e){var t=g[e].stroke_width
t&&(document.querySelector("#predef_border_width input").value=parseFloat(t))}function u(e){var t=g[e].line_height
t&&(document.querySelector("#predef_fig_line_height input").value=parseFloat(t))}function d(e){var t=g[e].font_family
t&&(document.querySelector("#predef_font_list").value=t)}function f(e){var t=g[e].padding
t&&(document.querySelector("#predef_article_padding input").value=t)}function h(e,t,r){g[e][t]=r,"fill"==t||"stroke"==t?d3.selectAll(".example_styles > rect.".concat(active_style.style_class)).style(t,r):"color"==t&&d3.selectAll(".example_styles > text.".concat(active_style.style_class)).style(t,r)}function p(){v=!1}function m(e){g=e,Object.keys(g).forEach(function(e){d3.selectAll(".example_styles > rect.".concat(e)).style("fill",g[e].fill),d3.selectAll(".example_styles > rect.".concat(e)).style("stroke",g[e].stroke),d3.selectAll(".example_styles > rect.".concat(e)).style("stroke-width",g[e].stroke_width+"px"),d3.selectAll(".example_styles > text.".concat(e)).style("fill","black"==g[e].color||"rgba(0,0,0,1)"==g[e].color?"rgba(0,0,0,0)":g[e].color)})}var g={style_1:{line_height:1.4,alignment:"left",font_class:2,padding:6,font_family:"Open Sans",stroke_width:1,fill:"rgba(95, 3, 255, 0.9)",color:"rgba(0,0,0,1)",alpha:.9,stroke:"rgba(0,0,0,1)"},style_2:{line_height:1.4,alignment:"left",font_class:2,padding:6,font_family:"Open Sans",stroke_width:1,fill:"rgba(2, 92, 252, 0.9)",color:"rgba(0,0,0,1)",alpha:.9,stroke:"rgba(0,0,0,1)"},style_0:{line_height:1.4,alignment:"left",font_class:2,padding:6,font_family:"Open Sans",stroke_width:1,fill:"rgba(255, 0, 11, 0.9)",color:"rgba(0,0,0,1)",alpha:.9,stroke:"rgba(0,0,0,1)"},style_3:{line_height:1.4,alignment:"left",font_class:2,padding:6,font_family:"Open Sans",stroke_width:1,fill:"rgba(26, 255, 0, 0.9)",color:"rgba(0,0,0,1)",alpha:.9,stroke:"rgba(0,0,0,1)"},style_4:{line_height:1.4,alignment:"left",font_class:2,padding:6,font_family:"Open Sans",stroke_width:1,fill:"rgba(246, 252, 5, 0.9)",color:"rgba(0,0,0,1)",alpha:.9,stroke:"rgba(0,0,0,1)"},style_5:{line_height:1.4,alignment:"left",font_class:2,padding:6,font_family:"Open Sans",stroke_width:1,fill:"rgba(253, 0, 192, 0.9)",color:"rgba(0,0,0,1)",alpha:.9,stroke:"rgba(0,0,0,1)"},style_6:{line_height:1.4,alignment:"left",font_class:2,padding:6,font_family:"Open Sans",stroke_width:1,fill:"rgba(171, 7, 7, 0.5)",color:"rgba(0,0,0,1)",alpha:.9,stroke:"rgba(0,0,0,1)"},style_7:{line_height:1.4,alignment:"left",font_class:2,padding:6,font_family:"Open Sans",stroke_width:1,fill:"rgba(129, 79, 179, 0.52)",color:"rgba(0,0,0,1)",alpha:.9,stroke:"rgba(0,0,0,1)"},style_8:{line_height:1.4,alignment:"left",font_class:2,padding:6,font_family:"Open Sans",stroke_width:1,fill:"rgba(8, 58, 150, 0.55)",color:"rgba(0,0,0,1)",alpha:.9,stroke:"rgba(0,0,0,1)"},style_9:{line_height:1.4,alignment:"left",font_class:2,padding:6,font_family:"Open Sans",stroke_width:1,fill:"rgba(20, 160, 4, 0.52)",color:"rgba(0,0,0,1)",alpha:.9,stroke:"rgba(0,0,0,1)"},style_10:{line_height:1.4,alignment:"left",font_class:2,padding:6,font_family:"Open Sans",stroke_width:1,fill:"rgba(214, 219, 0, 0.48)",color:"rgba(0,0,0,1)",alpha:.9,stroke:"rgba(0,0,0,1)"},style_11:{line_height:1.4,alignment:"left",font_class:2,padding:6,font_family:"Open Sans",stroke_width:1,fill:"rgba(165, 6, 126, 0.39)",color:"rgba(0,0,0,1)",alpha:.9,stroke:"rgba(0,0,0,1)"},style_12:{line_height:1.4,alignment:"left",font_class:2,padding:6,font_family:"Open Sans",stroke_width:1,fill:"rgba(110, 5, 9, 0.14)",color:"rgba(0,0,0,1)",alpha:.9,stroke:"rgba(0,0,0,1)"},style_13:{line_height:1.4,alignment:"left",font_class:2,padding:6,font_family:"Open Sans",stroke_width:1,fill:"rgba(74, 5, 107, 0.14)",color:"rgba(0,0,0,1)",alpha:.9,stroke:"rgba(0,0,0,1)"},style_14:{line_height:1.4,alignment:"left",font_class:2,padding:6,font_family:"Open Sans",stroke_width:1,fill:"rgba(5, 36, 108, 0.18)",color:"rgba(0,0,0,1)",alpha:.9,stroke:"rgba(0,0,0,1)"},style_15:{line_height:1.4,alignment:"left",font_class:2,padding:6,font_family:"Open Sans",stroke_width:1,fill:"rgba(16, 124, 4, 0.12)",color:"rgba(0,0,0,1)",alpha:.9,stroke:"rgba(0,0,0,1)"},style_16:{line_height:1.4,alignment:"left",font_class:2,padding:6,font_family:"Open Sans",stroke_width:1,fill:"rgba(246, 252, 5, 0.2)",color:"rgba(0,0,0,1)",alpha:.9,stroke:"rgba(0,0,0,1)"},style_17:{line_height:1.4,alignment:"left",font_class:2,padding:6,font_family:"Open Sans",stroke_width:1,fill:"rgba(157, 5, 120, 0.13)",color:"rgba(0,0,0,1)",alpha:.9,stroke:"rgba(0,0,0,1)"},style_18:{line_height:1.4,alignment:"left",font_class:2,padding:6,font_family:"Open Sans",stroke_width:3,fill:"rgba(0,0,0,0)",color:"rgba(207, 85, 68,1)",alpha:0,stroke:"rgba(207, 85, 68, 1)"},style_19:{line_height:1.4,alignment:"left",font_class:2,padding:6,font_family:"Open Sans",stroke_width:0,fill:"rgba(0,0,0,0)",color:"rgba(0,0,0,1)",alpha:0,stroke:"rgba(0,0,0,1)"},style_20:{line_height:1.4,alignment:"left",font_class:2,padding:6,font_family:"Open Sans",stroke_width:1,fill:"rgba(255,255,255,0.9)",color:"rgba(0,0,0,1)",alpha:0,stroke:"rgba(0,0,0,1)"},style_21:{line_height:1.4,alignment:"left",font_class:2,padding:6,font_family:"Open Sans",stroke_width:1,fill:"rgba(49,232,120,0.9)",color:"rgba(0,0,0,1)",alpha:.9,stroke:"rgba(0,0,0,1)"},style_22:{line_height:1.4,alignment:"left",font_class:2,padding:6,font_family:"Open Sans",stroke_width:1,fill:"rgba(246,247,56,0.9)",color:"rgba(0,0,0,1)",alpha:.9,stroke:"rgba(0,0,0,1)"},style_23:{line_height:1.4,alignment:"left",font_class:2,padding:6,font_family:"Open Sans",stroke_width:1,fill:"rgba(0,0,0,0.9)",color:"rgba(0,0,0,1)",alpha:.9,stroke:"rgba(0,0,0,1)"},style_24:{line_height:1.4,alignment:"left",font_class:2,padding:6,font_family:"Open Sans",stroke_width:1,fill:"rgba(0,0,0,0.9)",color:"rgba(0,0,0,1)",alpha:.9,stroke:"rgba(0,0,0,1)"}},y=[48,32,24,18,12],v=!1
return["predef_font1_holder","predef_font2_holder","predef_font3_holder","predef_font4_holder","predef_font5_holder"].forEach(function(e,r){document.querySelector("."+e).onclick=function(e){predef_styles.set_val_to_class(active_style.style_class,"font_class",r),_(active_style.style_class),t(!1,!0)}}),document.querySelector("#predef_font_list").onchange=function(e){predef_styles.set_val_to_class(active_style.style_class,"font_family",this.value),t(!1,!0)},document.querySelector(".predef_text_align_left").onclick=function(e){predef_styles.set_val_to_class(active_style.style_class,"alignment","left"),l(active_style.style_class),t(!1,!0)},document.querySelector(".predef_text_align_right").onclick=function(e){predef_styles.set_val_to_class(active_style.style_class,"alignment","right"),l(active_style.style_class),t(!1,!0)},document.querySelector(".predef_text_align_center").onclick=function(e){predef_styles.set_val_to_class(active_style.style_class,"alignment","center"),l(active_style.style_class),t(!1,!0)},plus_minus_generator(document.getElementById("predef_fig_line_height"),function(e){predef_styles.set_val_to_class(active_style.style_class,"line_height",parseFloat(e.value)),t(!1,!0)},.1,2),plus_minus_generator(document.getElementById("predef_border_width"),function(e){predef_styles.set_val_to_class(active_style.style_class,"stroke_width",parseFloat(e.value)),d3.selectAll(".example_styles > rect.".concat(active_style.style_class)).style("stroke-width",Math.min(parseFloat(e.value),.2)),t()},.5,2),plus_minus_generator(document.getElementById("predef_article_padding"),function(e){predef_styles.set_val_to_class(active_style.style_class,"padding",parseFloat(e.value)),t(!1,!0)},1,1),{change_shapes_with_class_for_predef_style_change:n,set_font_size_of_predef:function(e,t){e>-1&&e<5&&(y[e]=t)},get_classes:function(){return g},style_class_to_custom:e,font_sizes:y,get_font_style:function(e){var t=""
return e.font_style&&(t+=e.font_style+" "),t+e.font_size+'px "'+e.font_family+'"'},font_class_to_size:o,is_font_class:a,set_styles_from_class:function(e,t){e.style_class=t,r(e,t)},set_cm_for_predef_style:i,styling_predef:function(){return v},set_val_to_class:h,styling_predef_done:p,load:m}}(),active_style={fill:"rgba(0,0,0,0)",stroke:"rgba(0,0,0,0)",color:"rgba(0,0,0,1)",fill_what:"fill",line_flow:"fluid",line_style:"plain",stroke_width:2,shape:"rect",style_class:"style_20",font_class:"font3",pencil_size:2},style_copier=function(){function e(e){var t=currentElement.iama
if(t in figs&&"copyable"in figs[t]&&!figs[t].copyable)return text_to_feedback_pane("cannot style copy a ".concat(t)),_=!1,!1
_=!0,l="parent"in currentElement?currentElement.parent:currentElement}function t(e){manage_groups.get_group(e,!0).forEach(function(e){var t=e.iama
if("path_group"==t)i(e),path.remake_path(e)
else if("math_shape"==t)n(e)
else if("text"==t){var r=part_to_chunk(e)
o(r),measure_text(r),recalc_border_width(r.border_id),recalc_border_height(r.border_id,!0),position_texts(r.border_id)}else!function(){a(e)
for(var t=get_chunks_by_par(l.id),r=get_chunks_by_par(e.id),n=0;n<e.num_pars;n++)!function(e){t[e]&&r[e].forEach(function(r){r.chunk_num<t[e].length&&(o(r,t[e][r.chunk_num]),measure_text(r))})}(n)
0!=e.num_pars&&(recalc_border_width(e.id),recalc_border_height(e.id,!0),position_texts(e.id))}()}),_=!1,l=!1,set_current_element(e)}function r(e,t){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2]
r||(r=l),t.forEach(function(t){t in r&&(e[t]=r[t])})}function n(e){r(e,["fill","stroke","stroke_width"])}function o(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1]
r(part_to_chunk(e),["has_own_style","color","fill","font_fam_inherited","font_family","font_size_inherited","font_size","line_height","margin","stroke","stroke_width"],t)}function a(e){r(e,["color","fill","font_family","font_size","padding","stroke","stroke_width","style_class","text_align","stroke_dasharray","border_sides_arr"])}function i(e){r(e,["inner_width","outer_width","fill","stroke","dasharray_inner","dasharray_outer"])}function s(){_=!1,l=!1}var _=!1,l=!1
return{setup_style_copy:e,is_on:function(){return _},copy_styles_to_shape:t,cancel:s}}(),OVERLAP=.95,path_end_figs={arrow:{filled:!0,fig:"polygon",attr:"points",style:"stroke-width:1px;fill:black;stroke:black;",func:make_arrow_head},curved_arrow:{fig:"path",attr:"d",style:"stroke-width:3px;stroke:black;",func:make_curved_arrow_head},rev_arrow:{filled:!0,fig:"polygon",attr:"points",style:"stroke-width:1px;fill:black;stroke:black;",func:make_arrow_head_rev}}
plus_minus_generator(document.getElementById("form_add_on_height"),change_arrow_size,5,1),plus_minus_generator(document.getElementById("form_add_on_width"),change_arrow_size,5,1),plus_minus_generator(document.getElementById("cm_add_on_height"),change_arrow_size,5,1),plus_minus_generator(document.getElementById("cm_add_on_width"),change_arrow_size,5,1)
for(var fsa=document.querySelectorAll(".toolbar1 legend"),i=0;i<fsa.length;i++)fsa[i].onclick=function(){this.parentElement.classList.contains("collapsed")&&(close_other_fieldsets(),!form_filled&&currentElement&&fill_forms(currentElement)),"fs_help"==this.parentElement.id&&(help_on=!help_on),toggle_field_set(this.parentElement)}
for(var fieldsets=document.querySelectorAll("fieldset"),k=0;k<fieldsets.length;k++)for(var menu=fieldsets[k],headers=menu.querySelectorAll(".submenus h4"),_i=0;_i<headers.length;_i++){var h=headers[_i]
h.onclick=change_submenu}var colorpicker=$("#colorpicker").spectrum({showAlpha:!0,color:"#ECC",showInput:!0,className:"full-spectrum",showInitial:!0,showPalette:!0,showSelectionPalette:!0,maxSelectionSize:10,localStorageKey:"spectrum.demo",move:function(e){if(0==e._a&&text_to_feedback_pane("warning: alpha is set to zero (see bar below the color)"),"stroke"==active_style.fill_what?active_style.stroke=e.toRgbString():"text"==active_style.fill_what?active_style.color=e.toRgbString():active_style.fill=e.toRgbString(),canvas_status.draw_mode)return start_new_draw_group(),!1
if("canvas"==currentElement.iama)return grid_canvas.node().style.backgroundColor=e.toRgbString(),!1
if(predef_styles.styling_predef()){var t="fill"==active_style.fill_what?"fill":"text"==active_style.fill_what?"color":"stroke"
return predef_styles.set_val_to_class(active_style.style_class,t,e.toRgbString()),"fill"==active_style.fill_what&&(el.style.fill=e.toRgbString()),predef_styles.change_shapes_with_class_for_predef_style_change(active_style.style_class,_defineProperty({},t,!0)),!1}manage_groups.get_group(currentElement).forEach(function(e){if(e){if("path_addon"==e.iama){e.has_own_style=!0
var t=e.style}else if("text"==e.iama){var t=part_to_chunk(e)
t.has_own_style=!0}else{e.style_class=!1
var t=e}"stroke"==active_style.fill_what?t.stroke=active_style.stroke:"text"==active_style.fill_what?(t.color=active_style.color,"border"==t.iama&&change_text_color_of_chunks(t.id,active_style.color)):t.fill=active_style.fill}}),set_current_element(currentElement,!0)},show:function(){set_color_picker(currentElement)},beforeShow:function(){},hide:function(){predef_styles.styling_predef_done()},change:function(){},palette:[["rgb(0, 0, 0)","rgb(67, 67, 67)","rgb(102, 102, 102)","rgb(204, 204, 204)","rgb(217, 217, 217)","rgb(255, 255, 255)"],["rgb(152, 0, 0)","rgb(255, 0, 0)","rgb(255, 153, 0)","rgb(255, 255, 0)","rgb(0, 255, 0)","rgb(0, 255, 255)","rgb(74, 134, 232)","rgb(0, 0, 255)","rgb(153, 0, 255)","rgb(255, 0, 255)"],["rgb(230, 184, 175)","rgb(244, 204, 204)","rgb(252, 229, 205)","rgb(255, 242, 204)","rgb(217, 234, 211)","rgb(208, 224, 227)","rgb(201, 218, 248)","rgb(207, 226, 243)","rgb(217, 210, 233)","rgb(234, 209, 220)","rgb(221, 126, 107)","rgb(234, 153, 153)","rgb(249, 203, 156)","rgb(255, 229, 153)","rgb(182, 215, 168)","rgb(162, 196, 201)","rgb(164, 194, 244)","rgb(159, 197, 232)","rgb(180, 167, 214)","rgb(213, 166, 189)","rgb(204, 65, 37)","rgb(224, 102, 102)","rgb(246, 178, 107)","rgb(255, 217, 102)","rgb(147, 196, 125)","rgb(118, 165, 175)","rgb(109, 158, 235)","rgb(111, 168, 220)","rgb(142, 124, 195)","rgb(194, 123, 160)","rgb(166, 28, 0)","rgb(204, 0, 0)","rgb(230, 145, 56)","rgb(241, 194, 50)","rgb(106, 168, 79)","rgb(69, 129, 142)","rgb(60, 120, 216)","rgb(61, 133, 198)","rgb(103, 78, 167)","rgb(166, 77, 121)","rgb(91, 15, 0)","rgb(102, 0, 0)","rgb(120, 63, 4)","rgb(127, 96, 0)","rgb(39, 78, 19)","rgb(12, 52, 61)","rgb(28, 69, 135)","rgb(7, 55, 99)","rgb(32, 18, 77)","rgb(76, 17, 48)"]]}),r1=20,r2=150,r3=280,r4=410,r5=540,r6=670,r7=800,c1=20,c2=140,c3=260,c4=380,c5=520,c6=600
fig_to_pos={rect:[[c1,r1],1],rhombus:[[c2,r1],1],diamond:[[c3,r1],1],octagon:[[c4,r1],1],triangle_l:[[c1,r2],1],triangle_r:[[c2,r2],1],triangle_u:[[c3,r2],1],triangle_d:[[c4,r2],1],hexagon_h:[[c5,r2],1],arrow_up:[[c1,r3],1],arrow_down:[[c2,r3],1],arrow_right:[[c3,r3],1],arrow_left:[[c4,r3],1],hexagon_v:[[c5,r3],1],chevron_right:[[c1,r4],1],chevron_left:[[c2,r4],1],chevron_up:[[c3,r4],1],chevron_down:[[c4,r4],1],house_up:[[c1,r5],1],house_down:[[c2,r5],1],house_left:[[c3,r5],1],house_right:[[c4,r5],1],parallello_hor:[[c1,r6],1],parallello_hor_mirrored:[[c2,r6],1],parallello_vert:[[c3,r6],1],parallello_vert_mirrored:[[c4,r6],1]},fill_example_css_styles(d3.select("#colors_svg")),fill_example_css_styles(d3.select("#cm_colors_svg"),12),fill_example_figs(),document.querySelector("#form_size_delta").onclick=toggle_size_fine,document.querySelector("#form_move_delta").onclick=toggle_move_fine
var toggle_side_bar=function(e){var t=document.querySelector("#sidebar").classList.contains("menu_hidden")
1==arguments.length&&(t=e),document.querySelector("#sidebar").classList.toggle("menu_hidden",!t),document.querySelector("#show_button").style.display=t?"none":"block",form_hidden=!t,rescale_canvasses()}
$("#form_menu_hide").on("click",function(e){toggle_side_bar(),e.stopPropagation()}),document.querySelector("#show_button").onclick=function(e){toggle_side_bar(),e.stopPropagation()}
var text_to_feedback_pane=create_feedback_func()
if(demo_mode){var div=document.querySelector("#fs_demo_fb"),text_to_demo_pane=create_feedback_func(div)
dragElement(div)}var show_temp_button=function(){var e,t=document.querySelector("#fs_temp_button")
return function(r,n,o){var a=arguments.length>3&&void 0!==arguments[3]&&arguments[3],i=arguments.length>4&&void 0!==arguments[4]&&arguments[4],s=arguments.length>5&&void 0!==arguments[5]&&arguments[5]
t.style.display="inherit","string"==typeof r&&(r=[r])
var _=r.reduce(function(e,t){return e+"<p>"+t+"</p>"},"")
t.querySelector("div").innerHTML=_,t.querySelector("button#een").innerText=n,t.querySelector("button#een").onclick=function(){o(),t.style.display="none"},a?(t.querySelector("button#twee").innerText=a,t.querySelector("button#twee").onclick=function(){i(),t.style.display="none"}):t.querySelector("button#twee").style.display="none",clearTimeout(e),s&&(e=setTimeout(function(){return t.style.display="none"},s))}}(),text_to_help_pane=make_feedback_func(document.querySelector("#fs_help"))
create_nesw_button(document.querySelector("#cm-path-directions-from"),16,"from",function(e,t){return path.fix_path_side(e,t,-1)}),create_nesw_button(document.querySelector("#cm-path-directions-to"),16,"to",function(e,t){return path.fix_path_side(e,-1,t)}),create_nesw_button(document.querySelector("#form-path-directions-from"),16,"from",function(e,t){return path.fix_path_side(e,t,-1)}),create_nesw_button(document.querySelector("#form-path-directions-to"),16,"to",function(e,t){return path.fix_path_side(e,-1,t)}),function(){var e=[["M 0 4 L 25 20","straight"],["M 0 4 L 12 4 L12 20 L25 20","manhattan"],["M 0 4 L 10 4 L 25 20","hooked"],["M 0 4 L 16 16 L 25 16","hooked_rev"],["M 0 4 C 12 4 10 20 25 20","fluid"],["M 0 4 C 25 4 0 20 25 20","manh_swirl"],["M 0 4   C   12 2   14 2    25 20","arced"],["M 0 4 C 25 4 0 20 25 20","super_swirl"],["M 0 4 L 25 20","straight"],["M 0 4 L 12 4 L12 20 L25 20","manhattan"],["M 0 4 L 10 4 L 25 20","hooked"],["M 0 4 L 16 16 L 25 16","hooked_rev"],["M 0 4 C 12 4 10 20 25 20","fluid"],["M 0 4 C 25 4 0 20 25 20","manh_swirl"],["M 0 4   C   12 2   14 2    25 20","arced"],["M 0 4 C 25 4 0 20 25 20","super_swirl"]]
d3.selectAll("#form_path_style .buttonsvg").data(e).attr("flow",function(e){return e[1]}).append("path").attr("d",function(e){return e[0]}),$("#form_path_style .svg_holder").on("click",function(e){var t=e.currentTarget.querySelector("svg").getAttribute("flow"),r=manage_groups.get_group(currentElement,!0),n=[]
r=new Set(r.concat(n)),r.forEach(function(e){set_current_element(e),change_path_flow_and_style(!0,t)}),gui_buttons.frame_element(currentElement),render()})}()
var MIN_IN_VIEW=250,SCROLL_DELTA=18,menu_scroll_placer=function(e){function t(e){var t=parseInt(r.style.top)
e&&(t+=e),t=Math.min(n,t)
var o=document.querySelector("#form_slide_under").getBoundingClientRect(),a=o.bottom-o.top
t=Math.max(t,-Math.max(0,a-MIN_IN_VIEW)),r.style.top=t+"px"}var r=document.querySelector("#form_slide_under"),n=0
return r.style.top=n+"px",document.querySelector("#fs_container").style.top=n+"px",{scroll:function(e){t(Math.sign(e.deltaY)*-SCROLL_DELTA/2)},up:function(e){t(-50)},down:function(e){t(50)}}}()
document.querySelector("#form_slide_under").onwheel=menu_scroll_placer.scroll,document.querySelector("#form_menu_down").onclick=menu_scroll_placer.up,document.querySelector("#form_menu_up").onclick=menu_scroll_placer.down
var a=document.querySelector(".sp-palette-container"),b=document.querySelector("#form_fill_what")
a.appendChild(b),add_end_figs_for_path_to_buttons(),close_other_fieldsets(),document.body.onresize=function(e){rescale_canvasses()},$(".form_par_to_flip_side").on("click",function(e){var t=part_to_chunk(currentElement)
"flipped"in t||make_shape_flippable(shapes_storage.borders[t.border_id]),t.flipped=!0,position_texts(t.border_id),set_current_element(shapes_storage.borders[t.border_id])})
var undoer=function(){function e(){n.length>r&&(n=n.splice(1))}function t(e){var t=path.extract_elements_from_path_id(e.id),r=_slicedToArray(t,2),n=r[0],o=r[1],a=shapes_storage.knots.map(function(e){return e.id})
return a.includes(n)&&a.includes(o)?[n,o]:a.includes(n)?[n]:a.includes(o)?[o]:[]}var r=10,n=[],o=[]
return{start:function(){o=[]},stop:function(){n.push(o),e()},remove:function(e){var r=this
o.push(e),"path_group"==e.iama&&t(e).map(function(e){return shapes_storage.knots.filter(function(t){return t.id==e})[0]}).forEach(function(e){return r.remove(e)},this),"border"==e.iama&&(get_text_with_border_id(e.id).forEach(function(e){o.push(e),shapes_storage.remove(e)}),e.id in shapes_storage.images&&(o.push(shapes_storage.images[e.id]),delete shapes_storage.images[e.id])),"path_group"==e.iama&&Object.values(shapes_storage.borders_bound).filter(function(t){return t.path_id==e.id}).forEach(function(e){return r.remove(e)},this),shapes_storage.remove(e),"text"==e.iama&&reset_par_and_chunk_numbering(e.border_id)},undo:function(){if(0==n.length)return text_to_feedback_pane("no more items stored"),!1
to_add=n.pop(),to_add.forEach(function(e){shapes_storage.add_existing_shape(e)}),set_current_element(to_add[0])},show_stored:function(){return n}}}(),paths_on_canvas_done={}
$(".form_pencil_size button").on("click",function(e){$(".form_pencil_size").find("button").toggleClass("onoff-on",!1),$('.form_pencil_size button[value="'.concat(this.value,'"]')).toggleClass("onoff-on",!0),active_style.pencil_size=this.value,canvas_status.draw_mode&&(start_new_draw_group(),render_current_draw_group(context_single)),canvas_status.draw_mode||drag_draw_on()}),_.forEach([document.querySelector("#form_toggle_draw"),document.querySelector("#cm_toggle_draw")],function(e){e.onclick=function(e){cmm.off(),this.querySelector(".toggle-button").classList.contains("toggle-button-selected")?drag_draw_off():drag_draw_on()}}),document.querySelector("#cm_align_equal_height_each_row").onclick=equal_height_per_row,document.querySelector("#cm_align_equal_width_each_col").onclick=equal_width_per_col,document.querySelector("#cm_align_equal_height_current_row").onclick=equal_height_current_row,document.querySelector("#cm_align_equal_width_current_col").onclick=equal_width_current_col,plus_minus_generator(document.querySelector("#cm_align_x_delta"),function(e){alter_min_x_margin_for_table(parseInt(e.value))},1,0),plus_minus_generator(document.querySelector("#cm_align_y_delta"),function(e){alter_min_y_margin_for_table(parseInt(e.value))},1,0)
for(var t=document.querySelectorAll("#form_resize button"),i=0;i<t.length;i++)d=t[i],d.onclick=function(){var e=currentElement.iama
if(!e||"path_group"==e||"knot"==e||"text_basic"==e||"icon_basic"==e)return text_to_feedback_pane("not a valid element for alignment"),!1
if(canvas_status.align_on)var t=_.flatten(tables.temp01)
else var t=manage_groups.get_group(currentElement,!0)
resize_elements(currentElement,t,this.value),manage_groups.get_group(currentElement,!0).forEach(function(e){return delete e.redraw_data}),render()}
group_aligner=function(){function e(e,t){var r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],n=bbox_to_xywh(to_bbox(e)),o=bbox_to_xywh(to_bbox(t)),a=r?[n.x,n.x+n.width]:[n.y,n.y+n.height],i=r?[o.x,o.x+o.width]:[o.y,o.y+o.height]
return!(a[1]<i[0]||a[0]>i[1])}function t(e,t){return!(e.x>t.x+t.width||t.x>e.x+e.width||e.y>t.y+t.height||t.y>e.y+e.height)}function r(e,t,r){var n=function(e){return[e.x,e.y]},o=function(e){return[e.x+e.width,e.y]},a=function(e){return[e.x,e.y+e.height]}
return"left"==r?pyth_dist(n(e),o(t)):"right"==r?pyth_dist(o(e),n(t)):"top"==r?pyth_dist(n(e),a(t)):"bottom"==r?pyth_dist(a(e),n(t)):void 0}function n(e,t,r){return r?Math.abs(e.y-t.y):Math.abs(e.x-t.x)}function o(e){var t={left:s,right:l,up:c,down:u}
Object.entries(t).forEach(function(t){var r=_slicedToArray(t,2),n=r[0],o=r[1],a=o(e.me)
e[n]=a?T[a.id]:void 0}),[["left","up"],["left","down"],["right","up"],["right","down"]].forEach(function(t){var r=_slicedToArray(t,2),n=r[0],o=r[1]
return a(e,n,o)})}function a(e,t,r){if(e[t]&&e[t]==e[r]){var o=n(e.me,e[t].me,!0),a=n(e.me,e[r].me,!1)
e[function(e,t,r,n){return e<t?r:n}(a,o,t,r)]=void 0}}function i(e){var t=e
return _.indexOf(t,Math.min.apply(void 0,t))}function s(t){var n=q.filter(function(r){return e(t,r,!1)}).filter(function(e){return e.x<t.x})
return n[i(n.map(function(e){return r(t,e,"left")}))]}function l(t){var n=q.filter(function(r){return e(t,r,!1)}).filter(function(e){return e.x>t.x})
return n[i(n.map(function(e){return r(t,e,"right")}))]}function c(t){var n=q.filter(function(r){return e(t,r,!0)}).filter(function(e){return e.y<t.y})
return n[i(n.map(function(e){return r(t,e,"top")}))]}function u(t){var n=q.filter(function(r){return e(t,r,!0)}).filter(function(e){return e.y>t.y})
return n[i(n.map(function(e){return r(t,e,"bottom")}))]}function d(e,t){function r(e,t){for(var r=0;r<t.length&&(e.x>t[r][1]||e.x>=t[r][0]&&e.x<t[r][1]);r++);return r-1}var n=t.map(function(e){return e.reduce(function(e,t){return[Math.min(e[0],t.x),Math.min(e[1],t.x+t.width)]},[1/0,1/0])})
e.map(function(e){return e.map(function(e){return r(e,n)})}).forEach(function(t,r){_.range(n.length).forEach(function(n){-1==t.indexOf(n)&&e[r].splice(n,0,make_table_dummy_node(r,n,"temp01"))})})
var o=e.map(function(e){return e.length})
return _.all(o.map(function(e){return e==o[0]}))?(e.forEach(function(e){return e.forEach(function(e){return e.is_cell=!0})}),e.forEach(function(e,t){return e.forEach(function(e,r){return e.vt="dummy_cell"==e.me?e.vt:"".concat(t,"_").concat(r)})}),e.forEach(function(e){return e.forEach(function(e){return e.table="temp01"})}),e.forEach(function(e,t){return e.forEach(function(e,r){return e.vt=="".concat(t,"_").concat(r)})}),_.all(e.map(function(e,t){return e.map(function(e,r){return e.vt=="".concat(t,"_").concat(r)})}).map(function(e){return _.all(e)}))?(tables.temp01=e,!0):(f(),text_to_feedback_pane("Sorry, failed at aligning group. Try using less shapes...",!0,3500),!1)):(text_to_feedback_pane("Sorry, failed at aligning group. Try using less shapes...",!0,3500),!1)}function f(){q.forEach(function(e){delete e.vt,delete e.table,delete e.is_cell}),delete tables.temp01}function h(e){for(var r=0;r<e.length-1;r++){var n=e[r]
if("dummy_cell"!=n.me){var o=T[n.id].right
if(o){var a=o.me
a&&t(n,a)&&repos_cell(a,function(e,t){return e.x+e.width-t.x+10}(n,a),0,!0)}}}}function p(e){for(var r=0;r<e.length-1;r++){var n=e[r]
if("dummy_cell"!=n.me){var o=T[n.id].down
if(o){var a=o.me
t(n,a)&&repos_cell(a,0,function(e,t){return e.y+e.height-t.y+10}(n,a),!0)}}}}function m(e){return y(e,x)}function g(e){return y(e,k)}function y(e,t){rows=[],Object.values(e).forEach(function(e){rows.push(t(e))})
var r=new Set
return rows.filter(function(e){return e=e.sort(function(e,t){return e.id<t.id?-1:1}),!r.has(e[0].id)&&(r.add(e[0].id),!0)})}function v(e){var t=Math.min.apply(void 0,e.map(function(e){return e.y}))
e.forEach(function(e){repos_shape(e,0,t-e.y)})}function b(e){var t=Math.min.apply(void 0,e.map(function(e){return e.x}))
e.forEach(function(e){repos_shape(e,t-e.x,0)})}function w(e,t){for(var r=[];e[t];)r.push(e[t].me),e=e[t]
return r}function x(e){var t=[e.me]
return t=t.concat(w(e,"left")),t=t.concat(w(e,"right"))}function k(e){var t=[e.me]
return t=t.concat(w(e,"up")),t=t.concat(w(e,"down"))}function E(e){Object.values(e).forEach(function(e){[["up","down"],["down","up"],["left","right"],["right","left"]].forEach(function(t){var r=_slicedToArray(t,2),n=r[0],o=r[1],a=e[n]
a&&(a[o]&&a[o].me==e.me||(a[o],e[n]=!1))})})}function A(e){return{me:e,left:!1,right:!1,up:!1,down:!1}}function S(e){function t(e,t){e.forEach(function(r){var n=_slicedToArray(t[r.id],4),o=n[0],a=n[1],i=n[2],s=n[3]
repos_shape(r,o-r.x,a-r.y),resize_shape(r,i-r.width,s-r.height),position_texts(r.id),e.forEach(function(e){return path.recalc_connections(e.id,!0,!0)}),to_canvas.set_canvas()})}var r={}
if(q=e.filter(function(e){return"text"!=e.iama&&"path_group"!=e.iama&&!e.bound&&"drawing"!=e.iama}),0==q.length)return text_to_feedback_pane(["Could not find shapes to align in group","(you cannot align texts or paths)."]),!1
q.forEach(function(e){return r[e.id]=[e.x,e.y,e.width,e.height]}),T={},q.forEach(function(e){var t=A(e)
T[t.me.id]=t}),q.forEach(function(e){o(T[e.id])}),E(T)
var n=m(T).sort(function(e,t){return e[0].y-t[0].y}).map(function(e){return e.sort(function(e,t){return e.x-t.x})}),a=g(T).sort(function(e,t){return e[0].x-t[0].x}).map(function(e){return e.sort(function(e,t){return e.y-t.y})})
if(manage_groups.reset(!1),n.forEach(v),a.forEach(b),!d(n,a))return t(q,r),!1
canvas_status.align_on=!0,n.forEach(h),a.forEach(p),Object.values(T).forEach(function(e){return position_texts(e.me.id)}),text_for_render.invalidate_sorted(),render_all(!1,!1,!0)
var i=function(){canvas_status.align_on=!1,f(q),t(q,r),render_all(!1,!1,!0),manage_groups.toggle_elements(q)}
return align_update_messager.add_message(i,function(){canvas_status.align_on=!1,f(q),manage_groups.toggle_elements(q)}),q.forEach(function(e){return path.recalc_connections(e.id,!0,!0)}),to_canvas.set_canvas(),!0}var q,T
return{has_overlap:e,rects_overlap:t,align:S}}(),document.querySelector("#form_align_group").onclick=function(e){if(0!=align_update_messager.message_count())return text_to_feedback_pane(["can only align one group at a time.","Reset or keep current alignment first"],!0,4e3),!1
group_aligner.align(manage_groups.get_current_group())}
var key_pressed=[],marge_for_copy=parseInt(40/mdd)*mdd
window.onblur=function(e){key_pressed=[]},window.onfocus=function(e){key_pressed=[]}
var gui_cursor=function(e){function t(){var t=re.chunk.font_size,r=re.pos[0],n=re.pos[1]
if(canvas_status.mobile_mode)return display_cursor_mobile_mode(t,r,n)
e.save(),e.beginPath(),e.translate(transform.x,transform.y),e.scale(transform.k,transform.k)
var o=transform.k>1?Math.max(.4,round_to(ne/transform.k,1)):ne
e.rect(r,n,o,t),e.fill(),e.restore(),ee=!0,cc.set_has_ink(e)}function r(){e.save(),e.translate(transform.x,transform.y),e.scale(transform.k,transform.k)
var t=re.pos[0],r=re.pos[1]+re.part.baseline_offset-re.chunk.font_size
e.clearRect(t-2,r-2,ne+4,re.chunk.font_size+4),e.restore()}function n(e){se=!1,ae||(ae=e),r(),e-ae>oe&&(ie=!ie,ae=e),ie&&t(),te=requestAnimationFrame(n)}function o(){se&&(window.clearTimeout(se),se=!1),ee&&(window.cancelAnimationFrame(te),te=!1,ee=!1,cc.clear_canvas(cursor_context))}function a(e,t){var r=e.indexOf(t)
return r+1<e.length?r+1:-1}function i(e,t){var r=e.indexOf(t)
return r-1>=0?r-1:-1}function s(e){var t=get_chunks_in_par(re.chunk.border_id,re.chunk.par_num)
if(1==t.length)e=Math.max(Math.min(e,re.chunk.text.length),0)
else if(e>re.chunk.text.length){var r=a(t,re.chunk);-1!=r?(e=1,re.chunk=t[r]):e=Math.max(Math.min(e,re.chunk.text.length),0)}else if(e<0){var n=i(t,re.chunk);-1!=n?(e=t[n].text.length-1,re.chunk=t[n]):e=Math.max(Math.min(e,re.chunk.text.length),0)}var o=b(re.chunk,e),s=_slicedToArray(o,2),_=s[0],l=s[1],c=measure_par_width_at_each_letter(_).map(function(e){return e+_.x})
re.pos=[c[l],_.y],re.part=_,re.index=w(_,l)}function l(e,t){var r=measure_par_width_at_each_letter(e).map(function(t){return t+e.x}),n=d(r,t),o=_slicedToArray(n,2),a=o[0],i=o[1]
re.pos=[a,e.y],re.chunk=e.parent,re.part=e,re.index=w(e,i)}function c(e,t){var r=measure_par_width_at_each_letter(e).map(function(t){return t+e.x}),n=r[t]
re.pos=[n,e.y],re.chunk=e.parent,re.part=e,re.index=w(e,t)}function u(e,t,r){var n=v(e,t,r),o=_slicedToArray(n,2),a=o[0],i=o[1]
a?(set_current_element(a),c(a,i),C()):(Y(),cc.clear_canvas(gui_context),to_canvas.set_canvas())}function d(e,t){for(var r=0;r<e.length-1&&!(e[r]+(e[r+1]-e[r])/4>t);r++);return[e[r],r]}function f(){_e=!1,cc.clear_canvas(e)}function h(e){if(arguments.length>1&&void 0!==arguments[1]&&arguments[1],1==get_chunks_by_par(re.chunk.border_id)[e.par_num].length)re.chunk.text="",position_texts(re.chunk.border_id),c(re.chunk.parts[0],0)
else{var t=y()
shapes_storage.remove(e),check_par_for_chunk_style_equality(e.border_id,e.par_num),reset_chunk_numbering(e.border_id,e.par_num),Y(),cc.clear_canvas(gui_context),u(t,e.border_id,e.par_num)}}function p(){if(1==re.chunk.text.length)h(re.chunk)
else{re.chunk.text=re.chunk.text.slice(0,re.index)+re.chunk.text.slice(re.index+1),position_texts(re.chunk.border_id)
var e=b(re.chunk,re.index),t=_slicedToArray(e,2)
c(t[0],t[1])}}function m(){if(1==re.chunk.text.length&&0!=re.index)return h(re.chunk,!0),!1
if(0==re.chunk.text.length)return!1
if(r(),re.index>0){re.chunk.text=re.chunk.text.slice(0,re.index-1)+re.chunk.text.slice(re.index),position_texts(re.chunk.border_id)
var e=b(re.chunk,re.index-1),t=_slicedToArray(e,2)
c(t[0],t[1])}else{var n=get_chunks_in_par(re.chunk.border_id,re.chunk.par_num),o=i(n,re.chunk)
if(-1!=o)c(n[o].parts.slice(-1)[0],n[o].text.length),m()
else if(re.chunk.par_num>0){var a=re.chunk.par_num,s=get_chunks_in_par(re.chunk.border_id,a-1).slice(-1)[0].text.length
g(re.chunk.border_id,a-1,re.chunk.par_num),u(s,re.chunk.border_id,a-1)}}}function g(e,t,r){var n=find_border_by_id(e),o=get_chunks_by_par(e)
n.num_pars-=1
var a=o[t].slice(-1)[0].chunk_num
o[r].forEach(function(e,r){e.chunk_num=r+1+a,e.par_num=t}),reset_par_and_chunk_numbering(e),check_par_for_chunk_style_equality(e,t),position_texts(e)}function y(){for(var e=get_chunks_by_par(re.chunk.border_id)[re.chunk.par_num],t=0,r=0;r<re.chunk.chunk_num;r++)t+=e[r].text.length
return t+=re.index}function v(e,t,r){var n=get_chunks_by_par(t)[r]
if(!n)return[!1,!1]
if(total_length=n.reduce(function(e,t){return e+t.text.length},0),e>total_length-1)return[!1,!1]
for(var o=0,a=0;a<n.length&&!((o+=n[a].text.length)>e);a++);var i=n[a],s=e-o+i.text.length
o=0
for(var a=0;a<i.parts.length&&!((o+=i.parts[a].text.length)>s);a++);var _=i.parts[a]
return[_,s-o+_.text.length]}function b(e,t){part_lengths=e.parts.map(function(e){return e.text.length})
var r=0
part_lengths=part_lengths.map(function(e){return r+=e})
var n=_.findIndex(part_lengths,function(e){return e>t})
return-1==n&&(n=e.parts.length-1),[e.parts[n],t-[0].concat(part_lengths)[n]]}function w(e,t){for(var r=e.parent,n=r.parts.indexOf(e),o=0,a=0;a<n;a++)o+=r.parts[a].text.length
return t+o}function x(){var e=_e.in_selection[0],t=_e.in_selection.slice(-1)[0],r=b(e.chunk,e.after_index),n=_slicedToArray(r,2),o=n[0],a=n[1],i=b(t.chunk,t.before_index),s=_slicedToArray(i,2),_=s[0],l=s[1],c=measure_par_width_at_each_letter(o).map(function(e){return e+o.x})[a],u=measure_par_width_at_each_letter(_).map(function(e){return e+_.x})[l]
_e.start_x=c,_e.end_x=u,S(c,u,o,_,{fill:"rgba(0,0,360,0.10)"})}function k(t,r,n,a,i){o(),cc.clear_canvas(e)
var s=measure_par_width_at_each_letter(i).map(function(e){return e+i.x}),_=d(s,t),l=_slicedToArray(_,2),c=l[0],u=l[1],f=shapes_storage.find_shape(n,a)
f&&"border"!=f.iama||(f=i),f&&f!=i&&"text"==f.iama&&(s=measure_par_width_at_each_letter(f).map(function(e){return e+f.x}))
var h=d(s,n),p=_slicedToArray(h,2),m=p[0],g=p[1]
if(i.num>f.num||i.num==f.num&&c>m){var y=[f,i]
i=y[0],f=y[1]
var v=[m,c]
c=v[0],m=v[1]
var b=[g,u]
u=b[0],g=b[1]}i.parent.par_num==f.parent.par_num&&i.parent.border_id==f.parent.border_id||(f=get_chunks_in_par(i.parent.border_id,i.parent.par_num).slice(-1)[0].parts.slice(-1)[0],g=f.text.length),E(i.parent,f.parent,w(i,u-1),w(f,g),c,m),x()}function E(e,t,r,n,o,a){var i=[]
if(e==t)i.push({text:e.text.slice(r+1,n),chunk:e,after_index:r+1,before_index:n})
else{var s=e.chunk_num,_=t.chunk_num,l=get_text_with_border_id(e.border_id).filter(function(e){return e.chunk_num>s&&e.chunk_num<_})
i.push({text:e.text.slice(r+1),chunk:e,after_index:r+1,before_index:-1}),l.forEach(function(e){i.push({text:e.text,chunk:e,after_index:0,before_index:-1})}),i.push({text:t.text.slice(0,n),chunk:t,after_index:0,before_index:n})}_e={before:{chunk:e,text:e.text.slice(0,r+1),after_index:0,before_index:r+1},after:{chunk:t,text:t.text.slice(n),after_index:n,before_index:-1},in_selection:i,startx:o,endx:a}}function A(e,t){return!!_e&&!!_e.bboxes&&_.any(_e.bboxes.map(function(r){var n=_slicedToArray(r,4),o=n[0],a=n[1],i=n[2],s=n[3]
return is_inside(e,t,xywh_to_bbox({x:o,y:a,width:i,height:s}))}))}function S(e,t,r,n,o){cc.clear_canvas(cursor_context),cursor_context.save(),cursor_context.translate(transform.x,transform.y),cursor_context.scale(transform.k,transform.k)
var a=render_text_selection(e,t,r,n,o,cursor_context)
cursor_context.restore(),Z(a),cc.set_has_ink(cursor_context)}function q(e,t,r){o()
var n=measure_par_width_at_each_letter(r).map(function(e){return e+r.x}),a=d(n,e),i=_slicedToArray(a,2),s=(i[0],i[1]),_=T(r.text,s),l=_slicedToArray(_,2),c=l[0],s=l[1],u=n[c],f=n[s]
r.parent.parts.length>1&&(c=w(r,c),s=w(r,s)),E(r.parent,r.parent,c-1,s,u,f),S(u,f,r,r,{fill:"rgba(0,0,360,0.10)"})}function T(e,t){for(var r,n=/\s/g,o=[];null!==(r=n.exec(e));)o.push(r.index)
for(var a=0;a<o.length&&!(o[a]>t);a++);return 0==o.length?[0,e.length]:1==o.length?0==a?[0,o[0]]:[o[0]+1,e.length]:0==a?[0,o[a]]:a==o.length?[o[a-1]+1,e.length]:[o[a-1]+1,o[a]]}function z(e){var t=gui_cursor.get_range()
t.before.chunk.border_id!=currentElement.border_id&&set_current_element(find_border_by_id(t.before.chunk.border_id)),t.before.chunk==t.after.chunk?t.before.chunk.text=t.before.text+e+t.after.text:(compare_styles_of_chunks(t.before.chunk,t.after.chunk)?(t.before.chunk.text=t.before.text+e+t.after.text,t.in_selection.forEach(function(e){e.chunk!=t.before.chunk&&shapes_storage.remove(e.chunk)})):(t.before.chunk.text=t.before.text+e,t.after.chunk.text=t.after.text,t.in_selection.forEach(function(e){e.chunk!=t.before.chunk&&e.chunk!=t.after.chunk&&shapes_storage.remove(e.chunk)})),reset_par_and_chunk_numbering(t.before.chunk.border_id)),f(),measure_text(t.before.chunk),recalc_border_width(t.before.chunk.border_id),position_texts(t.before.chunk.border_id),c(t.before.chunk.parts[0],t.before.text.length+1),C()}function I(e){var r=re.chunk.text,n=r.slice(0,re.index),o=r.slice(re.index)
re.chunk.text=n+e+o,measure_text(re.chunk),recalc_border_width(re.chunk.border_id,!1,!0,!0),position_texts(re.chunk.border_id),s(re.index+1),cc.clear_canvas(cursor_context),t()}function M(e){j(),_e?z(e):I(e)}function j(){te&&window.cancelAnimationFrame(te),se&&window.clearTimeout(se),se=setTimeout(n,300)}function L(){var e=gui_cursor.get_range()
shapes_storage.remove(e.before.chunk)
var t=get_chunks_in_par(e.before.chunk.border_id,e.before.chunk.par_num).filter(function(t){return t.chunk_num>e.after.chunk.chunk_num})
delete e.before.chunk.parts
var r=JSON.parse(JSON.stringify(e.before.chunk))
r.text=e.before.text,""!=r.text&&(r.x=e.before.chunk.x,measure_text(r),r.chunk_num=e.before.chunk.chunk_num,shapes_storage.add_text(r))
var n=JSON.parse(JSON.stringify(e.before.chunk))
n.text=e.after.text,""!=n.text&&(measure_text(n),n.chunk_num=e.before.chunk.chunk_num+2,shapes_storage.add_text(n))
var o=JSON.parse(JSON.stringify(e.before.chunk))
return o.text=e.in_selection[0].text,measure_text(o),o.chunk_num=e.before.chunk.chunk_num+1,shapes_storage.add_text(o),t.forEach(function(e){return e.chunk_num+=3}),position_texts(e.before.chunk.border_id),reset_chunk_numbering(e.before.chunk.border_d,e.before.chunk.par_num),o}function C(){o(),canvas_status.mobile_mode?t():n(),ee=!0}function O(){var e=_e.in_selection.slice(-1)[0],t=function(){if(""==_e.after.text){var e=get_chunks_in_par(_e.before.chunk.border_id,_e.before.chunk.par_num)
return e.length>_e.after.chunk.chunk_num&&e[_e.after.chunk.chunk_num+1]}return _e.after.chunk}()
if(!t)return!1
if(t==_e.after.chunk)e.text=e.text+_e.after.text[0],_e.after.text=_e.after.text.slice(1),e.before_index+=1,_e.after.after_index+=1
else{var r={chunk:t,text:t.text[0],after_index:-1,before_index:1}
_e.after={chunk:t,text:t.text.slice(1),after_index:1,before_index:t.text.length},_e.in_selection.push(r)}x()}function R(){var e=_e.in_selection.slice(-1)[0]
if(""==e.text){if(1==_e.in_selection.length)return!1
_e.after={text:e.chunk.text,chunk:e.chunk,before_index:e.chunk.text.length,after_index:0},_e.in_selection.pop(),e=_e.in_selection.slice(-1)[0],e.before_index=e.chunk.text.length-1}else e.before_index-=1,_e.after.after_index-=1
_e.after.text=e.text.slice(-1)[0]+_e.after.text,e.text=e.text.slice(0,-1),x()}function P(){var e=_e.in_selection.slice(-1)[0]
e.text=e.text+_e.before.text.slice(-1)[0],e.after_index-=1,_e.before.text=_e.before.text.slice(0,-1),_e.before.before_index-=1,x()}function W(){var e=_e.in_selection.slice(-1)[0]
_e.before.text=_e.before.text+e.text[0],e.text=e.text.slice(1),e.after_index+=1,_e.before.before_index+=1,x()}function H(){E(re.chunk,re.chunk,re.index-1,re.index)}function B(){var e=get_chunks_in_par(_e.before.chunk.border_id,_e.before.chunk.par_num),t=_e.in_selection[0].chunk,r=e.slice(-1)[0]
E(t,r,_e.in_selection[0].after_index,r.text.length)}function $(){E(get_chunks_in_par(_e.before.chunk.border_id,_e.before.chunk.par_num)[0],_e.in_selection.slice(-1)[0].chunk,0,_e.in_selection.slice(-1)[0].before_index)}function N(){var e=get_chunks_in_par(_e.before.chunk.border_id,_e.before.chunk.par_num),t=e[0],r=e.slice(-1)[0]
E(t,r,-1,r.text.length),x()}function F(){var e=re.chunk,t=get_chunks_in_par(e.border_id,e.par_num)
E(t[0],t.slice(-1)[0],-1,t.slice(-1)[0].text.length),Y(),x()}function D(){var e=_e.in_selection[0].chunk,t=get_chunks_in_par(e.border_id,e.par_num)
return _e.in_selection.reduce(function(e,t){return e+t.text},"")==t.reduce(function(e,t){return e+t.text},"")}function Y(){o(),re.pos=[0,0],re.chunk=!1,re.index=0}function X(){I(le),le=!1,position_texts(currentElement.border_id),render()}function U(){le=K(),copy_or_cut_from_canvas(le,"copy")}function J(){le=K(),copy_or_cut_from_canvas(le,"copy"),z(""),render()}function K(){return le=_e.in_selection.map(function(e){return e.text}).join("")}function G(){if(!ee)return!1
var e=b(re.chunk,re.index),t=_slicedToArray(e,2),r=t[0]
return t[1],r}function V(){o()
var e=Object.assign({},re.chunk),t=Object.assign({},re.chunk)
shapes_storage.remove_text(re.chunk),shapes_storage.add_text(t),shapes_storage.add_text(e),e.text=re.chunk.text.slice(0,re.index),t.text=re.chunk.text.slice(re.index),measure_text(e),measure_text(t),0==t.text.length&&(t.has_own_style=!1)
for(var r=get_chunks_in_par(re.chunk.border_id,re.chunk.par_num),n=r.filter(function(e){return e.chunk_num>re.chunk.chunk_num}),a=find_border_by_id(re.chunk.border_id),i=re.chunk.par_num,s=get_chunks_by_par(re.chunk.border_id,!0),_=i+1;_<a.num_pars;_++)s[_].forEach(function(e){return e.par_num+=1})
n.forEach(function(e,t){e.par_num=i+1,e.chunk_num=t+1}),t.par_num=i+1,t.chunk_num=0,a.num_pars+=1,position_texts(a.id),reset_par_and_chunk_numbering(a.id),t.parts?c(t.parts[0],0):c(n.sort(function(e,t){return e.chunk_num-t.chunk_num})[0].parts[0],0),C(),render()}function Z(e){_e.bboxes=e}function Q(e){r(),j(),s(e),t()}var ee=!1,te=!1,re={pos:[0,0],index:0},ne=3,oe=500,ae=null,ie=!0,se=!1
e.save()
var _e=!1,le=!1
return{handle_text_paste:X,handle_text_copy:U,handle_text_cut:J,handle_new_line:V,handle_double_click:q,select_all_text_in_par_from_cursor:F,select_all_text_in_par_from_range:N,range_contains_all_text_in_par:D,get_range_to_paste:function(){return le},has_range_to_paste:function(){return!!le},move_cursor_to_end:function(){var e=re.chunk.text.length
j(),s(e)},move_cursor_to_start:function(){j(),s(0)},move_cursor_backward:function(){Q(re.index-1)},move_cursor_forward:function(){Q(re.index+1)},range_forward:function(){ee&&(H(),o()),_e.cursor_at_back?W():O()},range_backward:function(){ee?(H(),o(),_e.cursor_at_back=!0):_e.cursor_at_back?P():R()},range_to_end:function(){re&&(H(),o()),_e&&B(),x()},range_to_start:function(){re&&(H(),o()),_e&&$(),x()},xy_is_in_range:A,set_cursor_by_xpos:l,set_cursor_by_index:c,stop_cursor:o,clear_cursor:Y,start_cursor:C,select_text:k,clear_selection:f,has_selection:function(){return 0!=_e},clear:function(){f(),this.clear_cursor()},cursor_on:function(){return ee},get_range:function(){return _e},insert_text:M,get_cursor:function(){return re},split_off_range:L,delete:function(){ee?p():_e&&z("")},backspace:function(){ee?m():_e&&z("")},get_part_from_cursor:G,cursor_index_to_par_index:y,par_index_to_part_and_index_of_part:v}}(cursor_context),gui_buttons=function(){function e(e,t){return t.map(function(t){return t/e}).map(function(e){return Math.max(1,round_to(e,0))})}function t(t){if(!t)return!1
gui_context.save(),gui_context.translate(transform.x,transform.y),gui_context.scale(transform.k,transform.k),gui_context.beginPath(),gui_context.strokeStyle="red",gui_context.lineWidth=Math.min(3,round_to(.7/transform.k,1)),gui_context.setLineDash(e(transform.k,[5,10]))
var r=-transform.x/transform.k,o=-transform.y/transform.k,a=canvas_width/transform.k,i=canvas_height/transform.k
"path_addon"==t.iama&&(t=t.bbox),n(r,t.y,r+a,t.y),n(r,t.y+t.height,r+a,t.y+t.height),n(t.x,o,t.x,o+i),n(t.x+t.width,o,t.x+t.width,o+i),gui_context.stroke(),gui_context.restore(),cc.set_has_ink(gui_context)}function n(e,t,r,n){gui_context.moveTo(e,t),gui_context.lineTo(r,n)}function o(e){cc.clear_canvas(gui_context),cc.clear_canvas(hover_context),t(e)}function a(e){var t=path_to_array(e.d),r=t[0],n={font_size:20,x:r.x,y:r.y,width:20/transform.k,height:20/transform.k,iama:"path_indicator_tail",stroke:"black",fill:"#734b6d",icon:fa_handler.get_icons_per_cat()["Audio & Video"][4]},o=t.slice(-1)[0],a={font_size:20,x:o.x,y:o.y,width:20/transform.k,height:20/transform.k,iama:"path_indicator_tail",stroke:"black",fill:"#734b6d",icon:fa_handler.get_icons_per_cat().Arrows[7]}
u(n),u(a),position_path_direction_buttons(e)}function i(e){if(e&&"canvas"==e.iama||!e)return!1
if("text"==e.iama&&!("parent"in e))return!1
if(T(),gui_context.save(),gui_context.translate(transform.x,transform.y),gui_context.scale(transform.k,transform.k),gui_cursor.clear(),"text"==e.iama)gui_cursor.set_cursor_by_xpos(e,last_pos[0]),gui_cursor.start_cursor(),h(e)
else if("path_group"==e.iama)a(e)
else if("fa_icon"==e.iama);else if("knot"==e.iama);else{if("gui_resize"==e.iama||"gui_connect"==e.iama)return!1;-1==["knot","path_addon","math_shape"].indexOf(e.iama)&&v(e),-1!=["knot","drawing","path_addon","math_shape"].indexOf(e.iama)||e.bound||b(e),l(e)&&g(e),"drawing"==e.iama&&"line"==e.type&&p(e),"rect"==e.shape&&"flipped"in e&&y(e)}gui_context.restore(),t(e),R.length>0&&E()}function s(){var e=C,t=posit2.get_w_h(currentElement),r=_slicedToArray(t,2),n=r[0],o=r[1],a=posit2.get_top_left(currentElement,!0)
return"M"+[a[0]+n/2,a[1]+o/2]+"L "+[e.x,e.y]}function _(e,t){C.x+=e,C.y+=t,gui_context.save(),cc.clear_canvas(gui_context),gui_context.translate(transform.x,transform.y),gui_context.scale(transform.k,transform.k),drawPath({d:s(),outer_width:3,stroke:"black"},gui_context),u(C),gui_context.restore()}function l(e){return"border"==e.iama&&-1!=["arrow_right","arrow_left","arrow_up","arrow_down","chevron_right","chevron_left","chevron_up","chevron_down","house_up","house_down","house_left","house_right","parallello_hor","parallello_hor_mirrored","parallello_vert","parallello_vert_mirrored"].indexOf(e.shape)}function u(e){e.zoom_scale=1/transform.k,"icon"in e?draw_fa_icon(e,gui_context):draw_gui_path(e,gui_context)}function d(e,t){var r=e[0].parts[0].y,n=e.slice(-1)[0].parts.slice(-1)[0],o=n.y+n.height
f([[t+5,r],[t,r],[t,o],[t+5,o]],gui_context)}function f(e,t){t.save(),t.strokeStyle="yellowgreen"
var n=transform.k>1?Math.max(.4,round_to(4/transform.k,1)):4
t.lineWidth=n,t.beginPath(),e.forEach(function(e){var n=_slicedToArray(e,2),o=n[0],a=n[1]
return t.lineTo(r(o),r(a))}),t.stroke(),t.restore(),cc.set_has_ink(t)}function h(e){var t=get_chunks_in_par(e.parent.border_id,e.parent.par_num),r=t[0].parts[0],n=shapes_storage.search_shapes_with_id(currentElement.border_id).x
H={font_size:20,x:n-22/transform.k,y:r.y,width:20/transform.k,height:20/transform.k,iama:"gui_par_handle",stroke:"black",fill:"yellowgreen"},H.icon=fa_handler.get_icons_per_cat().Arrows[34],u(H),d(t,n)}function p(e){var t=path_to_array("M"+e.d.split("M")[1]).map(function(t){var r=t.x,n=t.y
return{x:r+e.x,y:n+e.y}})
P=[],m(t[0]),m(t.slice(-1)[0]),P.forEach(u)}function m(e){var t={font_size:20,x:e.x,y:e.y,width:20/transform.k,height:20/transform.k,iama:"gui_line_end",stroke:"black",stroke_width:.5,fill:"yellowgreen",index:P.length}
t.icon=fa_handler.get_icons_per_cat().Arrows[0],P.push(t)}function g(e){O={font_size:20,x:e.x+e.width,y:e.y+e.height/2-10,width:20/transform.k,height:20/transform.k,iama:"gui_morph",stroke:"black",stroke_width:.5,fill:"#734b6d"}
var t="reshape_icon"in poly_config[e.shape]?poly_config[e.shape].reshape_icon:24
O.icon=fa_handler.get_icons_per_cat().Arrows[t],u(O)}function y(e){L={font_size:20,x:e.x+e.width,y:e.y+e.height/2-10,width:20/transform.k,height:20/transform.k,iama:"gui_flip",stroke:"black",stroke_width:.5,fill:"#734b6d"},L.icon=fa_handler.get_icons_per_cat().Arrows[102],u(L)}function v(e){var t,r
t=e.x+e.width,r=e.y+e.height,j={font_size:20,x:t,y:r,width:20/transform.k,height:20/transform.k,iama:"gui_resize",stroke:"black",stroke_width:.5,fill:"yellowgreen"},"drawing"==e.iama&&(j.x+=20/transform.k),j.icon=fa_handler.get_icons_per_cat().Arrows[24],u(j)}function b(e){C={font_size:20,x:e.x-20/transform.k,y:e.y+e.height,width:20/transform.k,height:20/transform.k,iama:"gui_connect",stroke:"black",stroke_width:.4,fill:"yellowgreen"},C.d="M 0 4 C 25 4 0 20 25 20 L25 22  C 0 24 22 7 0 6",u(C)}function w(e,t,r){return is_inside(t,r,to_bbox(e))}function x(e){e&&e!=currentElement?(path.make_new_connection(currentElement,e,document.querySelector("#form_always_add_arrow").checked),set_current_element(cpa.path_g)):path_to_nothing(get_xy_inverted_from_event(d3.event.sourceEvent),currentElement,document.querySelector("#form_always_add_arrow").checked),T()}function k(e){function t(e,t){var r=d3.select(t).select("rect."+e)
if(!r.empty()){var n=r.attr("x"),o=r.attr("y")
d3.select(t).append("circle").attr("cx",parseInt(n)+13).attr("cy",parseInt(o)+9).attr("r",2).attr("class","style_marker").style("stroke","#504545").style("stroke-width","1px").style("fill","white").style("pointer-events","none")}}d3.selectAll(".style_marker").remove(),c=e,c&&(t(c,"#colors_svg"),t(c,"#cm_colors_svg"))}function E(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0]
gui_context.save(),e||cc.clear_canvas(gui_context),gui_context.translate(transform.x,transform.y),gui_context.scale(transform.k,transform.k),R.forEach(function(e){e.width=10/transform.k,e.height=10/transform.k}),R.forEach(function(e){return drawEllipse(e,gui_context)}),gui_context.restore(),cc.set_has_ink(gui_context)}function A(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1]
cc.clear_canvas(hover_context),"path_addon"==e.iama?render_hover_highlight(e.bbox,"rgba(154,0,50,0.5)",hover_context,get_scaled_margin()):e.is_cell?render_hover_highlight(e,"#f9f951a6",hover_context,get_scaled_margin()):canvas_status.view_mode&&"flipped"in e?render_hover_highlight(e,"rgba(154,205,50,0.5)",hover_context,get_scaled_margin()):S(manage_groups.get_group(e),t),B=e}function S(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1]
e.forEach(function(e){"parts"in e?e.parts.forEach(function(e){return render_hover_highlight(e,t||"pink",hover_context,get_scaled_margin()/3)}):render_hover_highlight(e,t||"rgba(154,205,50,0.5)",hover_context,get_scaled_margin())})}function q(){cc.clear_canvas(hover_context),B=!1}function T(){cc.clear_canvas(gui_context),cc.clear_canvas(hover_context),j={},C={},P=[],O={},H={},plumb_pos=!1,B=!1}function z(){var e
cc.clear_canvas(gui_context),gui_context.save(),gui_context.translate(transform.x,transform.y),gui_context.scale(transform.k,transform.k),gui_context.fillStyle=function(){var e=infinity.get_level()
return"L0"==e?"rgba(255,0,0,0.8)":"L1"==e?"yellowgreen":"L2"==e?"pink":"L3"==e?"rgba(0,0,255,0.5)":void 0}(),gui_context.beginPath()
var t=Math.min(8,4/transform.k);(e=gui_context).ellipse.apply(e,_toConsumableArray(last_pos).concat([t,t,0,0,2*Math.PI])),gui_context.closePath(),gui_context.fill(),gui_context.restore(),cc.set_has_ink(gui_context)}function I(){return R.length>0}function M(){R=[],W=!1}var j={},L={},C={},O={},R=[],P=[],W=!1,H={},B=!1
return{render_hover_highlight_for_group:S,has_control_points:I,add_location_circle:z,add_hover_highlight:A,frame_element:i,draw_plumbs_only:o,is_resize_button:function(e,t){if(w(j,e,t))return j},is_flip_button:function(e,t){if(w(L,e,t))return L},is_connect_button:function(e,t){if(w(C,e,t))return C},is_morph_button:function(e,t){if(w(O,e,t))return O},is_par_handle:function(e,t){if(w(H,e,t))return H},is_path_control_point:function(e,t){for(var r=0;r<R.length;r++)if(w(R[r],e,t))return R[r]},is_line_end_button:function(e,t){for(var r=0;r<P.length;r++)if(w(P[r],e,t))return P[r]},dummy_connect:s,move_resize_button:function(e,t){j.x+=e,j.y+=t},move_connect_button:_,end_drag_gui_connect:x,add_marker_to_example_style:k,get_path_control_points_as_ref:function(){return R},render_path_control_points:E,add_path_control_point:function(e){return R.push(e)},set_el_with_cps:function(e){return W=e},get_el_with_cps:function(){return W},reset_path_control_points:M,remove_hover_highlight:q,clear:T}}()
canvas_has_been_dragged=!1
var el_under,current_draw_group=[],free_draw=!0,drag_draw=d3.drag().on("start",function(){if("mousedown"==d3.event.sourceEvent.type&&0!=d3.event.sourceEvent.button)return!1
var e=get_xy_inverted_from_event(d3.event.sourceEvent),t=_slicedToArray(e,2),r=t[0],n=t[1]
0==current_draw_group.length?start_new_draw_group(r,n):(currentElement.d+="M"+[r,n].map(function(e){return round_to(e,2)}),"points"in currentElement||(currentElement.points=[]),currentElement.points.push([[r,n]]))}).on("drag",function(){if("mousemove"==d3.event.sourceEvent.type&&0!=d3.event.sourceEvent.button)return!1
if("drawing"!=currentElement.iama)return!1
var e=get_xy_inverted_from_event(d3.event.sourceEvent),t=_slicedToArray(e,2),r=t[0],n=t[1]
currentElement.points[currentElement.points.length-1].push([r,n]),currentElement.d+="L"+[r,n].map(function(e){return round_to(e,2)}),render_current_draw_group(context_single)}).on("end",function(){if("mousedown"==d3.event.sourceEvent.type&&0!=d3.event.sourceEvent.button)return!1
if("drawing"!=currentElement.iama)return!1
if(1==currentElement.points.slice(-1)[0].length){var e=currentElement.points.slice(-1)[0],t=e[0].map(function(e){return round_to(e,2)+1}),r=_slicedToArray(t,2),n=r[0],o=r[1]
currentElement.d+="L"+[n,o],e.push([n,o]),render_current_draw_group(context_single)}ignore_svg_click=!0}),manhattan_move={drag:function(e,t){cp=d3.event.subject,cp.x+=e,cp.y+=t
var r=get_manhattan_perc(currentElement,[cp.x,cp.y]),n=currentElement
path.set_path_attrs(n),cpa.hg=!1,cpa.fixed_side=!0,cpa.manhattan_perc=r,path.remake_path(!0,!0).manhattan_perc=r,!cpa.fixed_side&&(g_d3.fixed_side=null),show_path_control_points()}},end_point_move={dragstart:function(){text_to_help_pane(help_text.end_point)},drag:function(e,t){function r(e,t,r){if("1"==r|"3"==r)var n=round_to((e[1]-t.top)/(t.bottom-t.top),4)
else var n=round_to((e[0]-t.left)/(t.right-t.left),4)
return(n<0||n>1)&&text_to_feedback_pane(['to connect path to other side of figure, "use path direction"',"you can find it by right clicking the path, or in the Path Controls menu"]),round_to(Math.min(1,Math.max(n,0)),4)}function n(e,t,r,n){return"0"==r?round_to(t.top-e[1],0)/n:"1"==r?round_to(e[0]-t.right,0)/n:"2"==r?round_to(e[1]-t.bottom,0)/n:"3"==r?round_to(t.left-e[0],0)/n:void 0}var o=d3.event.subject,a=gui_buttons.get_el_with_cps()
path.set_path_attrs(a)
var i=!d3.event.sourceEvent.shiftKey
o.x+=e,o.y+=t
var s,_,l=[o.x,o.y]
if("endpoint_from"==o.drag_type){var c=cpa.from_side,u=posit2.tlbr(cpa.e1),d=r(l,u,c)
s=i?0:n(l,u,c,1)}else{var c=cpa.to_side,u=posit2.tlbr(cpa.e2),f=r(l,u,c)
_=i?0:n(l,u,c,1)}cpa.pos1=d||parseFloat(cpa.pos1)||.5,cpa.pos2=f||parseFloat(cpa.pos2)||.5,cpa.fixed_side=!0,cpa.offset_from=s||cpa.offset_from||0,cpa.offset_to=_||cpa.offset_to||0,path.remake_path(!0,!0),!cpa.fixed_side&&delete cpa.fixed_side,show_path_control_points()}},poly_point_move={dragstart:function(){},drag:function(e,t){if(0!=e||0!=t){var r=d3.event.subject
r.x+=e,r.y+=t
var n=gui_buttons.get_path_control_points_as_ref().map(function(e){return[e.x,e.y]})
update_poly_points(currentElement,n),currentElement.rough&&delete currentElement.redraw_data}},dragend:function(){}},cubic_move={drag:function(e,t){var r=gui_buttons.get_el_with_cps()
path.set_path_attrs(r),cpa.fixed_side=!0
var n=d3.event.subject,o=parseInt(n.index),a=r.d
p=path_to_array(a),move_cubic_cp(e,t,p,o,void 0,d3.event.sourceEvent.shiftKey)
var i=array_to_path(p)
r.d=i,r.rough&&delete currentElement.redraw_data,r.custom_flow=get_path_custom_flow_attrs(p),r.fixed_side=!0,show_path_control_points()}},free_move={drag:function(e,t){if(d3.event.subject.index)var r=parseInt(d3.event.subject.index)
else var r=0
var n=gui_buttons.get_el_with_cps(),o="path_group"==n.iama,a=("manhattan"==cpa.flow||"straight"==cpa.flow||"hooked"==cpa.flow)&&o||!o&&"lineto"==n.flow,i=path_to_array(n.d)
i[r].x+=e,i[r].y+=t
var s=[i.map(function(e){var t=e.x,r=e.y
return[t+n.x,r+n.y]})]
if("drawing"==n.iama&&set_drawing_pos(n,s),"path_group"==n.iama&&a){path.set_path_attrs(n)
var _=array_to_line(i)
n.d=_,n.rough&&delete currentElement.redraw_data,n.custom_flow=get_path_custom_flow_attrs(i),n.fixed_side=!0,show_path_control_points()}d3.event.subject.x+=e,d3.event.subject.y+=t,n.rough&&delete n.redraw_data,gui_buttons.render_path_control_points()},dragend:function(){var e=gui_buttons.get_el_with_cps()
"drawing"==e.iama&&"add_ons"in e&&Object.keys(e.add_ons).forEach(function(t){return add_arrow_test(e,t,e.add_ons[t].figure,e.add_ons[t].width,e.add_ons[t].height)})}},last_zoomed=0,zoom_count=0,last_anim=0
document.fonts&&(document.fonts.onloadingdone=function(e){render()}),document.body.onkeydown=document.body.onkeyup=handle_keyboard,canvas.node().onmousemove=function(e){if(canvas_status.drag_select)return!1
if(canvas_status.draw_mode)return!1
var t=get_xy_inverted_from_event(e),r=_slicedToArray(t,2),n=r[0],o=r[1],a=shapes_storage.find_clickable_shape(n,o)
if(canvas_status.view_mode)return a&&"flipped"in a?(canvas.node().style.cursor="pointer",gui_buttons.add_hover_highlight(a)):a&&"text"==a.iama&&is_web_link(a.parent.text)?canvas.node().style.cursor="pointer":(canvas.node().style.cursor="inherit",gui_buttons.remove_hover_highlight()),!1
style_copier.is_on()&&a?(canvas.node().style.cursor="copy",gui_buttons.add_hover_highlight(a,"goldenrod")):a?(gui_buttons.remove_hover_highlight(),"path_cp"==a.iama?canvas.node().style.cursor=a.cursor:"gui_resize"==a.iama?canvas.node().style.cursor="se-resize":"gui_connect"==a.iama?canvas.node().style.cursor="crosshair":"gui_morph"==a.iama?canvas.node().style.cursor="crosshair":"gui_flip"==a.iama?canvas.node().style.cursor="pointer":(canvas.node().style.cursor="text"in a?"text":"move",gui_buttons.add_hover_highlight(a))):(canvas.node().style.cursor="inherit",gui_buttons.remove_hover_highlight())}
var cumulator_pos=drag_discrete(),MARGE_COM=100,MARGE_MENU=200,FADE_MARGIN=1500,zoom_factor=1,has_transformed=!1,zoom_behavior=d3.zoom().scaleExtent([1/30,8]).on("start",zoom_start).on("zoom",zoomed).on("end",zoom_end),zoom_level_start
add_canvas_default_click(),add_canvas_drag_default()
var cc=function(){function e(){context.clearRect(0,0,canvas_width,canvas_height),context_single.clearRect(0,0,canvas_width,canvas_height),hover_context.clearRect(0,0,canvas_width,canvas_height),gui_context.clearRect(0,0,canvas_width,canvas_height),cursor_context.clearRect(0,0,canvas_width,canvas_height),grid_context.clearRect(0,0,canvas_width,canvas_height)}function t(e){if(!e.canvas)return!1
canvas_is_clear[e.canvas.id]||(e.clearRect(0,0,canvas_width,canvas_height),canvas_is_clear[e.canvas.id]=!0)}function r(e){if(!e.canvas)return!1
canvas_is_clear[e.canvas.id]=!1}return canvas_is_clear={gui_canvas:!0,cursor_canvas:!0,hover_canvas:!0,draw_canvas_single:!0,draw_canvas:!0},{clear_canvas:t,set_has_ink:r,clear_all:e,status:function(){return canvas_is_clear}}}(),view=function(){function e(){var e=canvas_width,t=canvas_height
return{x:-transform.x/transform.k,y:-transform.y/transform.k,width:e/transform.k,height:t/transform.k}}function t(e){return!(i&&!i.has(e))&&(e.x+e.width>a.x&&e.x<a.x+a.width&&e.y+e.height>a.y&&e.y<a.y+a.height)}function r(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0]
a=t||e()}function n(e){i=e}function o(){i=!1}var a,i=!1
return{is_in_view:t,set_bbox:r,set_shapes_to_render:n,clear_shapes_to_render:o,get_view_bbox:e}}()
render=render_single
var wobbles=[],render_to_pdf=!1,last_text_item_rendered=!1,cpa={},path=function(){function e(e,t){return e.level>t.level?e.level:t.level}function t(){var e,t,r=predef_styles.get_classes()[active_style.style_class]
return t=is_visible_color(r.fill)?r.fill:is_visible_color(r.stroke)?r.stroke:"rgba(10,10,10,0.8)",e=el.stroke,el.color=r.color,"double"==cpa.type?(e=r.fill,t=r.stroke,is_visible_color(e)||(e="black"),is_visible_color(t)||(t="black")):(t=r.stroke,e=t),[e,t]}function r(r){var n=t(),o=_slicedToArray(n,2),a=o[0],i=o[1],s=l(r,cpa.type),_=r[1],c=get_path_pos(_.midpoints,_.cps),u=_slicedToArray(c,4),d=u[0],f=u[1],h=u[2],p=u[3],m=e(cpa.e1,cpa.e2),g={id:cpa.id,from_side:_.i,to_side:_.j,type:cpa.type,flow:cpa.flow,pos1:cpa.pos1,pos2:cpa.pos2,d:s,e1:1,e2:2,x:d,y:f,width:h,height:p,iama:"path_group",fill:a,stroke:i,inner_width:infinity.get_standard_scaling(4,m),outer_width:infinity.get_standard_scaling(7,m)}
return cpa.level=m,cpa.manhattan_perc&&(g.manhattan_perc=cpa.manhattan_perc),roughen_all&&(g.rough=!0),shapes_storage.paths.push(g),g}function n(e){var t=(!(arguments.length>1&&void 0!==arguments[1])||arguments[1],l(e,cpa.type)),r=e[1],n=r.midpoints.slice()
"original_point_head"in r&&(n[1]=r.original_point_head),"original_point_tail"in r&&(n[0]=r.original_point_tail)
var o=get_path_pos(n,r.cps),a=_slicedToArray(o,4),i=a[0],s=a[1],_=a[2],c=a[3]
return cpa.path_g.d=t,cpa.path_g.x=i,cpa.path_g.y=s,cpa.path_g.width=_,cpa.path_g.height=c,cpa.path_g.from_side=e[1].i,cpa.path_g.to_side=e[1].j,cpa.path_g.pos1=cpa.pos1,cpa.path_g.pos2=cpa.pos2,cpa.path_g.offset_from=cpa.offset_from,cpa.path_g.offset_to=cpa.offset_to,delete cpa.path_g.redraw_data,"add_ons"in cpa.path_g||(cpa.path_g.add_ons={}),cpa.arrow_head&&(cpa.path_g.add_ons.head=add_shape_to_line_end(e[1],1,cpa.arrow_head)),cpa.arrow_tail&&(cpa.path_g.add_ons.tail=add_shape_to_line_end(e[1],0,cpa.arrow_tail)),Object.values(shapes_storage.borders_bound).filter(function(e){return e.path_id==cpa.id}).forEach(function(e){return repos_text_block(e,cpa.path_g)}),cpa.path_g}function o(){n(c())}function a(e,t){var r=find_borders_bound_by_path_id(cpa.path_g.id),n={head_arrow:cpa.arrow_head,tail_arrow:cpa.arrow_tail,arrow_width:cpa.arrow_width,arrow_height:cpa.arrow_height},o=cpa.e1
currentElement=cpa.path_g,style_copier.setup_style_copy(),shapes_storage.remove(t),shapes_storage.remove(cpa.path_g)
var a=cpa.e1==t?cpa.e2:cpa.e1
path.make_new_connection(a,e,!1,{flow:cpa.flow}),r.forEach(function(e){return e.path_id=cpa.path_g.id}),r.forEach(function(e){return repos_text_block(e,cpa.path_g)}),s(n,!(cpa.e1===o)),style_copier.copy_styles_to_shape(cpa.path_g),path.remake_path(!0)}function i(e,t){var r=find_borders_bound_by_path_id(e.id),n={head_arrow:cpa.arrow_head,tail_arrow:cpa.arrow_tail,arrow_width:cpa.arrow_width,arrow_height:cpa.arrow_height}
style_copier.setup_style_copy()
var o=cpa.e1
shapes_storage.remove(e),g(e)
var a,i
t?(a=[cpa.e2.x-25,cpa.e2.y-25],i=cpa.e1):(a=[cpa.e1.x-25,cpa.e1.y-25],i=cpa.e2),path_to_nothing(a,i,!1,cpa.flow),r.forEach(function(e){return e.path_id=cpa.path_g.id}),r.forEach(function(e){return repos_text_block(e,cpa.path_g)}),s(n,!(cpa.e1===o)),style_copier.copy_styles_to_shape(cpa.path_g),path.remake_path(!0)}function s(e,t){e.head_arrow&&(t?cpa.arrow_tail=e.head_arrow:cpa.arrow_head=e.head_arrow),e.tail_arrow&&(t?cpa.arrow_head=e.tail_arrow:cpa.arrow_tail=e.tail_arrow),(e.tail_arrow||e.head_arrow)&&(cpa.arrow_width=e.arrow_width,cpa.arrow_height=e.arrow_height)}function l(e,t){var r=e[1],t=t||active_style.line_style,n=n||active_style.line_flow
if(cpa.arrow_head||cpa.arrow_tail){if(cpa.arrow_head){var o=path_correction_for_arrow(e,1)
e[0]=o[0],r.original_point_head=o[1]}if(cpa.arrow_tail){var o=path_correction_for_arrow(e,0)
e[0]=o[0],r.original_point_tail=o[1]}}return"single_stroke"!=path_specs[t].thickness&&"double"!=path_specs[t].thickness||(d=e[0]),d}function c(e,t){function r(e){elements=Object.values(shapes_storage.borders)
var t=u(e),r=n(t,elements)
return _.values(r).some(function(e){return e})}function n(e,t){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:100,o={},a=get_points_along_path(e,n,5)
if(0==a.length)return{geenpunt:!1}
for(var i=0;i<t.length;i++){var s=t[i]
if("border"==s.iama&&"rect"!=s.shape&&"ellipse"!=s.shape){var l
!function(){var e=get_poly_config(s).points,t=e.map(function(e){var t=_slicedToArray(e,2),r=t[0],n=t[1]
return[s.x+r*s.width,s.y+n*s.height]})
l=_.any(a.map(function(e){return point_is_inside(e,t)}))}()}else var l=points_in_area(a,get_bbox_of_figure(s,!1,!0),_.any)
if(o[s.id]=l,l)return r?[o,a]:o}return r?[o,a]:o}var o,a,i,s,l=f(),c=[]
if(k&&!path_buffer.check_path(cpa.id)||(t=!0),(e||t||E)&&(function(){var e=parseInt(_.findIndex(l,function(e){return e.i==cpa.from_side&&e.j==cpa.to_side}))
s=l.splice(e,1)[0],a=make_d(s),o=!!k&&r(a)}(),c.push([a,s])),t||E||0==l.length)return[a,s]
if(e&&(l[l.length-1],!0)&&(!o||!k))return[a,s]
if(!k){var i=l.pop()
return[make_d(i),i]}for(;l.length>0;){var i=l.pop(),d=make_d(i)
if(!r(d))return[d,i]
c.push([d,i])}return path_buffer.add_path(cpa.id),c[0]}function u(e){var t=document.createElementNS("http://www.w3.org/2000/svg","path")
return t.setAttribute("d",e),t}function f(){function e(e){return"number"==typeof e&&e>=0&&e<=3}function t(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=[e.x,e.y],o=n[0],a=n[1],i=[e.width,e.height],s=i[0],_=i[1],l=!1,c=[e.x,e.y],u=c[0],d=c[1]
return l="rect"!=e.shape&&"knot"!=e.iama&&0==r?path_placement_correction(e,t,o,a,s,_):[[s*t,0],[s,_*t],[s*t,_],[0,_*t]],l[0][1]-=r,l[1][0]+=r,l[2][1]+=r,l[3][0]-=r,l.map(function(e){return[u+e[0],d+e[1]]})}var r=cpa.from_side,n=cpa.to_side,o=(cpa.pos1,cpa.pos2,[]),a=t(cpa.e1,cpa.pos1,cpa.offset_from||0),i=t(cpa.e2,cpa.pos2,cpa.offset_to||0)
if(cpa.fixed_side&&e(r)&&e(n)){var s=i[n][0]-a[r][0],_=i[n][1]-a[r][1]
return o.push({i:r,j:n,dist:Math.sqrt(s*s+_*_),dx:s,dy:_,midpoints:[a[r],i[n]]}),o}var l=cpa.fixed_side&&r?[r]:[0,1,2,3],c=cpa.fixed_side&&n?[n]:[0,1,2,3]
for(var u in l){var d=l[u]
for(var f in c){var h=c[f],s=i[h][0]-a[d][0],_=i[h][1]-a[d][1]
o.push({i:d,j:h,dist:Math.sqrt(s*s+_*_),dx:s,dy:_,midpoints:[a[d],i[h]]})}}return o.sort(function(e,t){var r=e.i%2==e.j%2?1:A,n=t.i%2==t.j%2?1:A
return t.dist*n-e.dist*r})}function h(e,t){var r=p(e.id,t.id),n=_slicedToArray(r,2),o=n[0],a=n[1]
cpa.class="from"+o+"_to"+a,cpa.id=cpa.class,e.id<t.id?(cpa.e1=e,cpa.e2=t):(cpa.e2=e,cpa.e1=t)}function p(e,t){return[e<t?e:t,e>t?e:t]}function m(){S.forEach(function(e){cpa[e]=null})}function g(e){S.forEach(function(t){cpa[t]=t in e?e[t]:null}),cpa.path_g=e
var t=w(cpa.id)
cpa.e1=shapes_storage.borders[t[0]]||shapes_storage.knots.filter(function(e){return e.id==t[0]})[0],cpa.e2=shapes_storage.borders[t[1]]||shapes_storage.knots.filter(function(e){return e.id==t[1]})[0],cpa.from_side=cpa.path_g.from_side,cpa.to_side=cpa.path_g.to_side,"add_ons"in e&&(e.add_ons.head&&(cpa.arrow_head=e.add_ons.head.figure,cpa.arrow_width=e.add_ons.head.width,cpa.arrow_height=e.add_ons.head.height),e.add_ons.tail&&(cpa.arrow_tail=e.add_ons.tail.figure,cpa.arrow_width=e.add_ons.tail.width,cpa.arrow_height=e.add_ons.tail.height)),cpa.path_g=e,cpa.offset_from="offset_from"in e?e.offset_from:0,cpa.offset_to="offset_to"in e?e.offset_to:0}function y(e,t,n){var o=arguments.length>3&&void 0!==arguments[3]&&arguments[3]
if(e.id!=t.id){m(),h(e,t),cpa.pos1=.5,cpa.pos2=.5,cpa.type=active_style.line_style,cpa.flow=active_style.line_flow,o&&Object.keys(o).forEach(function(e){cpa[e]=o[e]})
var a=c(),i=r(a)
return cpa.path_g=i,n&&(set_current_element(i),path_end_fig="curved_arrow",cpa.e1==e?(cpa.arrow_to=path_end_fig,change_path_end_fig("head",!0)):(cpa.arrow_tail=path_end_fig,change_path_end_fig("tail",!0))),o&&"disperse"in o&&!o.disperse?i:(disperse_path_over_side(cpa.e1,a[1].i,MARGIN_DIV),disperse_path_over_side(cpa.e2,a[1].j,MARGIN_DIV),i)}}function v(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],o=(arguments.length>3&&void 0!==arguments[3]&&arguments[3],arguments.length>4&&void 0!==arguments[4]&&arguments[4],b(e))
if(0==o.length)return!1
for(var a=0;a<o.length;a++)g(o[a]),n(c(!0,t),r),z&&(disperse_path_over_side(cpa.e2,cpa.to_side,MARGIN_DIV),disperse_path_over_side(cpa.e1,cpa.from_side,MARGIN_DIV))
return!0}function b(e,t){return ids=t||shapes_storage.paths,ids.filter(function(t){var r=w(t.id),n=_slicedToArray(r,2),o=n[0],a=n[1]
return o==e|a==e})}function w(e){return[e.slice(4,9),e.slice(12,17)]}function x(e,t,r){g(e),t=-1==t?cpa.from_side:t,cpa.from_side=t,cpa.path_g.from_side=t,r=-1==r?cpa.to_side:r,cpa.to_side=r,cpa.path_g.to_side=r,cpa.path_g.fixed_side=!0,cpa.fixed_side=!0}var k=!0,E=!1,A=1.25,S=["class","id","e1","e2","from_side","to_side","pos1","pos2","flow","type","fixed_side","arrow_head","arrow_tail","arrow_width","arrow_height","custom_flow","path_g","manhattan_perc","hg","tail_style","head_style","on_top","flasher","offset_from","offset_to"],q=function(){var e=!1,t=!1
return{turn_off_temporary:function(){t||(e=k,k=!1,t=!0)},restore:function(){t&&(k=e,t=!1)},turn_on:function(){return k=!0},turn_off:function(){return k=!1},status:function(){return k}}}(),T={turn_on:function(){return E=!0},turn_off:function(){return E=!1},status:function(){return E}},z=!1
return{clear_path_attrs:m,set_path_attrs:g,make_new_connection:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=arguments.length>3&&void 0!==arguments[3]&&arguments[3]
manage_groups.get_group(e,!0).forEach(function(e){y(e,t,r,n)})},recalc_connections:v,find_connections:b,fix_path_side:x,remake_path:function(){return n(c(arguments.length>0&&void 0!==arguments[0]&&arguments[0],arguments.length>1&&void 0!==arguments[1]&&arguments[1]))},redo_path:o,change_collision_detection:q,change_all_paths_fixed:T,extract_elements_from_path_id:w,create_svg_path_for_measurement:u,detach_path:i,find_path:c,attach_path:a}}()
path.clear_path_attrs(),path_buffer=function(){var e={}
return{check_path:function(t){return t in e&&(Date.now()-e[t]<1e3?("c"!=e[t]&&setTimeout(this.generate_callback(t),3e3),e[t]="c",!0):"c"==e[t]||(delete e[t],!1))},generate_callback:function(t){return function(){delete e[t]}},add_path:function(t){t in e||(e[t]=Date.now())}}}(),document.querySelector("#cm-path-detach").onclick=function(){path.detach_path(currentElement,"from"!=cpa.side),render()},document.querySelector("#form_path_add_control_point").onclick=function(e){if("manhattan"==g.flow)return text_to_feedback_pane("currently not possible for paths with flow manhattan"),!1
add_cp_to_path(currentElement)
var t=currentElement.d
cpa.custom_flow=get_path_custom_flow_attrs(path_to_array(t)),currentElement.custom_flow=cpa.custom_flow,currentElement.fixed_side=!0,show_path_control_points()},document.querySelector("#form_path_toggle_cps").onclick=function(e){currentElement==gui_buttons.get_el_with_cps()?(gui_buttons.reset_path_control_points(),gui_buttons.frame_element(currentElement)):show_path_control_points(currentElement)},$(".cm_button_toggle_poly_point").on("click",function(){currentElement==gui_buttons.get_el_with_cps()?(gui_buttons.reset_path_control_points(),gui_buttons.frame_element(currentElement)):show_poly_points(currentElement)}),$(".cm_button_add_point").on("click",function(){add_point_to_polygon(currentElement,last_pos)}),document.querySelector("#form_path_straighten_cps").onclick=function(e){straighten_cps(currentElement),show_path_control_points(),render()},$(".cm-show-path-basic-points").on("click",function(e){show_line_control_points(currentElement)}),document.querySelector("#cm-show-drawing-points").onclick=function(e){show_line_control_points(currentElement)}
var fonts=["PT Sans","Cabin","Zilla Slab","Roboto","Open Sans","Ubuntu","Lato","Roboto condensed","Source Code Pro","Ubuntu Condensed","Comfortaa","Hind","Lora","Aleo","Montserrat","Raleway","Acme","Amatic SC","Handlee","Caveat","Schoolbell","Athiti","Kalam","Sacramento","Quattrocento","Arimo","Exo","Cinzel","Orbitron","Audiowide"]
append_options(".form_font_list",fonts),append_options("#predef_font_list",fonts),plus_minus_generator(document.getElementById("form_max_width"),function(e){max_border_width=parseInt(e.value),this.value=max_border_width},100,0),document.querySelector("#form_font_size .plus").onmousedown=function(e){var t=document.querySelector("#form_font_size input"),r=parseInt(t.value)
t.value=r+1,$("#form_font_size input").change()},document.querySelector("#form_font_size .minus").onmousedown=function(e){document.querySelector("#form_font_size input").value-=1,$("#form_font_size input").change()},[1,2,3,4,5].forEach(function(e){$(".font"+e+"_holder").on("click",function(t){change_font_class(e-1)})}),document.querySelector("#form_font_size input").onchange=function(e){"text"==currentElement.iama&&check_for_range_when_p_form_action()
var t=parseInt($("#form_font_size input").val())
manage_groups.get_group(currentElement,!0).forEach(function(e){var r=e.font_size
change_font_size_of_el(e,t)&&resize_if_wanted_after_font_change(e,r<t)}),gui_buttons.frame_element(currentElement),set_current_element(currentElement)}
var get_dict_with_vals=function(){var e={}
return function(t){var r=predef_styles.get_font_style(t)
if(!(r in e)){gui_context.font=r
var n={}
"ABCDEFGHIJKLMNOPWQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789,./;:[]\\=+-{}|<>?!@#$%^&*()~`'\" ".split("").map(function(e){n[e]=gui_context.measureText(e).width}),e[r]=n}return e[r]}}()
$(".button_bold").on("mousedown",function(e){add_styling_to_par("bold")}),$(".button_italic").on("mousedown",function(e){add_styling_to_par("italic")})
var paragraph_prefixes={bullet:!1,triangle:!1,rhombus:!1,check:!1,cross:!1,arrow:!1,letter:!0,number:!0,roman:!0}
$(".form_paragraph_prefix").on("click",function(e){"BUTTON"==e.target.tagName&&(manage_groups.get_group(currentElement).forEach(function(t){t=part_to_chunk(t),paragraph_prefixes[e.target.value]?t.text=e.target.innerText+". "+t.text:t.text=e.target.innerText+t.text,measure_text(t),recalc_border_width(t.border_id,!1,!0,!0),position_texts(t.border_id),t.par_prefix=e.target.value,render()}),set_current_element(currentElement,!0))}),["text_align_left","text_align_center","text_align_right"].forEach(function(e){$("."+e).on("click",function(){manage_groups.get_group(currentElement,!0).forEach(function(t){t.text_align=e.split("_")[2],position_texts(t.id)}),set_current_element(currentElement)})}),$(".form_paragraph_clear_style").on("click",function(e){manage_groups.get_group(part_to_chunk(currentElement),!0).forEach(function(e){var t=find_border_by_id(e.border_id)
e.fill="rgba(0,0,0,1)",e.has_own_style=!1,e.font_fam_inherited=!0,e.font_size=t.font_size,e.font_family=t.font_family})}),$(".form_even_out_pars").on("click",function(e){manage_groups.get_group(currentElement,!1).forEach(even_out_paragraphs)}),$(".chunk_cover_whole_line").on("click",function(e){manage_groups.get_group(currentElement,!0).forEach(function(e){e.cover_whole_line=!0,position_texts(e.border_id)}),set_current_element(currentElement,!0)}),plus_minus_generator(document.querySelector("#form_article_padding"),function(e){manage_groups.get_group(currentElement,!0).forEach(function(t){t.padding=parseInt(e.value),resize_if_wanted_after_font_change(t),t.style_class=!1}),render_all(0,!1,!0)},1,0),plus_minus_generator(document.getElementById("form_paragraph_line_height"),function(e){manage_groups.get_group(currentElement,!0).forEach(function(t){"text"==t.iama&&(t=part_to_chunk(t)),("text"!=t.iama?get_text_with_border_id(t.id||t.border_id):[t]).forEach(function(t){t.line_height=parseFloat(e.value),measure_text(t)}),position_texts(t.id||t.border_id)}),render()},.1,2),$(".form_reset_par_margins_all").on("click",function(e){delete_par_margings(currentElement.id)}),$("#form_reset_par_margin").on("click",function(e){get_chunks_in_par(currentElement.border_id,currentElement.par_num).forEach(function(e){delete e.margin_top,delete e.margin_left}),position_texts(currentElement.border_id),render()}),plus_minus_generator(document.getElementById("form_border_width"),change_border_width,.5,2),plus_minus_generator(document.getElementById("cm_border_width"),change_border_width,.5,2),$("#form_border_side button").on("click",function(e){e.target.classList.toggle("onoff-on")
var t=_.map(this.parentElement.querySelectorAll("button"),function(e){return e.classList.contains("onoff-on")})
manage_groups.get_group(currentElement,!0).forEach(function(e){e=part_to_chunk(e),_.any(t)?calc_border_dasharray(e,t):"stroke_dasharray"in e&&delete e.stroke_dasharray,_.all(t)||_.all(t.map(function(e){return!e}))?delete e.border_sides_arr:e.border_sides_arr=t}),render()}),document.querySelector("#form_border_dash input").oninput=function(){change_border_dasharray(currentElement,this.value.split(" ").map(function(e){return parseFloat(e)}))},$(".form_border_dash_styles > svg").on("click",function(e){var t=Array.from(this.querySelectorAll("path")).map(function(e){return e.style["stroke-dasharray"].split(" ").map(function(e){return parseFloat(e)})})
change_border_dasharray(currentElement,t[0],t[1])}),document.querySelector("#form_border_inner").onchange=function(e){if("path_group"!=currentElement.iama&&"double"!=currentElement.type)return!1
this.checked?("dasharray_inner"in currentElement&&(document.querySelector("#form_border_dash input").value=currentElement.dasharray_inner.join(" ")),document.querySelector("#form_border_width input").value=currentElement.inner_width):("dasharray_outer"in currentElement&&(document.querySelector("#form_border_dash input").value=currentElement.dasharray_outer.join(" ")),document.querySelector("#form_border_width input").value=currentElement.outer_width)}
var manage_groups=function(){function e(){w.last_clicked_shape=!1,w.colors=[],w.index=-1}function t(){u={red:[],green:[],yellow:[],blue:[],purple:[],black:[],white:[],orange:[]},d=u.red,f="red",h=[]}function r(){for(;-1!=h.indexOf(b);)b+=1
return b}function n(){u={},h.forEach(function(e){return u[e]=[]})}function o(e,t){return"fa_icon"==e?1:"border"==e&&t.bound?2:"path_group"==e?3:"text"==e?4:"cell_basic"==e?5:"graph_basic"==e?6:0}function a(){m=!1,v="",u.black=[]}function i(e){var t=new Set(d)
if(merged.is_child(e)){var r=merged.get_parent(e)
if(t.has(r))return!1}return!0}function s(e){var t=d.length
d=d.filter(function(t){return t!=e}),u[f]=d
var r=d.length,n=e.iama
return t!=r&&(text_to_feedback_pane("removed "+n+"\n Group length = "+r.toString(),!0),!0)}function l(){0==d.length&&(delete u[f],h=h.filter(function(e){return e!=f}),f="black",u[f]=d=[],h.push("black"),for_group=!1)}function c(e){e in u&&0==u[e].length&&(h=h.filter(function(t){return t!=e}),delete u[e],f==e&&(f="black"))}var u={red:[],green:[],yellow:[],blue:[],purple:[],black:[],white:[],orange:[]},d=u.red,f="red",h=[],p=!1,m=!1,y=!1,v="",b=1
l()
var w={last_clicked_shape:!1,index:0,colors:[]},x=function(){var e=1/0,t=1/0,r=0,n=0
group_no_paths=d.filter(function(e){return"path_group"!=e.iama})
for(var o=0;o<group_no_paths.length;o++){var a=group_no_paths[o],i=[a.x,a.y],s=[a.x+a.width,a.y+a.height]
e=Math.min(e,i[0]),t=Math.min(t,i[1]),r=Math.max(r,s[0]),n=Math.max(n,s[1])}return[e,t]}
return{push_temp_to_new_group:function(){b=r(),h.push(b),u[b]=d.slice(),this.activate_group(b)},permanent_group_active:function(){return"black"!=f&&d.length>0},get_color_from_index:function(e){return h[e]},swap_group_for_nth_paragraps:function(e){var t=this,r=[]
manage_groups.get_current_group().filter(function(t){return t.num_pars&&t.num_pars>=e}).forEach(function(t){var n=get_text_with_border_id(t.id)
0==e?_.forEach(n,function(e){return r.push(e)}):n.length>=e&&r.push(n[e-1])}),this.reset(!1),r.forEach(function(e){return t.add(e)})},activate_group:function(e){a(),this.unshow_my_group(),e in u?(d=u[e],f=e,this.set_my_filter(),this.show_my_group(),for_group=!0):text_to_feedback_pane("not a valid group name")},deactivate_group:function(){this.unshow_my_group(),update_quick_grouping_forms()},activate_temp_group:function(e,t){this.unshow_my_group(),for_group=!0,m=!0,v=t||"",d=u.black=[],f="black"
for(var r=0;r<e.length;r++)this.add(e[r])
this.set_my_filter(),p=!0,for_group=!0},get_group_of_element:function(e){for(var t=0;t<h.length;t++){var r=h[t]
if(u[r].find(function(t){return t==e}))return r}return!1},get_groups_of_element:function(e){for(var t=[],r=0;r<h.length;r++){var n=h[r]
u[n].find(function(t){return t==e})&&t.push(n)}return t},element_in_active_group:function(e){return d.find(function(t){return t==e})},add:function(e){if("slide"==e.iama)return!1
for_group||this.activate_temp_group([],"temp"),d.push(e),update_quick_grouping_forms()},remove:s,toggle_elements:function(e){var t=this
if(canvas_status.align_on)return text_to_feedback_pane("keep or reset alignment first",!0),!1
var r=e.length
e=e.filter(function(e){return!("table"in e)}),e.forEach(function(e){return t.toggle_element(e)}),e.length!=r?text_to_feedback_pane("cannot add shapes that already belong to a table to a group",!0):text_to_feedback_pane("".concat(e.length," shapes in current group"))},toggle_element:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1]
return canvas_status.align_on?(text_to_feedback_pane("keep or reset alignment first",!0),!1):i(e)?(d.filter(function(t){return t==e}).length>0?(this.remove(e),t&&text_to_feedback_pane("removed shape: ".concat(d.length," remaining")),l(),set_current_element(e,!0)):(this.add(e),t&&text_to_feedback_pane("added shape: group has ".concat(d.length," shapes"))),void(d.length>0&&this.show_my_group())):(t&&text_to_feedback_pane("cannot add shape to group"),!1)},reset:function(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0]
this.unshow_my_group(),delete u[f],h=h.filter(function(e){return e!=f}),t&&text_to_feedback_pane("group has been deleted"),e(),to_canvas.set_canvas(),gui_buttons.clear()},to_list:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=!!e&&e.iama
if(t){var r=o(t,e)
return d.filter(function(e){return o(e.iama,e)==r})}return d.slice()},show_my_group:function(){cc.clear_canvas(hover_context),gui_buttons.render_hover_highlight_for_group(d)},unshow_my_group:function(){d.forEach(function(e){}),p=!1,for_group=!1,d=[]},toggle_showing:function(){p?this.unshow_my_group():this.show_my_group()},set_my_filter:function(){},paste_group:function(e){var t=x(),r={},n=[]
group_no_paths=d.filter(function(e){return"path_group"!=e.iama&&"knot"!=e.iama}),group_no_paths.forEach(function(o){offset=[t[0]-o.x,t[1]-o.y]
var a=to_discrete_position([e[0]-offset[0],e[1]-offset[1]]),i=copy_element_new(o,a,document.querySelector("#form_copy_with_text").checked)
snap_to_grid(i),r[o.id]=i.id,n.push(i)}),this.activate_temp_group(n)},remove_element_if_present:function(e){var t=[]
for(key in u)-1!=u[key].indexOf(e)&&(u[key]=u[key].filter(function(t){return t!=e}),c(key),t.push(key))
return t},add_element_to_multiple_groups:function(e,t){e.forEach(function(e){e in u||(u[e]=[]),u[e].push(t),e==f&&(d=u[e])})},returninternals:function(){return{color:f,groups:u}},save:function(){var e={}
for(g in u)e[g]=u[g].map(function(e){return e.id})
return e},load:function(e){n()
for(g in e)-1==h.indexOf(g)&&h.push(g),u[g]=e[g].map(function(e){return shapes_storage.search_shapes_with_id(e)}).filter(function(e){return e})
b=d3.max(h.map(function(e){return parseInt(e)}).filter(function(e){return!isNaN(e)}))+1||1},add_highlight:function(){d.forEach(function(e){return render_hover_highlight(e,"pink",hover_context)})},get_group:function(e,t){if(y)return y=!1,[e]
if("text"==e.iama&&(e=part_to_chunk(e)),for_group&&manage_groups.element_in_active_group(e))if(t)var r=manage_groups.to_list(e)
else var r=manage_groups.to_list()
else var r=[e]
return r},set_pass_on_next_call:function(){return y=!0},get_group_info:function(){return v},get_current_group:function(){return d},get_group_from_color:function(e){return e in u?u[e]:[]},ready_for_paste:!1,cycle_through_groups_of_shape:function(e){if(e!=w.last_clicked_shape&&(w.last_clicked_shape=e,w.colors=manage_groups.get_groups_of_element(e),w.index=-1),0==w.colors.length)return!1
w.index+=1
var t=w.colors[w.index%w.colors.length]
t?manage_groups.activate_group(t):manage_groups.unshow_my_group()},find_els_in_bbox_not_in_group:function(e){var t=get_bbox_of_group(e),r=_slicedToArray(t,4),n=r[0],o=r[1],a=r[2],i=r[3],s=parse_to_bbox(n-5,a-5,o-n+10,i-a+10),_=find_elements_in_bbox_test(s,!0,!0),l=new Set(e)
return[_.filter(function(e){return!l.has(e)}),s]},reset_all_groups:t}}()
$(".form_deselect_group").on("click",function(e){manage_groups.deactivate_group(),update_quick_grouping_forms()}),$(".form_temp_group_to_perm").on("click",function(e){manage_groups.push_temp_to_new_group(),update_quick_grouping_forms()}),$(".form_temp_group_to_perm_deactivate").on("click",function(e){manage_groups.push_temp_to_new_group(),manage_groups.deactivate_group(),update_quick_grouping_forms()})
for(var t=document.querySelectorAll(".form_reset_group"),i=0;i<t.length;i++)t[i].onclick=function(){manage_groups.reset()}
var searcher=function(){function e(e){var r=t(),n="text"==currentElement.iama?part_to_chunk(currentElement):currentElement
"shape"==e&&(e="border"!=n.iama?"iama":n.bound?"bound":"shape")
var o=n[e],a=r.filter(function(t){return t[e]==o})
manage_groups.activate_temp_group(a)}function t(){var e=manage_groups.get_current_group()
return 0==e.length&&(e=shapes_storage.get_all()),e=e.map(part_to_chunk)}$("#form_search_for_grouping button").on("click",function(t){e(this.getAttribute("search_attrib")),manage_groups.show_my_group()}),document.querySelector("#button_group_reset").onclick=function(){manage_groups.reset()}}()
document.querySelector(".form_group_disperse_a").onclick=function(e){disperse_group(manage_groups.get_group(currentElement,!0),.9,1)},document.querySelector(".form_group_disperse_b").onclick=function(e){disperse_group(manage_groups.get_group(currentElement,!0),1.1,1)},document.querySelector(".form_group_disperse_c").onclick=function(e){disperse_group(manage_groups.get_group(currentElement,!0),1,.9)},document.querySelector(".form_group_disperse_d").onclick=function(e){disperse_group(manage_groups.get_group(currentElement,!0),1,1.1)},document.querySelector("#form_group_delete_all").onclick=manage_groups.reset_all_groups,$(".form_paste_group").on("click",function(e){manage_groups.paste_group(last_pos),render()}),$(".form_select_nth_paragraph").on("click",function(e){var t=parseInt(document.querySelector("#form_nth_par").value)
manage_groups.swap_group_for_nth_paragraps(t)})
var form_filled=!1,away=80,cmm=function(){function e(){s.style.display="none",_=!1,predef_styles.styling_predef_done()}function t(e,t,r){var n,o,a,i
return n=e.x-r[0],a=e.y-r[1],o=t.x-r[0],i=t.y-r[1],n*n+a*a<o*o+i*i}function r(){for(var e=s.children,t=0;t<e.length;t++)e[t].style.display="none"
s.querySelector("#cm_closer").style.display="inline-block"}function n(e,r){var n=!0,i=!0
if(canvas_status.view_mode)return!1
if(r.target.parentElement.classList.contains("slide_preview")){var s="#cm-slide-preview"
n=!1,i=!1}else if(slider&&is_inside(e[0],e[1],xywh_to_bbox(slider))){var s="#cm-slide"
set_buttons_for_slide(),n=!1,i=!1}else{var _,l=!!e&&shapes_storage.find_clickable_shape(e[0],e[1])
if(l?set_current_element(l):to_canvas.set_canvas(),display_fs_for_shape(currentElement),me=currentElement.iama,(_=gui_cursor).xy_is_in_range.apply(_,_toConsumableArray(e))||gui_buttons.frame_element(currentElement),document.querySelector("#cm-fig-menu-addon-pb").style.display="none",document.querySelector("#cm-fig-menu-addon-pp").style.display="none","x_axis"==me||"y_axis"==me)return r.preventDefault(),!1
if("text"==me)var s="#cm-par"
else if("fa_icon"==me)var s="#cm-icon"
else if("drawing"==me){var s="#cm-path-basic-without-fo"
document.querySelector("#cm-fig-menu-addon-pb").style.display="flex",document.querySelector("#cm-show-drawing-points").style.display="line"==currentElement.type?"inherit":"none"}else if("path_group"==me){path.clear_path_attrs(),path.set_path_attrs(currentElement)
var c=path_to_array(currentElement.d),u=c[0],d=c.slice(-1)[0]
t(u,d,e)?cpa.side="from":cpa.side="to",document.querySelector("#cm-path-directions-from").style.display="flex",document.querySelector("#cm-path-directions-to").style.display="flex",$(".no-hg").css("display","block"),$(".form_path_style2 select").val(currentElement.type)
var s="#cm-path"}else if("slide"==me){var s="#cm-"+figs[me].my_menu
n=!1,i=!1}else if("canvas"==me){var s="#cm-svg"
manage_groups.to_list().length>0?$(".when_group").css("display","flex"):$(".when_group").css("display","none"),update_quick_grouping_forms(),i=!1}else if(currentElement.is_cell)s="#cm-table",n=!1,i=!1
else if("path_addon"==me)s="#cm-addon",n=!1,i=!1
else if("math_shape"==me)s="#cm-math-shape",document.querySelector("#cm_math_scale input").value=parseInt(get_scale_of_math_shape(currentElement.scale))
else if(me)if(currentElement.bound&&"path_id"in currentElement)s="#cm-"+figs.text_block.my_menu
else{var s="#cm-fig"
"custom"==currentElement.shape&&(document.querySelector("#cm-fig-menu-addon-pp").style.display="flex"),$(".form_fig_has_path").css("display",0==path.find_connections(el.id).length?"none":"flex")}}currentElement&&fill_forms(currentElement),s&&(o(s,n,i),a(r.clientX,r.clientY,currentElement)),r.preventDefault()}function o(e,t,n){r(),s.querySelector(e).style.display="block",s.style.display="block",document.querySelector("#cm-colors").style.display=t?"block":"none",document.querySelector("#cm-delete").style.display=n?"block":"none",_=!0}function a(e,t,r){"canvas"!=r.iama&&(e=transform.applyX(r.x+r.width)+canvas_offset_x+30,t=transform.applyY(r.y)+canvas_offset_y)
var n=s.getBoundingClientRect(),o=window.innerWidth-e-n.width,a=window.innerHeight-t-n.height
e=o>0?e:e+o,t=a>0?t:t+a,s.style.left=Math.max(0,e)+"px",s.style.top=Math.max(0,t)+"px",r=part_to_chunk(r),change_selected_in_font_list(document.querySelector("#cm_fonts_list"),r.font_family),change_selected_in_font_list(document.querySelector("#cm_fonts_list_par"),r.font_family)}function i(e,t,n,o,a){r(),s.querySelector(n).style.display="block",s.style.display="block",document.querySelector("#cm-colors").style.display=o?"block":"none",document.querySelector("#cm-delete").style.display=a?"block":"none",_=!0
var i=s.getBoundingClientRect(),l=window.innerWidth-e-i.width,c=window.innerHeight-t-i.height
e=l>0?e:e+l,t=c>0?t:t+c,s.style.left=e+"px",s.style.top=t+"px"}var s=document.querySelector("#context-menu"),_=!1
return s.onclick=function(t){t&&t.target&&!d3.select(t.target).classed("keep-open")&&e()},document.addEventListener("contextmenu",function(e){function t(e,t){r(),n(t,e)}demo_mode&&text_to_demo_pane("right click"),last_pos=[transform.invertX(e.clientX-canvas_offset_x),transform.invertY(e.clientY-canvas_offset_y)]
var o=document.elementFromPoint(e.clientX-canvas_offset_x,e.clientY-canvas_offset_y)
if(o.parentElement.classList.contains("slide_preview"))t(e)
else{if(o.closest("#context-menu"))return!0
if(o.closest(".toolbar1"))return!0
t(e,last_pos)}}),{off:e,status:function(){return _},position_and_display:i,display_fs_for_current_element:n}}(),save_and_load=function(){function e(e,t,r){"pos"in e&&set_zoom_and_trans(e.pos.x,e.pos.y,e.pos.k,!1,function(){return!1},!0),"styles"in e&&predef_styles.load(e.styles),"merged"in e&&merged.load(e.merged),"groups"in e&&!t&&r&&manage_groups.load(e.groups),"map_name"in e&&!t&&(current_map_name=e.map_name),"slides"in e&&!t&&r&&e.slides.order.length>0&&slide_manager.load_slides(e.slides.order),document.querySelector("#grid_canvas").style.backgroundColor="canvas_color"in e&&r?e.canvas_color:null}function t(){return{canvas_color:document.querySelector("#grid_canvas").style.backgroundColor,pos:JSON.parse(JSON.stringify(transform)),styles:predef_styles.get_classes(),version:VERSION,groups:manage_groups.save(),map_name:current_map_name,datetime:(new Date).toUTCString(),merged:merged.save(),slides:{order:slide_manager.save_slides()}}}function r(e,r){return manage_groups.unshow_my_group(),{gs:shapes_storage.get_data_for_save(),info:t()}}function n(){i(save_and_load.get_data_to_save())
var e=document.getElementById("save_name")
e.value=current_map_name,document.querySelector("#dl_vis").style.visibility="inherit",document.querySelector("#save_name").focus(),e.onchange=function(){current_map_name=o(this.value),document.getElementById("dl_link").download=current_map_name}}function o(e){return res=e.split("."),document.querySelector("#modal_save_zip").checked?res[0]+".zip":res[0]+".json"}function a(e,t,r){if(t){var n=new JSZip
return n.file(r,e),n.generateAsync({type:"blob",compression:"DEFLATE"})}return Promise.resolve(new Blob([e],{type:"application/json"}))}function i(e){var t=document.querySelector("#modal_save_zip").checked
current_map_name=o(current_map_name||"yourMap.json"),a(e,t,current_map_name.split(".")[0]+".json").then(function(e){var t=URL.createObjectURL(e),r=document.getElementById("dl_link")
r.download=current_map_name,r.href=t,r.textContent="Download"})}return{canvas_to_json:r,get_info_for_save:t,set_info_on_load:e,get_data_to_save:function(){return JSON.stringify(r())},reset_save:n}}(),local_store=function(){function e(){var e=[]
for(var t in localStorage)"string"==typeof localStorage[t]&&'{"gs":'==localStorage[t].slice(0,6)&&e.push(t)
return e}function t(){d3.selectAll("#load_previews div").remove(),document.querySelector("#load_preview_buttons").style.display="flex"}function r(e){arguments.length>1&&void 0!==arguments[1]&&arguments[1]
try{var t=save_and_load.get_data_to_save()
return localStorage.setItem(e,t),!0}catch(e){return"QuotaExceededError"!==e.name&&"NS_ERROR_DOM_QUOTA_REACHED"!==e.name||(console.log("not enough space left in local storage"),text_to_feedback_pane(["not enough space left in local storage","Use download or gist save instead"],!0)),!1}}function n(){return 0==shapes_storage.get_all().length}function o(e){var t=document.querySelector("#"+e+"_map")
return t&&t.remove(),!0}function a(e,t){var r=(arguments.length>2&&void 0!==arguments[2]&&arguments[2],arguments.length>3?arguments[3]:void 0),n=e,o=t.append("div").attr("id",n+"_map").attr("class","load_preview"),a=o.append("label")
a.append("h5").text(n),a.append("input").attr("type","radio").attr("name","local_maps").attr("id",n).attr("value",n),o.node().onclick=function(e){_.forEach(document.querySelectorAll(".load_preview"),function(e){return e.classList.remove("load_selected")}),e.currentTarget.classList.add("load_selected")},o.node().setAttribute("title",r.info.datetime)}return"undefined"==typeof Storage?(console.log("no local storage"),text_to_feedback_pane("no local storage",!0),!1):{quick_save:function(){var e="qs_"+current_map_name.split(".")[0]||"last_quicksave"
text_to_feedback_pane("quick saving as "+e),o(e),this.save(e)&&text_to_feedback_pane('saved map as "'+e+'"')},save:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1]
return e=e||current_map_name,n()?(show_feedback_modal("","no data found to save on map"),text_to_feedback_pane("no data found to save on map"),!1):(this.check_if_maps_loaded(),!!r(e,t)&&(a(e,d3.select("#load_previews"),!1,JSON.parse(localStorage.getItem(e))),t||text_to_feedback_pane("map saved locally with name: "+e),!0))},load:function(e,t){if(e in localStorage){var r=JSON.parse(localStorage.getItem(e))
return loader.load_data(r,t,!0),!0}return text_to_feedback_pane("could not find map"),!1},delete:function(e){delete localStorage[e],o(e)},log_size_of_storage:function(){for(var e in localStorage)console.log(e+"="+(2*localStorage[e].length/1024).toFixed(2)+" kb")},dump_all:function(){var t=current_map_name
e().forEach(function(e){current_map_name=e+".json"
var t=localStorage.getItem(e),r=prep_blob_for_download(t)
document.getElementById("dl_link").click(),URL.revokeObjectURL(r)}),current_map_name=t},reset:function(){text_to_feedback_pane("loading previews for map. may take a few seconds"),function(){var r=e()
if(0==r.length)return d3.select("#load_previews").append("div").text("no maps in local storage"),!1
t(),r.forEach(function(e){a(e,d3.select("#load_previews"),!0,JSON.parse(localStorage.getItem(e)))}),text_to_feedback_pane("done loading!")}()},check_if_maps_loaded:function(){0==document.querySelectorAll("#load_previews div").length&&this.reset()},save_as_gist:function(){},edit_as_gist:function(e){},fork_gist:function(e){},get_gists_from_user:function(e){},get_gist_from_id:function(e){},add_single_map_to_preview:a}}(),loader=function(){function e(e){return e=get_new_ids(e),shapes_storage.add_shapes(e),e}function t(e,t){var r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],n=(arguments.length>3&&void 0!==arguments[3]&&arguments[3],arguments.length>4&&void 0!==arguments[4]&&arguments[4])
if(arguments.length>5&&void 0!==arguments[5]&&arguments[5],t?document.querySelector("#edit_mode_menu").classList.add("menu_hidden"):n||document.querySelector("#edit_mode_menu").classList.remove("menu_hidden"),r&&!n&&slide_manager.clear_all_slide_previews(),!check_if_data_is_valid(e))return text_to_feedback_pane("file not recognized as valid breakdown-map",!0),!1
currentElement=!1,manage_groups.reset_all_groups(),slider=!1,canvas_status.reset()
var o
"info"in e&&(o=e.info,("version"in e.info?e.info.version:"20160101")<"20180701"?(shapes_storage=make_shape_storage(),old_to_new(e.gs,o)):(shapes_storage=make_shape_storage(e.gs),save_and_load.set_info_on_load(o,!1,!0)),add_canvas_drag_default()),function(){Object.values(shapes_storage.borders).forEach(function(e){return position_texts(e.id)}),Object.values(shapes_storage.borders_bound).forEach(function(e){return position_texts(e.id)}),render()
var e=find_highest_id_and_prefix(shapes_storage.get_all(),"_"),t=_slicedToArray(e,2),a=(t[0],t[1])
if(get_new_id=next_id_gen("_",a+1),a>9998){var i=get_new_id_prefix_and_num(),s=_slicedToArray(i,2),_=s[0],l=s[1]
get_new_id=next_id_gen(_,l)}last_used_gist_id=!1,slide_manager.update_all_slides(),n||r&&table_init(),cc.clear_all(),render_all(0,!1,!0),hide_wait_spinner(),text_to_feedback_pane("done loading map "+o.map_name),to_canvas.set_canvas()}()}return{load_data:t,load_part:e}}(),data_ext_loaded={}
document.querySelector("#upload").onclick=function(e){this.value=""},document.querySelector("#upload").onchange=function(e){data_ext_loaded={},d3.selectAll("#load_previews_ext div").remove()
for(var t=0;t<this.files.length;t++){var r=this.files[t].name
reader=new FileReader
var n=r.split(".").slice(-1)
"json"==n||"zip"==n?("zip"==n?(reader.readAsArrayBuffer(this.files[t]),reader.onload=function(e){return function(t){try{unzip_blob(t.target.result,function(t){if(!check_if_data_is_valid(t))return text_to_feedback_pane("file "+e+" not recognized as valid breakdown-map",!0),!1
local_store.add_single_map_to_preview(e,d3.select("#load_previews_ext"),!1,t),e in data_ext_loaded||(data_ext_loaded[e]=t)})}catch(t){console.log(t),text_to_feedback_pane("failed to load map ".concat(e,". It does not appear to be a zipped and valid json map"),!0,5e3)}}}(r)):(reader.readAsText(this.files[t]),reader.onload=function(e){return function(t){try{var r=JSON.parse(t.target.result)}catch(t){console.log(t),text_to_feedback_pane("failed to load map ".concat(e,". It does not appear to be valid json"),!0,5e3)}if(!check_if_data_is_valid(r))return text_to_feedback_pane("file "+e+" not recognized as valid breakdown-map",!0),!1
local_store.add_single_map_to_preview(e,d3.select("#load_previews_ext"),!1,r),e in data_ext_loaded||(data_ext_loaded[e]=r)}}(r)),document.querySelector("#load_ext_map").style.display="block"):text_to_feedback_pane([r+" is not a json or zip file. Will only load json or zip files"],!0)}},document.querySelector("#load_ext_map").onclick=function(){var e=document.querySelector("#load_previews_ext").querySelector(":checked").value,t=data_ext_loaded[e]
loader.load_data(t),history.pushState({},"","/make"),close_modal("save_load_modal")},document.querySelector("#modal_save_zip").onchange=function(e){save_and_load.reset_save()},document.querySelector(".open_modal_save").onclick=function(e){open_modal("save_load_modal"),open_tab(e,"save"),save_and_load.reset_save()},document.querySelector(".open_modal_load").onclick=function(e){setTimeout(function(){open_modal("save_load_modal"),open_tab(e,"load"),menu_status.modal_on=!0,local_store.check_if_maps_loaded()}.bind(this),200)},$(".open_modal1").on("click",function(e){open_modal("save_load_modal")}),$(".close_modal").on("click",function(e){d3.selectAll(".modal").style("display","none"),close_modal(e.target.parentElement.parentElement.id)}),document.querySelector("#dl_link").onclick=function(){document.getElementById("dl_vis").style.visibility="hidden",history.pushState({},"","/make"),close_modal("save_load_modal")},document.querySelector("#load_local_map").onclick=function(){local_store.load(document.querySelector("#load_previews").querySelector(":checked").value,pres_mode_for_load)?(history.pushState({},"","/make"),close_modal("save_load_modal")):text_to_feedback_pane("have you selected a map ? Map not found in local storage")},document.querySelector("#delete_local_maps").onclick=function(){var e=document.querySelector("#load_previews").querySelector(":checked").value,t=""
confirm("delete map"+e+"?")?(local_store.delete(e),t="deleted map "+e):t="aborting delete of"+e,text_to_feedback_pane(t)},document.querySelector("#savebutton_local").onclick=function(){document.getElementById("dl_link").innerText
var e=document.getElementById("save_name").value
local_store.save(e.split(".")[0]),document.getElementById("dl_vis").style.visibility="hidden",history.pushState({},"","/make"),close_modal("save_load_modal")},document.querySelector("#modal_load_tabs").onclick=function(e){var t=this.parentElement.querySelectorAll(".modal_sub_tab")
this.querySelector(".active").classList.remove("active"),e.target.classList.add("active"),_.forEach(t,function(e){return e.classList.add("hidden")}),i=["a","b","c"].indexOf(e.target.id),t[i].classList.remove("hidden")}
var fa_handler=function(){function e(){$.getJSON(window.location.origin+"/static/assets/fa_cats_to_icons.json",function(e){s=e,a=!0,_=s.Emoji[5]})}function t(e){var t=parseInt(e.target.getAttribute("i"))
_=s[l][t],d3.selectAll("#fa_show_icons i.selected").classed("selected",!1)
var r=Array.from(document.querySelectorAll("#fa_show_icons .fa-"+_.icon))
1==r.length?r[0].classList.add("selected"):400==_.weight?r[1].classList.add("selected"):r[0].classList.add("selected")}function r(r){a||e(),document.querySelector("#fa_categories li.selected")&&document.querySelector("#fa_categories li.selected").classList.remove("selected"),r.target.classList.add("selected")
var n=r.target.innerText,o=document.querySelector("#fa_show_icons")
d3.select(o).selectAll(".fa, .fab").remove(),s[n].forEach(function(e,r){var n=document.createElement("i")
e.is_brand?(n.classList.add("fab"),n.style.fontWeight=400):(n.classList.add("fa"),n.style.fontWeight=e.weight),n.classList.add("fa-"+e.icon),n.classList.add("fa-3x"),n.setAttribute("i",r),n.onclick=t,n.ondblclick=function(e){t(e),c&&(currentElement.icon=_,render(),c=!1),close_modal("icon_modal")},o.appendChild(n)}),l=n}function n(){var e=document.createElement("ul")
document.querySelector("#fa_categories").appendChild(e),i.forEach(function(t){var n=document.createElement("li")
e.appendChild(n),n.innerText=t,n.onclick=r})}function o(e){c=e}var a=!1,i=["Accessibility","Animals","Arrows","Audio & Video","Buildings","Business","Charity","Chat","Chess","Code","Communication","Computers","Currency","Date & Time","Design","Editors","Emoji","Files","Genders","Hands","Health","Images","Interfaces","Logistics","Maps","Mathematics","Medical","Moving","Objects","Payments & Shopping","Shapes","Spinners","Sports","Status","Travel","Users & People","Vehicles","Writing"],s={},_={icon:"flushed",code:"f579",weight:400,is_brand:!1},l=!1,c=!1
return{init:function(){n(),e()},get_icons_per_cat:function(){return s},load:e,get_selected_icon:function(){return _},opened_from_canvas:o}}()
fa_handler.init()
var get_title_of_folder=function(){var e=0
return function(t){return t.children.length>0?t.children[0].innerText:"_"+(e+=1)}}()
document.body.onpaste=handle_paste_event,document.body.ondrop=handle_paste_event,document.body.ondragover=function(e){e.preventDefault()}
var splitter_for_text_primary="\n",splitter_for_text_parsing=";",auto_number_import=!1,tag_import=!1,delta_x_import=15,delta_y_import=15,write_colwise=!0,max_rc_before_break=10
$(".background_fit_larger").on("click",function(e){size_fig_to_image(currentElement,!0,!1)}),$(".background_fit_smaller").on("click",function(e){size_fig_to_image(currentElement,!1,!1)}),$(".background_fit_orig").on("click",function(e){size_fig_to_image(currentElement,!1,!0)})
var slide_preview_dims={width:200,height:125,class:"slide_preview",margin:22},slide_manager=function(){function e(){var e=Array.from(H.querySelectorAll(".slide_preview"))
J=e.map(function(e){return h(e)})}function t(){slider=!1,canvas_status.slide_mode=!1,gui_buttons.reset_path_control_points(),cc.clear_canvas(context_single),cc.clear_canvas(gui_context),slide_edit_mode=!1,set_buttons_for_slide()}function r(e){return Math.floor(e/(slide_preview_dims.height+slide_preview_dims.margin))}function o(e){var t=parseInt(window.getComputedStyle(document.querySelector("#fs_container")).height),r=parseInt(H.style.top)
t-r>e?L(-1):e>window.innerHeight-t-r&&L(1)}function a(e,t){t.parentElement.appendChild(t)
var r=Array.from(H.querySelectorAll("g"))
r=r.filter(function(e){return e!=t})
for(var n=e;n<r.length;n++)r[n]!=t&&t.parentElement.appendChild(r[n])}function i(){canvas_status.slide_mode||(P=this,d3.selectAll(".slide_title.active").classed("active",!1),this.querySelector("text").classList.add("active"),set_buttons_for_slide())}function s(e){e.on("mousedown",i).on("click",function(){if(U){var e=this.parentElement.querySelector(".slide_title").textContent.match(/[0-9]+/)[0]
e=parseInt(e),w(e)}d3.event.stopPropagation()}).on("dblclick",function(){t(),zoom_to_area(h(P).xywh,!1)}),e.call(X)}function l(e){slide=h(e),slider={existing:!0,height:slide.xywh.height,iama:"slider",id:slide.id,width:slide.xywh.width,x:slide.xywh.x,y:slide.xywh.y},draw_slider(slider),canvas_status.slide_mode=!0,set_buttons_for_slide()}function c(e,t){e.append("text").attr("class","slide_title").attr("transform","translate(0,-20)").text("slide "+t)}function u(e,t){var r=t.xywh,n=[transform.x,transform.y,transform.k]
zoom_to_area(t.xywh),render_all(0,!1,!0)
var o=make_snapshot(r.x,r.y,r.width,r.height,slide_preview_dims.width,slide_preview_dims.height,canvas.node())
if(e.select(".slide_title").empty()){var a=H.querySelectorAll("g").length
e.style("top",(a-1)*(slide_preview_dims.height+slide_preview_dims.margin)+"px"),e.style("border-top","1px solid black")}else a=e.select(".slide_title").text().match(/[0-9]+/)[0],e.selectAll("*").remove()
e.node().appendChild(o),s(e),c(e,a),view.clear_shapes_to_render(),set_zoom_and_trans.apply(void 0,n.concat([!1,null,!0])),render_all(0,!1,!0)}function d(){var e=Array.from(H.querySelectorAll("g"))
e=e.filter(function(e){return!e.classList.contains("moving")})
for(var t=0;t<e.length;t++){var r=d3.select(e[t])
r.transition().ease(d3.easeExp).style("top",t*(slide_preview_dims.height+slide_preview_dims.margin)+"px"),r.select(".slide_title").remove(),c(r,t+1),h(r.node()).num=t}}function f(e){return d3.select(H).select("#"+e.id)}function h(e){return p(e.getAttribute("id"))}function p(e){var t=J.filter(function(t){return t.id==e})
if(1==t.length)return t[0]}function m(){J=[]}function g(e,t){e.forEach(function(e){return e.on_slide=t})}function y(e){var t=[]
return J.forEach(function(r){r.shapes.has(e)&&t.push(r)}),t}function v(e){return function(t,r){var n=get_items_to_render(t,r),o=_slicedToArray(n,7),a=o[0],i=o[1],s=o[2],_=o[3],l=o[4],c=o[5],u=o[6],d=slide_manager.get_current_slide_bbox()
return a.forEach(function(t){!bbox_is_inside_bbox(xywh_to_bbox(t),d)||e.shapes_excluded.has(t)?(t.filter="blur(15px)",get_text_with_border_id(t.id).forEach(function(e){return e.filter="blur(15px)"})):(delete t.filter,get_text_with_border_id(t.id).forEach(function(e){return delete e.filter}))}),_.forEach(function(t){!bbox_is_inside_bbox(xywh_to_bbox(t),d)||e.shapes_excluded.has(shapes_storage.borders[t.border_id])?t.filter="blur(15px)":delete t.filter}),[a,i,s,_,l,c,u]}}function b(){Object.values(shapes_storage.borders).forEach(function(e){return delete e.filter}),_.flatten(Object.values(shapes_storage.texts)).forEach(function(e){return delete e.filter}),shapes_storage.paths.forEach(function(e){return delete e.filter})}function w(e){if(e>=J.length||e<0)return!1
K=e
var t=J[e]
return cc.clear_canvas(gui_context),N&&view.set_shapes_to_render(t.shapes),$?zoom_to_area(t.xywh,!1,v(t)):zoom_to_area(t.xywh,!1),document.querySelector("#slides_quick_controls p").textContent=e+1+" / "+J.length,!0}function x(e){e?(document.querySelector("#form_slide_show_controls").style.display="flex",document.querySelector("#form_slide_show_start_controls ").style.display="none",document.querySelector("#slides_quick_controls").style.display="block"):(document.querySelector("#form_slide_show_controls").style.display="none",document.querySelector("#form_slide_show_start_controls ").style.display="block",document.querySelector("#slides_quick_controls").style.display="none")}function k(e){var t=E(e)
return t?(J.push(t),cc.clear_canvas(context_single),drag_slides_off(),to_canvas.set_canvas(),canvas.node().focus(),!0):(text_to_feedback_pane("no shapes found inside slider....Will not make a slide without shapes"),!1)}function E(e){var t=shapes_storage.find_shapes_in_bbox(xywh_to_bbox(e))
if(0==t.length)return!1
var r=A(),n=d3.select(H).append("g").attr("class","slide_preview").style("position","absolute")
n.attr("id",r),e.id=r,g(t,r)
var o={}
o.id=r,o.shapes=new Set(t),o.shapes_excluded=new Set
var a=e.x,i=e.y,s=e.width,_=e.height
return o.xywh={x:a,y:i,width:s,height:_},o.num=J.length,u(n,o),o}function A(){return"slide_"+(G+=1)}function S(e){var t=p(e)
u(f(t),t)}function q(e,t){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=p(e)
n.shapes.forEach(function(e){1==y(e).length&&delete e.on_slide})
var o=shapes_storage.find_shapes_in_bbox(xywh_to_bbox(t))
g(o,n.id),n.shapes=new Set(o.filter(function(e){return!n.shapes_excluded.has(e)})),n.xywh=t,r||S(e)}function T(e){function t(e,t){return e.x>t.x||e.y>t.y||e.x+e.width<t.x+t.width||e.y+e.height<t.y+t.height}y(e).forEach(function(r){var n=z(r,5)
if(t(r.xywh,n)){var o=function(){return q(r.id,n,!slides_mode)},a=function(){return q(r.id,r.xywh,!slides_mode)}
"message"==Y?slide_update_messager.add_message(r,e,o,a):"update"==Y?o():a()}})}function z(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:40,r=get_bbox_of_group(Array.from(e.shapes)),n=_slicedToArray(r,4),o=n[0],a=n[1],i=n[2]
return{x:o-t,y:i-t,width:a-o+2*t,height:n[3]-i+2*t}}function I(){var e=p(P.id)
e.shapes_excluded=new Set(Array.from(e.shapes_excluded).map(function(e){return shapes_storage.search_shapes_with_id(e.id)}).filter(function(e){return e})),e.shapes=new Set(Array.from(e.shapes).map(function(e){return shapes_storage.search_shapes_with_id(e.id)}).filter(function(e){return e})),zoom_to_area(e.xywh),e.shapes_excluded.forEach(function(e){return render_hover_highlight(e,"red",gui_context,get_scaled_margin())}),e.shapes.forEach(function(e){return render_hover_highlight(e,"green",gui_context,get_scaled_margin())})}function M(e,t){e.shapes.delete(t),e.shapes_excluded.add(t),delete t.on_slide}function j(e){var t=p(P.id)
t.shapes.has(e)?M(t,e):t.shapes_excluded.add(e)?(t.shapes_excluded.delete(e),t.shapes.add(e),e.on_slide=t.id):console.log("to be implemented"),S(t.id),cc.clear_canvas(gui_context),I()}function L(e){if(0==e)return!1
n=H.querySelectorAll("canvas").length
var t=F-n*(slide_preview_dims.height+slide_preview_dims.margin),r=parseInt(H.style.top)||0
r+=e*-SCROLL_DELTA,r=Math.min(Math.max(t+2*slide_preview_dims.height,r),F),H.style.top=r+"px"}function C(e){e.shapes_excluded=new Set(e.shapes_excluded.map(shapes_storage.search_shapes_with_id).filter(function(e){return e}))}function O(e){var t,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[5,5,5,5],n=shapes_storage.find_shapes_in_bbox(xywh_to_bbox(e))
if(e.existing){var o=p(e.id)
t=find_boundaries_based_on_inside_figs(n.filter(function(e){return!o.shapes_excluded.has(e)}))}else t=find_boundaries_based_on_inside_figs(n)
var a=t.top-r[0],i=t.left-r[2],s=t.right-t.left+r[1]+r[3],_=t.bottom-t.top+r[0]+r[2]
e.x=i,e.y=a,e.width=s,e.height=_,render()}function R(e){Y=e}var P,W,H=document.querySelector("#fdasdf"),B=0
H.style.position="absolute"
var $,N,F=0,D=!1,Y="remove",X=d3.drag().on("start",function(){B=Array.from(H.querySelectorAll("g")).indexOf(this),this.classList.add("moving"),W=drag_treshold(15)}).on("drag",function(){var e=W.add(0,d3.event.dy),t=_slicedToArray(e,2),n=(t[0],t[1])
if(0!=n&&!canvas_status.slide_mode){var a=parseInt(this.style.top)+n
o(a),this.style.top=a+"px"
var i=r(a)
i!=B&&(B=i,d())}}).on("end",function(){this.classList.remove("moving"),W.treshold_reached()&&!canvas_status.slide_mode&&(a(r(parseInt(this.style.top))+1,this),d(),U&&e()),i.call(this),set_buttons_for_slide()}),U=!1,J=[],K=0,G=0
return{set_slide_update_action:R,shrink_wrap_around_figures:O,get_current_slide_bbox:function(){return xywh_to_bbox(J[K].xywh)},get_slides_as_arr:function(){return J},handle_object_of_slide_has_moved:T,handle_exclusion_mode_click:j,setup_menu:function(){F=document.querySelector("#fs_container").getBoundingClientRect().bottom,H.style.top=F+"px"},get_slider:h,add_slide:k,update_slide_by_bbox:q,update_slide_snapshot:S,delete_slide:function(e){d3.select("#"+e.id).remove(),P=!1,J=J.filter(function(t){return t.id!=e.id}),d()},delete_slide_from_preview:function(){P.id==slider.id&&t(),this.delete_slide(h(P))},save_slides:function(){var e=[]
return J.forEach(function(t){var r={id:t.id,xywh:t.xywh,shapes:Array.from(t.shapes).map(function(e){return e.id}),shapes_excluded:Array.from(t.shapes_excluded).map(function(e){return e.id})}
e.push(r)}),e},load_slides:function(e){this.remove_all_slides(),e.forEach(function(e){var t=JSON.parse(JSON.stringify(e))
t.shapes=new Set(t.shapes.map(shapes_storage.search_shapes_with_id).filter(function(e){return e})),C(t),d3.select(H).append("g").attr("class","slide_preview").style("position","absolute").attr("id",t.id),J.push(t)}),d(),G=Math.max.apply(void 0,J.map(function(e){return parseInt(e.id.split("_")[1])}))},update_all_slides:function(){J.forEach(function(e){return S(e.id)})},hide_slider:function(){cc.clear_canvas(context_single),slider=!1},show_slider:function(e){l(e)},toggle_slider_visibility:function(e){var r=e||P
if(slider)return t(),!1
canvas_status.slide_mode=!0,set_buttons_for_slide(),l(r)
var n=slider
return zoom_to_area({x:n.x-100,y:n.y-100,width:n.width+200,height:n.height+200}),draw_slider_resize_points(),!0},start_slide_show:function(){ids_with_filter_to_clear=[]
var t=document.querySelector("#form_slide_show_filter")
$="fade"==t[t.selectedIndex].innerText,N="hide"==t[t.selectedIndex].innerText,e(),U=!0,x(!0),K=0,w(0)},end_slide_show:function(e){view.clear_shapes_to_render(),b(),cc.clear_all(),render_all(0,!1,!0),U=!1,x(!1),_.forEach(document.querySelectorAll('g[i_am_a="slide"]'),function(e){e.classList.remove("blank"),e.classList.remove("displayed"),e.classList.add("hidden")}),D&&(D=!1,toggle_slide_edit_menu(void 0,!0),document.querySelector("#sidebar").classList.remove("menu_hidden")),this.setup_menu()},next_slide:function(){w(K+1)||text_to_feedback_pane("no more slides")},prev_slide:function(){w(K-1)||text_to_feedback_pane("first slide reached")},slide_show_on:function(){return U},scroll_slides:L,clear_all_slide_previews:function(){d3.select(H).selectAll("svg").remove()},move_slide_in_order:function(e,t){t=t||P,a(e,P),d()},remove_all_slides:function(e){m(),K=0,d3.select(H).selectAll(".slide_preview").remove()},show_all_sliders:function(e){J.forEach(function(e){return draw_slider([e.x,e.y],[e.x+e.width,e.y+e.height])})},remove_slider:t,show_excluded_included:I,get_last_clicked_slide_preview:function(){return P}}}()
$(".form_add_slide").on("click",function(e){drag_slides_on(),set_slides_buttons(!1,!1,!1,!1,!0)}),$(".form_make_slide").on("click",make_slide_handler),$(".form_cancel_slide").on("click",function(e){slide_manager.remove_slider(),set_buttons_for_slide()}),$(".form_delete_slide").on("click",function(){slide_manager.delete_slide_from_preview(),set_buttons_for_slide()}),$(".form_toggle_slider").on("click",function(e){slide_manager.toggle_slider_visibility()}),$(".form_slide_exclusion_mode").on("click",function(e){enter_slide_exclusion_mode(),slide_manager.show_excluded_included()}),$(".form_update_slide").on("click",function(){if(slider&&slider.existing){var e=slider,t=e.x,r=e.y,n=e.width,o=e.height
slide_manager.update_slide_by_bbox(slider.id,{x:t,y:r,width:n,height:o}),slider_off()}else text_to_feedback_pane("select a slider to update first")
set_buttons_for_slide()}),$(".form_wrap_slide").on("click",function(){if(slide_manager.shrink_wrap_around_figures(slider),slider.existing){var e=slider,t=e.x,r=e.y,n=e.width,o=e.height
slide_manager.update_slide_by_bbox(slider.id,{x:t,y:r,width:n,height:o}),slider_off()}else slide_manager.add_slide(slider),slider_off()
set_buttons_for_slide()}),document.querySelector("#form_slide_show_start").onclick=function(e){slide_manager.start_slide_show()},$(".form_slide_show_next").on("click",slide_manager.next_slide),$(".form_slide_show_prev").on("click",slide_manager.prev_slide),$(".form_slide_show_stop").on("click",function(){slide_manager.end_slide_show()}),document.querySelector("#slides_menu").onclick=slide_manager.setup_menu,document.querySelector("#form_remove_all_slides").onclick=slide_manager.remove_all_slides,document.querySelector("#fdasdf").onwheel=function(e){slide_manager.scroll_slides(Math.sign(e.deltaY))}
var slide_update_messager=make_messenger(document.querySelector("#form_slide_update_messages"),add_slide_update_message),align_update_messager=make_messenger(document.querySelector("#form_align_update_messages"),align_update_message)
$("#form_slide_update_action").on("change",function(e){var t=this.querySelector("input[name=update_slide_action]:checked").value
slide_manager.set_slide_update_action(t)})
var roughen_all=!1,roughing=function(){function e(e){delete e.rough,delete e.rough_pars,delete e.rough_ds,delete e.redraw_data}function t(e){if("path_group"==e.iama)var t=e.inner_width,r=e.fill,n="rgba(0,0,0,0)"
else var t=e.stroke_width,r=e.stroke,n=e.fill
return{strokeWidth:t,stroke:r,fill:n}}function r(e){var r=t(e),n="rough_pars"in e
return n?(r.roughness=e.rough_pars.roughness,r.hachureGap=e.rough_pars.hachureGap,r.hachureAngle=e.rough_pars.hachureAngle):(r.roughness=d,r.hachureGap=h,r.hachureAngle=f),(0==parseInt(r.hachureGap)||p&&!n)&&(r.fillStyle="solid"),r}function n(){return{roughness:d,gap:h,angle:f,roughen_all:roughen_all,fill_is_solid:p}}function o(e){a(e.roughness),document.querySelector("#form_hachure_angle input").value=e.angle,document.querySelector("#form_hachure_gap input").value=parseInt(e.gap),document.querySelector("#form_roughen_all").checked=e.roughen_all,p=e.fill_is_solid,d=e.roughness,f=e.angle,h=e.gap,roughen_all=e.roughen_all}function a(e){d3.selectAll("#form_roughness button").classed("onoff-on",!1)
var t=[1,2,4,7].indexOf(e)
if(-1==t)return!1
document.querySelectorAll("#form_roughness button")[t].classList.add("onoff-on")}function i(e,t){var n,o=!(arguments.length>2&&void 0!==arguments[2])||arguments[2]
if(n=u||("draw_canvas"==t.canvas.id?l:c),e.redraw_data)return t.save(),t.translate(e.x-e.redraw_data.origin[0],e.y-e.redraw_data.origin[1]),n.draw(e.redraw_data.rough_data),t.restore(),!0
var a,i=r(e)
if(e.rough_pars=i,"path_group"==e.iama)a=n.path(e.d,i)
else if("drawing"==e.iama&&"line"==e.type){var s=path_to_array(e.d).map(function(t){var r=t.x,n=t.y
return{x:e.x+r,y:e.y+n}}),_=line_generator_linear(s)
a=n.path(_,i)}else if("ellipse"==e.shape)a=n.ellipse(e.x+e.width/2,e.y+e.height/2,e.width,e.height,i)
else if("rect"==e.shape)a=n.rectangle(e.x,e.y,e.width,e.height,i)
else{var d=e.width,f=e.height,h=get_poly_config(e),p=h.points.map(function(t){var r=_slicedToArray(t,2),n=r[0],o=r[1]
return[e.x+n*d,e.y+o*f]}),m=line_generator_linear(p.map(function(e){return{x:e[0],y:e[1]}}))+"z"
a=n.path(m,i)}o&&a&&(e.redraw_data={rough_data:a,origin:[e.x,e.y]})}function s(e){u=rough.canvas(e)}function _(){u=!1}var l=rough.canvas(canvas.node()),c=rough.canvas(canvas_single.node()),u=!1,d=1,f=0,h=0,p=!0
return document.querySelector("#form_make_rough").onclick=function(t){if("canvas"==currentElement.iama)return text_to_feedback_pane("select a shape first"),!1
manage_groups.get_group(currentElement).forEach(function(t){e(t),t.rough=!0}),render()},document.querySelector("#form_undo_rough").onclick=function(t){if("canvas"==currentElement.iama)return text_to_feedback_pane("select a shape first"),!1
manage_groups.get_group(currentElement).forEach(function(t){e(t)}),render()},document.querySelector("#form_roughen_all").onchange=function(e){roughen_all=this.checked},$("#form_roughness button").on("click",function(e){d=parseFloat(this.getAttribute("roughness")),a(d)}),{get_specs:r,get_current_settings:n,load_settings:o,draw:i,hook:l,set_for_export:s,set_default:_}}(),infinity=function(){function e(e){for(var t=["L0","L1","L2","L3"],r=0;r<t.length;r++)if(e<=_[t[r]].valid_to_zoom_level)return[_[t[r]].scale_for_figure,t[r]]
return[1,"L1"]}function t(e){return"L0"==e?4:"L1"==e?2:"L2"==e?2:1}function r(e,r){"text"==e.iama&&(e=find_border_by_id(e.border_id)),manage_groups.get_group(e).forEach(function(e){var n=e.level
if(n!=r){e.level=r
var o=predef_styles.is_font_class(e.font_size,n);-1!=o&&(change_font_size_of_el(e,c[r][o]),e.padding=t(r),resize_if_wanted_after_font_change(e)),e.stroke_width=round_to(e.stroke_width*u[r]/u[n],1)}})}function n(e){return"level"in e?e.level:"text"==e.iama?shapes_storage.borders[e.border_id].level:"L1"}function o(e){var t=/\d+\.*\d*/g,r=e.match(t)
if(!r||4!=r.length)return e
r=r.map(function(e){return parseFloat(e)})
var n=Math.max(0,Math.min(1,transform.k-1))
return r[3]=n,"rgba("+r.join(",")+")"}function a(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0
return!t&&s&&(t=i()),s||(t="L1"),round_to(e*u[t],r)}function i(){return s?e(transform.k)[1]:"L1"}var s=!0,_={L0:{valid_to_zoom_level:.4},L1:{valid_to_zoom_level:1.5},L2:{valid_to_zoom_level:3.5},L3:{valid_to_zoom_level:100}},l={L0:8,L1:4,L2:2,L3:1},c={L0:predef_styles.font_sizes.map(function(e){return 2*e}),L1:predef_styles.font_sizes.map(function(e){return e}),L2:predef_styles.font_sizes.map(function(e){return parseInt(.5*e)}),L3:predef_styles.font_sizes.map(function(e){return parseInt(.2*e)})},u={L0:2,L1:1,L2:.5,L3:.25}
return{get_mdd:function(){return l[i()]},get_level:i,get_font_sizes_of_level:function(e){return c[e]},get_font_size:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:3
return s||(e="L1"),c[e][t]},get_border_width:function(e,t){return s||(e="L1"),round_to(predef_styles.get_classes()[t].stroke_width*u[e],1)},get_standard_scaling:a,turn_scaling_on:function(){return s=!0},turn_scaling_off:function(){return s=!1},change_shape_level:r,get_level_of_item:n,get_alpha:o}}()
document.querySelector("#form_toggle_infinity").onclick=function(){is_toggle_button_on(this)?infinity.turn_scaling_off():infinity.turn_scaling_on(),toggle_button(this)},$("#form_set_infinity_level button").on("click",function(e){$("#form_set_infinity_level").find("button").toggleClass("onoff-on",!1),this.classList.add("onoff-on"),infinity.change_shape_level(currentElement,this.value),set_current_element(currentElement)})
var merged=function(){function e(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[]
return!(e.id in s||(s[e.id]=t,0))}function t(e,t){return all_children.has(t)?(text_to_feedback_pane("cannot add a child that already is a child of another shape"),!1):-1!=Object.keys(s).indexOf(t.id)?(text_to_feedback_pane("a shape cannot be a parent and a child at the same time... Unmerge first."),!1):-1==s[e.id].indexOf(t)?(s[e.id].push(t),all_children.add(t),shapes_storage.move_to_top(t),!0):void 0}function r(e){Object.keys(s).forEach(function(t){-1!=s[t].indexOf(e)&&(s[t]=s[t].filter(function(t){return t!=e}),0==s[t].length&&delete s[t],all_children.delete(e))})}function n(){var e={}
return Object.keys(s).forEach(function(t){e[t]=s[t].filter(function(e){return e}).map(function(e){return e.id})}),JSON.stringify(e)}function o(e){all_children=new Set
var t=JSON.parse(e),r=shapes_storage.borders
Object.keys(t).forEach(function(e){s[e]=t[e].map(function(e){return r[e]}).filter(function(e){return e}),s[e].forEach(function(e){return all_children.add(e)})})}function a(e){s[e.id].forEach(r),delete s[e.id]}function i(e){var t=!1
return Object.keys(s).forEach(function(r){-1!=s[r].indexOf(e)&&(t=shapes_storage.borders[r])}),t}var s={}
return all_children=new Set,{is_parent:function(e){return e.id in s},get_children:function(e){return s[e.id]},get_parent:i,add_child:t,remove_child:r,is_child:function(e){return all_children.has(e)},create_new_group:e,save:n,load:o,remove_group:a}}(),no_table=!0,tables={},table_with_pos=[]
shuffle_shapes=function(){function e(e){r=t(e),n=[]
var o=get_bbox_of_group(r),a=_slicedToArray(o,4),i=a[0],s=a[1],_=a[2],l=a[3]
return n.push({x:i,y:_,w:s-i,h:l-_}),[i,s,_,l]}function t(e){var t={}
return e.forEach(function(e){var r=posit2.get_w_h(e),n=_slicedToArray(r,2),o=n[0],a=n[1]
t[e.id]=o*a}),e.sort(function(e,r){return t[r.id]-t[e.id]})}var r=[],n=[]
return{place_shapes:function(t){var r=e(t),n=_slicedToArray(r,4)
minX=n[0],maxX=n[1],minY=n[2],maxY=n[3]
var o=get_placer_fill_area(minX,minY,maxX-minX,maxY-minY)
t=_.shuffle(t),t.forEach(function(e){o.position_shape(e)})}}}()
for(var gridlines=function(){function e(){(!(arguments.length>0&&void 0!==arguments[0])||arguments[0])&&t(n,o)}function t(e,t){var r=parseInt(-transform.x/transform.k/e)*e,n=parseInt(-transform.y/transform.k/t)*t,o=canvas_width/transform.k,i=canvas_height/transform.k
if(grid_context.clearRect(0,0,canvas_width,canvas_height),grid_context.save(),grid_context.translate(transform.x,transform.y),grid_context.scale(transform.k,transform.k),grid_context.beginPath(),e>0)for(var s=r;s<r+o;s+=e)grid_context.moveTo(s,n),grid_context.lineTo(s,n+i)
if(t>0)for(var s=n;s<n+i;s+=t)grid_context.moveTo(r,s),grid_context.lineTo(r+o,s)
grid_context.closePath(),grid_context.strokeStyle="black",grid_context.lineWidth=a,grid_context.stroke(),grid_context.restore(),cc.set_has_ink(grid_context)}var r=!1,n=25,o=25,a=.25
return plus_minus_generator(document.getElementById("form_grid_lines_width"),function(e){var t=Math.max(0,e.value/20)
e.value=20*t,a=t},1,0),plus_minus_generator(document.getElementById("form_grid_lines_dx"),function(e){e.value=Math.max(0,e.value)}),plus_minus_generator(document.getElementById("form_grid_lines_dy"),function(e){e.value=Math.max(0,e.value)}),document.querySelector("#form_toggle_grid_lines").onclick=function(){if(is_toggle_button_on(this))cc.clear_canvas(grid_context),r=!1
else{var t=parseInt(document.querySelector("#form_grid_lines_dx input").value),a=parseInt(document.querySelector("#form_grid_lines_dy input").value)
if(!t&&!a)return text_to_feedback_pane("you have to set delta x or delta y to a value bigger then zero",!0),!1
n=t,o=a,e(),r=!0}toggle_button(this)},{make:e,on:function(){return r}}}(),_help_mapper,formulaText="the formula must have the variable x, and can contain any of the following operators: \n\t+ - / *  sin, cos, tan, ceil, floor, log, sqrt, abs (use as sin(x) or sin(2) )\n\t, 'pow, min and max  are special, because they takes two arguments: x^2 => pow(x,2)",axis_help=["About axis","You can color the axis using the color menu","Or use the border menu to make the axis thicker or thinner","In the font menu, you can choose a font and size for text","In the graph menu, you can change the ticks, and the ranges","By using the arrow keys \tyou can position the axis"],help_mapper=(_help_mapper={"sign in/out":["Sign in with your github account to save and load and edit maps from and to your github profile"],"toggle view mode":["Enter view mode if you want to just view the map","You will not be able to alter or add any shapes or text","It is meant to make it easier to read, and zoom and pan the map"],"to slides":["takes you to the slide menu where you can make presentations from your notes","Quick key: F9"],"to tutorial":["opens a new map with the basics of breakdown Notes explained"],"hot keys":[" opens a new map where all the hot keys / keyboard shortcuts are explained"],"study mode":["when there are flashcards on the map, switching to study mode will make it\t\t easier to flip a flashcard. Also some of the gui-elements are hidden, so you focus\t\t on stuying.","In the one-by-one mode, you can choose to show only one card at a time.","Just click the start button to activate it","Click the card to flip it, and the map to show the next one",'If the "check" box is on, you can type\t\t in an answer and have Breakdown Notes check it'],"Study mode":["when there are flashcards on the map, switching to study mode will make it\t\t easier to flip a flashcard. Also some of the gui-elements are hidden, so you focus\t\t on stuying.","You also have an option to type in an answer and have Breakdown Notes check it"],Export:["Go here to export as png"],"add region":["to start exporting, first press this button"],"keep standard ratio":["uncheck this box to set your own export region. Check it to have the export region set to the standard paper size (A4)"],"No background":["If checked, when exporting, the background (the canvas) will be left blank, and only the shapes, texts and paths \t\tetc will be printed","If you uncheck, the background for the image will be set to the background color of the canvas"],"Choose print size":["Choose the format to print the image to. This will be the ouput size of the image"],scale:["With scale, you can increase or decrease the output size of the image that will be exported","See the output format below \t\tfor an estimation of the output size"],Shapes:["Choose a shape to add to the canvas. Choose by clicking it, and then double click the canvas to add it"],Colors:["Lets you choose a quick style for a figure.","Click an element on the canvas, then on a predefined style.","You can also choose a custom color using the color picker. There you can also choose a color for \t\tthe border of an element","You can change any of the predefined styles by right clicking it. A menu will pop up from where you can change the style","This will change all the shapes with this particular style."],"Custom color":["Set your own color, for the fill, the border or the text of shapes"],fill:["color the interior of an object"],text:["color the text of a paragraph"],stroke:["color the stroke, or border of an object","only works if the border is bigger\t\tthen 0: see border controls menu to change"],Sketch:["use this to make a shape look like it has been drawn by hand"],Import:["Settings to control what happens when importing (copy paste or drag and drop) text or html"],"new shape when":["Enter one or more characters to split on, for instance . (a point)","For every time this character (or these characters) are encountered in the imported text, a new shape will be added","Can be empty","use "],"new paragraph when":["Enter one or more characters to split on, for instance . (a point)","For every time this character (or these characters) are encountered in the imported text, a new paragraph will be added","Can be empty"],Font:["Choose a font","Can choose a font for figure or paragraph","Fonts in a paragraph will overrule the figure-font, so multiple fonts per figure possible","Multiple fonts per paragraph are impossible"],"Font size":["Predefined font sizes (from extra large to extra small","You can choose a size for a shape or paragraph","Paragraph will overrule shape font, so multiple sizes for one shape are possible","Multiple fonts sizes in one paragraph is not possible"],"font size":["Predefined font sizes (from extra large to extra small","You can choose a size for a shape or paragraph","Paragraph will overrule shape font, so multiple sizes for one shape are possible","Multiple fonts sizes in one paragraph is not possible"],Quick:["Predefined font sizes (from extra large to very small","Can choose a size for figure or paragraph","Paragraph will overrule figure-font, so multiple sizes per figure possible","Multiple fonts sizes per paragraph impossible","Does not work for or icon figure"],Specific:["Choose a specific font size","For paragraph and figure","Paragraph font size will \t\toverrule figure font size"],"max width":["controls how wide a shape will get before it ads a line break"],flip:["Press to add a backside to an element. After that you can add text to the backside and the frontside of a shape","You can flip an element using the flip-button just below a shape.",'This button is only visible when an element is "flippable"'],paths:["Updates paths on selected figure","When multiple paths are attached \t\tto the same side, will recalculate which path goes where, or put all paths on a side on the same position"],"toggle sticky":["if on, elements positioned on / within the boundaries of the sticky figure, will be \t\t\tmoved simultaneous with the sticky when repositioned"],top:["moves the active shape on top of other elements on top of it"],bottom:["moves elements below the active shape on top of it"],"copy with text":["When on, will copy shapes with all paragraphs text and styling","When off, will only\t\tcopy shape"],shape:["First select the shape you want copied, then press the shape copy button, and finally press\t\tthe position on the canvas where you want the copied shape placed","quick key: control C"],style:["First select the shape with the style you want copied, then press the style copy button, and finally \t\tclick the shape / paragraph or path you want the style copied onto"],"even out paragraphs":["Set the margin between the paragraphs so that all the paragraphs are evenly\t\tdistributed over the shape"],"inside padding":["controls the distance between the border of a shape and the paragraphs inside it"],resize:["if checked, when you change anything font related (size, family etc), the shape will automatically \t\t be resized so the text will fit inside it"],"height only":["if resize is checked, will only make the shape bigger or smaller in height. The width of the shape \t\t wil stay the same"],Sizing:["With sizing you control whether the displayed part image is larger then the shape is, or smaller","Choosing contain will fit the whole image inside the shape. This might leave part of the shape uncovered","When choosing cover, the whole image will cover the shape, but part of the image might be invisible"],"Fit image":["With fit image, the image and the shape its in will be sized equally: this means the shape will be totaly covered\t\t and the image precisely contained in the shape","By clicking larger, the shape will be increased in size etc."],"Text-align":["to align text in a figure","Works on figure and paragraphs in figure","Paragraph overrules figure alignment","Not for text or icon"],Margin:["Set the distance of the border of the paragraph to other paragraphs and the figure \t\tit is contained in"],Padding:["Sets the distance of the text in a paragraph to the border of the paragraph \t\tit is contained in"],"to flip side":["Moves the current paragraph to the flip side of this shape","Afterwards, you can flip a shape with the triangle to the right of the shape\t  which will appear once you select the shape"],"set to shape width":["When you click the button, the current paragraph will take on the whole width of the shape it is in","You will only notice an effect, if the paragraph fill is different from the fill of the shape."],"Show plumb lines on move":["when off, the red plumb lines will not be shown while moving a shape by dragging","On slower computers, this will increase the frame rate","When using arrow keys to move a shape, the plumbs will always be shown"],"Toggle glow":["when off, the greenish glow will no longer appear while hovering some shapes","on slower computers, this will increate the frame rate"],"Zoom and pan":["when on (green) allows to zoom with scroll mouse button and pan with mouse"],"Auto resize on input":["If on, the shape you are typing text in will automatically resize so that the text will fit neatly\t\tinside the shape."],"Fine position move":["When on, moves the figure while pressing arrow key \t\tone pixel, when off, moves multiple pixels","When dragging with the mouse, you can also hold the alt key to only change 1 px"],"Fine position resize":["When on, resizes the figure while holding control and pressing arrow key \t\tone pixel, when off, resizes multiple pixels","When dragging with the mouse, you can also hold the alt key to only change 1 px"],"Catcher width":["Set the width of the catcher. The catcher is the greenish border that appears around\t\tmost shapes and lets you drag, select and touch a shape more easily"],"Grid delta":["set the minimum interval you want to drag before an elements moves or resizes","An element when added to the canvas will always be in interval steps","the width/height not always"],"Snap to Grid":["will snap an element to the grid (after you have changed the grid interval)","Button for position and size (width and hight together)","If button is transparant\t\tposition and/or size already on interval"],"Show lines":["when on, shows gridlines"],"Delta x":["adjust the distance between the gridlines","Turn gridlines off and on again\t\tfor change to take effect"],"Delta y":["adjust the distance between the gridlines","Turn gridlines off and on again\t\tfor change to take effect"],"draw mode":["By entering the drawing mode, you can use the canvas as a basic sketch book. You will be able to draw\t\t lines by dragging the mouse, or using a pen for your touchscreen (when available)","Enter the drawing mode by toggling the draw mode button, or by holding shift and then press control","Exxit the draw mode, by toggling the draw button, or by pressing escape"],"pencil size":["choose a size for your pencil.","To change the size of another drawing, click the drawing and use \t\t the border controls menu"],"Recognize paths":["When on, if you start drawing a line from a shape and end your line on another shape \t\t, it will be made into a path between these shapes"],"Recognize shapes":["When on, if you end drawing a line in the same position as where you started, it will \t\tbe made into a shape to which you can add text and which you can move and resize"],Levels:["With levels you can add structure to your notes and diagrams: the size is decided by the zoom level","If you are zoomed in, the shapes you add will be small, if you are zoomed out, the shapes will be big."],"Use levels":["If on, then shapes and the text inside will be scaled dependent on the current zoom level of the map","If off, all shapes will have the same size"],"Set level":["Use this button to assign a shape to a level","Paths will be assigned based of the levels of the \t\tshapes the path is connecting"],Width:["sets the width of the border of the selected figure","for paragraphs, and figures, sets \t\t\tthe width of the border, for textfigures and icons: sets the width of the outline \t\t\tfor paths: set the width of the path","paragraph borders are not coloured by default so you must choose a color also"],Radius:["only for rectangles","sets how round the corners are"],"Dots 'n dashes":["lets you style the border, path or text/icon-figures by setting gaps in the stroke / border","first value = dash, second value = gap, third value = dash etc","for instance giving value 5 will show dashes of 5 px, 5 1  will show dash of 5px, gap of 1px"],From:["choose on which side the path starts","will persist after choice, also when \t\tconflicting with other figure","use reset to undo"],To:["choose on which side the path ends","will persist after choice, also when \t\tconflicting with other figure","use reset to undo"],reset:["resets path choices, for chosen direction and also for manually adjusted \t\tcontrol points"],Flow:["set the flow of the selected path"],Style:["set the style of the selected path"],"Add arrow":["add an arrow on any or both sides of the path"],"Show control points":["By dragging the control points, you can change the flow of the path","After dragging a control point, the path will keep the flow. Press reset to change back."],"Add control point":["By adding more control points to a line, you can make the path flow in more complex ways"],"Set free":['By setting the control points "free" you can move the points one by one.',"Normally some of the control points move together so that the flow of the path stays smooth","This is only relevant for path to which you have added control points."],"As text-path":["switch from text block to text path","text block is text in a rectangle, text path is text along the path"],"To top":["Copy text path or text block to the top of all other figures","Usefull when multiple path intersect and the one with a text label is not on top"],"Group Shapes":["With groupings you can select multiple elements at the same time, so you can \t\tmove them together, or change the style together"],"Paste current group":["Will copy all the elements in the active group centered around the last \t\tclicked position on the canvas"],Subset:["To help with selecting shapes or paragraph that have a particular feature (like color, stroke width)","First select a shape that has the feature you want to group on, then press the button describing the feature"],"Resize all in group":["Press any of the buttons to change the width and/or height of the shapes in the group, to the width\t and /or height of the current active shape."],"disperse group":["you can use the buttons to increase or decrease the space between the shapes in the active group, either \tvertically (vert) or horizontally(hor)"],"Merge Shapes":["lets you group two or more elements into one"],"Merge all covered elements":["will merge / group elements together. children need to be inside parent, then select \t\tparent and click button","Moving parent will now also move children. Children are still moveable"],"Merge by dragging":["will merge / group elements together. children need to be inside parent, then select \t\tparent and click button","Moving parent will now also move children. Children are still moveable"],"Undo Merge":["will ungroup an previously merged/grouped element."],"Align Shapes":["lets you position elements on the same position hor / vert, or the same size width /height","works on grouped elements, or on hierarchical elements (without need for grouping"],Line:["Place shapes in one line (the same column or row). Or give shapes the same size"],Table:["Align shapes in a table (multiple rows and columns)"],Align:["Align all the element in the active group (permanent, temporary or hierarchical","You can align vertically, horizontally, or both","When aligning horizantally \t\tfor figures next to each other, they will get the same distance from each other","The distance is the distance between the selected figure (if in the group) and the next figure \t\tint the group"],Resize:["Similar to alignment, only will change the size of the figures in the group \t\t(width, height or both) based of the selected figure (if in the group)"],Hierarchy:["With hierarchies, you can connect elements as children.","Advantage is that these elements are easier aligned and that part of the connections will partly overlap","Click Add child button once to add a knot, then click to add children","You can add existing elements to a\t\thierarchy by clicking the knot and drag the connect button onto the shape you want to add to the hierarchy"],"Add child":["Add a child element on a particular side of the selected figure"],Orientation:["Change the orientation of the selected figure from horizontal to vertical \t\tand vice versa.","The active shape needs to be a child element for it to work."],Mirror:["Put the selected child figure on the other side of the shared path of the \t\t   path"]},_defineProperty(_help_mapper,"Margin",["Set the distance between the child elements for the selected group"]),_defineProperty(_help_mapper,"Mark element as child",[" Will add a non-child figure that has a connection to a figure that already has \t\ta child group, to this child group","If there are multiple child groups on the parent element, will add to the child group on the \t\tsame side as the figure thats is going to be marked as child. Random otherwise"]),_defineProperty(_help_mapper,"Select child group",["group all the element for simultaneous moving / styling"]),_defineProperty(_help_mapper,"update slides",["Update all the slide previews.","Handy when you have moved about shapes of slides on the canvas a lot"]),_defineProperty(_help_mapper,"Choose filter",["With the filter you control what happens with the content that is not on a slide when, zooming into a slide.","Choosing none will still show these elements, Fade will fade these elements, and hide will hide elements not on the slide"]),_defineProperty(_help_mapper,"Hide shapes",["You can hide shapes that are inside the slider on the slide","First either make or show a slider on the map.","Then group the shapes you want to hide (control right click the shapes","Then click the slider and click this button"]),_defineProperty(_help_mapper,"Update settings",["Controls what happens when a shape that is moved outside of the slide it is on"]),_defineProperty(_help_mapper,"always update",["When the shape is moved outside of the slides current area, the area is increased to include the moved shape"]),_defineProperty(_help_mapper,"always remove",["When the shape is moved outside of the slides current area, the shape will be removed from the slide"]),_defineProperty(_help_mapper,"ask",["When the shape is moved outside of the slides current area, you are asked wether you want to update the slide, or remove the shape \t\tfrom the slide"]),_defineProperty(_help_mapper,"copy style",["Will copy the styles of a paragraph or shape.","After clicking this button,\t\t   click the shape you want to style.","Styles includes colors, font size and family, alignment\t\t   but not underlining, bolds and italics."]),_defineProperty(_help_mapper,"done",['Pressing this button will also use "linebreaks / enters /new-lines" to the text',"You can also just click the canvas, but then it will be without line breaks"]),_defineProperty(_help_mapper,"To line",["Make this line out of straight segments in stead of curvy segments"]),_defineProperty(_help_mapper,"Push",["pushes the current selected shapes into a group","This enables you to reactive the\t\t group by holding shift and clicking one of the shapes in the group"]),_defineProperty(_help_mapper,"Deactivate",["Use this to deactivate the current group"]),_defineProperty(_help_mapper,"Paste",["copy and paste the current group to the last clicked position"]),_defineProperty(_help_mapper,"Fuse",["Will add the paragraphs in all the shapes in the current group into one shape","will delete the remaining empty shapes"]),_defineProperty(_help_mapper,"Add subcanvas",["Will place the shapes in the current group onto a subcanvas"]),_defineProperty(_help_mapper,"shuffle",["Will shuffle the cards over the map","If you have a group selected, will only flip the selected cards"]),_defineProperty(_help_mapper,"flip all",["Will flip all the flashcards over.","If you have a group selected, will only flip the selected cards"]),_defineProperty(_help_mapper,"flash time",["Amount of time after which a card will be flipped back after being flipped"]),_defineProperty(_help_mapper,"one by one",["Will zoom in to each card","Clicking the map will show the next card",'if "check" is on, an inputbox will appear in which you can type an answer']),_defineProperty(_help_mapper,"check",["When checked, will display an input field where you can type in an answer","After typing in your answer, it will check the result","The result is checked against the text on the\t\t flipside of the card","Pressing enter from the input field will check, pressing tab from the input field\t\t will move on the the next card"]),_defineProperty(_help_mapper,"scored",["When off, will choose next card randomly from cards that have not been shown yet","When on, will show cards you have answered incorrectly, or that have not been shown yet with a higher probability"]),_defineProperty(_help_mapper,"start",["start studying flashcards one by one"]),_defineProperty(_help_mapper,"stop",["Stop studying flashcards one by one","To exit study mode, press exit mode in the study tab of this menu \t\tor study mode from the options menu"]),_defineProperty(_help_mapper,"double click for text",["alter the shape so you can add text to it by double clicking, just like other shapes (rectangles, ellipses)","This might not work, or might not work properly if the shape is simply a line, because then \t\tthere is no room to add text"]),_defineProperty(_help_mapper,"add function",["enter the formula to add a line",formulaText]),_defineProperty(_help_mapper,"ticks x/y",["suggest a number or ticks for an axis","The exact number \t\tmight be different because ticks will only added at intervals that make some sense"]),_defineProperty(_help_mapper,"min/max x",["change the range of the x axis"]),_defineProperty(_help_mapper,"min/max y",["change the range of the y axis"]),_defineProperty(_help_mapper,"Grid",["Add a grid to the plot","the grid lines will be places at each tick"]),_defineProperty(_help_mapper,"Crossed Axis",["When checked, will cross the axis at zero (when in the range)"]),_defineProperty(_help_mapper,"even scale",["changes x axis so that one tick on the x-scale is just as long \t\ton the y-scale"]),_help_mapper),el,els=Array.from(document.querySelectorAll("button, label, legend")).filter(function(e){return!e.classList.contains("no-help")}),i=0;i<els.length;i++)el=els[i],el.innerText.trim()in help_mapper&&(el.style.cursor="help",el.setAttribute("title","right click for help"),el.oncontextmenu=function(e){display_help_for_button(this,e)})
var basic_fig_help=["<span class=hh1>Resize or connect</span> by using yellow-green buttons","Start typing to<span class=hh1>add text</span>","To <span class=hh1>move</span>, click, hold and drag the shape. Or use the arrow keys","<span class=hh1>Delete</span> a shape with the delete or backspace key","Right click for <span class=hh1>quick controls </span>","To <span class=hh1>copy</span>, press Control C, then click canvas","Press shift tab to select an existing paragraph in the shape","Drag image file onto shape to <span class=hh1>add background</span>","Press control v to add image from clipboard","Press shift plus arrow \tkey to <span class=hh1>select closest neighbouring shape</span> in the direction of the arrow","Use arrow keys to move shape","Use control plus arrow key to resize shape","Hold alt when moving to move the shape one pixel at a time","Hold shift and click to activate group shape is in. Click again to cycle through multiple groups (if these are present)"],help_text={slidePreview:["Drag up or down to order slide","Scroll to move all slide preview up or down","Right click to activate slider on canvas","After reactivating you can update slide content by right clicking the slider on the canvas"],polygon:["About polygons"].concat(basic_fig_help.concat(["Some polygons (for example the arrow) have\tan extra button to alter the shape of the polygon somewhat. You can use it to make the arrow thicker or thinner, or\t the arrowhead longer or shorter"])),drawing_lineto:["About lines","Double click to show (or hide) control points","Drag control points to change the shape of the line","use the resize button to resizes the line","Extend the line from either side by dragging the line-end-points to a new position","You can add arrows to the line from the Arrows menu on the left"],slide:["About Slides","Move and resize slide over area you want to show","Right click and press make slide when done","To remove, right click and press remove"],rect:["About rectangles"].concat(basic_fig_help.concat([])),ellipse:["About ellipses"].concat(basic_fig_help.concat([])),text_path:["About text paths","Click hold and drag in x dimension to position on path","Right click for choosing font style and sizes","To change text: double click on text","If upside down, keep dragging past end of path."],text_block:["About text paths","Click hold and drag in x dimension to position on path","Right click for choosing font style and sizes","To change text: double click on text"],path_addon:["Change the size of the arrow from the contextmenu, or arrow menu","You can remove the arrow, or change the shape by pressing an arrow arrows menu","The style of the arrow is derived from the style of the path. You cannot set this on the arrow directly"],icon:["About icons","Change icon by double clicking","Use font size to make bigger or smaller","See fonts, colors in menu for more controls"],svg:["About the canvas","<span class=hh1>Add shape</span> by double clicking the canvas, or click the canvas and just start typing","Scroll to <span class=hh1>zoom</span> in or out","Click hold and drag to <span class=hh1>pan</span>","Use arrow keys to move canvas in the direction of the arrow","Hold shift while pressing an arrow key to zoom in or out",'Add <span class=hh1>gridlines</span> in "Zoom and Positioning menu"'],svg_slide:["Add a slide by first clicking shift control, then click and drag the area on the canvas you want to \t\tdisplay on the slide",'If you are happy with the position, right click the slide and press "make slide"'],P:["About paragraphs","Start typing to <span class=hh1>add text</span>","Press enter <span class=hh1>to add</span> another paragraph","For <span class=hh1>styling</span>: right-click paragraph","use up and down arrow to select other paragraphs","Press shift tab to select shape the paragraph is in","Use colors, font and paragraph controls in menu for more features","<span class=hh1>Remove</span> by press shift delete","<span class=hh1>Move</span> a paragraph inside of the shape by dragging the arrow before the paragraph (or set the margin in the           paragraph control menu","Move a paragraph onto another shape, or onto the canvas, by holding control while dragging the arrow in front of the paragraph"],path_group:["About paths","To <span class=hh1>remove</span>, press delete","Press control s to copy style","Right click to choose the side of the shape the path lands on or to <span class=hh1>add arrow</span>","Double click to show control points which will allow you to\t\t<span class=hh1>change the flow</span> of the path and the landing position on the shape","Add a <span class=hh1>text label</span> by simply typing when the path is the active shape"],print_region:["Place the print region over the area you want to export.","You can adjust the size by dragging the corners of the print region\t\t(if you have not choosen a fixed size).","Zooming in and out on the canvas is a second way to control what is visible inside the\t\tprint region.","Zooming in will also increase the pixel size of the resulting image en vice versa."],knot:["dasf"],knot_hierarchy:["About this hierarchical knot.","By connecting shapes to this knot, they become part\t\tof the hierarchy.","They can be aligned similarly, and the flow of the path will be similar","You cannot alter the path between a knot and a child as much as a normal path","To change sides, you can only mirror the shape (click shape, see hierarchy menu and klik mirror element), or\t\tchange the orientation (horizontal or vertical)"],rect_canvas:["about sub canvasses:"," this canvas behaves a bit like a layer.","you can add things to it.","If you move the canvas, everything on the canvas moves with it","Hold shift while dragging\t\tto only move the canvas and not the elements on it","You cannot add paragraphs to a canvas"],cell_basic:["about cells /tables:","This shape is a cell that is part of a table","To add text, double click it","When resizing or moving a cell, any cell that is part of the same table will also move if it is placed to the right or below\t\t of the cell you are moving","Right click for regular context menu","shift right click (or control right click for firefox) \t\t to show table context menu",'Activate "Caps Lock" to more or resize only one cell in table','See also "Table (edit)" menu on left for more options'],end_point:["move endpoint by dragging","hold shift while dragging to keep path attached to the shape"],cubic_point:["drag to alter shape of path","hold shift to only move one point at a time"],graph_basic:["About plots","You can make simple graphs","Add a line from the context menu or the graph menu",formulaText,"From the menus you can \t\talso add gridlines, or make the axes crossed"],axes_board:["About boards","You can use this board sorting and ordering other shapes","Any shape you drag onto the board, will stick to it","Look in the menu's to add or gridlines, or numbers to the axes"],math_basic:["about math text","Double click the this shape to enter your formula",'Your formula should be entered in "Tex" format',"Check out the blog (from our homepage) to read more about Tex","Press delete or backspace to delete","You can move it by dragging or using the keyboard arrow keys",'Chang the colors or font size using the "Border Controls" and "Colors" Menu'],x_axis:axis_help,y_axis:axis_help,line_for_graph:["About lines on a plot","You can color the line using the color menu","Or use the border menu to make the line thicker or thinner","To delete a line, click the del or backspace key"]}
to_canvas.set_canvas(),$(".form_disp_go").on("click",function(e){manage_groups.get_group(currentElement,!0).forEach(function(e){[0,1,2,3].forEach(function(t){disperse_path_over_side(e,t,MARGIN_DIV)})}),render()}),$(".form_no_disp").on("click",function(e){[0,1,2,3].forEach(function(e){disperse_path_over_side(currentElement,e,.5)}),render()}),$(".swap_menu").on("click",toggle_slide_edit_menu),document.querySelector("#form_toggle_advanced_options").onclick=toggle_advanced_options,$(".copy_styles").on("click",function(){style_copier.setup_style_copy(),text_to_feedback_pane("click another ".concat(me," to copy style to it"))}),$(".form_copy").on("click",make_ready_for_copy),document.querySelector("#form_fill_what").onclick=function(e){set_button_class(this,e.target),active_style.fill_what=e.target.value,set_color_picker(part_to_chunk(currentElement))},$(".form_path_style2 select").on("change",function(){manage_groups.get_group(currentElement,!0).forEach(function(e){set_current_element(e),change_path_flow_and_style(!1,active_style.line_flow,this.value)}.bind(this)),render(),gui_buttons.frame_element(currentElement)}),$(".form_group_cov").on("click",merge_covered_shapes),$(".form_ungroup_all_children").on("click",function(){merged.is_parent(currentElement)&&merged.remove_group(currentElement)}),document.querySelector("#form_ungroup").onclick=function(e){merged.remove_child(currentElement)},document.querySelector("#cm_delete_button").onclick=function(e){delete_shape(currentElement)},document.querySelector("#cm_zoom_button").onclick=function(){if(for_group){var e=get_bbox_of_group(manage_groups.get_current_group()),t=_slicedToArray(e,4),r=t[0],n=t[1],o=t[2]
zoom_to_area({x:r,y:o,width:n-r,height:t[3]-o},!0),manage_groups.deactivate_group()}else{var a="text"==currentElement.iama?find_border_by_id(currentElement.border_id):currentElement
zoom_to_area(a,!0,!1,get_max_scale_for_zoom(a.level))}},document.querySelector("#form_grid_snap").onclick=snap_to_grid,document.querySelector("#form_grid_size").onclick=function(e){manage_groups.get_group(currentElement,!1).forEach(function(e){var t=e.width,r=e.height
resize_protocol(e,t%grid_step==0?0:grid_step-t%grid_step,r%grid_step==0?0:grid_step-r%grid_step,!0)}),set_current_element(currentElement)},plus_minus_generator(document.getElementById("form_grid_step"),function(e){var t=grid_step
grid_step=isNaN(parseInt(e.value))?4:Math.max(1,parseInt(e.value)),e.value=grid_step
var r=parseInt(document.querySelector("#form_grid_lines_dx input").value)
document.querySelector("#form_grid_lines_dx input").value=Math.floor(r/t)*grid_step
var n=parseInt(document.querySelector("#form_grid_lines_dy input").value)
document.querySelector("#form_grid_lines_dy input").value=Math.floor(n/t)*grid_step,plus_minus_generator(document.getElementById("form_grid_lines_dx"),function(e){e.value=Math.max(0,e.value)},grid_step),plus_minus_generator(document.getElementById("form_grid_lines_dy"),function(e){e.value=Math.max(0,e.value)},grid_step)}),$(".button-new-map").on("click",function(){window.open(document.location.origin+"/make/new")}),document.querySelector("#button_tut_restart").onclick=function(e){quick_tut.start()},$(".button_to_hotkeys").on("click",function(){var e=document.location.origin+"/make/load/hotkeys"
window.open(e,"_blank")}),$(".form_path_reset").on("click",function(){toggle_path_reset_button(currentElement),delete currentElement.custom_flow,delete currentElement.offset_from,delete currentElement.offset_to,delete currentElement.fixed_side,delete currentElement.from_side,delete currentElement.to_side,path.set_path_attrs(currentElement),cpa.pos1=.5,cpa.pos2=.5,path.remake_path(),render()}),make_font_selector(document.querySelector("#form_fonts_list")),make_font_selector(document.querySelector("#cm_fonts_list")),make_font_selector(document.querySelector("#cm_fonts_list_par")),make_font_selector(document.querySelector("#cm_fonts_list_path")),document.querySelector("#form_collision_detection").onclick=function(e){is_toggle_button_on(this)?path.change_collision_detection.turn_off():path.change_collision_detection.turn_on(),toggle_button(this)},plus_minus_generator(document.getElementById("form_paragraph_padding_top"),function(e){part_to_chunk(currentElement).margin_top=parseInt(e.value),position_texts(currentElement.border_id),render()},1,1),plus_minus_generator(document.getElementById("form_paragraph_padding_left"),function(e){part_to_chunk(currentElement).margin_left=parseInt(e.value),position_texts(currentElement.border_id),render()},1,1),document.querySelector("#form_toggle_plumb_lines").onclick=function(e){is_toggle_button_on(this)?canvas_status.plumbs_on=!1:canvas_status.plumbs_on=!0,toggle_button(this)},document.querySelector("#form_view_mode").onclick=function(e){view_mode_on(),to_canvas.set_canvas()},document.querySelector("#view_mode_button").onclick=function(){view_mode_off()},document.querySelector("#form_view_mode").onclick=function(){view_mode_on()},document.querySelector("#math_modal_closer").onclick=close_math_modal
var quick_tut=function(){function e(){arguments.length>0&&void 0!==arguments[0]&&arguments[0],r(),cmm.off(),document.querySelector("#tut_frame").style.display="none"}function t(e){return{top:transform.applyY(e.top),left:transform.applyX(e.left),bottom:transform.applyY(e.bottom),right:transform.applyX(e.right)}}function r(){["left_arrow","right_arrow","up_arrow","down_arrow"].forEach(function(e){document.querySelector("#"+e).style.display="none"})}function n(e){_.innerText=i[e][u],r()
var t=i[e]
if("actions"in t&&t.actions.forEach(function(e){return e()}),"arrow"in i[e]){var n=document.querySelector("#"+t.arrow)
if(n.style.display="block",n.style.position="absolute","string"==typeof t.pos)var o=document.querySelector("#"+t.pos),a=o.getBoundingClientRect()
else var a=t.pos()
c[t.arrow](a,n)}}function o(e){l.innerText="step ".concat(e," of 19")}var a,i=[{text:"Welcome. This is a quick introduction into the basic controls for Breakdown Notes. Use the buttons to continue, move back or exit"},{text:"Check the help menu to see what shape is active and what actions are possible",pos:"fs_help",arrow:"right_arrow",actions:[function(){return display_help(to_canvas.get_canvas())},function(){return toggle_field_set(document.querySelector("#fs_help"))}]},{text:"You start out on an empty canvas. Reading the help learns that you can add shapes here by double clicking ....",pos:function(e){return document.querySelector("#fs_help p:nth-child(2)")},arrow:"right_arrow",actions:[]},{text:"..and that you can zoom in or out the canvas, among other things",pos:function(e){return document.querySelector("#fs_help p:nth-child(3)")},arrow:"right_arrow"},{text:"The menu on the left contains many options, for instance for saving and loading, fonts, colors and shapes",pos:"fs_maps",arrow:"right_arrow",actions:[]},{text:"Menu items with this color offer controls specific to the shape that is active.  Dependend on the shape that is\t\t     active, some items may disappear",pos:"fs_border",arrow:"right_arrow",actions:[function(){last_pos=[-transform.x/transform.k+250,-transform.y/transform.k+250],add_active_shape_to_canvas(),display_fs_for_shape(currentElement)}]},{text:"Just click a menu item to fully expand it, and click it again to hide it. Scroll while hovering the menu to move it up or down",actions:[function(){close_other_fieldsets(),toggle_field_set(document.querySelector("#fs_buttons"))}]},{text:"In the Options menu you can also choose to show advanced options. But you probably do not need these when you are just starting out",pos:"form_toggle_advanced_options",arrow:"right_arrow"},{text:"Let's look at a shape. You can add it by simple double clicking the canvas. Notice the green control buttons.",pos:function(){var e=to_bbox(currentElement)
return e.top+=40,e.right+=50,t(e)},arrow:"left_arrow",actions:[function(){display_fs_for_shape(currentElement),gui_buttons.frame_element(currentElement)}]},{text:"This button is for resizing the shape:  just click, hold and drag",pos:function(){var e=to_bbox(currentElement)
return e.top+=currentElement.height,e.right+=50,t(e)},arrow:"left_arrow"},{text:"And to connect: click, hold and drag onto another shape ",pos:function(){var e=to_bbox(currentElement)
return e.top+=currentElement.height,e.right+=10,t(e)},arrow:"right_arrow"},{text:"To move a shape, click hold and drag its greenish border or an empty part of it. The border will appear when hovering the shape with your mouse",actions:[function(){return render_hover_highlight(currentElement,"rgba(154,205,50,0.5)",hover_context,get_scaled_margin())}]},{text:"You can see which element is active by the green controls or green border and the red lines. Any commands, like choosing fonts or colors\t\t  will have effect on the active element",actions:[]},{text:"To add text to a shape, make sure its active and then just start typing. Notice the paragraph is now the activate shape and the help menu\t\t    is listing controls for paragraphs.",actions:[function(){var e=add_paragraph_to_shape(currentElement)
add_text_to_paragraph(e,"This is a paragraph"),measure_text(e)
var t=e.parent
position_texts(e.parent.border_id),set_current_element(t.parts[0]),gui_buttons.frame_element(currentElement),render_all(0,!1,!0)}],pos:function(){return currentElement},arrow:"right_arrow"},{text:"To add a shape and paragraph in one go, you can also just click the canvas once and start typing, or press tab from within a paragraph and continue typing"},{text:"Right click shapes and element to show the quick controls",pos:"context-menu",arrow:"down_arrow",actions:[function(){return cmm.position_and_display(150,150,"#cm-par")}]},{text:"Right click buttons and labels in menus to get additional help. This for instance is help about how to group shapes together.",actions:[function(){cmm.off(),text_to_help_pane(help_mapper["Group Shapes"],!0,!0)}],pos:"fs_help",arrow:"right_arrow"},{text:"Save and load your map from the save load new menu.",pos:"fs_maps",arrow:"right_arrow"},{text:"Export to pgn  using the export menu. Remember, right click buttons and labels for help",pos:"fs_export",arrow:"right_arrow"},{text:"That's it! Hope you enjoy making notes and maps with Breakdown Notes."}],s=0,_=document.querySelector("#lesson"),l=document.querySelector("#tut_progress")
document.querySelector("#close_tut").onclick=e
var c={left_arrow:function(e,t){t.style.left=e.right+"px",t.style.top=e.top+"px"},right_arrow:function(e,t){t.style.left=e.left-a+"px",t.style.top=e.top+"px"},down_arrow:function(e,t){t.style.left=e.left+"px",t.style.top=e.top-arrow_height+"px"},up_arrow:function(e,t){t.style.left=e.left+"px",t.style.top=e.bottom+arrow_height+"px"}},u="text"
return{forward:function(){s<i.length-1&&(s+=1,o(s),n(s))},backward:function(){s>0&&(s-=1,n(s),o(s))},start:function(){s=0,n(s),o(s),arrow_height=parseInt(window.getComputedStyle(document.querySelector(".anim")).height),a=parseInt(window.getComputedStyle(document.querySelector(".anim")).width),r(),document.querySelector("#step_forward").onclick=this.forward,document.querySelector("#step_back").onclick=this.backward,document.querySelector("#tut_frame").style.display="block",set_val_to_cookie("tut_seen","true")},end:function(){e()},check_cookie_for_tutorial:function(){return find_val_in_cookie("tut_seen")}}}(),options={shouldSort:!0,threshold:.3,location:0,distance:600,maxPatternLength:32,minMatchCharLength:2,keys:["text"]}
document.querySelector("#search_form_close").onclick=hide_search_form,document.querySelector("#search_form_search").onclick=function(e){find_search_results(document.querySelector("#search_form_search_value").value)}
var printer=function(){function e(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=100/transform.k,n=e.width,o=e.height,a=e.width/e.height
return t?a>1/Math.sqrt(2)?(e.height-=r,e.width=e.height/Math.sqrt(2),e.y+=r/2,e.x+=(n-e.width)/2):(e.width-=r,e.height=e.width*Math.sqrt(2),e.x+=r/2,e.y+=(o-e.height)/2):a>Math.sqrt(2)?(e.height-=r,e.width=e.height*Math.sqrt(2),e.y+=r/2,e.x+=(n-e.width)/2):(e.width-=r,e.height=e.width/Math.sqrt(2),e.x+=r/2,e.y+=(o-e.height)/2),e}function t(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0]
if(h){var n=e(view.get_view_bbox(),r())
draw_slider(n),slider=JSON.parse(JSON.stringify(n)),slider.iama="slider"}else slider||(slider={x:-transform.x/transform.k+100,y:-transform.y/transform.k+100,width:400,height:400,iama:"slider"},s(1)),draw_slider(slider),i(slider.width,slider.height)
h||t||draw_slider_resize_points()}function r(){return"portrait"==document.querySelector(".cm-print-layout").value}function n(){if(h){var e=document.querySelector("#form_print_size"),t=_slicedToArray(sizes[e[e.selectedIndex].value],2),n=t[0],o=t[1]
return r()?[n,o]:[o,n]}return[p,m]}function o(e){for(var t=e.split(","),r=t[0].match(/:(.*?);/)[1],n=atob(t[1]),o=n.length,a=new Uint8Array(o);o--;)a[o]=n.charCodeAt(o)
return new Blob([a],{type:r})}function a(e){var t=o(e),r=window.URL.createObjectURL(t)
window.open(r,"_blank")}function i(e,t){document.querySelector("#form_print_result_print_size").innerText="".concat(round_to(e,0)," x ").concat(round_to(t,0)),e*t>2e7&&text_to_feedback_pane("Your image will be large. Processing a size this big might take a long time             or even crash your browser.")}function s(e){g=e
var t=round_to(slider.width*g,0),r=round_to(slider.height*g,0)
p=t,m=r,i(t,r)}function _(e,t){p=e,m=t,i(e,t)}function l(e,t){return t/e.width}function c(){return!document.querySelector("#form_printer_no_background").checked&&(grid_canvas.node().style.backgroundColor||window.getComputedStyle(document.body).backgroundColor)}function u(){to_canvas.set_canvas()
var e=new PDFDocument({autoFirstPage:!1}),t=get_canvas_proxy_for_pdfkit(e)
roughing.set_for_export(t)
var r=e.pipe(blobStream())
return render_to_pdf=!0,always_reset=!0,no_wobble=!0,r.on("finish",function(){var e=r.toBlob("application/pdf")
if(e.size>400){var t=window.URL.createObjectURL(e)
window.open(t,"_blank")}}),[e,t,r]}function d(e){render_to_pdf=!1,always_reset=!1,no_wobble=!1,e.end(),roughing.set_default()}function f(){var e=n(),t=_slicedToArray(e,2),r=t[0],o=t[1]
r*=.75,o*=.75
var a=l(slider,r,o)
return[r,o,{x:round_to(-slider.x*a,0),y:round_to(-slider.y*a,0),k:a}]}A0=[3179,4494],A1=[2245,3179],A2=[1587,2245],A3=[1123,1587],A4=[794,1123],A5=[559,794],A6=[397,559],sizes={A0:A0,A1:A1,A2:A2,A3:A3,A4:A4,A5:A5,A6:A6}
var h=!0,p=0,m=0,g=1
return{change_goal_w_h:_,change_scale:s,get_background_color:c,set_fixed_A_ratio:function(e){return h=e},is_fixed_A_ratio:function(){return h},draw_print_region:t,print:function(){0==document.querySelector("#form_print_to_image").selectedIndex?this.print_to_image():this.export_to_pdf()},print_to_image:function(){cc.clear_canvas(context_single)
var e=n(),t=_slicedToArray(e,2),r=t[0],o=t[1]
no_wobble=!0
var i=document.createElement("canvas")
i.style.backgroundColor="white",roughing.set_for_export(i)
var s=i.getContext("2d")
scale_canvas(i,s,r,o)
var _=l(slider,r,o),u={x:round_to(-slider.x*_,0),y:round_to(-slider.y*_,0),k:_}
document.body.appendChild(i),render_for_pic(s,slider,u,c()),a(i.toDataURL()),i.remove(),roughing.set_default(),no_wobble=!1},export_to_pdf:function(){var e=f(),t=_slicedToArray(e,3),r=t[0],n=t[1],o=t[2]
show_wait_spinner("exporting to pdf","This may take a while"),load_pdf_script().then(function(e){var t=u(),a=_slicedToArray(t,3),i=a[0],s=a[1]
a[2],prep_fonts().then(function(){i.addPage({size:[r,n]}),render_for_pic(s,slider,o,!1),d(i),hide_wait_spinner()}).catch(function(e){d(i),hide_wait_spinner(),text_to_feedback_pane([e],!0,4e3)})})}}}()
document.querySelector("#form_print_add_print_region").onclick=function(e){canvas_status.export_mode||drag_export_on(),printer.draw_print_region()},document.querySelector(".cm-print-layout").onchange=printer.draw_print_region,document.querySelector("#form_remove_print_region").onclick=function(){drag_export_off()},document.querySelector(".cm-print-print").onclick=function(){printer.print()},add_export_scale_events(),document.querySelector("#form_print_A_ratio").onchange=function(){var e=document.querySelector("#form_print_A_ratio").checked
printer.set_fixed_A_ratio(e),set_form_print_ratio_choice(),e?text_to_feedback_pane("drag and zoom the map so that the part of the map you want to print is inside the blue export area",!1,4e3):text_to_feedback_pane("you can resize and drag the blue export region over the part of the map you want to export",!1,4e3)}
var font_cache={},font_to_file={Acme:{regular:"Acme-Regular.ttf"},Aleo:{regular:"Aleo-Regular.ttf",bold:"Aleo-Bold.ttf",italic:"Aleo-Italic.ttf",bolditalic:"Aleo-BoldItalic.ttf"},"Amatic SC":{regular:"AmaticSC-Regular.ttf",bold:"AmaticSC-Bold.ttf"},Arimo:{regular:"Arimo-Regular.ttf",bold:"Arimo-Bold.ttf",italic:"Arimo-Italic.ttf",bolditalic:"Arimo-BoldItalic.ttf"},Athiti:{regular:"Athiti-Regular.ttf",bold:"Athiti-Bold.ttf"},Audiowide:{regular:"Audiowide-Regular.ttf"},Cabin:{regular:"Cabin-Regular.ttf",bold:"Cabin-Bold.ttf",italic:"Cabin-Italic.ttf",bolditalic:"Cabin-BoldItalic.ttf"},Caveat:{regular:"Caveat-Regular.ttf",bold:"Caveat-Bold.ttf"},Cinzel:{regular:"Cinzel-Regular.ttf",bold:"Cinzel-Bold.ttf"},Comfortaa:{regular:"Comfortaa-Regular.ttf",bold:"Comfortaa-Bold.ttf"},Exo:{regular:"Exo-Regular.ttf",bold:"Exo-Bold.ttf",italic:"Exo-Italic.ttf",bolditalic:"Exo-BoldItalic.ttf"},"Font Awesome 5 Free":{regular:"fa-regular-400.ttf"},"Font Awesome 5 Brands":{regular:"fa-brands-400.ttf"},Handlee:{regular:"Handlee-Regular.ttf"},Hind:{regular:"Hind-Regular.ttf",bold:"Hind-Bold.ttf"},Kalam:{regular:"Kalam-Regular.ttf",bold:"Kalam-Bold.ttf"},Lato:{regular:"Lato-Regular.ttf",bold:"Lato-Bold.ttf",italic:"Lato-Italic.ttf",bolditalic:"Lato-BoldItalic.ttf"},Lora:{regular:"Lora-Regular.ttf",bold:"Lora-Bold.ttf",italic:"Lora-Italic.ttf",bolditalic:"Lora-BoldItalic.ttf"},Montserrat:{regular:"Montserrat-Regular",bold:"Montserrat-Bold.ttf",italic:"Montserrat-Italic.ttf",bolditalic:"Montserrat-BoldItalic.ttf"},"Open Sans":{regular:"OpenSans-Regular.ttf",bold:"OpenSans-Bold.ttf",italic:"OpenSans-Italic.ttf",bolditalic:"OpenSans-BoldItalic.ttf"},Orbitron:{regular:"Orbitron-Regular.ttf",bold:"Orbitron-Bold.ttf"},"PT Sans":{regular:"pt-sans-regular.ttf",bold:"pt-sans-bold.ttf",italic:"pt-sans-italic.ttf",bolditalic:"pt-sans-bold-italic.ttf"},Quattrocento:{regular:"Quattrocento-Regular.ttf",bold:"Quattrocento-Bold.ttf"},"Raleway-Regular":{regular:"Raleway-Regular.ttf",bold:"Raleway-Bold.ttf",italic:"Raleway-Italic.ttf",bolditalic:"Raleway-BoldItalic.ttf"},Roboto:{regular:"Roboto-Regular.ttf",bold:"Roboto-Bold.ttf",italic:"Roboto-Italic.ttf",bolditalic:"Roboto-BoldItalic.ttf"},"Roboto condensed":{regular:"RobotoCondensed-Regular.ttf",bold:"RobotoCondensed-Bold.ttf",italic:"RobotoCondensed-Italic.ttf",bolditalic:"RobotoCondensed-BoldItalic.ttf"},Sacramento:{regular:"Sacramento-Regular.ttf"},Schoolbell:{regular:"Schoolbell-Regular.ttf"},"Source Code Pro":{regular:"SourceCodePro-Regular.ttf",bold:"SourceCodePro-Bold.ttf",italic:"SourceCodePro-It.ttf",bolditalic:"SourceCodePro-BoldIt.ttf"},Ubuntu:{regular:"Ubuntu-Regular.ttf",bold:"Ubuntu-Bold.ttf",italic:"Ubuntu-Italic.ttf",bolditalic:"Ubuntu-BoldItalic.ttf"},"Ubuntu Condensed":{regular:"ubuntu-condensed-webfont.ttf"},"Zilla Slab":{regular:"ZillaSlab-Regular.ttf",bold:"ZillaSlab-Bold.ttf",italic:"ZillaSlab-Italic.ttf",bolditalic:"ZillaSlab-BoldItalic.ttf"}}
$(window).on("load",function(){var e=0!=quick_tut.check_cookie_for_tutorial()
if(reloading);else if(start_tut&&!dataFile)e||quick_tut.start()
else if(dataFile)if(quick_tut.end(!e),dataPad=dataPad,show_wait_spinner("loading map "+dataFile),zipped){var t=new XMLHttpRequest
t.open("GET",dataPad,!0),t.responseType="blob",t.onload=function(e){var r=t.response
unzip_blob(new Response(r).arrayBuffer(),function(e){loader.load_data(e,!1,!0,!1,!1,!1)})},t.send()}else $.getJSON(dataPad,function(e){loader.load_data(e,!1,!0,!1,!1,!1)})
view_mode&&view_mode_on(),canvas_status.mobile_mode=mobilecheck(),canvas_status.mobile_mode&&(quick_tut.end(),document.querySelector("#keyboard_button").style.display="inline",dataFile?view_mode_on():toggle_side_bar(),document.querySelector("#full_screen_button").style.display="inline")}),document.querySelector("#full_screen_button").onclick=toggleFullScreen,document.querySelector("#keyboard_button").onclick=function(e){var t=document.querySelector("#mobile_text_input")
t.style.display="block"==t.style.display?"none":"block"},document.querySelector('#mobile_text_input input[type="text"]').oninput=function(e){var t=document.querySelector("#mobile_text_input input").value
document.querySelector('#mobile_text_input input[type="text"]').value="",1==t.length&&add_text_from_mobile_input(t)},document.querySelector("#mobile_text_input form").onsubmit=function(e){return e.preventDefault(),!1}
var math_jax_specs={loaded:!1,busy:!1,must_rerender:!1,shape:!1,auto_update:!0,error_callback:!1}
document.querySelector("#math_modal_auto_update").onchange=function(e){math_jax_specs.auto_update=this.checked,document.querySelector("#math_modal_button").style.display=this.checked?"none":"inherit"},document.querySelector("#math_modal_button").onclick=function(e){change_math(document.querySelector("#math_modal_input").value,math_jax_specs.shape)},document.querySelector("#math_modal_input").oninput=function(){if(!math_jax_specs.auto_update)return!1
0===MathJax.Hub.queue.pending&&0===MathJax.Hub.queue.running?(clearTimeout(math_jax_specs.timeout),change_math(this.value,math_jax_specs.shape)):delayed_change(this.value,math_jax_specs.shape)},plus_minus_generator(document.querySelector("#cm_math_scale"),function(e){alter_scale_of_math_shape(currentElement,parseInt(e.value))},1,0)
var math_menu=document.querySelector("#math_modal > div.inner"),multiline_test_text="\n    function test(arr){\n        arr= arr.map(d=>d+1)\n        return arr\n    }\n    test([1,2,3,4])",prism_color_map={comment:["#999","slategrey"],prolog:["#999","slategrey"],doctype:["#999","slategrey"],cdata:["#999","slategrey"],punctuation:["#7ec6be","#999"],tag:["#e2777a","#905"],"attr-name":["#c5a5c5","#690"],namespace:["#e2777a","#690"],deleted:["#e2777a","#905"],"function-name":["#6196cc","#cf1515"],boolean:["#f08d49","#905"],number:["#f08d49","#905"],function:["#f08d49","#cf1515"],property:["#f8c555","#905"],"class-name":["#f8c555","#cf1515"],constant:["#f8c555","#905"],symbol:["#f8c555","#905"],selector:["#cc99cd","#690"],important:["#cc99cd","#e90"],atrule:["#cc99cd","#07a"],keyword:["#cc99cd","#07a"],builtin:["#cc99cd","#690"],string:["#7ec699","#690"],char:["#7ec699","#690"],"attr-value":["#7ec699","#07a"],regex:["#7ec699","#e90"],variable:["#7ec699","#e90"],operator:["#67cdcc","#9a6e3a"],entity:["#67cdcc","#9a6e3a"],url:["#67cdcc","#9a6e3a"],inserted:["green","#690"]}
document.querySelector(".form_syntax_highlight_item").onclick=function(e){var t=document.querySelector("#form_language_for_syntax_highlight"),r=t[t.selectedIndex].value
manage_groups.get_group(currentElement,!0).forEach(function(e){"border"==e.iama&&syntax_highlight_shape(e,r,document.querySelector("#form_syntax_highlight_dark_mode").checked)})}
})()